cscope 15 W:\asteroids_game\src\game"               0000350541
	@asset_formats.h

1 
	eVERTEX_BUFFER
 {

2 
	mVERTEX_BUFFER_NOT_SET
,

3 
	mVERTEX_BUFFER_POSITION
,

4 
	mVERTEX_BUFFER_NORMAL
,

5 
	mVERTEX_BUFFER_TANGENT
,

6 
	mVERTEX_BUFFER_COLOR
,

7 
	mVERTEX_BUFFER_TEXCOORD
,

8 
	mVERTEX_BUFFER_TOTAL


11 
	sVîãxBuf„rD©a
 {

12 * 
	md©a
;

13 
VERTEX_BUFFER
 
	mty≥
;

16 
	sMeshD©a
 {

17 
VîãxBuf„rD©a
* 
	mvb_d©a
;

18 
u32
 
	mvb_d©a_cou¡
;

20 
u32
* 
	mödi˚s
;

21 
u32
 
	mvîti˚s_cou¡
;

22 
u32
 
	mödi˚s_cou¡
;

25 
	eTEXTURE_SLOT
 {

26 
	mTEXTURE_SLOT_DIFFUSE
,

27 
	mTEXTURE_SLOT_NORMAL
,

28 
	mTEXTURE_SLOT_TOTAL


31 
	sTextuªD©a
 {

32 
TEXTURE_SLOT
 
	mty≥
;

33 * 
	mpixñs
;

34 
u32
 
	mwidth
;

35 
u32
 
	mheight
;

36 
u8
 
	mnum_comp⁄íts
;

39 
	sM©îülD©a
 {

40 
TextuªD©a
* 
	mãxtuª_d©a
;

41 
u8
 
	mcou¡
;

42 * 
	m«me
;

	@asset_info.cpp

1 
	~"as£t_öfo.h
"

3 
As£tInfo
*

4 
	$InôAs£tInfo
(
Mem‹yAª«
* 
¨ía
) {

5 
As£tInfo
* 
ªsu…
 = 0;

6 
u8
* 
memblock
 = 
	`GëMem‹y
(
¨ía
, 
	`Megabyãs
(1));

7 
ªsu…
 = (
As£tInfo
*)
memblock
;

8 
ªsu…
->
≥rm™ít
.
mem‹y
.
bp
 = 
memblock
;

9 
ªsu…
->
≥rm™ít
.
mem‹y
.
size
 = 
	`Megabyãs
(1);

10 
ªsu…
->
≥rm™ít
.
u£d
 = (
As£tInfo
);

12  
ªsu…
;

13 
	}
}

15 
TextuªD©a
*

16 
	$LﬂdTextuªD©a
(
TextuªF‹m©
* 
tf
, 
GameAs£ts
* 
as£ts
, 
Mem‹yAª«
* 
¨ía
) {

17 
TextuªD©a
* 
ªsu…
 = 
	`PushSåu˘
(
¨ía
, TextureData);

19 
ªsu…
->
pixñs
 = 
as£ts
->
d©a
 + 
tf
->
off£t_to_d©a
;

20 
ªsu…
->
width
 = 
tf
->width;

21 
ªsu…
->
height
 = 
tf
->height;

22 
ªsu…
->
num_comp⁄íts
 = 
tf
->num_components;

24  
ªsu…
;

25 
	}
}

27 
TextuªAs£tInfo
*

28 
	$LﬂdTextuªAs£t
(* 
«me
, 
GameAs£ts
* 
as£ts
, 
As£tInfo
* 
as£t_öfo
) {

29 
TextuªAs£tInfo
* 
ãxtuª_öfo
 = 
	`PushTextuªAs£tInfo
(
as£t_öfo
);

31 
TextuªF‹m©
* 
tf
 = 
	`GëTextuªF‹m©
(
«me
, 
as£ts
);

32 
TextuªD©a
* 
td
 = 
	`LﬂdTextuªD©a
(
tf
, 
as£ts
, &
as£t_öfo
->
≥rm™ít
);

34 
ãxtuª_öfo
->
«me
 = 
tf
->name;

35 
ãxtuª_öfo
->
d©a
 = 
td
;

37  
ãxtuª_öfo
;

38 
	}
}

41 
	$LﬂdAŒTextuªAs£ts
(
GameAs£ts
* 
as£ts
, 
As£tInfo
* 
öfo
) {

42 
u32
 
cou¡
 = 0;

43 
TextuªF‹m©
* 
tf_¨øy
 = 
	`GëAŒTextuªF‹m©s
(
as£ts
, &
cou¡
);

45 
TextuªAs£tInfo
* 
ãxtuª_öfo
;

46 
TextuªF‹m©
* 
ãxtuª_f‹m©
;

47 
u32
 
i
=0; i<
cou¡
; i++) {

48 
ãxtuª_öfo
 = 
	`PushTextuªAs£tInfo
(
öfo
);

49 
ãxtuª_f‹m©
 = 
tf_¨øy
+
i
;

50 
ãxtuª_öfo
->
«me
 = 
tf_¨øy
[
i
].name;

51 
ãxtuª_öfo
->
d©a
 = 
	`LﬂdTextuªD©a
(
tf_¨øy
+
i
, 
as£ts
, &
öfo
->
≥rm™ít
);

53 
	}
}

56 
	$U∂ﬂdAŒTextuªAs£ts
(
As£tInfo
* 
öfo
, 
Rídîî
* 
ªndîî
) {

57 
TextuªAs£tInfo
* 
ãxtuª_öfo
;

58 
u32
 
i
=0; i<
öfo
->
ãxtuª_cou¡î
; i++) {

59 
ãxtuª_öfo
 = 
öfo
->
ãxtuªs
 + 
i
;

60 if(
ãxtuª_öfo
->
d©a
->
pixñs
) {

61 
ãxtuª_öfo
->
ªndî_buf„r
 = 
	`U∂ﬂdTextuª
(
öfo
->
ãxtuªs
[
i
].
d©a
, 
ªndîî
);

64 
	}
}

66 
TextuªAs£tInfo
*

67 
	$GëTextuªAs£tInfo
(* 
«me
, 
As£tInfo
* 
öfo
) {

68 
TextuªAs£tInfo
* 
ªsu…
 = 0;

69 
	`As£π
(
«me
);

70 
boﬁ
 
found
 = 
Ál£
;

71 
u32
 
i
=0;

72 
i
=0; i<
öfo
->
ãxtuª_cou¡î
; i++) {

73 if(
	`SåögCom∑ª
(
öfo
->
ãxtuªs
[
i
].
«me
,Çame)) {

74 
ªsu…
 = 
öfo
->
ãxtuªs
 + 
i
;

75 
found
 = 
åue
;

79 
	`As£π
(
found
);

80  
ªsu…
;

81 
	}
}

	@asset_info.h

1 
	sTextuªAs£tInfo
 {

2 
TextuªD©a
* 
	md©a
;

3 
RídîBuf„r
* 
	mªndî_buf„r
;

4 * 
	m«me
;

7 
	sAs£tInfo
 {

8 
TextuªAs£tInfo
 
	mãxtuªs
[
MAX_TEXTURES
];

9 
u32
 
	mãxtuª_cou¡î
;

10 
Mem‹yAª«
 
	m≥rm™ít
;

13 
TextuªAs£tInfo
*

14 
	$PushTextuªAs£tInfo
(
As£tInfo
* 
öfo
) {

15 
	`As£π
(
öfo
->
ãxtuª_cou¡î
 < 
MAX_TEXTURES
);

16 
TextuªAs£tInfo
* 
ªsu…
 = 
öfo
->
ãxtuªs
 + info->
ãxtuª_cou¡î
++;

17  
ªsu…
;

18 
	}
}

	@asset_loading.cpp

1 
	~"as£t_f‹m©s.h
"

2 
	~"fûe_f‹m©s.h
"

4 
	#MAX_TEXTURES
 255

	)

6 
	sGameAs£ts
 {

7 
Mem‹yAª«
 
	m≥rm™ít
;

8 
u32
 
	moff£ts
[
ASSET_BLOB_TOTAL
];

9 
u8
* 
	md©a
;

13 
	$GëAs£tBlob
(
ASSET_BLOB
 
blob
, 
GameAs£ts
* 
as£ts
) {

14  
as£ts
->
d©a
 +ás£ts->
off£ts
[
blob
];

15 
	}
}

17 
GameAs£ts
*

18 
	$InôGameAs£ts
(
Pœtf‹mAPI
* 
∂©f‹m_≠i
, 
Mem‹yAª«
* 
¨ía
) {

19 
GameAs£ts
* 
ga
 = {};

21 
Pœtf‹mFûeInfo
 
öfo
;

22 
u8
 
«me
[] = "data.gaf";

23 
öfo
.
«me
 =Çame;

24 
Pœtf‹mFûeH™dÀ
 
h™dÀ
 = 
∂©f‹m_≠i
->
	`›í_fûe
(&
öfo
);

25 
	`As£π
(!
h™dÀ
.
Áûed
);

27 
u8
* 
memblock
 = 
	`GëMem‹y
(
¨ía
, 
öfo
.
size
 + (
GameAs£ts
));

28 
ga
 = (
GameAs£ts
*)
memblock
;

29 
ga
->
≥rm™ít
.
mem‹y
.
bp
 = 
memblock
;

30 
ga
->
≥rm™ít
.
mem‹y
.
size
 = 
öfo
.size+(
GameAs£ts
);

31 
ga
->
≥rm™ít
.
u£d
 = 
öfo
.
size
+(
GameAs£ts
);

33 
ga
->
d©a
 = 
memblock
 + (
GameAs£ts
);

35 
∂©f‹m_≠i
->
	`ªad_fûe
(&
h™dÀ
, 
öfo
.
size
, 
ga
->
d©a
);

36 
GameAs£tFûe
* 
gaf
 = (GameAs£tFûe*)
ga
->
d©a
;

37 
	`As£π
(
	`SåögCom∑ª
(
gaf
->
idítifiˇti⁄
, "gaff"));

39 
Dúe˘‹y
* 
dú
 = (Dúe˘‹y*)(
ga
->
d©a
 + 
gaf
->
off£t_to_blob_dúe˘‹õs
);

40 
u8
 
i
=0; i<
gaf
->
numbî_of_blobs
; i++)

41 
u8
 
j
=0; j<
ASSET_BLOB_TOTAL
; j++)

42 if(
	`SåögCom∑ª
(
blob_«mes
[
j
], 
dú
[
i
].
«me_of_blob
))

43 
ga
->
off£ts
[
j
] = 
dú
[
i
].
off£t_to_blob
;

45  
ga
;

46 
	}
}

48 
VîãxBuf„rD©a


49 
	$MakeVîãxBuf„rD©a
(
VîãxBuf„rF‹m©
* 
vbf
, 
GameAs£ts
* 
ga
) {

50 
VîãxBuf„rD©a
 
vbd
 = {};

52 
boﬁ
 
found
 = 
Ál£
;

53 
u8
 
i
=0; i<
VERTEX_BUFFER_TOTAL
; i++) {

54 if(
	`SåögCom∑ª
(
vbf
->
ty≥
, 
vîãx_buf„r_«mes
[
i
])) {

55 
vbd
.
ty≥
 = (
VERTEX_BUFFER
)
i
;

56 
found
 = 
åue
;

60 
	`As£π
(
found
);

62 
vbd
.
d©a
 = (*)(
ga
->d©®+ 
vbf
->
off£t_to_d©a
);

64  
vbd
;

65 
	}
}

67 
MeshD©a


68 
	$MakeMeshD©a
(
MeshF‹m©
* 
mf
, 
GameAs£ts
* 
ga
, 
Mem‹yAª«
* 
¨ía
) {

69 
MeshD©a
 
md
 = {};

71 
md
.
vîti˚s_cou¡
 = 
mf
->vertices_count;

72 
md
.
ödi˚s_cou¡
 = 
mf
->indices_count;

73 
md
.
vb_d©a_cou¡
 = 
mf
->
vîãx_buf„r_cou¡
;

74 
md
.
ödi˚s
 = (
u32
*)(
ga
->
d©a
 + 
mf
->
off£t_to_ödi˚s
);

75 
md
.
vb_d©a
 = 
	`PushAºay
(
¨ía
, 
VîãxBuf„rD©a
, 
mf
->
vîãx_buf„r_cou¡
);

77 
VîãxBuf„rF‹m©
* 
vbf_¨r
 = (VîãxBuf„rF‹m©*)(
ga
->
d©a
 + 
mf
->
off£t_to_vîãx_buf„rs
);

78 
u8
 
i
=0; i<
mf
->
vîãx_buf„r_cou¡
; i++)

79 
md
.
vb_d©a
[
i
] = 
	`MakeVîãxBuf„rD©a
(
vbf_¨r
 + i, 
ga
);

81  
md
;

82 
	}
}

84 
MeshD©a


85 
	$LﬂdMeshD©aFromAs£ts
(* 
«me
, 
GameAs£ts
* 
ga
, 
Mem‹yAª«
* 
¨ía
) {

86 
	`As£π
(
«me
);

87 
MeshD©a
 
md
 = {};

89 
MeshesBlob
* 
mb
 = (MeshesBlob*)(
ga
->
d©a
 + ga->
off£ts
[
ASSET_BLOB_MESHES
]);

90 
MeshF‹m©
* 
mf_¨r
 = (MeshF‹m©*)(
ga
->
d©a
 + 
mb
->
off£t_to_mesh_f‹m©s
);

92 
MeshF‹m©
* 
mf
 = 0;

93 
u32
 
i
=0;

94 !
	`SåögCom∑ª
(
mf_¨r
[
i
].
«me
,Çame)) i++;

95 
mf
 = 
mf_¨r
 + 
i
;

97 
	`As£π
(
	`SåögCom∑ª
(
mf
->
«me
,Çame));

99 
md
 = 
	`MakeMeshD©a
(
mf
, 
ga
, 
¨ía
);

101  
md
;

102 
	}
}

103 
TextuªF‹m©
*

104 
	$GëAŒTextuªF‹m©s
(
GameAs£ts
* 
ga
, 
u32
* 
cou¡
) {

105 
TextuªsBlob
* 
tb
 = (TextuªsBlob*)(
ga
->
d©a
 + ga->
off£ts
[
ASSET_BLOB_TEXTURES
]);

106 
TextuªF‹m©
* 
tf_¨r
 = (TextuªF‹m©*)(
ga
->
d©a
 + 
tb
->
off£t_to_ãxtuª_f‹m©s
);

108 *
cou¡
 = 
tb
->
ãxtuªs_cou¡
;

109  
tf_¨r
;

110 
	}
}

112 
TextuªF‹m©
*

113 
	$GëTextuªF‹m©
(* 
«me
, 
GameAs£ts
* 
ga
) {

114 
	`As£π
(
«me
);

115 
TextuªF‹m©
* 
tf
 = 0;

117 
u32
 
cou¡
 = 0;

118 
TextuªF‹m©
* 
tf_¨r
 = 
	`GëAŒTextuªF‹m©s
(
ga
, &
cou¡
);

120 
boﬁ
 
found
 = 
Ál£
;

121 
u32
 
i
=0;

122 
i
=0; i<
cou¡
; i++) {

123 if(
	`SåögCom∑ª
(
tf_¨r
[
i
].
«me
,Çame)) {

124 
found
 = 
åue
;

128 
	`As£π
(
found
);

130 
tf
 = 
tf_¨r
 + 
i
;

131  
tf
;

132 
	}
}

	@base_types.h

1 
	~<öåö.h
>

2 
	~<°döt.h
>

3 
	~<°ddef.h
>

4 
	~<limôs.h
>

5 
	~<Êﬂt.h
>

7 
	#globÆ
 

	)

9 
öt8_t
 
	ti8
;

10 
öt16_t
 
	ti16
;

11 
öt32_t
 
	ti32
;

12 
öt64_t
 
	ti64
;

14 
uöt8_t
 
	tu8
;

15 
uöt16_t
 
	tu16
;

16 
uöt32_t
 
	tu32
;

17 
uöt64_t
 
	tu64
;

19 
	#U8Max
 255

	)

20 
	#U16Max
 65535

	)

21 
	#I32Mö
 ((
i32
)0x80000000)

	)

22 
	#I32Max
 ((
i32
)0x7fffffff)

	)

23 
	#U32Mö
 0

	)

24 
	#U32Max
 ((
u32
)-1)

	)

25 
	#U64Max
 ((
u64
)-1)

	)

26 
	#F32Max
 
FLT_MAX


	)

27 
	#F32Mö
 -
FLT_MAX


	)

29 
	#PI32
 3.14159265359f

	)

31 
	#Kûobyãs
(
VÆue
Ë((VÆue)*1024LL)

	)

32 
	#Megabyãs
(
VÆue
Ë(
	`Kûobyãs
(VÆue)*1024LL)

	)

33 
	#Gigabyãs
(
VÆue
Ë(
	`Megabyãs
(VÆue)*1024LL)

	)

34 
	#Tîabyãs
(
VÆue
Ë(
	`Gigabyãs
(VÆue)*1024LL)

	)

36 
	#AºayCou¡
(
Aºay
Ë((AºayË/ ((Aºay)[0]))

	)

38 #i‡
DEBUG_ASSERT


39 
	#As£π
(
Ex¥essi⁄
Ëif(!(Ex¥essi⁄)Ë{*(vﬁ©ûê*)0 = 0;}

	)

41 
	#As£π
(
Ex¥essi⁄
)

	)

	@camera.cpp

1 
	sCamîa
 {

2 
Vec3
 
	mposôi⁄
;

3 
Qu©
 
	mrŸ©i⁄
;

4 
	mfov
;

5 
	m√¨_˛ù
;

6 
	mÁr_˛ù
;

7 
	ma•e˘_øtio
;

10 
FPC⁄åﬁInfo


11 
	$DeÁu…FPC⁄åﬁInfo
() {

12 
FPC⁄åﬁInfo
 
ªsu…
 = {};

13 
ªsu…
.
ba£_£ns
 = 1.0f;

14 
ªsu…
.
å™s_£ns
 = 1.0f;

15 
ªsu…
.
rŸ_£ns
 = 1.0f;

16  
ªsu…
;

17 
	}
}

19 
Camîa
*

20 
	$DeÁu…Camîa
(
WödowDimísi⁄s
 
wd
, 
Mem‹yAª«
* 
¨ía
) {

21 
Camîa
* 
ˇm
 = 
	`PushSåu˘
(
¨ía
, Camera);

22 
ˇm
->
posôi⁄
 = 
	`V3Z
();

23 
ˇm
->
rŸ©i⁄
 = 
	`Qu©I
();

24 
ˇm
->
fov
 = 90.0f;

25 
ˇm
->
√¨_˛ù
 = 0.1f;

26 
ˇm
->
Ár_˛ù
 = 1000.0f;

27 
ˇm
->
a•e˘_øtio
 = ()
wd
.
width
/()wd.
height
;

28  
ˇm
;

29 
	}
}

32 
	$CamîaDøwDebugText
(
Camîa
* 
ˇm
, 
DebugText
* 
dt
, 
Mem‹yAª«
* 
¨ía
) {

33 
	`DøwDebugText
("CAMERA INFO", 
YELLOW
, 
QUADRANT_TOP_LEFT
, 
dt
, 
¨ía
);

35 * 
ch¨_°rög
 = 
	`PushAºay
(
¨ía
, , 100);

36 
	`°b•_•rötf
(
ch¨_°rög
, "Posôi⁄: %.2f, %.2f, %.2f", 
ˇm
->
posôi⁄
.
x
, cam->posôi⁄.
y
, cam->posôi⁄.
z
);

37 
	`DøwDebugText
(
ch¨_°rög
, 
WHITE
, 
QUADRANT_TOP_LEFT
, 
dt
, 
¨ía
);

40 * 
ch¨_°rög
 = 
	`PushAºay
(
¨ía
, , 100);

41 
Vec3
 
euÀr
 = 
	`EuÀrFromQu©
(
ˇm
->
rŸ©i⁄
);

42 
	`°b•_•rötf
(
ch¨_°rög
, "RŸ©i⁄: %.2f, %.2f, %.2f", 
	`RadToDeg
(
euÀr
.
x
), RadToDeg”uÀr.
y
), RadToDeg”uÀr.
z
));

48 
	`DøwDebugText
(
ch¨_°rög
, 
WHITE
, 
QUADRANT_TOP_LEFT
, 
dt
, 
¨ía
);

51 * 
ch¨_°rög
 = 
	`PushAºay
(
¨ía
, , 100);

52 
	`°b•_•rötf
(
ch¨_°rög
, "FOV: %.2f", 
ˇm
->
fov
);

53 
	`DøwDebugText
(
ch¨_°rög
, 
WHITE
, 
QUADRANT_TOP_LEFT
, 
dt
, 
¨ía
);

56 * 
ch¨_°rög
 = 
	`PushAºay
(
¨ía
, , 100);

57 
	`°b•_•rötf
(
ch¨_°rög
, "A•e˘ R©i⁄: %.2f", 
ˇm
->
a•e˘_øtio
);

58 
	`DøwDebugText
(
ch¨_°rög
, 
WHITE
, 
QUADRANT_TOP_LEFT
, 
dt
, 
¨ía
);

60 
	}
}

62 
M©4


63 
	$MakeVõwPî•e˘ive
(
Camîa
* 
ˇmîa
) {

64 
M©4
 
ªsu…
 = 
	`M4I
();

65 
M©4
 
å™¶©i⁄
 = 
	`M4Tøn¶©e
(
	`V3Neg
(
ˇmîa
->
posôi⁄
));

75 
M©4
 
rŸ
 = 
	`M4FromQu©
(
ˇmîa
->
rŸ©i⁄
);

76 
M©4
 
võw
 = 
	`M4Mul
(
	`M4Tøn•o£
(
rŸ
), 
å™¶©i⁄
);

77 
M©4
 
≥r•e˘ive
 = 
	`M4Pî•e˘ive
(
ˇmîa
->
fov
, camîa->
a•e˘_øtio
, camîa->
√¨_˛ù
, camîa->
Ár_˛ù
);

78 
ªsu…
 = 
	`M4Mul
(
≥r•e˘ive
, 
võw
);

79  
ªsu…
;

80 
	}
}

83 
	$Fú°Pîs⁄Camîa
(
Camîa
* 
ˇmîa
, 
FPC⁄åﬁInfo
* 
Âci
, 
I≈ut
* 
öput
) {

84 
	`Fú°Pîs⁄C⁄åﬁ
(&
ˇmîa
->
posôi⁄
, &ˇmîa->
rŸ©i⁄
, 
åue
, 
Âci
, 
öput
);

85 
	}
}

	@file_formats.h

1 
	eSTRING_LENGTH
 {

2 
	mSTRING_LENGTH_BLOB
 = 12,

3 
	mSTRING_LENGTH_VERTEX_BUFFER
 = 12,

4 
	mSTRING_LENGTH_MESH
 = 12,

5 
	mSTRING_LENGTH_TEXTURE
 = 12,

6 
	mSTRING_LENGTH_TEXTURE_TYPE
 = 12,

7 
	mSTRING_LENGTH_FONT
 = 12,

10 
	eASSET_BLOB
 {

11 
	mASSET_BLOB_MESHES
,

12 
	mASSET_BLOB_TEXTURES
,

13 
	mASSET_BLOB_FONTS
,

14 
	mASSET_BLOB_TOTAL


17 * 
	gblob_«mes
[
ASSET_BLOB_TOTAL
] = {

23 * 
	gvîãx_buf„r_«mes
[
VERTEX_BUFFER_TOTAL
] = {

32 * 
	gãxtuª_ty≥_«mes
[
TEXTURE_SLOT_TOTAL
] = {

38 
	sGameAs£tFûe
 {

39 
	midítifiˇti⁄
[5];

40 
u8
 
	mnumbî_of_blobs
;

41 
u32
 
	moff£t_to_blob_dúe˘‹õs
;

44 
	sDúe˘‹y
 {

45 
u32
 
	moff£t_to_blob
;

46 
	m«me_of_blob
[
STRING_LENGTH_BLOB
];

49 
	sMeshesBlob
 {

50 
u32
 
	mmeshes_cou¡
;

51 
u32
 
	moff£t_to_mesh_f‹m©s
;

54 
	sTextuªsBlob
 {

55 
u32
 
	mãxtuªs_cou¡
;

56 
u32
 
	moff£t_to_ãxtuª_f‹m©s
;

59 
	sF⁄tsBlob
 {

60 
u32
 
	mf⁄ts_cou¡
;

61 
u32
 
	moff£t_to_f⁄t_f‹m©s
;

64 
	sVîãxBuf„rF‹m©
 {

65 
	mty≥
[
STRING_LENGTH_VERTEX_BUFFER
];

66 
u32
 
	moff£t_to_d©a
;

69 
	sMeshF‹m©
 {

70 
	m«me
[
STRING_LENGTH_MESH
];

71 
u8
 
	mvîãx_buf„r_cou¡
;

72 
u32
 
	mvîti˚s_cou¡
;

73 
u32
 
	mödi˚s_cou¡
;

74 
u32
 
	moff£t_to_ödi˚s
;

75 
u32
 
	moff£t_to_vîãx_buf„rs
;

78 
	sTextuªF‹m©
 {

79 
	m«me
[
STRING_LENGTH_TEXTURE
];

80 
	mty≥
[
STRING_LENGTH_TEXTURE_TYPE
];

81 
u32
 
	mwidth
;

82 
u32
 
	mheight
;

83 
u32
 
	mnum_comp⁄íts
;

84 
u32
 
	moff£t_to_d©a
;

87 
	sF⁄tF‹m©
 {

88 
	m«me
[
STRING_LENGTH_FONT
];

89 
u32
 
	moff£t_to_d©a
;

	@font_handling.cpp

1 
	~"f⁄t_h™dlög.h
"

4 
	$CompûeDebugTextShadî
(
DebugText
* 
debug_ãxt
, 
Rídîî
* 
ªndîî
) {

5 
VîãxShadîCode
[] = 
R
"FOO(

8 
	sGlyph
 {

9 
Êﬂt2
 
pos0
;

10 
Êﬂt2
 
pos1
;

11 
Êﬂt2
 
uv0
;

12 
Êﬂt2
 
uv1
;

13 
Êﬂt3
 
cﬁ‹
;

16 
Såu˘uªdBuf„r
<
Glyph
> 
glyph
 : (
t0
);

18 
	sps
 {

19 
Êﬂt4
 
pixñ_pos
 : 
SV_POSITION
;

20 
Êﬂt2
 
ãxco‹d
 : 
TEXCOORD
;

21 
Êﬂt3
 
cﬁ‹
 : 
COLOR
;

24 
	`m≠
(
vÆue
, 
mö1
, 
max1
, 
mö2
, 
max2
) {

27 
≥rc
 = (
vÆue
 - 
mö1
Ë/ (
max1
 - min1);

30 
föÆ
 = 
≥rc
 * (
max2
 - 
mö2
) + min2;

31  
föÆ
;

34 
ps
 
	`vsf
(
ö
 
uöt
 
vît_id
 : 
SV_VîãxID
) {

35 
ps
 
ouçut
;

39 
ödex
 = 
vît_id
/6;

42 
pos0x
 = 
glyph
[
ödex
].
pos0
.
x
;

43 
pos0y
 = 
glyph
[
ödex
].
pos0
.
y
;

44 
xoff
 = 
glyph
[
ödex
].
pos1
.
x
 - 
pos0x
;

45 
yoff
 = 
glyph
[
ödex
].
pos1
.
y
 - 
pos0y
;

46 
Êﬂt2
 
uv0
 = 
glyph
[
ödex
].uv0;

47 
Êﬂt2
 
uv1
 = 
glyph
[
ödex
].uv1;

48 
zvÆ
 = 1.0f;

50 
Êﬂt2
 
t›_À·
 = 
	`Êﬂt2
(
pos0x
, 
pos0y
);

51 
Êﬂt2
 
t›_right
 = 
	`Êﬂt2
(
pos0x
+
xoff
, 
pos0y
);

52 
Êﬂt2
 
bŸtom_right
 = 
	`Êﬂt2
(
pos0x
+
xoff
, 
pos0y
+
yoff
);

53 
Êﬂt2
 
bŸtom_À·
 = 
	`Êﬂt2
(
pos0x
, 
pos0y
+
yoff
);

55 
t›_À·
 = 
	`Êﬂt2
(
	`m≠
—›_À·.
x
, 0, 1, -1, 1), m≠—›_À·.
y
, 0, 1, 1, -1));

56 
t›_right
 = 
	`Êﬂt2
(
	`m≠
—›_right.
x
, 0, 1, -1, 1), m≠—›_right.
y
, 0, 1, 1, -1));

57 
bŸtom_right
 = 
	`Êﬂt2
(
	`m≠
(bŸtom_right.
x
, 0, 1, -1, 1), m≠(bŸtom_right.
y
, 0, 1, 1, -1));

58 
bŸtom_À·
 = 
	`Êﬂt2
(
	`m≠
(bŸtom_À·.
x
, 0, 1, -1, 1), m≠(bŸtom_À·.
y
, 0, 1, 1, -1));

60 
vît_cou¡
 = 
vît_id
 % 6;

62 if(
vît_cou¡
 == 0) {

63 
ouçut
.
pixñ_pos
 = 
	`Êﬂt4
(
t›_À·
, 
zvÆ
, zval);

64 
ouçut
.
ãxco‹d
 = 
uv0
;

66 if(
vît_cou¡
 == 1) {

67 
ouçut
.
pixñ_pos
 = 
	`Êﬂt4
(
bŸtom_À·
, 
zvÆ
, zval);

68 
ouçut
.
ãxco‹d
 = 
	`Êﬂt2
(
uv0
.
x
, 
uv1
.
y
);

70 if(
vît_cou¡
 == 2) {

71 
ouçut
.
pixñ_pos
 = 
	`Êﬂt4
(
bŸtom_right
, 
zvÆ
, zval);

72 
ouçut
.
ãxco‹d
 = 
uv1
;

74 if(
vît_cou¡
 == 3) {

75 
ouçut
.
pixñ_pos
 = 
	`Êﬂt4
(
bŸtom_right
, 
zvÆ
, zval);

76 
ouçut
.
ãxco‹d
 = 
uv1
;

78 if(
vît_cou¡
 == 4) {

79 
ouçut
.
pixñ_pos
 = 
	`Êﬂt4
(
t›_right
, 
zvÆ
, zval);

80 
ouçut
.
ãxco‹d
 = 
	`Êﬂt2
(
uv1
.
x
, 
uv0
.
y
);

82 if(
vît_cou¡
 == 5) {

83 
ouçut
.
pixñ_pos
 = 
	`Êﬂt4
(
t›_À·
, 
zvÆ
, zval);

84 
ouçut
.
ãxco‹d
 = 
uv0
;

87 
ouçut
.
cﬁ‹
 = 
glyph
[
ödex
].color;

88  
ouçut
;

90 )
FOO
";

92 
PixñShadîCode
[] = 
R
"FOO(

94 
	sps
 {

95 
Êﬂt4
 
pixñ_pos
 : 
SV_POSITION
;

96 
Êﬂt2
 
ãxco‹d
 : 
TEXCOORD
;

97 
Êﬂt3
 
cﬁ‹
 : 
COLOR
;

100 
Textuª2D
 
©œs
 : (
t0
);

101 
Sam∂îSèã
 
ãxtuª_ßm∂î
 : (
s0
);

103 
Êﬂt4
 
	`psf
(
ps
 
öput
Ë: 
SV_TARGET
 {

104 
Êﬂt3
 
ãx
 = 
©œs
.
	`Sam∂e
(
ãxtuª_ßm∂î
, 
öput
.
ãxco‹d
).
xyz
;

105 if(
ãx
.
r
 =0.0Ë
disˇrd
;

106 
ãx
 = 
öput
.
cﬁ‹
;

107  
	`Êﬂt4
(
ãx
, 1.0f);

110 )
FOO
";

112 
VîãxShadîDesc
 
vs_desc
 = {};

113 
vs_desc
.
shadî
.
code
 = 
VîãxShadîCode
;

114 
vs_desc
.
shadî
.
size
 = (
VîãxShadîCode
);

115 
vs_desc
.
shadî
.
íåy
 = "vsf";

117 
Såu˘uªdBuf„rDesc
 
sb_desc
[] = { { 
STRUCTURED_BINDING_SLOT_FRAME
, (
GlyphQuad
), 
MAX_DEBUG_TEXT_GLYPHS
 } };

118 
vs_desc
.
sb_desc
 = sb_desc;

119 
vs_desc
.
sb_cou¡
 = 1;

121 
debug_ãxt
->
vîãx_shadî
 = 
	`U∂ﬂdVîãxShadî
(
vs_desc
, 
ªndîî
);

123 
PixñShadîDesc
 
ps_desc
 = {};

124 
ps_desc
.
shadî
.
code
 = 
PixñShadîCode
;

125 
ps_desc
.
shadî
.
size
 = (
PixñShadîCode
);

126 
ps_desc
.
shadî
.
íåy
 = "psf";

128 
TEXTURE_SLOT
 
ãxtuª_¶Ÿ
[] = { 
TEXTURE_SLOT_DIFFUSE
 };

129 
ps_desc
.
ãxtuª_¶Ÿ
 =Åexture_slot;

130 
ps_desc
.
ãxtuª_cou¡
 = 
	`AºayCou¡
(
ãxtuª_¶Ÿ
);;

132 
debug_ãxt
->
pixñ_shadî
 = 
	`U∂ﬂdPixñShadî
(
ps_desc
, 
ªndîî
);

134 
	}
}

136 
DebugText
*

137 
	$InôDebugText
(
Pœtf‹mAPI
* 
∂©f‹m_≠i
, 
Rídîî
* 
ªndîî
, 
Mem‹yAª«
* 
¨ía
) {

138 
DebugText
* 
dt
 = 
	`PushSåu˘
(
¨ía
, DebugText);

140 
Pœtf‹mFûeInfo
 
öfo
 = {};

141 * 
öfo_∑th
 = "../assets/fonts/JetBrainsMono/jetbrains_mono_light.fi";

142 * 
image_∑th
 = "../assets/fonts/JetBrainsMono/jetbrains_mono_light.png";

143 
öfo
.
«me
 = 
öfo_∑th
;

144 
Pœtf‹mFûeH™dÀ
 
h™dÀ
 = 
∂©f‹m_≠i
->
	`›í_fûe
(&
öfo
);

145 
	`As£π
(!
h™dÀ
.
Áûed
);

147 
∂©f‹m_≠i
->
	`ªad_fûe
(&
h™dÀ
, (
F⁄tInfo
), &
dt
->
öfo
);

149 
dt
->
ãxtuª_©œs
 = 
	`U∂ﬂdTextuªFromFûe
(
image_∑th
, 
TEXTURE_SLOT_DIFFUSE
, 
ªndîî
);

151 
	`CompûeDebugTextShadî
(
dt
, 
ªndîî
);

153  
dt
;

154 
	}
}

157 
GlyphQuad
 
	$MakeGlyphQuad
(
PackedCh¨
 *
pc
, 
pw
, 
ph
, *
xpos
, *
ypos
)

159 
GlyphQuad
 
q
 = {};

160 
ùw
 = 1.0‡/ 
pw
, 
ùh
 = 1.0‡/ 
ph
;

161 
PackedCh¨
* 
b
 = 
pc
;

172 
q
.
x0
 = *
xpos
 + 
b
->
xoff
;

173 
q
.
y0
 = *
ypos
 + 
b
->
yoff
;

174 
q
.
x1
 = *
xpos
 + 
b
->
xoff2
;

175 
q
.
y1
 = *
ypos
 + 
b
->
yoff2
;

177 
q
.
u0
 = 
b
->
x0
 * 
ùw
;

178 
q
.
v0
 = 
b
->
y0
 * 
ùh
;

179 
q
.
u1
 = 
b
->
x1
 * 
ùw
;

180 
q
.
v1
 = 
b
->
y1
 * 
ùh
;

182 *
xpos
 +
b
->
xadv™˚
;

184  
q
;

185 
	}
}

187 
	$BegöDebugText
(
DebugText
* 
dt
, 
WödowDimísi⁄s
 
wd
) {

188 
dt
->
glyph_cou¡î
 = 0;

189 
dt
->
w
 = 
wd
.
width
;

190 
dt
->
h
 = 
wd
.
height
;

191 
dt
->
löe_cou¡
[
QUADRANT_TOP_LEFT
] = 0;

192 
dt
->
löe_cou¡
[
QUADRANT_TOP_RIGHT
] = 0;

193 
dt
->
löe_cou¡
[
QUADRANT_BOTTOM_LEFT
] = 0;

194 
dt
->
löe_cou¡
[
QUADRANT_BOTTOM_RIGHT
] = 0;

195 
	}
};

197 
	$Gíî©eGlyphsT›Le·
(* 
ãxt
, 
Àn
, 
Vec3
 
cﬁ‹
, 
GlyphQuad
* 
gq
, * 
x
, * 
y
, 
DebugText
* 
dt
) {

198 
i
=0; i<=
Àn
; i++) {

199 
u8
 
glyph_ödex
 = 
ãxt
[
i
] - 0x20;

200 
PackedCh¨
 
pc
 = 
dt
->
öfo
.pc[
glyph_ödex
];

202 
gq
[
i
] = 
	`MakeGlyphQuad
(&
pc
, 
dt
->
öfo
.
bôm≠_w
, dt->öfo.
bôm≠_h
, 
x
, 
y
);

204 
gq
[
i
].
x0
 = (gq[i].x0 * 0.35f);

205 
gq
[
i
].
y0
 = (gq[i].y0 * 0.35f);

206 
gq
[
i
].
x1
 = (gq[i].x1 * 0.35f);

207 
gq
[
i
].
y1
 = (gq[i].y1 * 0.35f);

209 
gq
[
i
].
cﬁ‹
 = color;

211 
	}
}

213 
	$PushGlyph
(
GlyphQuad
 
gq
, 
DebugText
* 
dt
) {

214 
dt
->
glyphs
[dt->
glyph_cou¡î
++] = 
gq
;

215 
	}
};

218 
	$DøwDebugText
(* 
ãxt
, 
Vec3
 
cﬁ‹
, 
QUADRANT
 
quad
, 
DebugText
* 
dt
, 
Mem‹yAª«
* 
¨ía
) {

219 
	`as£π
(
ãxt
);

220 
Àn
 = 
	`SåögLígth
(
ãxt
);

221 
x
, 
y
;

222 
x
 = 0.0f;

223 
f⁄t_löe_width
 = 
dt
->
öfo
.
as˚¡
 - dt->öfo.
des˚¡
 + dt->öfo.
löe_g≠
;

224 
GlyphQuad
* 
gq
 = 
	`PushAºay
(
¨ía
, GlyphQuad, 
Àn
);

225 
löe_width
 = (
dt
->
löe_cou¡
[
quad
] + 1Ë* 
f⁄t_löe_width
 * 0.8f;

227 
quad
) {

228 
QUADRANT_TOP_LEFT
: {

229 
y
 = 
löe_width
;

230 
	`Gíî©eGlyphsT›Le·
(
ãxt
, 
Àn
, 
cﬁ‹
, 
gq
, &
x
, &
y
, 
dt
);

231 
u8
 
i
=0; i<=
Àn
; i++) {

232 
gq
[
i
].
x0
 /
dt
->
w
;

233 
gq
[
i
].
y0
 /
dt
->
h
;

234 
gq
[
i
].
x1
 /
dt
->
w
;

235 
gq
[
i
].
y1
 /
dt
->
h
;

237 
	`PushGlyph
(
gq
[
i
], 
dt
);

241 
QUADRANT_TOP_RIGHT
: {

242 
y
 = 
löe_width
;

243 
	`Gíî©eGlyphsT›Le·
(
ãxt
, 
Àn
, 
cﬁ‹
, 
gq
, &
x
, &
y
, 
dt
);

244 
xpos
 = 
dt
->
w
 - 
gq
[
Àn
].
x1
;

246 
i
=0; i<=
Àn
; i++) {

247 
gq
[
i
].
x0
 = (gq[i].x0 + 
xpos
)/
dt
->
w
;

248 
gq
[
i
].
x1
 = (gq[i].x1 + 
xpos
)/
dt
->
w
;

249 
gq
[
i
].
y0
 = gq[i].y0/
dt
->
h
;

250 
gq
[
i
].
y1
 = gq[i].y1/
dt
->
h
;

252 
	`PushGlyph
(
gq
[
i
], 
dt
);

256 
QUADRANT_BOTTOM_LEFT
: {

257 
y
 = 
löe_width
;

258 
	`Gíî©eGlyphsT›Le·
(
ãxt
, 
Àn
, 
cﬁ‹
, 
gq
, &
x
, &
y
, 
dt
);

259 
ypos
 = 
dt
->
h
 - 
gq
[
Àn
].
y1
*(dt->
löe_cou¡
[
quad
]+1);

260 
u8
 
i
=0; i<=
Àn
; i++) {

261 
gq
[
i
].
x0
 /
dt
->
w
;

262 
gq
[
i
].
x1
 /
dt
->
w
;

263 
gq
[
i
].
y0
 = (gq[i].y0 + 
ypos
)/
dt
->
h
;

264 
gq
[
i
].
y1
 = (gq[i].y1 + 
ypos
)/
dt
->
h
;

266 
	`PushGlyph
(
gq
[
i
], 
dt
);

270 
QUADRANT_BOTTOM_RIGHT
: {

271 
y
 = 
löe_width
;

272 
	`Gíî©eGlyphsT›Le·
(
ãxt
, 
Àn
, 
cﬁ‹
, 
gq
, &
x
, &
y
, 
dt
);

273 
xpos
 = 
dt
->
w
 - 
gq
[
Àn
].
x1
;

274 
ypos
 = 
dt
->
h
 - 
gq
[
Àn
].
y1
*(dt->
löe_cou¡
[
quad
]+1);

275 
u8
 
i
=0; i<=
Àn
; i++) {

276 
gq
[
i
].
x0
 = (gq[i].x0 + 
xpos
)/
dt
->
w
;

277 
gq
[
i
].
x1
 = (gq[i].x1 + 
xpos
)/
dt
->
w
;

278 
gq
[
i
].
y0
 = (gq[i].y0 + 
ypos
)/
dt
->
h
;

279 
gq
[
i
].
y1
 = (gq[i].y1 + 
ypos
)/
dt
->
h
;

281 
	`PushGlyph
(
gq
[
i
], 
dt
);

286 
dt
->
löe_cou¡
[
quad
]++;

287 
	`P›Aºay
(
¨ía
, 
GlyphQuad
, 
Àn
);

288 
	}
};

290 
	$SubmôDebugTextDøwCÆl
(
DebugText
* 
dt
, 
Rídîî
* 
ªndîî
) {

291 
RídîPùñöe
 
Ω
 = {};

293 
Ω
.
rs
 = 
	`RídîSèãDeÁu…s
();

294 
Ω
.
rs
.
comm™d
 = 
RENDER_COMMAND_CLEAR_DEPTH_STENCIL
;

295 
Ω
.
vs
 = 
dt
->
vîãx_shadî
;

296 
Ω
.
ps
 = 
dt
->
pixñ_shadî
;

297 
Ω
.
dc
.
ty≥
 = 
DRAW_CALL_VERTICES
;

298 
Ω
.
dc
.
vîti˚s_cou¡
 = 6 * 
dt
->
glyph_cou¡î
;

299 
Ω
.
¥bg
 = 
dt
->
ãxtuª_©œs
;

300 
Ω
.
vrbd_cou¡
 = 1;

301 
Ω
.
vrbd
 = 
	`PushSåu˘
(&
ªndîî
->
å™sõ¡
, 
PushRídîBuf„rD©a
);

302 
Ω
.
vrbd
->
ty≥
 = 
RENDER_BUFFER_TYPE_STRUCTURED
;

303 
Ω
.
vrbd
->
°ru˘uªd
.
¶Ÿ
 = 
STRUCTURED_BINDING_SLOT_FRAME
;

304 
Ω
.
vrbd
->
°ru˘uªd
.
d©a
 = 
dt
->
glyphs
;

305 
Ω
.
vrbd
->
°ru˘uªd
.
cou¡
 = 
dt
->
glyph_cou¡î
;

307 
	`AddToRídîQueue
(
Ω
, 
ªndîî
);

308 
	}
}

	@font_handling.h

1 
	#MAX_DEBUG_TEXT_GLYPHS
 1000

	)

3 
	eQUADRANT
 {

4 
	mQUADRANT_TOP_LEFT
,

5 
	mQUADRANT_TOP_RIGHT
,

6 
	mQUADRANT_BOTTOM_LEFT
,

7 
	mQUADRANT_BOTTOM_RIGHT
,

8 
	mQUADRANT_TOTAL


11 
	sPackedCh¨
 {

12 
u16
 
	mx0
, 
	my0
, 
	mx1
, 
	my1
;

13 
	mxoff
, 
	myoff
, 
	mxadv™˚
;

14 
	mxoff2
, 
	myoff2
;

17 
	#FONT_CHARS_TOTAL
 (0x7E - 0x20)

	)

19 
	sF⁄tInfo
 {

20 
u16
 
	mheight_of_ch¨_ö_bôm≠
;

21 
u16
 
	mbôm≠_w
, 
	mbôm≠_h
;

22 
	mas˚¡
, 
	mdes˚¡
, 
	mlöe_g≠
, 
	mba£löe
;

23 
PackedCh¨
 
	mpc
[
FONT_CHARS_TOTAL
];

26 
	sGlyphQuad
 {

27 
	mx0
, 
	my0
;

28 
	mx1
, 
	my1
;

29 
	mu0
, 
	mv0
;

30 
	mu1
, 
	mv1
;

31 
Vec3
 
	mcﬁ‹
;

34 
	sDebugText
 {

35 
F⁄tInfo
 
	möfo
;

36 
u32
 
	mw
, 
	mh
;

37 
GlyphQuad
 
	mglyphs
[
MAX_DEBUG_TEXT_GLYPHS
];

38 
u32
 
	mglyph_cou¡î
;

39 
u8
 
	mlöe_cou¡
[
QUADRANT_TOTAL
];

41 
VîãxShadî
* 
	mvîãx_shadî
;

42 
PixñShadî
* 
	mpixñ_shadî
;

43 
RídîBuf„rGroup
* 
	mãxtuª_©œs
;

	@game.cpp

1 
	~<wödows.h
>

2 
	~<d3d11_1.h
>

3 
	~<dxgi1_4.h
>

4 
	~<d3dcompûî.h
>

6 
	#As£πHR
(
ªsu…
Ë
	`As£π
(‘esu…Ë=0)

	)

8 
	~"ba£_ty≥s.h
"

9 
	~"mem‹y_m™agemít.h
"

10 
	~"m©h.h
"

11 
	~"sh≠es.˝p
"

13 
	#STB_SPRINTF_IMPLEMENTATION


	)

14 
	#STB_IMAGE_IMPLEMENTATION


	)

16 
	~"ö˛ude/°b_•rötf.h
"

17 
	~"ö˛ude/°b_image.h
"

19 
	~"∂©f‹m_≠i.h
"

20 
	~"game_œyî.h
"

22 
	~"as£t_lﬂdög.˝p
"

23 
	~"ªndîî.˝p
"

25 
	~"as£t_öfo.˝p
"

27 
	~"f⁄t_h™dlög.˝p
"

28 
	~"simuœti⁄.h
"

29 
	~"simuœti⁄.˝p
"

30 
	~"ˇmîa.˝p
"

31 
	~"quad_ªndîî.˝p
"

32 
	~"mesh_ªndîî.˝p
"

34 
	~"ãåa.˝p
"

35 
	~"game.h
"

37 "C" 
	$GAME_INIT
(
game_öô
) {

39 
Pœtf‹mAPI
* 
∂©f‹m_≠i
 = 
game_œyî
->platform_api;

40 
Pœtf‹mMem‹yBlock
* 
memblock
 = 
∂©f‹m_≠i
->
	`Æloˇã_mem‹y
((
Game
Ë+ 
	`Megabyãs
(30));

42 
game_œyî
->
game
 = (
Game
*)
memblock
->
bp
;

43 
Game
* 
game
 = 
game_œyî
->game;

45 
game
->
≥rm™ít
.
mem‹y
.
bp
 = 
memblock
->bp;

46 
game
->
≥rm™ít
.
mem‹y
.
size
 = 
	`Megabyãs
(25);

47 
game
->
≥rm™ít
.
u£d
 = (
Game
);

49 
game
->
å™sõ¡
.
mem‹y
.
bp
 = 
memblock
->b∞+ 
	`Megabyãs
(25);

50 
game
->
å™sõ¡
.
mem‹y
.
size
 = 
	`Megabyãs
(5);

52 
As£tInfo
* 
as£t_öfo
 = 
	`InôAs£tInfo
(&
game
->
≥rm™ít
);

53 
game
->
as£t_öfo
 =ásset_info;

55 
GameAs£ts
* 
as£ts
 = 
	`InôGameAs£ts
(
∂©f‹m_≠i
, &
game
->
≥rm™ít
);

56 
game
->
as£ts
 =ássets;

58 
	`LﬂdAŒTextuªAs£ts
(
as£ts
, 
as£t_öfo
);

60 
Rídîî
* 
ªndîî
 = 
	`InôRídîî
(
wödow
, 
as£ts
, &
game
->
≥rm™ít
);

61 
game
->
ªndîî
 =Ñenderer;

63 
	`U∂ﬂdAŒTextuªAs£ts
(
as£t_öfo
, 
ªndîî
);

65 
game
->
debug_ãxt
 = 
	`InôDebugText
(
∂©f‹m_≠i
, 
ªndîî
, &game->
≥rm™ít
);

67 
game
->
ˇmîa
 = 
	`DeÁu…Camîa
(
wödow
->
dim
, &game->
≥rm™ít
);

69 
game
->
quad_ªndîî
 = 
	`InôQuadRídîî
(
ªndîî
, &game->
≥rm™ít
);

71 
game
->
mesh_ªndîî
 = 
	`InôMeshRídîî
(
ªndîî
, &game->
≥rm™ít
);

73 
game
->
ãåa
 = 
	`InôTëø
(
ªndîî
, &game->
≥rm™ít
);

74 
Tønsf‹m
 
å™sf‹m
 = 
	`Tønsf‹mI
();

75 
å™sf‹m
.
posôi⁄
 = 
	`V3
(5.0f, 0.0f, 0.0f);

76 
	`S∑wnTëø
(
game
->
ãåa
, 
	`Tønsf‹mI
(), 
	`V4FromV3
(
RED
, 0.5f));

77 
	`S∑wnTëø
(
game
->
ãåa
, 
å™sf‹m
, 
	`V4FromV3
(
GREEN
, 0.5f));

78 
	}
}

81 
	$GameBegö
(
Game
* 
game
, 
Wö32Wödow
* 
wödow
) {

83 
	`BegöDebugText
(
game
->
debug_ãxt
, 
wödow
->
dim
);

84 
	`RídîîBegöFøme
(
game
->
ªndîî
, 
wödow
->
dim
);

85 
	}
}

88 
	$GameEnd
(
Game
* 
game
) {

91 
	`RídîîFøme
(
game
->
ªndîî
);

92 
	`RídîîEndFøme
(
game
->
ªndîî
);

94 
game
->
å™sõ¡
.
u£d
 = 0;

95 
	}
}

97 "C" 
	$GAME_LOOP
(
game_lo›
) {

98 
Game
* 
game
 = 
game_œyî
->game;

99 
	`GameBegö
(
game
, 
wödow
);

101 if(
öput
->
buâ⁄s
[
WIN32_BUTTON_F2
].
¥es£d
) {

102 
game
->
ªndîî
->
°©e_ovîrides
.
rs
 ? game->ªndîî->°©e_ovîrides.r†
RASTERIZER_STATE_NONE
 :

103 
game
->
ªndîî
->
°©e_ovîrides
.
rs
 = 
RASTERIZER_STATE_WIREFRAME
;

105 if(
öput
->
buâ⁄s
[
WIN32_BUTTON_F1
].
¥es£d
) {

106 
game_œyî
->
debug_curs‹_ªque°
 = !game_layer->debug_cursor_request;

109 
FPC⁄åﬁInfo
 
öfo
 = 
	`DeÁu…FPC⁄åﬁInfo
();

110 
ögo
.
ba£_£ns
 = 0.5f;

111 
öfo
.
å™s_£ns
 = 10.0f;

112 
öfo
.
rŸ_£ns
 = 0.6f;

113 
	`Fú°Pîs⁄Camîa
(
game
->
ˇmîa
, &
öfo
, 
öput
);

115 
	`CamîaDøwDebugText
(
game
->
ˇmîa
, game->
debug_ãxt
, &game->
å™sõ¡
);

116 
Quad
 
quad
 = { 
	`V3
(5.0f, 5.0f, -8.5f), V3(5.0f, -5.0f, -8.5f),

117 
	`V3
(-5.0f, 5.0f, -8.5f), V3(-5.0f, -5.0f, -8.5f) };

118 
Quad
 
quad1
 = { 
	`V3
(5.0f, 5.0f, -5.5f), V3(5.0f, -5.0f, -5.5f),

119 
	`V3
(-5.0f, 5.0f, -5.5f),V3(-5.0f, -5.0f, -5.5f) };

121 
Löe
 
löe
 = { 
	`V3
(2.0f, 0.0f, 0.0f), V3(10.0f, 0.0f, 0.0f) };

123 
TextuªAs£tInfo
* 
ãxtuª_as£t
 = 
	`GëTextuªAs£tInfo
("BluêNebuœ", 
game
->
as£t_öfo
);

124 
TextuªAs£tInfo
* 
ãxtuª_as£t1
 = 
	`GëTextuªAs£tInfo
("Gªí Nebul", 
game
->
as£t_öfo
);

126 
	`PushTextuªdQuad
(&
quad
, 
ãxtuª_as£t
->
ªndî_buf„r
, 
game
->
quad_ªndîî
);

128 
	`PushRídîQuad
(&
quad1
, 
	`V4FromV3
(
BLUE
, 0.8f), 
game
->
quad_ªndîî
);

134 
	`Gíî©eTëøInfo
(
game
->
ãåa
);

136 if(
öput
->
buâ⁄s
[
WIN32_BUTTON_A
].
¥es£d
)

137 
	`DøwDebugText
("Pªs£d", 
WHITE
, 
QUADRANT_TOP_RIGHT
, 
game
->
debug_ãxt
, &game->
å™sõ¡
);

138 if(
öput
->
buâ⁄s
[
WIN32_BUTTON_A
].
hñd
)

139 
	`DøwDebugText
("Hñd", 
WHITE
, 
QUADRANT_TOP_RIGHT
, 
game
->
debug_ãxt
, &game->
å™sõ¡
);

141 
x
, 
y
, 
xdñ
, 
ydñ
;

142 
x
 = 
öput
->
axes
[
WIN32_AXIS_MOUSE
].x;

143 
y
 = 
öput
->
axes
[
WIN32_AXIS_MOUSE
].y;

144 
xdñ
 = 
öput
->
axes
[
WIN32_AXIS_MOUSE_DEL
].
x
;

145 
ydñ
 = 
öput
->
axes
[
WIN32_AXIS_MOUSE_DEL
].
y
;

147 *
a
, *
b
, *
c
, *
d
;

148 
a
 = (*)
	`GëMem‹y
(&
game
->
å™sõ¡
, 50);

149 
b
 = (*)
	`GëMem‹y
(&
game
->
å™sõ¡
, 50);

150 
c
 = (*)
	`GëMem‹y
(&
game
->
å™sõ¡
, 50);

151 
d
 = (*)
	`GëMem‹y
(&
game
->
å™sõ¡
, 50);

152 
	`°b•_•rötf
(
a
, "Mou£ x: %i", 
x
);

153 
	`°b•_•rötf
(
b
, "Mou£ y: %i", 
y
);

154 
	`°b•_•rötf
(
c
, "Mou£ xdñ: %i", 
xdñ
);

155 
	`°b•_•rötf
(
d
, "Mou£ ydñ: %i", 
ydñ
);

157 
	`DøwDebugText
(
a
, 
WHITE
, 
QUADRANT_TOP_RIGHT
, 
game
->
debug_ãxt
, &game->
å™sõ¡
);

158 
	`DøwDebugText
(
b
, 
WHITE
, 
QUADRANT_TOP_RIGHT
, 
game
->
debug_ãxt
, &game->
å™sõ¡
);

159 
	`DøwDebugText
(
c
, 
WHITE
, 
QUADRANT_TOP_RIGHT
, 
game
->
debug_ãxt
, &game->
å™sõ¡
);

160 
	`DøwDebugText
(
d
, 
WHITE
, 
QUADRANT_TOP_RIGHT
, 
game
->
debug_ãxt
, &game->
å™sõ¡
);

161 
	`DøwDebugText
("w‹kög", 
RED
, 
QUADRANT_BOTTOM_LEFT
, 
game
->
debug_ãxt
, &game->
å™sõ¡
);

165 
LightInfo
 
light
 = {};

166 
light
.
posôi⁄
 = 
	`V3
(0.2f, 3.0f, -4.0f);

167 
light
.
ambõn˚
 = 0.2f;

169 
	`RídîTëø
(
game
->
ãåa
, game->
mesh_ªndîî
);

170 
	`Upd©eTëø
(
game
->
ãåa
);

172 
	`MeshRídîîFøme
(
game
->
mesh_ªndîî
, game->
ˇmîa
, &
light
, game->
ªndîî
);

173 
	`QuadRídîîFøme
(
game
->
quad_ªndîî
, game->
ˇmîa
, game->
ªndîî
);

174 
	`SubmôDebugTextDøwCÆl
(
game
->
debug_ãxt
, game->
ªndîî
);

176 
	`GameEnd
(
game
);

177 
	}
}

	@game.h

1 
	sGame
 {

2 
Mem‹yAª«
 
	m≥rm™ít
;

3 
Mem‹yAª«
 
	må™sõ¡
;

5 
GameAs£ts
* 
	mas£ts
;

6 
As£tInfo
* 
	mas£t_öfo
;

7 
Rídîî
* 
	mªndîî
;

8 
QuadRídîî
* 
	mquad_ªndîî
;

9 
MeshRídîî
* 
	mmesh_ªndîî
;

10 
DebugText
* 
	mdebug_ãxt
;

11 
Camîa
* 
	mˇmîa
;

13 
Tëø
* 
	mãåa
;

	@game_layer.h

1 
	sGameLayî
 {

2 
Game
* 
	mgame
;

3 
Pœtf‹mAPI
* 
	m∂©f‹m_≠i
;

4 
boﬁ
 
	mquô_ªque°
;

5 
boﬁ
 
	mdebug_curs‹_ªque°
;

12 
	#GAME_INIT
(
«me
Ë
	`«me
(
GameLayî
* 
game_œyî
, 
Wö32Wödow
* 
wödow
)

	)

13 
GAME_INIT
(
	tGameInô
);

15 
	#GAME_LOOP
(
«me
Ë
	`«me
(
GameLayî
* 
game_œyî
, 
Wö32Wödow
* 
wödow
, 
I≈ut
* 
öput
)

	)

16 
GAME_LOOP
(
	tGameLo›
);

	@include/stb_image.h

126 #i‚de‡
STBI_INCLUDE_STB_IMAGE_H


127 
	#STBI_INCLUDE_STB_IMAGE_H


	)

367 #i‚de‡
STBI_NO_STDIO


368 
	~<°dio.h
>

371 
	#STBI_VERSION
 1

	)

375 
	mSTBI_deÁu…
 = 0,

377 
	mSTBI_gªy
 = 1,

378 
	mSTBI_gªy_Æpha
 = 2,

379 
	mSTBI_rgb
 = 3,

380 
	mSTBI_rgb_Æpha
 = 4

383 
	~<°dlib.h
>

384 
	t°bi_uc
;

385 
	t°bi_us
;

387 #ifde‡
__˝lu•lus


391 #i‚de‡
STBIDEF


392 #ifde‡
STB_IMAGE_STATIC


393 
	#STBIDEF
 

	)

395 
	#STBIDEF
 

	)

410 (*
ªad
Ë(*
u£r
,*
d©a
,
size
);

411 (*
skù
Ë(*
u£r
,
n
);

412 (*
eof
Ë(*
u£r
);

413 } 
	t°bi_io_ˇŒbacks
;

420 
STBIDEF
 
°bi_uc
 *
°bi_lﬂd_‰om_mem‹y
 (°bi_u¯c⁄° *
buf„r
, 
Àn
 , *
x
, *
y
, *
ch™√ls_ö_fûe
, 
desúed_ch™√ls
);

421 
STBIDEF
 
°bi_uc
 *
°bi_lﬂd_‰om_ˇŒbacks
(
°bi_io_ˇŒbacks
 c⁄° *
˛bk
 , *
u£r
, *
x
, *
y
, *
ch™√ls_ö_fûe
, 
desúed_ch™√ls
);

423 #i‚de‡
STBI_NO_STDIO


424 
STBIDEF
 
°bi_uc
 *
°bi_lﬂd
 (c⁄° *
fûíame
, *
x
, *
y
, *
ch™√ls_ö_fûe
, 
desúed_ch™√ls
);

425 
STBIDEF
 
°bi_uc
 *
°bi_lﬂd_‰om_fûe
 (
FILE
 *
f
, *
x
, *
y
, *
ch™√ls_ö_fûe
, 
desúed_ch™√ls
);

429 #i‚de‡
STBI_NO_GIF


430 
STBIDEF
 
°bi_uc
 *
°bi_lﬂd_gif_‰om_mem‹y
(°bi_u¯c⁄° *
buf„r
, 
Àn
, **
dñays
, *
x
, *
y
, *
z
, *
comp
, 
ªq_comp
);

433 #ifde‡
STBI_WINDOWS_UTF8


434 
STBIDEF
 
°bi_c⁄vît_wch¨_to_utf8
(*
buf„r
, 
size_t
 
buf„æí
, c⁄° 
wch¨_t
* 
öput
);

442 
STBIDEF
 
°bi_us
 *
°bi_lﬂd_16_‰om_mem‹y
 (
°bi_uc
 c⁄° *
buf„r
, 
Àn
, *
x
, *
y
, *
ch™√ls_ö_fûe
, 
desúed_ch™√ls
);

443 
STBIDEF
 
°bi_us
 *
°bi_lﬂd_16_‰om_ˇŒbacks
(
°bi_io_ˇŒbacks
 c⁄° *
˛bk
, *
u£r
, *
x
, *
y
, *
ch™√ls_ö_fûe
, 
desúed_ch™√ls
);

445 #i‚de‡
STBI_NO_STDIO


446 
STBIDEF
 
°bi_us
 *
°bi_lﬂd_16
 (c⁄° *
fûíame
, *
x
, *
y
, *
ch™√ls_ö_fûe
, 
desúed_ch™√ls
);

447 
STBIDEF
 
°bi_us
 *
°bi_lﬂd_‰om_fûe_16
(
FILE
 *
f
, *
x
, *
y
, *
ch™√ls_ö_fûe
, 
desúed_ch™√ls
);

454 #i‚de‡
STBI_NO_LINEAR


455 
STBIDEF
 *
°bi_lﬂdf_‰om_mem‹y
 (
°bi_uc
 c⁄° *
buf„r
, 
Àn
, *
x
, *
y
, *
ch™√ls_ö_fûe
, 
desúed_ch™√ls
);

456 
STBIDEF
 *
°bi_lﬂdf_‰om_ˇŒbacks
 (
°bi_io_ˇŒbacks
 c⁄° *
˛bk
, *
u£r
, *
x
, *
y
, *
ch™√ls_ö_fûe
, 
desúed_ch™√ls
);

458 #i‚de‡
STBI_NO_STDIO


459 
STBIDEF
 *
°bi_lﬂdf
 (c⁄° *
fûíame
, *
x
, *
y
, *
ch™√ls_ö_fûe
, 
desúed_ch™√ls
);

460 
STBIDEF
 *
°bi_lﬂdf_‰om_fûe
 (
FILE
 *
f
, *
x
, *
y
, *
ch™√ls_ö_fûe
, 
desúed_ch™√ls
);

464 #i‚de‡
STBI_NO_HDR


465 
STBIDEF
 
°bi_hdr_to_ldr_gamma
(
gamma
);

466 
STBIDEF
 
°bi_hdr_to_ldr_sˇÀ
(
sˇÀ
);

469 #i‚de‡
STBI_NO_LINEAR


470 
STBIDEF
 
°bi_ldr_to_hdr_gamma
(
gamma
);

471 
STBIDEF
 
°bi_ldr_to_hdr_sˇÀ
(
sˇÀ
);

475 
STBIDEF
 
°bi_is_hdr_‰om_ˇŒbacks
(
°bi_io_ˇŒbacks
 c⁄° *
˛bk
, *
u£r
);

476 
STBIDEF
 
°bi_is_hdr_‰om_mem‹y
(
°bi_uc
 c⁄° *
buf„r
, 
Àn
);

477 #i‚de‡
STBI_NO_STDIO


478 
STBIDEF
 
°bi_is_hdr
 (c⁄° *
fûíame
);

479 
STBIDEF
 
°bi_is_hdr_‰om_fûe
(
FILE
 *
f
);

485 
STBIDEF
 c⁄° *
°bi_Áûuª_ªas⁄
 ();

488 
STBIDEF
 
°bi_image_‰ì
 (*
ªtvÆ_‰om_°bi_lﬂd
);

491 
STBIDEF
 
°bi_öfo_‰om_mem‹y
(
°bi_uc
 c⁄° *
buf„r
, 
Àn
, *
x
, *
y
, *
comp
);

492 
STBIDEF
 
°bi_öfo_‰om_ˇŒbacks
(
°bi_io_ˇŒbacks
 c⁄° *
˛bk
, *
u£r
, *
x
, *
y
, *
comp
);

493 
STBIDEF
 
°bi_is_16_bô_‰om_mem‹y
(
°bi_uc
 c⁄° *
buf„r
, 
Àn
);

494 
STBIDEF
 
°bi_is_16_bô_‰om_ˇŒbacks
(
°bi_io_ˇŒbacks
 c⁄° *
˛bk
, *
u£r
);

496 #i‚de‡
STBI_NO_STDIO


497 
STBIDEF
 
°bi_öfo
 (c⁄° *
fûíame
, *
x
, *
y
, *
comp
);

498 
STBIDEF
 
°bi_öfo_‰om_fûe
 (
FILE
 *
f
, *
x
, *
y
, *
comp
);

499 
STBIDEF
 
°bi_is_16_bô
 (c⁄° *
fûíame
);

500 
STBIDEF
 
°bi_is_16_bô_‰om_fûe
(
FILE
 *
f
);

508 
STBIDEF
 
°bi_£t_u≈ªmu…ùly_⁄_lﬂd
(
Êag_åue_if_should_u≈ªmu…ùly
);

512 
STBIDEF
 
°bi_c⁄vît_ùh⁄e_≤g_to_rgb
(
Êag_åue_if_should_c⁄vît
);

515 
STBIDEF
 
°bi_£t_Êù_vîtiˇŒy_⁄_lﬂd
(
Êag_åue_if_should_Êù
);

520 
STBIDEF
 
°bi_£t_u≈ªmu…ùly_⁄_lﬂd_thªad
(
Êag_åue_if_should_u≈ªmu…ùly
);

521 
STBIDEF
 
°bi_c⁄vît_ùh⁄e_≤g_to_rgb_thªad
(
Êag_åue_if_should_c⁄vît
);

522 
STBIDEF
 
°bi_£t_Êù_vîtiˇŒy_⁄_lﬂd_thªad
(
Êag_åue_if_should_Êù
);

526 
STBIDEF
 *
°bi_zlib_decode_mÆloc_guesssize
(c⁄° *
buf„r
, 
Àn
, 
öôül_size
, *
ouéí
);

527 
STBIDEF
 *
°bi_zlib_decode_mÆloc_guesssize_hódîÊag
(c⁄° *
buf„r
, 
Àn
, 
öôül_size
, *
ouéí
, 
∑r£_hódî
);

528 
STBIDEF
 *
°bi_zlib_decode_mÆloc
(c⁄° *
buf„r
, 
Àn
, *
ouéí
);

529 
STBIDEF
 
°bi_zlib_decode_buf„r
(*
obuf„r
, 
ﬁí
, c⁄° *
ibuf„r
, 
ûí
);

531 
STBIDEF
 *
°bi_zlib_decode_nohódî_mÆloc
(c⁄° *
buf„r
, 
Àn
, *
ouéí
);

532 
STBIDEF
 
°bi_zlib_decode_nohódî_buf„r
(*
obuf„r
, 
ﬁí
, c⁄° *
ibuf„r
, 
ûí
);

535 #ifde‡
__˝lu•lus


544 #ifde‡
STB_IMAGE_IMPLEMENTATION


546 #i‡
deföed
(
STBI_ONLY_JPEG
Ë|| deföed(
STBI_ONLY_PNG
Ë|| deföed(
STBI_ONLY_BMP
) \

547 || 
deföed
(
STBI_ONLY_TGA
Ë|| deföed(
STBI_ONLY_GIF
Ë|| deföed(
STBI_ONLY_PSD
) \

548 || 
deföed
(
STBI_ONLY_HDR
Ë|| deföed(
STBI_ONLY_PIC
Ë|| deföed(
STBI_ONLY_PNM
) \

549 || 
	$deföed
(
STBI_ONLY_ZLIB
)

550 #i‚de‡
STBI_ONLY_JPEG


551 
	#STBI_NO_JPEG


	)

553 #i‚de‡
STBI_ONLY_PNG


554 
	#STBI_NO_PNG


	)

556 #i‚de‡
STBI_ONLY_BMP


557 
	#STBI_NO_BMP


	)

559 #i‚de‡
STBI_ONLY_PSD


560 
	#STBI_NO_PSD


	)

562 #i‚de‡
STBI_ONLY_TGA


563 
	#STBI_NO_TGA


	)

565 #i‚de‡
STBI_ONLY_GIF


566 
	#STBI_NO_GIF


	)

568 #i‚de‡
STBI_ONLY_HDR


569 
	#STBI_NO_HDR


	)

571 #i‚de‡
STBI_ONLY_PIC


572 
	#STBI_NO_PIC


	)

574 #i‚de‡
STBI_ONLY_PNM


575 
	#STBI_NO_PNM


	)

579 #i‡
	`deföed
(
STBI_NO_PNG
Ë&& !deföed(
STBI_SUPPORT_ZLIB
Ë&& !deföed(
STBI_NO_ZLIB
)

580 
	#STBI_NO_ZLIB


	)

584 
	~<°d¨g.h
>

585 
	~<°ddef.h
>

586 
	~<°dlib.h
>

587 
	~<°rög.h
>

588 
	~<limôs.h
>

590 #i‡!
	`deföed
(
STBI_NO_LINEAR
Ë|| !deföed(
STBI_NO_HDR
)

591 
	~<m©h.h
>

594 #i‚de‡
STBI_NO_STDIO


595 
	~<°dio.h
>

598 #i‚de‡
STBI_ASSERT


599 
	~<as£π.h
>

600 
	#STBI_ASSERT
(
x
Ë
	`as£π
(x)

	)

603 #ifde‡
__˝lu•lus


604 
	#STBI_EXTERN
 "C"

	)

606 
	#STBI_EXTERN
 

	)

610 #i‚de‡
_MSC_VER


611 #ifde‡
__˝lu•lus


612 
	#°bi_ölöe
 
ölöe


	)

614 
	#°bi_ölöe


	)

617 
	#°bi_ölöe
 
__f‹˚ölöe


	)

620 #i‚de‡
STBI_NO_THREAD_LOCALS


621 #i‡
	`deföed
(
__˝lu•lus
) && __cplusplus >= 201103L

622 
	#STBI_THREAD_LOCAL
 
thªad_loˇl


	)

623 #ñi‡
	`deföed
(
__GNUC__
) && __GNUC__ < 5

624 
	#STBI_THREAD_LOCAL
 
__thªad


	)

625 #ñi‡
	`deföed
(
_MSC_VER
)

626 
	#STBI_THREAD_LOCAL
 
	`__de˛•ec
(
thªad
)

	)

627 #ñi‡
	`deföed
 (
__STDC_VERSION__
Ë&& __STDC_VERSION__ >201112L && !deföed(
__STDC_NO_THREADS__
)

628 
	#STBI_THREAD_LOCAL
 
_Thªad_loˇl


	)

631 #i‚de‡
STBI_THREAD_LOCAL


632 #i‡
	`deföed
(
__GNUC__
)

633 
	#STBI_THREAD_LOCAL
 
__thªad


	)

638 #ifde‡
_MSC_VER


639 
	t°bi__uöt16
;

640 sig√d 
	t°bi__öt16
;

641 
	t°bi__uöt32
;

642 sig√d 
	t°bi__öt32
;

644 
	~<°döt.h
>

645 
uöt16_t
 
	t°bi__uöt16
;

646 
öt16_t
 
	t°bi__öt16
;

647 
uöt32_t
 
	t°bi__uöt32
;

648 
öt32_t
 
	t°bi__öt32
;

652 
	tvÆid©e_uöt32
[(
°bi__uöt32
)==4 ? 1 : -1];

654 #ifde‡
_MSC_VER


655 
	#STBI_NOTUSED
(
v
Ë()(v)

	)

657 
	#STBI_NOTUSED
(
v
Ë()(v)

	)

660 #ifde‡
_MSC_VER


661 
	#STBI_HAS_LROTL


	)

664 #ifde‡
STBI_HAS_LROTL


665 
	#°bi_ÃŸ
(
x
,
y
Ë
	`_ÃŸl
(x,y)

	)

667 
	#°bi_ÃŸ
(
x
,
y
Ë(((xË<< (y)Ë| ((xË>> (-(yË& 31)))

	)

670 #i‡
	`deföed
(
STBI_MALLOC
Ë&& deföed(
STBI_FREE
Ë&& (deföed(
STBI_REALLOC
Ë|| deföed(
STBI_REALLOC_SIZED
))

672 #ñi‡!
	`deföed
(
STBI_MALLOC
Ë&& !deföed(
STBI_FREE
Ë&& !deföed(
STBI_REALLOC
Ë&& !deföed(
STBI_REALLOC_SIZED
)

678 #i‚de‡
STBI_MALLOC


679 
	#STBI_MALLOC
(
sz
Ë
	`mÆloc
(sz)

	)

680 
	#STBI_REALLOC
(
p
,
√wsz
Ë
	`ªÆloc
’,√wsz)

	)

681 
	#STBI_FREE
(
p
Ë
	`‰ì
’)

	)

684 #i‚de‡
STBI_REALLOC_SIZED


685 
	#STBI_REALLOC_SIZED
(
p
,
ﬁdsz
,
√wsz
Ë
	`STBI_REALLOC
’,√wsz)

	)

689 #i‡
	`deföed
(
__x86_64__
Ë|| deföed(
_M_X64
)

690 
	#STBI__X64_TARGET


	)

691 #ñi‡
	`deföed
(
__i386
Ë|| deföed(
_M_IX86
)

692 
	#STBI__X86_TARGET


	)

695 #i‡
	`deföed
(
__GNUC__
Ë&& deföed(
STBI__X86_TARGET
Ë&& !deföed(
__SSE2__
Ë&& !deföed(
STBI_NO_SIMD
)

703 
	#STBI_NO_SIMD


	)

706 #i‡
	`deföed
(
__MINGW32__
Ë&& deföed(
STBI__X86_TARGET
Ë&& !deföed(
STBI_MINGW_ENABLE_SSE2
Ë&& !deföed(
STBI_NO_SIMD
)

718 
	#STBI_NO_SIMD


	)

721 #i‡!
	`deföed
(
STBI_NO_SIMD
Ë&& (deföed(
STBI__X86_TARGET
Ë|| deföed(
STBI__X64_TARGET
))

722 
	#STBI_SSE2


	)

723 
	~<emmöåö.h
>

725 #ifde‡
_MSC_VER


727 #i‡
_MSC_VER
 >= 1400

728 
	~<öåö.h
>

729 
	$°bi__˝uid3
()

731 
öfo
[4];

732 
	`__˝uid
(
öfo
,1);

733  
öfo
[3];

734 
	}
}

736 
	$°bi__˝uid3
()

738 
ªs
;

739 
__asm
 {

740 
mov
 
óx
,1

741 
˝uid


742 
mov
 
ªs
,
edx


744  
ªs
;

745 
	}
}

748 
	#STBI_SIMD_ALIGN
(
ty≥
, 
«me
Ë
	`__de˛•ec
(
	`Æign
(16)Ëty≥ 
	)
name

750 #i‡!
deföed
(
STBI_NO_JPEG
Ë&& deföed(
STBI_SSE2
)

751 
	$°bi__s£2_avaûabÀ
()

753 
öfo3
 = 
	`°bi__˝uid3
();

754  ((
öfo3
 >> 26) & 1) != 0;

755 
	}
}

759 
	#STBI_SIMD_ALIGN
(
ty≥
, 
«me
Ëty≥Çamê
	`__©åibuã__
((
	`Æig√d
(16)))

	)

761 #i‡!
deföed
(
STBI_NO_JPEG
Ë&& deföed(
STBI_SSE2
)

762 
	$°bi__s£2_avaûabÀ
()

768 
	}
}

775 #i‡
deföed
(
STBI_NO_SIMD
Ë&& deföed(
STBI_NEON
)

776 #unde‡
STBI_NEON


779 #ifde‡
STBI_NEON


780 
	~<¨m_√⁄.h
>

781 #ifde‡
_MSC_VER


782 
	#STBI_SIMD_ALIGN
(
ty≥
, 
«me
Ë
	`__de˛•ec
(
	`Æign
(16)Ëty≥ 
	)
name

784 
	#STBI_SIMD_ALIGN
(
ty≥
, 
«me
Ëty≥Çamê
	`__©åibuã__
((
	`Æig√d
(16)))

	)

788 #i‚de‡
STBI_SIMD_ALIGN


789 
	#STBI_SIMD_ALIGN
(
ty≥
, 
«me
Ëty≥ 
	)
name

792 #i‚de‡
STBI_MAX_DIMENSIONS


793 
	#STBI_MAX_DIMENSIONS
 (1 << 24)

	)

804 
°bi__uöt32
 
	mimg_x
, 
	mimg_y
;

805 
	mimg_n
, 
	mimg_out_n
;

807 
°bi_io_ˇŒbacks
 
	mio
;

808 *
	mio_u£r_d©a
;

810 
	mªad_‰om_ˇŒbacks
;

811 
	mbuÊí
;

812 
°bi_uc
 
	mbuf„r_°¨t
[128];

813 
	mˇŒback_Æªady_ªad
;

815 
°bi_uc
 *
	mimg_buf„r
, *
	mimg_buf„r_íd
;

816 
°bi_uc
 *
	mimg_buf„r_‹igöÆ
, *
	mimg_buf„r_‹igöÆ_íd
;

817 } 
	t°bi__c⁄ãxt
;

820 
°bi__ªfûl_buf„r
(
°bi__c⁄ãxt
 *
s
);

823 
	$°bi__°¨t_mem
(
°bi__c⁄ãxt
 *
s
, 
°bi_uc
 c⁄° *
buf„r
, 
Àn
)

825 
s
->
io
.
ªad
 = 
NULL
;

826 
s
->
ªad_‰om_ˇŒbacks
 = 0;

827 
s
->
ˇŒback_Æªady_ªad
 = 0;

828 
s
->
img_buf„r
 = s->
img_buf„r_‹igöÆ
 = (
°bi_uc
 *Ë
buf„r
;

829 
s
->
img_buf„r_íd
 = s->
img_buf„r_‹igöÆ_íd
 = (
°bi_uc
 *Ë
buf„r
+
Àn
;

830 
	}
}

833 
	$°bi__°¨t_ˇŒbacks
(
°bi__c⁄ãxt
 *
s
, 
°bi_io_ˇŒbacks
 *
c
, *
u£r
)

835 
s
->
io
 = *
c
;

836 
s
->
io_u£r_d©a
 = 
u£r
;

837 
s
->
buÊí
 = (s->
buf„r_°¨t
);

838 
s
->
ªad_‰om_ˇŒbacks
 = 1;

839 
s
->
ˇŒback_Æªady_ªad
 = 0;

840 
s
->
img_buf„r
 = s->
img_buf„r_‹igöÆ
 = s->
buf„r_°¨t
;

841 
	`°bi__ªfûl_buf„r
(
s
);

842 
s
->
img_buf„r_‹igöÆ_íd
 = s->
img_buf„r_íd
;

843 
	}
}

845 #i‚de‡
STBI_NO_STDIO


847 
	$°bi__°dio_ªad
(*
u£r
, *
d©a
, 
size
)

849  (Ë
	`‰ód
(
d©a
,1,
size
,(
FILE
*Ë
u£r
);

850 
	}
}

852 
	$°bi__°dio_skù
(*
u£r
, 
n
)

854 
ch
;

855 
	`f£ek
((
FILE
*Ë
u£r
, 
n
, 
SEEK_CUR
);

856 
ch
 = 
	`fgëc
((
FILE
*Ë
u£r
);

857 i‡(
ch
 !
EOF
) {

858 
	`ungëc
(
ch
, (
FILE
 *Ë
u£r
);

860 
	}
}

862 
	$°bi__°dio_eof
(*
u£r
)

864  
	`„of
((
FILE
*Ë
u£r
Ë|| 
	`„º‹
((FILE *) user);

865 
	}
}

867 
°bi_io_ˇŒbacks
 
	g°bi__°dio_ˇŒbacks
 =

869 
°bi__°dio_ªad
,

870 
°bi__°dio_skù
,

871 
°bi__°dio_eof
,

874 
	$°bi__°¨t_fûe
(
°bi__c⁄ãxt
 *
s
, 
FILE
 *
f
)

876 
	`°bi__°¨t_ˇŒbacks
(
s
, &
°bi__°dio_ˇŒbacks
, (*Ë
f
);

877 
	}
}

883 
	$°bi__ªwöd
(
°bi__c⁄ãxt
 *
s
)

888 
s
->
img_buf„r
 = s->
img_buf„r_‹igöÆ
;

889 
s
->
img_buf„r_íd
 = s->
img_buf„r_‹igöÆ_íd
;

890 
	}
}

894 
	mSTBI_ORDER_RGB
,

895 
	mSTBI_ORDER_BGR


900 
	mbôs_≥r_ch™√l
;

901 
	mnum_ch™√ls
;

902 
	mch™√l_‹dî
;

903 } 
	t°bi__ªsu…_öfo
;

905 #i‚de‡
STBI_NO_JPEG


906 
°bi__j≥g_ã°
(
°bi__c⁄ãxt
 *
s
);

907 *
°bi__j≥g_lﬂd
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
);

908 
°bi__j≥g_öfo
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
);

911 #i‚de‡
STBI_NO_PNG


912 
°bi__≤g_ã°
(
°bi__c⁄ãxt
 *
s
);

913 *
°bi__≤g_lﬂd
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
);

914 
°bi__≤g_öfo
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
);

915 
°bi__≤g_is16
(
°bi__c⁄ãxt
 *
s
);

918 #i‚de‡
STBI_NO_BMP


919 
°bi__bmp_ã°
(
°bi__c⁄ãxt
 *
s
);

920 *
°bi__bmp_lﬂd
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
);

921 
°bi__bmp_öfo
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
);

924 #i‚de‡
STBI_NO_TGA


925 
°bi__tga_ã°
(
°bi__c⁄ãxt
 *
s
);

926 *
°bi__tga_lﬂd
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
);

927 
°bi__tga_öfo
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
);

930 #i‚de‡
STBI_NO_PSD


931 
°bi__psd_ã°
(
°bi__c⁄ãxt
 *
s
);

932 *
°bi__psd_lﬂd
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
, 
bpc
);

933 
°bi__psd_öfo
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
);

934 
°bi__psd_is16
(
°bi__c⁄ãxt
 *
s
);

937 #i‚de‡
STBI_NO_HDR


938 
°bi__hdr_ã°
(
°bi__c⁄ãxt
 *
s
);

939 *
°bi__hdr_lﬂd
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
);

940 
°bi__hdr_öfo
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
);

943 #i‚de‡
STBI_NO_PIC


944 
°bi__pic_ã°
(
°bi__c⁄ãxt
 *
s
);

945 *
°bi__pic_lﬂd
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
);

946 
°bi__pic_öfo
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
);

949 #i‚de‡
STBI_NO_GIF


950 
°bi__gif_ã°
(
°bi__c⁄ãxt
 *
s
);

951 *
°bi__gif_lﬂd
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
);

952 *
°bi__lﬂd_gif_maö
(
°bi__c⁄ãxt
 *
s
, **
dñays
, *
x
, *
y
, *
z
, *
comp
, 
ªq_comp
);

953 
°bi__gif_öfo
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
);

956 #i‚de‡
STBI_NO_PNM


957 
°bi__≤m_ã°
(
°bi__c⁄ãxt
 *
s
);

958 *
°bi__≤m_lﬂd
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
);

959 
°bi__≤m_öfo
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
);

960 
°bi__≤m_is16
(
°bi__c⁄ãxt
 *
s
);

964 #ifde‡
STBI_THREAD_LOCAL


965 
	gSTBI_THREAD_LOCAL


967 c⁄° *
	g°bi__g_Áûuª_ªas⁄
;

969 
STBIDEF
 c⁄° *
	$°bi_Áûuª_ªas⁄
()

971  
°bi__g_Áûuª_ªas⁄
;

972 
	}
}

974 #i‚de‡
STBI_NO_FAILURE_STRINGS


975 
	$°bi__îr
(c⁄° *
°r
)

977 
°bi__g_Áûuª_ªas⁄
 = 
°r
;

979 
	}
}

982 *
	$°bi__mÆloc
(
size_t
 
size
)

984  
	`STBI_MALLOC
(
size
);

985 
	}
}

999 
	$°bi__addsizes_vÆid
(
a
, 
b
)

1001 i‡(
b
 < 0)  0;

1006  
a
 <
INT_MAX
 - 
b
;

1007 
	}
}

1011 
	$°bi__mul2sizes_vÆid
(
a
, 
b
)

1013 i‡(
a
 < 0 || 
b
 < 0)  0;

1014 i‡(
b
 == 0)  1;

1016  
a
 <
INT_MAX
/
b
;

1017 
	}
}

1019 #i‡!
deföed
(
STBI_NO_JPEG
Ë|| !deföed(
STBI_NO_PNG
Ë|| !deföed(
STBI_NO_TGA
Ë|| !deföed(
STBI_NO_HDR
)

1021 
	$°bi__mad2sizes_vÆid
(
a
, 
b
, 
add
)

1023  
	`°bi__mul2sizes_vÆid
(
a
, 
b
Ë&& 
	`°bi__addsizes_vÆid
◊*b, 
add
);

1024 
	}
}

1028 
	$°bi__mad3sizes_vÆid
(
a
, 
b
, 
c
, 
add
)

1030  
	`°bi__mul2sizes_vÆid
(
a
, 
b
Ë&& stbi__mul2sizes_vÆid◊*b, 
c
) &&

1031 
	`°bi__addsizes_vÆid
(
a
*
b
*
c
, 
add
);

1032 
	}
}

1035 #i‡!
deföed
(
STBI_NO_LINEAR
Ë|| !deföed(
STBI_NO_HDR
Ë|| !deföed(
STBI_NO_PNM
)

1036 
	$°bi__mad4sizes_vÆid
(
a
, 
b
, 
c
, 
d
, 
add
)

1038  
	`°bi__mul2sizes_vÆid
(
a
, 
b
Ë&& stbi__mul2sizes_vÆid◊*b, 
c
) &&

1039 
	`°bi__mul2sizes_vÆid
(
a
*
b
*
c
, 
d
Ë&& 
	`°bi__addsizes_vÆid
◊*b*c*d, 
add
);

1040 
	}
}

1043 #i‡!
deföed
(
STBI_NO_JPEG
Ë|| !deföed(
STBI_NO_PNG
Ë|| !deföed(
STBI_NO_TGA
Ë|| !deföed(
STBI_NO_HDR
)

1045 *
	$°bi__mÆloc_mad2
(
a
, 
b
, 
add
)

1047 i‡(!
	`°bi__mad2sizes_vÆid
(
a
, 
b
, 
add
)Ë 
NULL
;

1048  
	`°bi__mÆloc
(
a
*
b
 + 
add
);

1049 
	}
}

1052 *
	$°bi__mÆloc_mad3
(
a
, 
b
, 
c
, 
add
)

1054 i‡(!
	`°bi__mad3sizes_vÆid
(
a
, 
b
, 
c
, 
add
)Ë 
NULL
;

1055  
	`°bi__mÆloc
(
a
*
b
*
c
 + 
add
);

1056 
	}
}

1058 #i‡!
deföed
(
STBI_NO_LINEAR
Ë|| !deföed(
STBI_NO_HDR
Ë|| !deföed(
STBI_NO_PNM
)

1059 *
	$°bi__mÆloc_mad4
(
a
, 
b
, 
c
, 
d
, 
add
)

1061 i‡(!
	`°bi__mad4sizes_vÆid
(
a
, 
b
, 
c
, 
d
, 
add
)Ë 
NULL
;

1062  
	`°bi__mÆloc
(
a
*
b
*
c
*
d
 + 
add
);

1063 
	}
}

1070 #ifde‡
STBI_NO_FAILURE_STRINGS


1071 
	#°bi__îr
(
x
,
y
Ë0

	)

1072 #ñi‡
deföed
(
STBI_FAILURE_USERMSG
)

1073 
	#°bi__îr
(
x
,
y
Ë
	`°bi__îr
(y)

	)

1075 
	#°bi__îr
(
x
,
y
Ë
	`°bi__îr
(x)

	)

1078 
	#°bi__îΩf
(
x
,
y
Ë((*)(
size_t
Ë(
	`°bi__îr
(x,y)?
NULL
:NULL))

	)

1079 
	#°bi__îΩuc
(
x
,
y
Ë((*)(
size_t
Ë(
	`°bi__îr
(x,y)?
NULL
:NULL))

	)

1081 
STBIDEF
 
	$°bi_image_‰ì
(*
ªtvÆ_‰om_°bi_lﬂd
)

1083 
	`STBI_FREE
(
ªtvÆ_‰om_°bi_lﬂd
);

1084 
	}
}

1086 #i‚de‡
STBI_NO_LINEAR


1087 *
°bi__ldr_to_hdr
(
°bi_uc
 *
d©a
, 
x
, 
y
, 
comp
);

1090 #i‚de‡
STBI_NO_HDR


1091 
°bi_uc
 *
°bi__hdr_to_ldr
(*
d©a
, 
x
, 
y
, 
comp
);

1094 
	g°bi__vîtiˇŒy_Êù_⁄_lﬂd_globÆ
 = 0;

1096 
STBIDEF
 
	$°bi_£t_Êù_vîtiˇŒy_⁄_lﬂd
(
Êag_åue_if_should_Êù
)

1098 
°bi__vîtiˇŒy_Êù_⁄_lﬂd_globÆ
 = 
Êag_åue_if_should_Êù
;

1099 
	}
}

1101 #i‚de‡
STBI_THREAD_LOCAL


1102 
	#°bi__vîtiˇŒy_Êù_⁄_lﬂd
 
°bi__vîtiˇŒy_Êù_⁄_lﬂd_globÆ


	)

1104 
STBI_THREAD_LOCAL
 
	g°bi__vîtiˇŒy_Êù_⁄_lﬂd_loˇl
, 
	g°bi__vîtiˇŒy_Êù_⁄_lﬂd_£t
;

1106 
STBIDEF
 
	$°bi_£t_Êù_vîtiˇŒy_⁄_lﬂd_thªad
(
Êag_åue_if_should_Êù
)

1108 
°bi__vîtiˇŒy_Êù_⁄_lﬂd_loˇl
 = 
Êag_åue_if_should_Êù
;

1109 
°bi__vîtiˇŒy_Êù_⁄_lﬂd_£t
 = 1;

1110 
	}
}

1112 
	#°bi__vîtiˇŒy_Êù_⁄_lﬂd
 (
°bi__vîtiˇŒy_Êù_⁄_lﬂd_£t
 \

1113 ? 
°bi__vîtiˇŒy_Êù_⁄_lﬂd_loˇl
 \

1114 : 
°bi__vîtiˇŒy_Êù_⁄_lﬂd_globÆ
)

	)

1117 *
	$°bi__lﬂd_maö
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
, 
bpc
)

1119 
	`mem£t
(
ri
, 0, (*ri));

1120 
ri
->
bôs_≥r_ch™√l
 = 8;

1121 
ri
->
ch™√l_‹dî
 = 
STBI_ORDER_RGB
;

1122 
ri
->
num_ch™√ls
 = 0;

1126 #i‚de‡
STBI_NO_PNG


1127 i‡(
	`°bi__≤g_ã°
(
s
)Ë 
	`°bi__≤g_lﬂd
(s,
x
,
y
,
comp
,
ªq_comp
, 
ri
);

1129 #i‚de‡
STBI_NO_BMP


1130 i‡(
	`°bi__bmp_ã°
(
s
)Ë 
	`°bi__bmp_lﬂd
(s,
x
,
y
,
comp
,
ªq_comp
, 
ri
);

1132 #i‚de‡
STBI_NO_GIF


1133 i‡(
	`°bi__gif_ã°
(
s
)Ë 
	`°bi__gif_lﬂd
(s,
x
,
y
,
comp
,
ªq_comp
, 
ri
);

1135 #i‚de‡
STBI_NO_PSD


1136 i‡(
	`°bi__psd_ã°
(
s
)Ë 
	`°bi__psd_lﬂd
(s,
x
,
y
,
comp
,
ªq_comp
, 
ri
, 
bpc
);

1138 
	`STBI_NOTUSED
(
bpc
);

1140 #i‚de‡
STBI_NO_PIC


1141 i‡(
	`°bi__pic_ã°
(
s
)Ë 
	`°bi__pic_lﬂd
(s,
x
,
y
,
comp
,
ªq_comp
, 
ri
);

1147 #i‚de‡
STBI_NO_JPEG


1148 i‡(
	`°bi__j≥g_ã°
(
s
)Ë 
	`°bi__j≥g_lﬂd
(s,
x
,
y
,
comp
,
ªq_comp
, 
ri
);

1150 #i‚de‡
STBI_NO_PNM


1151 i‡(
	`°bi__≤m_ã°
(
s
)Ë 
	`°bi__≤m_lﬂd
(s,
x
,
y
,
comp
,
ªq_comp
, 
ri
);

1154 #i‚de‡
STBI_NO_HDR


1155 i‡(
	`°bi__hdr_ã°
(
s
)) {

1156 *
hdr
 = 
	`°bi__hdr_lﬂd
(
s
, 
x
,
y
,
comp
,
ªq_comp
, 
ri
);

1157  
	`°bi__hdr_to_ldr
(
hdr
, *
x
, *
y
, 
ªq_comp
 ?Ñeq_com∞: *
comp
);

1161 #i‚de‡
STBI_NO_TGA


1163 i‡(
	`°bi__tga_ã°
(
s
))

1164  
	`°bi__tga_lﬂd
(
s
,
x
,
y
,
comp
,
ªq_comp
, 
ri
);

1167  
	`°bi__îΩuc
("unknown imageÅype", "ImageÇot ofány knownÅype, or corrupt");

1168 
	}
}

1170 
°bi_uc
 *
	$°bi__c⁄vît_16_to_8
(
°bi__uöt16
 *
‹ig
, 
w
, 
h
, 
ch™√ls
)

1172 
i
;

1173 
img_Àn
 = 
w
 * 
h
 * 
ch™√ls
;

1174 
°bi_uc
 *
ªdu˚d
;

1176 
ªdu˚d
 = (
°bi_uc
 *Ë
	`°bi__mÆloc
(
img_Àn
);

1177 i‡(
ªdu˚d
 =
NULL
Ë 
	`°bi__îΩuc
("outofmem", "Out of memory");

1179 
i
 = 0; i < 
img_Àn
; ++i)

1180 
ªdu˚d
[
i
] = (
°bi_uc
)((
‹ig
[i] >> 8) & 0xFF);

1182 
	`STBI_FREE
(
‹ig
);

1183  
ªdu˚d
;

1184 
	}
}

1186 
°bi__uöt16
 *
	$°bi__c⁄vît_8_to_16
(
°bi_uc
 *
‹ig
, 
w
, 
h
, 
ch™√ls
)

1188 
i
;

1189 
img_Àn
 = 
w
 * 
h
 * 
ch™√ls
;

1190 
°bi__uöt16
 *
íœrged
;

1192 
íœrged
 = (
°bi__uöt16
 *Ë
	`°bi__mÆloc
(
img_Àn
*2);

1193 i‡(
íœrged
 =
NULL
Ë (
°bi__uöt16
 *Ë
	`°bi__îΩuc
("outofmem", "Out of memory");

1195 
i
 = 0; i < 
img_Àn
; ++i)

1196 
íœrged
[
i
] = (
°bi__uöt16
)((
‹ig
[i] << 8) + orig[i]);

1198 
	`STBI_FREE
(
‹ig
);

1199  
íœrged
;

1200 
	}
}

1202 
	$°bi__vîtiˇl_Êù
(*
image
, 
w
, 
h
, 
byãs_≥r_pixñ
)

1204 
row
;

1205 
size_t
 
byãs_≥r_row
 = (size_t)
w
 * 
byãs_≥r_pixñ
;

1206 
°bi_uc
 
ãmp
[2048];

1207 
°bi_uc
 *
byãs
 = (°bi_u¯*)
image
;

1209 
row
 = 0;Ñow < (
h
>>1);Ñow++) {

1210 
°bi_uc
 *
row0
 = 
byãs
 + 
row
*
byãs_≥r_row
;

1211 
°bi_uc
 *
row1
 = 
byãs
 + (
h
 - 
row
 - 1)*
byãs_≥r_row
;

1213 
size_t
 
byãs_À·
 = 
byãs_≥r_row
;

1214 
byãs_À·
) {

1215 
size_t
 
byãs_c›y
 = (
byãs_À·
 < (
ãmp
)) ? bytes_left : (temp);

1216 
	`mem˝y
(
ãmp
, 
row0
, 
byãs_c›y
);

1217 
	`mem˝y
(
row0
, 
row1
, 
byãs_c›y
);

1218 
	`mem˝y
(
row1
, 
ãmp
, 
byãs_c›y
);

1219 
row0
 +
byãs_c›y
;

1220 
row1
 +
byãs_c›y
;

1221 
byãs_À·
 -
byãs_c›y
;

1224 
	}
}

1226 #i‚de‡
STBI_NO_GIF


1227 
	$°bi__vîtiˇl_Êù_¶i˚s
(*
image
, 
w
, 
h
, 
z
, 
byãs_≥r_pixñ
)

1229 
¶i˚
;

1230 
¶i˚_size
 = 
w
 * 
h
 * 
byãs_≥r_pixñ
;

1232 
°bi_uc
 *
byãs
 = (°bi_u¯*)
image
;

1233 
¶i˚
 = 0; sli˚ < 
z
; ++slice) {

1234 
	`°bi__vîtiˇl_Êù
(
byãs
, 
w
, 
h
, 
byãs_≥r_pixñ
);

1235 
byãs
 +
¶i˚_size
;

1237 
	}
}

1240 *
	$°bi__lﬂd_™d_po°¥o˚ss_8bô
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
)

1242 
°bi__ªsu…_öfo
 
ri
;

1243 *
ªsu…
 = 
	`°bi__lﬂd_maö
(
s
, 
x
, 
y
, 
comp
, 
ªq_comp
, &
ri
, 8);

1245 i‡(
ªsu…
 =
NULL
)

1246  
NULL
;

1249 
	`STBI_ASSERT
(
ri
.
bôs_≥r_ch™√l
 == 8 ||Ñi.bits_per_channel == 16);

1251 i‡(
ri
.
bôs_≥r_ch™√l
 != 8) {

1252 
ªsu…
 = 
	`°bi__c⁄vît_16_to_8
((
°bi__uöt16
 *Ëªsu…, *
x
, *
y
, 
ªq_comp
 =0 ? *
comp
 :Ñeq_comp);

1253 
ri
.
bôs_≥r_ch™√l
 = 8;

1258 i‡(
°bi__vîtiˇŒy_Êù_⁄_lﬂd
) {

1259 
ch™√ls
 = 
ªq_comp
 ?Ñeq_com∞: *
comp
;

1260 
	`°bi__vîtiˇl_Êù
(
ªsu…
, *
x
, *
y
, 
ch™√ls
 * (
°bi_uc
));

1263  (*Ë
ªsu…
;

1264 
	}
}

1266 
°bi__uöt16
 *
	$°bi__lﬂd_™d_po°¥o˚ss_16bô
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
)

1268 
°bi__ªsu…_öfo
 
ri
;

1269 *
ªsu…
 = 
	`°bi__lﬂd_maö
(
s
, 
x
, 
y
, 
comp
, 
ªq_comp
, &
ri
, 16);

1271 i‡(
ªsu…
 =
NULL
)

1272  
NULL
;

1275 
	`STBI_ASSERT
(
ri
.
bôs_≥r_ch™√l
 == 8 ||Ñi.bits_per_channel == 16);

1277 i‡(
ri
.
bôs_≥r_ch™√l
 != 16) {

1278 
ªsu…
 = 
	`°bi__c⁄vît_8_to_16
((
°bi_uc
 *Ëªsu…, *
x
, *
y
, 
ªq_comp
 =0 ? *
comp
 :Ñeq_comp);

1279 
ri
.
bôs_≥r_ch™√l
 = 16;

1285 i‡(
°bi__vîtiˇŒy_Êù_⁄_lﬂd
) {

1286 
ch™√ls
 = 
ªq_comp
 ?Ñeq_com∞: *
comp
;

1287 
	`°bi__vîtiˇl_Êù
(
ªsu…
, *
x
, *
y
, 
ch™√ls
 * (
°bi__uöt16
));

1290  (
°bi__uöt16
 *Ë
ªsu…
;

1291 
	}
}

1293 #i‡!
deföed
(
STBI_NO_HDR
Ë&& !deföed(
STBI_NO_LINEAR
)

1294 
	$°bi__Êﬂt_po°¥o˚ss
(*
ªsu…
, *
x
, *
y
, *
comp
, 
ªq_comp
)

1296 i‡(
°bi__vîtiˇŒy_Êù_⁄_lﬂd
 && 
ªsu…
 !
NULL
) {

1297 
ch™√ls
 = 
ªq_comp
 ?Ñeq_com∞: *
comp
;

1298 
	`°bi__vîtiˇl_Êù
(
ªsu…
, *
x
, *
y
, 
ch™√ls
 * ());

1300 
	}
}

1303 #i‚de‡
STBI_NO_STDIO


1305 #i‡
deföed
(
_WIN32
Ë&& deföed(
STBI_WINDOWS_UTF8
)

1306 
STBI_EXTERN
 
	$__de˛•ec
(
dŒimp‹t
Ë
__°dˇŒ
 
	`Mu…iByãToWideCh¨
(
˝
, 
Êags
, c⁄° *
°r
, 
cbmb
, 
wch¨_t
 *
wide°r
, 
cchwide
);

1307 
STBI_EXTERN
 
	$__de˛•ec
(
dŒimp‹t
Ë
__°dˇŒ
 
	`WideCh¨ToMu…iByã
(
˝
, 
Êags
, c⁄° 
wch¨_t
 *
wide°r
, 
cchwide
, *
°r
, 
cbmb
, c⁄° *
defch¨
, *
u£d_deÁu…
);

1310 #i‡
	`deföed
(
_WIN32
Ë&& deföed(
STBI_WINDOWS_UTF8
)

1311 
STBIDEF
 
	$°bi_c⁄vît_wch¨_to_utf8
(*
buf„r
, 
size_t
 
buf„æí
, c⁄° 
wch¨_t
* 
öput
)

1313  
	`WideCh¨ToMu…iByã
(65001 , 0, 
öput
, -1, 
buf„r
, (Ë
buf„æí
, 
NULL
, NULL);

1314 
	}
}

1317 
FILE
 *
	$°bi__f›í
(c⁄° *
fûíame
, c⁄° *
mode
)

1319 
FILE
 *
f
;

1320 #i‡
	`deföed
(
_WIN32
Ë&& deföed(
STBI_WINDOWS_UTF8
)

1321 
wch¨_t
 
wMode
[64];

1322 
wch¨_t
 
wFûíame
[1024];

1323 i‡(0 =
	`Mu…iByãToWideCh¨
(65001 , 0, 
fûíame
, -1, 
wFûíame
, (wFilename)/(*wFilename)))

1326 i‡(0 =
	`Mu…iByãToWideCh¨
(65001 , 0, 
mode
, -1, 
wMode
, (wMode)/(*wMode)))

1329 #i‡
	`deföed
(
_MSC_VER
) && _MSC_VER >= 1400

1330 i‡(0 !
	`_wf›í_s
(&
f
, 
wFûíame
, 
wMode
))

1331 
f
 = 0;

1333 
f
 = 
	`_wf›í
(
wFûíame
, 
wMode
);

1336 #ñi‡
	`deföed
(
_MSC_VER
) && _MSC_VER >= 1400

1337 i‡(0 !
	`f›í_s
(&
f
, 
fûíame
, 
mode
))

1338 
f
=0;

1340 
f
 = 
	`f›í
(
fûíame
, 
mode
);

1342  
f
;

1343 
	}
}

1346 
STBIDEF
 
°bi_uc
 *
	$°bi_lﬂd
(c⁄° *
fûíame
, *
x
, *
y
, *
comp
, 
ªq_comp
)

1348 
FILE
 *
f
 = 
	`°bi__f›í
(
fûíame
, "rb");

1349 *
ªsu…
;

1350 i‡(!
f
Ë 
	`°bi__îΩuc
("can't fopen", "UnableÅo open file");

1351 
ªsu…
 = 
	`°bi_lﬂd_‰om_fûe
(
f
,
x
,
y
,
comp
,
ªq_comp
);

1352 
	`f˛o£
(
f
);

1353  
ªsu…
;

1354 
	}
}

1356 
STBIDEF
 
°bi_uc
 *
	$°bi_lﬂd_‰om_fûe
(
FILE
 *
f
, *
x
, *
y
, *
comp
, 
ªq_comp
)

1358 *
ªsu…
;

1359 
°bi__c⁄ãxt
 
s
;

1360 
	`°bi__°¨t_fûe
(&
s
,
f
);

1361 
ªsu…
 = 
	`°bi__lﬂd_™d_po°¥o˚ss_8bô
(&
s
,
x
,
y
,
comp
,
ªq_comp
);

1362 i‡(
ªsu…
) {

1364 
	`f£ek
(
f
, - (Ë(
s
.
img_buf„r_íd
 - s.
img_buf„r
), 
SEEK_CUR
);

1366  
ªsu…
;

1367 
	}
}

1369 
STBIDEF
 
°bi__uöt16
 *
	$°bi_lﬂd_‰om_fûe_16
(
FILE
 *
f
, *
x
, *
y
, *
comp
, 
ªq_comp
)

1371 
°bi__uöt16
 *
ªsu…
;

1372 
°bi__c⁄ãxt
 
s
;

1373 
	`°bi__°¨t_fûe
(&
s
,
f
);

1374 
ªsu…
 = 
	`°bi__lﬂd_™d_po°¥o˚ss_16bô
(&
s
,
x
,
y
,
comp
,
ªq_comp
);

1375 i‡(
ªsu…
) {

1377 
	`f£ek
(
f
, - (Ë(
s
.
img_buf„r_íd
 - s.
img_buf„r
), 
SEEK_CUR
);

1379  
ªsu…
;

1380 
	}
}

1382 
STBIDEF
 
°bi_us
 *
	$°bi_lﬂd_16
(c⁄° *
fûíame
, *
x
, *
y
, *
comp
, 
ªq_comp
)

1384 
FILE
 *
f
 = 
	`°bi__f›í
(
fûíame
, "rb");

1385 
°bi__uöt16
 *
ªsu…
;

1386 i‡(!
f
Ë (
°bi_us
 *Ë
	`°bi__îΩuc
("can't fopen", "UnableÅo open file");

1387 
ªsu…
 = 
	`°bi_lﬂd_‰om_fûe_16
(
f
,
x
,
y
,
comp
,
ªq_comp
);

1388 
	`f˛o£
(
f
);

1389  
ªsu…
;

1390 
	}
}

1395 
STBIDEF
 
°bi_us
 *
	$°bi_lﬂd_16_‰om_mem‹y
(
°bi_uc
 c⁄° *
buf„r
, 
Àn
, *
x
, *
y
, *
ch™√ls_ö_fûe
, 
desúed_ch™√ls
)

1397 
°bi__c⁄ãxt
 
s
;

1398 
	`°bi__°¨t_mem
(&
s
,
buf„r
,
Àn
);

1399  
	`°bi__lﬂd_™d_po°¥o˚ss_16bô
(&
s
,
x
,
y
,
ch™√ls_ö_fûe
,
desúed_ch™√ls
);

1400 
	}
}

1402 
STBIDEF
 
°bi_us
 *
	$°bi_lﬂd_16_‰om_ˇŒbacks
(
°bi_io_ˇŒbacks
 c⁄° *
˛bk
, *
u£r
, *
x
, *
y
, *
ch™√ls_ö_fûe
, 
desúed_ch™√ls
)

1404 
°bi__c⁄ãxt
 
s
;

1405 
	`°bi__°¨t_ˇŒbacks
(&
s
, (
°bi_io_ˇŒbacks
 *)
˛bk
, 
u£r
);

1406  
	`°bi__lﬂd_™d_po°¥o˚ss_16bô
(&
s
,
x
,
y
,
ch™√ls_ö_fûe
,
desúed_ch™√ls
);

1407 
	}
}

1409 
STBIDEF
 
°bi_uc
 *
	$°bi_lﬂd_‰om_mem‹y
(
°bi_uc
 c⁄° *
buf„r
, 
Àn
, *
x
, *
y
, *
comp
, 
ªq_comp
)

1411 
°bi__c⁄ãxt
 
s
;

1412 
	`°bi__°¨t_mem
(&
s
,
buf„r
,
Àn
);

1413  
	`°bi__lﬂd_™d_po°¥o˚ss_8bô
(&
s
,
x
,
y
,
comp
,
ªq_comp
);

1414 
	}
}

1416 
STBIDEF
 
°bi_uc
 *
	$°bi_lﬂd_‰om_ˇŒbacks
(
°bi_io_ˇŒbacks
 c⁄° *
˛bk
, *
u£r
, *
x
, *
y
, *
comp
, 
ªq_comp
)

1418 
°bi__c⁄ãxt
 
s
;

1419 
	`°bi__°¨t_ˇŒbacks
(&
s
, (
°bi_io_ˇŒbacks
 *Ë
˛bk
, 
u£r
);

1420  
	`°bi__lﬂd_™d_po°¥o˚ss_8bô
(&
s
,
x
,
y
,
comp
,
ªq_comp
);

1421 
	}
}

1423 #i‚de‡
STBI_NO_GIF


1424 
STBIDEF
 
°bi_uc
 *
	$°bi_lﬂd_gif_‰om_mem‹y
(
°bi_uc
 c⁄° *
buf„r
, 
Àn
, **
dñays
, *
x
, *
y
, *
z
, *
comp
, 
ªq_comp
)

1426 *
ªsu…
;

1427 
°bi__c⁄ãxt
 
s
;

1428 
	`°bi__°¨t_mem
(&
s
,
buf„r
,
Àn
);

1430 
ªsu…
 = (*Ë
	`°bi__lﬂd_gif_maö
(&
s
, 
dñays
, 
x
, 
y
, 
z
, 
comp
, 
ªq_comp
);

1431 i‡(
°bi__vîtiˇŒy_Êù_⁄_lﬂd
) {

1432 
	`°bi__vîtiˇl_Êù_¶i˚s
–
ªsu…
, *
x
, *
y
, *
z
, *
comp
 );

1435  
ªsu…
;

1436 
	}
}

1439 #i‚de‡
STBI_NO_LINEAR


1440 *
	$°bi__lﬂdf_maö
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
)

1442 *
d©a
;

1443 #i‚de‡
STBI_NO_HDR


1444 i‡(
	`°bi__hdr_ã°
(
s
)) {

1445 
°bi__ªsu…_öfo
 
ri
;

1446 *
hdr_d©a
 = 
	`°bi__hdr_lﬂd
(
s
,
x
,
y
,
comp
,
ªq_comp
, &
ri
);

1447 i‡(
hdr_d©a
)

1448 
	`°bi__Êﬂt_po°¥o˚ss
(
hdr_d©a
,
x
,
y
,
comp
,
ªq_comp
);

1449  
hdr_d©a
;

1452 
d©a
 = 
	`°bi__lﬂd_™d_po°¥o˚ss_8bô
(
s
, 
x
, 
y
, 
comp
, 
ªq_comp
);

1453 i‡(
d©a
)

1454  
	`°bi__ldr_to_hdr
(
d©a
, *
x
, *
y
, 
ªq_comp
 ?Ñeq_com∞: *
comp
);

1455  
	`°bi__îΩf
("unknown imageÅype", "ImageÇot ofány knownÅype, or corrupt");

1456 
	}
}

1458 
STBIDEF
 *
	$°bi_lﬂdf_‰om_mem‹y
(
°bi_uc
 c⁄° *
buf„r
, 
Àn
, *
x
, *
y
, *
comp
, 
ªq_comp
)

1460 
°bi__c⁄ãxt
 
s
;

1461 
	`°bi__°¨t_mem
(&
s
,
buf„r
,
Àn
);

1462  
	`°bi__lﬂdf_maö
(&
s
,
x
,
y
,
comp
,
ªq_comp
);

1463 
	}
}

1465 
STBIDEF
 *
	$°bi_lﬂdf_‰om_ˇŒbacks
(
°bi_io_ˇŒbacks
 c⁄° *
˛bk
, *
u£r
, *
x
, *
y
, *
comp
, 
ªq_comp
)

1467 
°bi__c⁄ãxt
 
s
;

1468 
	`°bi__°¨t_ˇŒbacks
(&
s
, (
°bi_io_ˇŒbacks
 *Ë
˛bk
, 
u£r
);

1469  
	`°bi__lﬂdf_maö
(&
s
,
x
,
y
,
comp
,
ªq_comp
);

1470 
	}
}

1472 #i‚de‡
STBI_NO_STDIO


1473 
STBIDEF
 *
	$°bi_lﬂdf
(c⁄° *
fûíame
, *
x
, *
y
, *
comp
, 
ªq_comp
)

1475 *
ªsu…
;

1476 
FILE
 *
f
 = 
	`°bi__f›í
(
fûíame
, "rb");

1477 i‡(!
f
Ë 
	`°bi__îΩf
("can't fopen", "UnableÅo open file");

1478 
ªsu…
 = 
	`°bi_lﬂdf_‰om_fûe
(
f
,
x
,
y
,
comp
,
ªq_comp
);

1479 
	`f˛o£
(
f
);

1480  
ªsu…
;

1481 
	}
}

1483 
STBIDEF
 *
	$°bi_lﬂdf_‰om_fûe
(
FILE
 *
f
, *
x
, *
y
, *
comp
, 
ªq_comp
)

1485 
°bi__c⁄ãxt
 
s
;

1486 
	`°bi__°¨t_fûe
(&
s
,
f
);

1487  
	`°bi__lﬂdf_maö
(&
s
,
x
,
y
,
comp
,
ªq_comp
);

1488 
	}
}

1497 
STBIDEF
 
	$°bi_is_hdr_‰om_mem‹y
(
°bi_uc
 c⁄° *
buf„r
, 
Àn
)

1499 #i‚de‡
STBI_NO_HDR


1500 
°bi__c⁄ãxt
 
s
;

1501 
	`°bi__°¨t_mem
(&
s
,
buf„r
,
Àn
);

1502  
	`°bi__hdr_ã°
(&
s
);

1504 
	`STBI_NOTUSED
(
buf„r
);

1505 
	`STBI_NOTUSED
(
Àn
);

1508 
	}
}

1510 #i‚de‡
STBI_NO_STDIO


1511 
STBIDEF
 
	$°bi_is_hdr
 (c⁄° *
fûíame
)

1513 
FILE
 *
f
 = 
	`°bi__f›í
(
fûíame
, "rb");

1514 
ªsu…
=0;

1515 i‡(
f
) {

1516 
ªsu…
 = 
	`°bi_is_hdr_‰om_fûe
(
f
);

1517 
	`f˛o£
(
f
);

1519  
ªsu…
;

1520 
	}
}

1522 
STBIDEF
 
	$°bi_is_hdr_‰om_fûe
(
FILE
 *
f
)

1524 #i‚de‡
STBI_NO_HDR


1525 
pos
 = 
	`·ñl
(
f
);

1526 
ªs
;

1527 
°bi__c⁄ãxt
 
s
;

1528 
	`°bi__°¨t_fûe
(&
s
,
f
);

1529 
ªs
 = 
	`°bi__hdr_ã°
(&
s
);

1530 
	`f£ek
(
f
, 
pos
, 
SEEK_SET
);

1531  
ªs
;

1533 
	`STBI_NOTUSED
(
f
);

1536 
	}
}

1539 
STBIDEF
 
	$°bi_is_hdr_‰om_ˇŒbacks
(
°bi_io_ˇŒbacks
 c⁄° *
˛bk
, *
u£r
)

1541 #i‚de‡
STBI_NO_HDR


1542 
°bi__c⁄ãxt
 
s
;

1543 
	`°bi__°¨t_ˇŒbacks
(&
s
, (
°bi_io_ˇŒbacks
 *Ë
˛bk
, 
u£r
);

1544  
	`°bi__hdr_ã°
(&
s
);

1546 
	`STBI_NOTUSED
(
˛bk
);

1547 
	`STBI_NOTUSED
(
u£r
);

1550 
	}
}

1552 #i‚de‡
STBI_NO_LINEAR


1553 
	g°bi__l2h_gamma
=2.2f, 
	g°bi__l2h_sˇÀ
=1.0f;

1555 
STBIDEF
 
	$°bi_ldr_to_hdr_gamma
(
gamma
Ë{ 
°bi__l2h_gamma
 = gamma; 
	}
}

1556 
STBIDEF
 
	$°bi_ldr_to_hdr_sˇÀ
(
sˇÀ
Ë{ 
°bi__l2h_sˇÀ
 = sˇÀ; 
	}
}

1559 
	g°bi__h2l_gamma_i
=1.0f/2.2f, 
	g°bi__h2l_sˇÀ_i
=1.0f;

1561 
STBIDEF
 
	$°bi_hdr_to_ldr_gamma
(
gamma
Ë{ 
°bi__h2l_gamma_i
 = 1/gamma; 
	}
}

1562 
STBIDEF
 
	$°bi_hdr_to_ldr_sˇÀ
(
sˇÀ
Ë{ 
°bi__h2l_sˇÀ_i
 = 1/sˇÀ; 
	}
}

1572 
	mSTBI__SCAN_lﬂd
=0,

1573 
	mSTBI__SCAN_ty≥
,

1574 
	mSTBI__SCAN_hódî


1577 
	$°bi__ªfûl_buf„r
(
°bi__c⁄ãxt
 *
s
)

1579 
n
 = (
s
->
io
.
ªad
)(s->
io_u£r_d©a
,(*)s->
buf„r_°¨t
,s->
buÊí
);

1580 
s
->
ˇŒback_Æªady_ªad
 +(Ë(s->
img_buf„r
 - s->
img_buf„r_‹igöÆ
);

1581 i‡(
n
 == 0) {

1584 
s
->
ªad_‰om_ˇŒbacks
 = 0;

1585 
s
->
img_buf„r
 = s->
buf„r_°¨t
;

1586 
s
->
img_buf„r_íd
 = s->
buf„r_°¨t
+1;

1587 *
s
->
img_buf„r
 = 0;

1589 
s
->
img_buf„r
 = s->
buf„r_°¨t
;

1590 
s
->
img_buf„r_íd
 = s->
buf„r_°¨t
 + 
n
;

1592 
	}
}

1594 
°bi_ölöe
 
°bi_uc
 
	$°bi__gë8
(
°bi__c⁄ãxt
 *
s
)

1596 i‡(
s
->
img_buf„r
 < s->
img_buf„r_íd
)

1597  *
s
->
img_buf„r
++;

1598 i‡(
s
->
ªad_‰om_ˇŒbacks
) {

1599 
	`°bi__ªfûl_buf„r
(
s
);

1600  *
s
->
img_buf„r
++;

1603 
	}
}

1605 #i‡
deföed
(
STBI_NO_JPEG
Ë&& deföed(
STBI_NO_HDR
Ë&& deföed(
STBI_NO_PIC
Ë&& deföed(
STBI_NO_PNM
)

1608 
°bi_ölöe
 
	$°bi__©_eof
(
°bi__c⁄ãxt
 *
s
)

1610 i‡(
s
->
io
.
ªad
) {

1611 i‡(!(
s
->
io
.
eof
)(s->
io_u£r_d©a
))  0;

1614 i‡(
s
->
ªad_‰om_ˇŒbacks
 == 0)  1;

1617  
s
->
img_buf„r
 >s->
img_buf„r_íd
;

1618 
	}
}

1621 #i‡
deföed
(
STBI_NO_JPEG
Ë&& deföed(
STBI_NO_PNG
Ë&& deföed(
STBI_NO_BMP
Ë&& deföed(
STBI_NO_PSD
Ë&& deföed(
STBI_NO_TGA
Ë&& deföed(
STBI_NO_GIF
Ë&& deföed(
STBI_NO_PIC
)

1624 
	$°bi__skù
(
°bi__c⁄ãxt
 *
s
, 
n
)

1626 i‡(
n
 == 0) ;

1627 i‡(
n
 < 0) {

1628 
s
->
img_buf„r
 = s->
img_buf„r_íd
;

1631 i‡(
s
->
io
.
ªad
) {

1632 
bÀn
 = (Ë(
s
->
img_buf„r_íd
 - s->
img_buf„r
);

1633 i‡(
bÀn
 < 
n
) {

1634 
s
->
img_buf„r
 = s->
img_buf„r_íd
;

1635 (
s
->
io
.
skù
)(s->
io_u£r_d©a
, 
n
 - 
bÀn
);

1639 
s
->
img_buf„r
 +
n
;

1640 
	}
}

1643 #i‡
deföed
(
STBI_NO_PNG
Ë&& deföed(
STBI_NO_TGA
Ë&& deföed(
STBI_NO_HDR
Ë&& deföed(
STBI_NO_PNM
)

1646 
	$°bi__gën
(
°bi__c⁄ãxt
 *
s
, 
°bi_uc
 *
buf„r
, 
n
)

1648 i‡(
s
->
io
.
ªad
) {

1649 
bÀn
 = (Ë(
s
->
img_buf„r_íd
 - s->
img_buf„r
);

1650 i‡(
bÀn
 < 
n
) {

1651 
ªs
, 
cou¡
;

1653 
	`mem˝y
(
buf„r
, 
s
->
img_buf„r
, 
bÀn
);

1655 
cou¡
 = (
s
->
io
.
ªad
)(s->
io_u£r_d©a
, (*Ë
buf„r
 + 
bÀn
, 
n
 - blen);

1656 
ªs
 = (
cou¡
 =(
n
-
bÀn
));

1657 
s
->
img_buf„r
 = s->
img_buf„r_íd
;

1658  
ªs
;

1662 i‡(
s
->
img_buf„r
+
n
 <s->
img_buf„r_íd
) {

1663 
	`mem˝y
(
buf„r
, 
s
->
img_buf„r
, 
n
);

1664 
s
->
img_buf„r
 +
n
;

1668 
	}
}

1671 #i‡
deföed
(
STBI_NO_JPEG
Ë&& deföed(
STBI_NO_PNG
Ë&& deföed(
STBI_NO_PSD
Ë&& deföed(
STBI_NO_PIC
)

1674 
	$°bi__gë16be
(
°bi__c⁄ãxt
 *
s
)

1676 
z
 = 
	`°bi__gë8
(
s
);

1677  (
z
 << 8Ë+ 
	`°bi__gë8
(
s
);

1678 
	}
}

1681 #i‡
deföed
(
STBI_NO_PNG
Ë&& deföed(
STBI_NO_PSD
Ë&& deföed(
STBI_NO_PIC
)

1684 
°bi__uöt32
 
	$°bi__gë32be
(
°bi__c⁄ãxt
 *
s
)

1686 
°bi__uöt32
 
z
 = 
	`°bi__gë16be
(
s
);

1687  (
z
 << 16Ë+ 
	`°bi__gë16be
(
s
);

1688 
	}
}

1691 #i‡
deföed
(
STBI_NO_BMP
Ë&& deföed(
STBI_NO_TGA
Ë&& deföed(
STBI_NO_GIF
)

1694 
	$°bi__gë16À
(
°bi__c⁄ãxt
 *
s
)

1696 
z
 = 
	`°bi__gë8
(
s
);

1697  
z
 + (
	`°bi__gë8
(
s
) << 8);

1698 
	}
}

1701 #i‚de‡
STBI_NO_BMP


1702 
°bi__uöt32
 
	$°bi__gë32À
(
°bi__c⁄ãxt
 *
s
)

1704 
°bi__uöt32
 
z
 = 
	`°bi__gë16À
(
s
);

1705 
z
 +(
°bi__uöt32
)
	`°bi__gë16À
(
s
) << 16;

1706  
z
;

1707 
	}
}

1710 
	#STBI__BYTECAST
(
x
Ë((
°bi_uc
) ((x) & 255))

1711 

	)

1712 #i‡
deföed
(
STBI_NO_JPEG
Ë&& deföed(
STBI_NO_PNG
Ë&& deföed(
STBI_NO_BMP
Ë&& deföed(
STBI_NO_PSD
Ë&& deföed(
STBI_NO_TGA
Ë&& deföed(
STBI_NO_GIF
Ë&& deföed(
STBI_NO_PIC
Ë&& deföed(
STBI_NO_PNM
)

1726 
°bi_uc
 
	$°bi__compuã_y
(
r
, 
g
, 
b
)

1728  (
°bi_uc
Ë(((
r
*77Ë+ (
g
*150Ë+ (29*
b
)) >> 8);

1729 
	}
}

1732 #i‡
deföed
(
STBI_NO_PNG
Ë&& deföed(
STBI_NO_BMP
Ë&& deföed(
STBI_NO_PSD
Ë&& deföed(
STBI_NO_TGA
Ë&& deföed(
STBI_NO_GIF
Ë&& deföed(
STBI_NO_PIC
Ë&& deföed(
STBI_NO_PNM
)

1735 *
	$°bi__c⁄vît_f‹m©
(*
d©a
, 
img_n
, 
ªq_comp
, 
x
, 
y
)

1737 
i
,
j
;

1738 *
good
;

1740 i‡(
ªq_comp
 =
img_n
Ë 
d©a
;

1741 
	`STBI_ASSERT
(
ªq_comp
 >= 1 &&Ñeq_comp <= 4);

1743 
good
 = (*Ë
	`°bi__mÆloc_mad3
(
ªq_comp
, 
x
, 
y
, 0);

1744 i‡(
good
 =
NULL
) {

1745 
	`STBI_FREE
(
d©a
);

1746  
	`°bi__îΩuc
("outofmem", "Out of memory");

1749 
j
=0; j < (Ë
y
; ++j) {

1750 *
§c
 = 
d©a
 + 
j
 * 
x
 * 
img_n
 ;

1751 *
de°
 = 
good
 + 
j
 * 
x
 * 
ªq_comp
;

1753 
	#STBI__COMBO
(
a
,
b
Ë(◊)*8+(b))

	)

1754 
	#STBI__CASE
(
a
,
b
Ë
	`STBI__COMBO
◊,b): 
i
=
x
-1; i >0; --i, 
§c
 +a, 
de°
 +b)

	)

1757 
	`STBI__COMBO
(
img_n
, 
ªq_comp
)) {

1758 
	`STBI__CASE
(1,2Ë{ 
de°
[0]=
§c
[0]; dest[1]=255; } ;

1759 
	`STBI__CASE
(1,3Ë{ 
de°
[0]=de°[1]=de°[2]=
§c
[0]; } ;

1760 
	`STBI__CASE
(1,4Ë{ 
de°
[0]=de°[1]=de°[2]=
§c
[0]; dest[3]=255; } ;

1761 
	`STBI__CASE
(2,1Ë{ 
de°
[0]=
§c
[0]; } ;

1762 
	`STBI__CASE
(2,3Ë{ 
de°
[0]=de°[1]=de°[2]=
§c
[0]; } ;

1763 
	`STBI__CASE
(2,4Ë{ 
de°
[0]=de°[1]=de°[2]=
§c
[0]; dest[3]=src[1]; } ;

1764 
	`STBI__CASE
(3,4Ë{ 
de°
[0]=
§c
[0];dest[1]=src[1];dest[2]=src[2];dest[3]=255; } ;

1765 
	`STBI__CASE
(3,1Ë{ 
de°
[0]=
	`°bi__compuã_y
(
§c
[0],src[1],src[2]); } ;

1766 
	`STBI__CASE
(3,2Ë{ 
de°
[0]=
	`°bi__compuã_y
(
§c
[0],src[1],src[2]); dest[1] = 255; } ;

1767 
	`STBI__CASE
(4,1Ë{ 
de°
[0]=
	`°bi__compuã_y
(
§c
[0],src[1],src[2]); } ;

1768 
	`STBI__CASE
(4,2Ë{ 
de°
[0]=
	`°bi__compuã_y
(
§c
[0],src[1],src[2]); dest[1] = src[3]; } ;

1769 
	`STBI__CASE
(4,3Ë{ 
de°
[0]=
§c
[0];dest[1]=src[1];dest[2]=src[2]; } ;

1770 : 
	`STBI_ASSERT
(0); 
	`STBI_FREE
(
d©a
); STBI_FREE(
good
);  
	`°bi__îΩuc
("unsupported", "Unsupported format conversion");

1772 #unde‡
STBI__CASE


1775 
	`STBI_FREE
(
d©a
);

1776  
good
;

1777 
	}
}

1780 #i‡
deföed
(
STBI_NO_PNG
Ë&& deföed(
STBI_NO_PSD
)

1783 
°bi__uöt16
 
	$°bi__compuã_y_16
(
r
, 
g
, 
b
)

1785  (
°bi__uöt16
Ë(((
r
*77Ë+ (
g
*150Ë+ (29*
b
)) >> 8);

1786 
	}
}

1789 #i‡
deföed
(
STBI_NO_PNG
Ë&& deföed(
STBI_NO_PSD
)

1792 
°bi__uöt16
 *
	$°bi__c⁄vît_f‹m©16
(
°bi__uöt16
 *
d©a
, 
img_n
, 
ªq_comp
, 
x
, 
y
)

1794 
i
,
j
;

1795 
°bi__uöt16
 *
good
;

1797 i‡(
ªq_comp
 =
img_n
Ë 
d©a
;

1798 
	`STBI_ASSERT
(
ªq_comp
 >= 1 &&Ñeq_comp <= 4);

1800 
good
 = (
°bi__uöt16
 *Ë
	`°bi__mÆloc
(
ªq_comp
 * 
x
 * 
y
 * 2);

1801 i‡(
good
 =
NULL
) {

1802 
	`STBI_FREE
(
d©a
);

1803  (
°bi__uöt16
 *Ë
	`°bi__îΩuc
("outofmem", "Out of memory");

1806 
j
=0; j < (Ë
y
; ++j) {

1807 
°bi__uöt16
 *
§c
 = 
d©a
 + 
j
 * 
x
 * 
img_n
 ;

1808 
°bi__uöt16
 *
de°
 = 
good
 + 
j
 * 
x
 * 
ªq_comp
;

1810 
	#STBI__COMBO
(
a
,
b
Ë(◊)*8+(b))

	)

1811 
	#STBI__CASE
(
a
,
b
Ë
	`STBI__COMBO
◊,b): 
i
=
x
-1; i >0; --i, 
§c
 +a, 
de°
 +b)

	)

1814 
	`STBI__COMBO
(
img_n
, 
ªq_comp
)) {

1815 
	`STBI__CASE
(1,2Ë{ 
de°
[0]=
§c
[0]; dest[1]=0xffff; } ;

1816 
	`STBI__CASE
(1,3Ë{ 
de°
[0]=de°[1]=de°[2]=
§c
[0]; } ;

1817 
	`STBI__CASE
(1,4Ë{ 
de°
[0]=de°[1]=de°[2]=
§c
[0]; dest[3]=0xffff; } ;

1818 
	`STBI__CASE
(2,1Ë{ 
de°
[0]=
§c
[0]; } ;

1819 
	`STBI__CASE
(2,3Ë{ 
de°
[0]=de°[1]=de°[2]=
§c
[0]; } ;

1820 
	`STBI__CASE
(2,4Ë{ 
de°
[0]=de°[1]=de°[2]=
§c
[0]; dest[3]=src[1]; } ;

1821 
	`STBI__CASE
(3,4Ë{ 
de°
[0]=
§c
[0];dest[1]=src[1];dest[2]=src[2];dest[3]=0xffff; } ;

1822 
	`STBI__CASE
(3,1Ë{ 
de°
[0]=
	`°bi__compuã_y_16
(
§c
[0],src[1],src[2]); } ;

1823 
	`STBI__CASE
(3,2Ë{ 
de°
[0]=
	`°bi__compuã_y_16
(
§c
[0],src[1],src[2]); dest[1] = 0xffff; } ;

1824 
	`STBI__CASE
(4,1Ë{ 
de°
[0]=
	`°bi__compuã_y_16
(
§c
[0],src[1],src[2]); } ;

1825 
	`STBI__CASE
(4,2Ë{ 
de°
[0]=
	`°bi__compuã_y_16
(
§c
[0],src[1],src[2]); dest[1] = src[3]; } ;

1826 
	`STBI__CASE
(4,3Ë{ 
de°
[0]=
§c
[0];dest[1]=src[1];dest[2]=src[2]; } ;

1827 : 
	`STBI_ASSERT
(0); 
	`STBI_FREE
(
d©a
); STBI_FREE(
good
);  (
°bi__uöt16
*Ë
	`°bi__îΩuc
("unsupported", "Unsupported format conversion");

1829 #unde‡
STBI__CASE


1832 
	`STBI_FREE
(
d©a
);

1833  
good
;

1834 
	}
}

1837 #i‚de‡
STBI_NO_LINEAR


1838 *
	$°bi__ldr_to_hdr
(
°bi_uc
 *
d©a
, 
x
, 
y
, 
comp
)

1840 
i
,
k
,
n
;

1841 *
ouçut
;

1842 i‡(!
d©a
Ë 
NULL
;

1843 
ouçut
 = (*Ë
	`°bi__mÆloc_mad4
(
x
, 
y
, 
comp
, (), 0);

1844 i‡(
ouçut
 =
NULL
Ë{ 
	`STBI_FREE
(
d©a
);  
	`°bi__îΩf
("outofmem", "Out of memory"); }

1846 i‡(
comp
 & 1Ë
n
 = comp; n = comp-1;

1847 
i
=0; i < 
x
*
y
; ++i) {

1848 
k
=0; k < 
n
; ++k) {

1849 
ouçut
[
i
*
comp
 + 
k
] = (Ë(
	`pow
(
d©a
[i*comp+k]/255.0f, 
°bi__l2h_gamma
Ë* 
°bi__l2h_sˇÀ
);

1852 i‡(
n
 < 
comp
) {

1853 
i
=0; i < 
x
*
y
; ++i) {

1854 
ouçut
[
i
*
comp
 + 
n
] = 
d©a
[i*comp +Ç]/255.0f;

1857 
	`STBI_FREE
(
d©a
);

1858  
ouçut
;

1859 
	}
}

1862 #i‚de‡
STBI_NO_HDR


1863 
	#°bi__Êﬂt2öt
(
x
Ë((Ë(x))

	)

1864 
°bi_uc
 *
	$°bi__hdr_to_ldr
(*
d©a
, 
x
, 
y
, 
comp
)

1866 
i
,
k
,
n
;

1867 
°bi_uc
 *
ouçut
;

1868 i‡(!
d©a
Ë 
NULL
;

1869 
ouçut
 = (
°bi_uc
 *Ë
	`°bi__mÆloc_mad3
(
x
, 
y
, 
comp
, 0);

1870 i‡(
ouçut
 =
NULL
Ë{ 
	`STBI_FREE
(
d©a
);  
	`°bi__îΩuc
("outofmem", "Out of memory"); }

1872 i‡(
comp
 & 1Ë
n
 = comp; n = comp-1;

1873 
i
=0; i < 
x
*
y
; ++i) {

1874 
k
=0; k < 
n
; ++k) {

1875 
z
 = (Ë
	`pow
(
d©a
[
i
*
comp
+
k
]*
°bi__h2l_sˇÀ_i
, 
°bi__h2l_gamma_i
) * 255 + 0.5f;

1876 i‡(
z
 < 0) z = 0;

1877 i‡(
z
 > 255) z = 255;

1878 
ouçut
[
i
*
comp
 + 
k
] = (
°bi_uc
Ë
	`°bi__Êﬂt2öt
(
z
);

1880 i‡(
k
 < 
comp
) {

1881 
z
 = 
d©a
[
i
*
comp
+
k
] * 255 + 0.5f;

1882 i‡(
z
 < 0) z = 0;

1883 i‡(
z
 > 255) z = 255;

1884 
ouçut
[
i
*
comp
 + 
k
] = (
°bi_uc
Ë
	`°bi__Êﬂt2öt
(
z
);

1887 
	`STBI_FREE
(
d©a
);

1888  
ouçut
;

1889 
	}
}

1913 #i‚de‡
STBI_NO_JPEG


1916 
	#FAST_BITS
 9

1917 

	)

1920 
°bi_uc
 
	mÁ°
[1 << 
FAST_BITS
];

1922 
°bi__uöt16
 
	mcode
[256];

1923 
°bi_uc
 
	mvÆues
[256];

1924 
°bi_uc
 
	msize
[257];

1925 
	mmaxcode
[18];

1926 
	mdñè
[17];

1927 } 
	t°bi__huffm™
;

1931 
°bi__c⁄ãxt
 *
	ms
;

1932 
°bi__huffm™
 
	mhuff_dc
[4];

1933 
°bi__huffm™
 
	mhuff_ac
[4];

1934 
°bi__uöt16
 
	mdequ™t
[4][64];

1935 
°bi__öt16
 
	mÁ°_ac
[4][1 << 
FAST_BITS
];

1938 
	mimg_h_max
, 
	mimg_v_max
;

1939 
	mimg_mcu_x
, 
	mimg_mcu_y
;

1940 
	mimg_mcu_w
, 
	mimg_mcu_h
;

1945 
	mid
;

1946 
	mh
,
	mv
;

1947 
	mtq
;

1948 
	mhd
,
	mha
;

1949 
	mdc_¥ed
;

1951 
	mx
,
	my
,
	mw2
,
	mh2
;

1952 
°bi_uc
 *
	md©a
;

1953 *
	møw_d©a
, *
	møw_c€ff
;

1954 
°bi_uc
 *
	mlöebuf
;

1955 *
	mc€ff
;

1956 
	mc€ff_w
, 
	mc€ff_h
;

1957 } 
	mimg_comp
[4];

1959 
°bi__uöt32
 
	mcode_buf„r
;

1960 
	mcode_bôs
;

1961 
	mm¨kî
;

1962 
	mnom‹e
;

1964 
	m¥ogªssive
;

1965 
	m•ec_°¨t
;

1966 
	m•ec_íd
;

1967 
	msucc_high
;

1968 
	msucc_low
;

1969 
	meob_run
;

1970 
	mjfif
;

1971 
	m≠p14_cﬁ‹_å™sf‹m
;

1972 
	mrgb
;

1974 
	msˇn_n
, 
	m‹dî
[4];

1975 
	mª°¨t_öãrvÆ
, 
	mtodo
;

1978 (*
	mid˘_block_kî√l
)(
°bi_uc
 *
	mout
, 
	mout_°ride
, 
	md©a
[64]);

1979 (*
	mYCbCr_to_RGB_kî√l
)(
°bi_uc
 *
	mout
, c⁄° stbi_u¯*
	my
, c⁄° stbi_u¯*
	mpcb
, c⁄° stbi_u¯*
	mp¸
, 
	mcou¡
, 
	m°ï
);

1980 
	m°bi_uc
 *(*
	mªßm∂e_row_hv_2_kî√l
)(
°bi_uc
 *
	mout
, stbi_u¯*
	mö_√¨
, stbi_u¯*
	mö_Ár
, 
	mw
, 
	mhs
);

1981 } 
	t°bi__j≥g
;

1983 
	$°bi__buûd_huffm™
(
°bi__huffm™
 *
h
, *
cou¡
)

1985 
i
,
j
,
k
=0;

1986 
code
;

1988 
i
=0; i < 16; ++i)

1989 
j
=0; j < 
cou¡
[
i
]; ++j)

1990 
h
->
size
[
k
++] = (
°bi_uc
Ë(
i
+1);

1991 
h
->
size
[
k
] = 0;

1994 
code
 = 0;

1995 
k
 = 0;

1996 
j
=1; j <= 16; ++j) {

1998 
h
->
dñè
[
j
] = 
k
 - 
code
;

1999 i‡(
h
->
size
[
k
] =
j
) {

2000 
h
->
size
[
k
] =
j
)

2001 
h
->
code
[
k
++] = (
°bi__uöt16
) (code++);

2002 i‡(
code
-1 >(1u << 
j
)Ë 
	`°bi__îr
("bad codeÜengths","Corrupt JPEG");

2005 
h
->
maxcode
[
j
] = 
code
 << (16-j);

2006 
code
 <<= 1;

2008 
h
->
maxcode
[
j
] = 0xffffffff;

2011 
	`mem£t
(
h
->
Á°
, 255, 1 << 
FAST_BITS
);

2012 
i
=0; i < 
k
; ++i) {

2013 
s
 = 
h
->
size
[
i
];

2014 i‡(
s
 <
FAST_BITS
) {

2015 
c
 = 
h
->
code
[
i
] << (
FAST_BITS
-
s
);

2016 
m
 = 1 << (
FAST_BITS
-
s
);

2017 
j
=0; j < 
m
; ++j) {

2018 
h
->
Á°
[
c
+
j
] = (
°bi_uc
Ë
i
;

2023 
	}
}

2027 
	$°bi__buûd_Á°_ac
(
°bi__öt16
 *
Á°_ac
, 
°bi__huffm™
 *
h
)

2029 
i
;

2030 
i
=0; i < (1 << 
FAST_BITS
); ++i) {

2031 
°bi_uc
 
Á°
 = 
h
->Á°[
i
];

2032 
Á°_ac
[
i
] = 0;

2033 i‡(
Á°
 < 255) {

2034 
rs
 = 
h
->
vÆues
[
Á°
];

2035 
run
 = (
rs
 >> 4) & 15;

2036 
magbôs
 = 
rs
 & 15;

2037 
Àn
 = 
h
->
size
[
Á°
];

2039 i‡(
magbôs
 && 
Àn
 + magbô†<
FAST_BITS
) {

2041 
k
 = ((
i
 << 
Àn
Ë& ((1 << 
FAST_BITS
Ë- 1)Ë>> (FAST_BITS - 
magbôs
);

2042 
m
 = 1 << (
magbôs
 - 1);

2043 i‡(
k
 < 
m
Ëk +(~0U << 
magbôs
) + 1;

2045 i‡(
k
 >= -128 && k <= 127)

2046 
Á°_ac
[
i
] = (
°bi__öt16
Ë((
k
 * 256Ë+ (
run
 * 16Ë+ (
Àn
 + 
magbôs
));

2050 
	}
}

2052 
	$°bi__grow_buf„r_unß„
(
°bi__j≥g
 *
j
)

2055 
b
 = 
j
->
nom‹e
 ? 0 : 
	`°bi__gë8
(j->
s
);

2056 i‡(
b
 == 0xff) {

2057 
c
 = 
	`°bi__gë8
(
j
->
s
);

2058 
c
 =0xffË¯
	`°bi__gë8
(
j
->
s
);

2059 i‡(
c
 != 0) {

2060 
j
->
m¨kî
 = (Ë
c
;

2061 
j
->
nom‹e
 = 1;

2065 
j
->
code_buf„r
 |
b
 << (24 - j->
code_bôs
);

2066 
j
->
code_bôs
 += 8;

2067 } 
j
->
code_bôs
 <= 24);

2068 
	}
}

2071 c⁄° 
°bi__uöt32
 
	g°bi__bmask
[17]={0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535};

2074 
°bi_ölöe
 
	$°bi__j≥g_huff_decode
(
°bi__j≥g
 *
j
, 
°bi__huffm™
 *
h
)

2076 
ãmp
;

2077 
c
,
k
;

2079 i‡(
j
->
code_bôs
 < 16Ë
	`°bi__grow_buf„r_unß„
(j);

2083 
c
 = (
j
->
code_buf„r
 >> (32 - 
FAST_BITS
)) & ((1 << FAST_BITS)-1);

2084 
k
 = 
h
->
Á°
[
c
];

2085 i‡(
k
 < 255) {

2086 
s
 = 
h
->
size
[
k
];

2087 i‡(
s
 > 
j
->
code_bôs
)

2089 
j
->
code_buf„r
 <<
s
;

2090 
j
->
code_bôs
 -
s
;

2091  
h
->
vÆues
[
k
];

2100 
ãmp
 = 
j
->
code_buf„r
 >> 16;

2101 
k
=
FAST_BITS
+1 ; ; ++k)

2102 i‡(
ãmp
 < 
h
->
maxcode
[
k
])

2104 i‡(
k
 == 17) {

2106 
j
->
code_bôs
 -= 16;

2110 i‡(
k
 > 
j
->
code_bôs
)

2114 
c
 = ((
j
->
code_buf„r
 >> (32 - 
k
)Ë& 
°bi__bmask
[k]Ë+ 
h
->
dñè
[k];

2115 
	`STBI_ASSERT
((((
j
->
code_buf„r
Ë>> (32 - 
h
->
size
[
c
])Ë& 
°bi__bmask
[h->size[c]]Ë=h->
code
[c]);

2118 
j
->
code_bôs
 -
k
;

2119 
j
->
code_buf„r
 <<
k
;

2120  
h
->
vÆues
[
c
];

2121 
	}
}

2124 c⁄° 
	g°bi__jbüs
[16] = {0,-1,-3,-7,-15,-31,-63,-127,-255,-511,-1023,-2047,-4095,-8191,-16383,-32767};

2128 
°bi_ölöe
 
	$°bi__exãnd_ª˚ive
(
°bi__j≥g
 *
j
, 
n
)

2130 
k
;

2131 
sgn
;

2132 i‡(
j
->
code_bôs
 < 
n
Ë
	`°bi__grow_buf„r_unß„
(j);

2134 
sgn
 = 
j
->
code_buf„r
 >> 31;

2135 
k
 = 
	`°bi_ÃŸ
(
j
->
code_buf„r
, 
n
);

2136 
j
->
code_buf„r
 = 
k
 & ~
°bi__bmask
[
n
];

2137 
k
 &
°bi__bmask
[
n
];

2138 
j
->
code_bôs
 -
n
;

2139  
k
 + (
°bi__jbüs
[
n
] & (
sgn
 - 1));

2140 
	}
}

2143 
°bi_ölöe
 
	$°bi__j≥g_gë_bôs
(
°bi__j≥g
 *
j
, 
n
)

2145 
k
;

2146 i‡(
j
->
code_bôs
 < 
n
Ë
	`°bi__grow_buf„r_unß„
(j);

2147 
k
 = 
	`°bi_ÃŸ
(
j
->
code_buf„r
, 
n
);

2148 
j
->
code_buf„r
 = 
k
 & ~
°bi__bmask
[
n
];

2149 
k
 &
°bi__bmask
[
n
];

2150 
j
->
code_bôs
 -
n
;

2151  
k
;

2152 
	}
}

2154 
°bi_ölöe
 
	$°bi__j≥g_gë_bô
(
°bi__j≥g
 *
j
)

2156 
k
;

2157 i‡(
j
->
code_bôs
 < 1Ë
	`°bi__grow_buf„r_unß„
(j);

2158 
k
 = 
j
->
code_buf„r
;

2159 
j
->
code_buf„r
 <<= 1;

2160 --
j
->
code_bôs
;

2161  
k
 & 0x80000000;

2162 
	}
}

2166 c⁄° 
°bi_uc
 
	g°bi__j≥g_dezigzag
[64+15] =

2182 
	$°bi__j≥g_decode_block
(
°bi__j≥g
 *
j
, 
d©a
[64], 
°bi__huffm™
 *
hdc
, stbi__huffm™ *
hac
, 
°bi__öt16
 *
Ác
, 
b
, 
°bi__uöt16
 *
dequ™t
)

2184 
diff
,
dc
,
k
;

2185 
t
;

2187 i‡(
j
->
code_bôs
 < 16Ë
	`°bi__grow_buf„r_unß„
(j);

2188 
t
 = 
	`°bi__j≥g_huff_decode
(
j
, 
hdc
);

2189 i‡(
t
 < 0 ||Å > 15Ë 
	`°bi__îr
("bad huffman code","Corrupt JPEG");

2192 
	`mem£t
(
d©a
,0,64*(data[0]));

2194 
diff
 = 
t
 ? 
	`°bi__exãnd_ª˚ive
(
j
,Å) : 0;

2195 
dc
 = 
j
->
img_comp
[
b
].
dc_¥ed
 + 
diff
;

2196 
j
->
img_comp
[
b
].
dc_¥ed
 = 
dc
;

2197 
d©a
[0] = (Ë(
dc
 * 
dequ™t
[0]);

2200 
k
 = 1;

2202 
zig
;

2203 
c
,
r
,
s
;

2204 i‡(
j
->
code_bôs
 < 16Ë
	`°bi__grow_buf„r_unß„
(j);

2205 
c
 = (
j
->
code_buf„r
 >> (32 - 
FAST_BITS
)) & ((1 << FAST_BITS)-1);

2206 
r
 = 
Ác
[
c
];

2207 i‡(
r
) {

2208 
k
 +(
r
 >> 4) & 15;

2209 
s
 = 
r
 & 15;

2210 
j
->
code_buf„r
 <<
s
;

2211 
j
->
code_bôs
 -
s
;

2213 
zig
 = 
°bi__j≥g_dezigzag
[
k
++];

2214 
d©a
[
zig
] = (Ë((
r
 >> 8Ë* 
dequ™t
[zig]);

2216 
rs
 = 
	`°bi__j≥g_huff_decode
(
j
, 
hac
);

2217 i‡(
rs
 < 0Ë 
	`°bi__îr
("bad huffman code","Corrupt JPEG");

2218 
s
 = 
rs
 & 15;

2219 
r
 = 
rs
 >> 4;

2220 i‡(
s
 == 0) {

2221 i‡(
rs
 != 0xf0) ;

2222 
k
 += 16;

2224 
k
 +
r
;

2226 
zig
 = 
°bi__j≥g_dezigzag
[
k
++];

2227 
d©a
[
zig
] = (Ë(
	`°bi__exãnd_ª˚ive
(
j
,
s
Ë* 
dequ™t
[zig]);

2230 } 
k
 < 64);

2232 
	}
}

2234 
	$°bi__j≥g_decode_block_¥og_dc
(
°bi__j≥g
 *
j
, 
d©a
[64], 
°bi__huffm™
 *
hdc
, 
b
)

2236 
diff
,
dc
;

2237 
t
;

2238 i‡(
j
->
•ec_íd
 !0Ë 
	`°bi__îr
("can't merge dcándác", "Corrupt JPEG");

2240 i‡(
j
->
code_bôs
 < 16Ë
	`°bi__grow_buf„r_unß„
(j);

2242 i‡(
j
->
succ_high
 == 0) {

2244 
	`mem£t
(
d©a
,0,64*(data[0]));

2245 
t
 = 
	`°bi__j≥g_huff_decode
(
j
, 
hdc
);

2246 i‡(
t
 < 0 ||Å > 15Ë 
	`°bi__îr
("can't merge dcándác", "Corrupt JPEG");

2247 
diff
 = 
t
 ? 
	`°bi__exãnd_ª˚ive
(
j
,Å) : 0;

2249 
dc
 = 
j
->
img_comp
[
b
].
dc_¥ed
 + 
diff
;

2250 
j
->
img_comp
[
b
].
dc_¥ed
 = 
dc
;

2251 
d©a
[0] = (Ë(
dc
 * (1 << 
j
->
succ_low
));

2254 i‡(
	`°bi__j≥g_gë_bô
(
j
))

2255 
d©a
[0] +(Ë(1 << 
j
->
succ_low
);

2258 
	}
}

2262 
	$°bi__j≥g_decode_block_¥og_ac
(
°bi__j≥g
 *
j
, 
d©a
[64], 
°bi__huffm™
 *
hac
, 
°bi__öt16
 *
Ác
)

2264 
k
;

2265 i‡(
j
->
•ec_°¨t
 =0Ë 
	`°bi__îr
("can't merge dcándác", "Corrupt JPEG");

2267 i‡(
j
->
succ_high
 == 0) {

2268 
shi·
 = 
j
->
succ_low
;

2270 i‡(
j
->
eob_run
) {

2271 --
j
->
eob_run
;

2275 
k
 = 
j
->
•ec_°¨t
;

2277 
zig
;

2278 
c
,
r
,
s
;

2279 i‡(
j
->
code_bôs
 < 16Ë
	`°bi__grow_buf„r_unß„
(j);

2280 
c
 = (
j
->
code_buf„r
 >> (32 - 
FAST_BITS
)) & ((1 << FAST_BITS)-1);

2281 
r
 = 
Ác
[
c
];

2282 i‡(
r
) {

2283 
k
 +(
r
 >> 4) & 15;

2284 
s
 = 
r
 & 15;

2285 
j
->
code_buf„r
 <<
s
;

2286 
j
->
code_bôs
 -
s
;

2287 
zig
 = 
°bi__j≥g_dezigzag
[
k
++];

2288 
d©a
[
zig
] = (Ë((
r
 >> 8Ë* (1 << 
shi·
));

2290 
rs
 = 
	`°bi__j≥g_huff_decode
(
j
, 
hac
);

2291 i‡(
rs
 < 0Ë 
	`°bi__îr
("bad huffman code","Corrupt JPEG");

2292 
s
 = 
rs
 & 15;

2293 
r
 = 
rs
 >> 4;

2294 i‡(
s
 == 0) {

2295 i‡(
r
 < 15) {

2296 
j
->
eob_run
 = (1 << 
r
);

2297 i‡(
r
)

2298 
j
->
eob_run
 +
	`°bi__j≥g_gë_bôs
(j, 
r
);

2299 --
j
->
eob_run
;

2302 
k
 += 16;

2304 
k
 +
r
;

2305 
zig
 = 
°bi__j≥g_dezigzag
[
k
++];

2306 
d©a
[
zig
] = (Ë(
	`°bi__exãnd_ª˚ive
(
j
,
s
Ë* (1 << 
shi·
));

2309 } 
k
 <
j
->
•ec_íd
);

2313 
bô
 = (Ë(1 << 
j
->
succ_low
);

2315 i‡(
j
->
eob_run
) {

2316 --
j
->
eob_run
;

2317 
k
 = 
j
->
•ec_°¨t
; k <j->
•ec_íd
; ++k) {

2318 *
p
 = &
d©a
[
°bi__j≥g_dezigzag
[
k
]];

2319 i‡(*
p
 != 0)

2320 i‡(
	`°bi__j≥g_gë_bô
(
j
))

2321 i‡((*
p
 & 
bô
)==0) {

2322 i‡(*
p
 > 0)

2323 *
p
 +
bô
;

2325 *
p
 -
bô
;

2329 
k
 = 
j
->
•ec_°¨t
;

2331 
r
,
s
;

2332 
rs
 = 
	`°bi__j≥g_huff_decode
(
j
, 
hac
);

2333 i‡(
rs
 < 0Ë 
	`°bi__îr
("bad huffman code","Corrupt JPEG");

2334 
s
 = 
rs
 & 15;

2335 
r
 = 
rs
 >> 4;

2336 i‡(
s
 == 0) {

2337 i‡(
r
 < 15) {

2338 
j
->
eob_run
 = (1 << 
r
) - 1;

2339 i‡(
r
)

2340 
j
->
eob_run
 +
	`°bi__j≥g_gë_bôs
(j, 
r
);

2341 
r
 = 64;

2348 i‡(
s
 !1Ë 
	`°bi__îr
("bad huffman code", "Corrupt JPEG");

2350 i‡(
	`°bi__j≥g_gë_bô
(
j
))

2351 
s
 = 
bô
;

2353 
s
 = -
bô
;

2357 
k
 <
j
->
•ec_íd
) {

2358 *
p
 = &
d©a
[
°bi__j≥g_dezigzag
[
k
++]];

2359 i‡(*
p
 != 0) {

2360 i‡(
	`°bi__j≥g_gë_bô
(
j
))

2361 i‡((*
p
 & 
bô
)==0) {

2362 i‡(*
p
 > 0)

2363 *
p
 +
bô
;

2365 *
p
 -
bô
;

2368 i‡(
r
 == 0) {

2369 *
p
 = (Ë
s
;

2372 --
r
;

2375 } 
k
 <
j
->
•ec_íd
);

2379 
	}
}

2382 
°bi_ölöe
 
°bi_uc
 
	$°bi__˛amp
(
x
)

2385 i‡((Ë
x
 > 255) {

2386 i‡(
x
 < 0)  0;

2387 i‡(
x
 > 255)  255;

2389  (
°bi_uc
Ë
x
;

2390 
	}
}

2392 
	#°bi__f2f
(
x
Ë((Ë(((xË* 4096 + 0.5)))

	)

2393 
	#°bi__fsh
(
x
Ë((xË* 4096)

	)

2396 
	#STBI__IDCT_1D
(
s0
,
s1
,
s2
,
s3
,
s4
,
s5
,
s6
,
s7
) \

2397 
t0
,
t1
,
t2
,
t3
,
p1
,
p2
,
p3
,
p4
,
p5
,
x0
,
x1
,
x2
,
x3
; \

2398 
p2
 = 
s2
; \

2399 
p3
 = 
s6
; \

2400 
p1
 = (
p2
+
p3
Ë* 
	`°bi__f2f
(0.5411961f); \

2401 
t2
 = 
p1
 + 
p3
*
	`°bi__f2f
(-1.847759065f); \

2402 
t3
 = 
p1
 + 
p2
*
	`°bi__f2f
( 0.765366865f); \

2403 
p2
 = 
s0
; \

2404 
p3
 = 
s4
; \

2405 
t0
 = 
	`°bi__fsh
(
p2
+
p3
); \

2406 
t1
 = 
	`°bi__fsh
(
p2
-
p3
); \

2407 
x0
 = 
t0
+
t3
; \

2408 
x3
 = 
t0
-
t3
; \

2409 
x1
 = 
t1
+
t2
; \

2410 
x2
 = 
t1
-
t2
; \

2411 
t0
 = 
s7
; \

2412 
t1
 = 
s5
; \

2413 
t2
 = 
s3
; \

2414 
t3
 = 
s1
; \

2415 
p3
 = 
t0
+
t2
; \

2416 
p4
 = 
t1
+
t3
; \

2417 
p1
 = 
t0
+
t3
; \

2418 
p2
 = 
t1
+
t2
; \

2419 
p5
 = (
p3
+
p4
)*
	`°bi__f2f
( 1.175875602f); \

2420 
t0
 =Å0*
	`°bi__f2f
( 0.298631336f); \

2421 
t1
 =Å1*
	`°bi__f2f
( 2.053119869f); \

2422 
t2
 =Å2*
	`°bi__f2f
( 3.072711026f); \

2423 
t3
 =Å3*
	`°bi__f2f
( 1.501321110f); \

2424 
p1
 = 
p5
 +Ö1*
	`°bi__f2f
(-0.899976223f); \

2425 
p2
 = 
p5
 +Ö2*
	`°bi__f2f
(-2.562915447f); \

2426 
p3
 =Ö3*
	`°bi__f2f
(-1.961570560f); \

2427 
p4
 =Ö4*
	`°bi__f2f
(-0.390180644f); \

2428 
t3
 +
p1
+
p4
; \

2429 
t2
 +
p2
+
p3
; \

2430 
t1
 +
p2
+
p4
; \

2431 
t0
 +
p1
+
p3
;

	)

2433 
	$°bi__id˘_block
(
°bi_uc
 *
out
, 
out_°ride
, 
d©a
[64])

2435 
i
,
vÆ
[64],*
v
=val;

2436 
°bi_uc
 *
o
;

2437 *
d
 = 
d©a
;

2440 
i
=0; i < 8; ++i,++
d
, ++
v
) {

2442 i‡(
d
[ 8]==0 && d[16]==0 && d[24]==0 && d[32]==0

2443 && 
d
[40]==0 && d[48]==0 && d[56]==0) {

2448 
d˘îm
 = 
d
[0]*4;

2449 
v
[0] = v[8] = v[16] = v[24] = v[32] = v[40] = v[48] = v[56] = 
d˘îm
;

2451 
	`STBI__IDCT_1D
(
d
[ 0],d[ 8],d[16],d[24],d[32],d[40],d[48],d[56])

2454 
x0
 +512; 
x1
 +512; 
x2
 +512; 
x3
 += 512;

2455 
v
[ 0] = (
x0
+
t3
) >> 10;

2456 
v
[56] = (
x0
-
t3
) >> 10;

2457 
v
[ 8] = (
x1
+
t2
) >> 10;

2458 
v
[48] = (
x1
-
t2
) >> 10;

2459 
v
[16] = (
x2
+
t1
) >> 10;

2460 
v
[40] = (
x2
-
t1
) >> 10;

2461 
v
[24] = (
x3
+
t0
) >> 10;

2462 
v
[32] = (
x3
-
t0
) >> 10;

2466 
i
=0, 
v
=
vÆ
, 
o
=
out
; i < 8; ++i,v+=8,o+=
out_°ride
) {

2468 
	`STBI__IDCT_1D
(
v
[0],v[1],v[2],v[3],v[4],v[5],v[6],v[7])

2475 
x0
 += 65536 + (128<<17);

2476 
x1
 += 65536 + (128<<17);

2477 
x2
 += 65536 + (128<<17);

2478 
x3
 += 65536 + (128<<17);

2481 
o
[0] = 
	`°bi__˛amp
((
x0
+
t3
) >> 17);

2482 
o
[7] = 
	`°bi__˛amp
((
x0
-
t3
) >> 17);

2483 
o
[1] = 
	`°bi__˛amp
((
x1
+
t2
) >> 17);

2484 
o
[6] = 
	`°bi__˛amp
((
x1
-
t2
) >> 17);

2485 
o
[2] = 
	`°bi__˛amp
((
x2
+
t1
) >> 17);

2486 
o
[5] = 
	`°bi__˛amp
((
x2
-
t1
) >> 17);

2487 
o
[3] = 
	`°bi__˛amp
((
x3
+
t0
) >> 17);

2488 
o
[4] = 
	`°bi__˛amp
((
x3
-
t0
) >> 17);

2490 
	}
}

2492 #ifde‡
STBI_SSE2


2496 
	$°bi__id˘_simd
(
°bi_uc
 *
out
, 
out_°ride
, 
d©a
[64])

2499 
__m128i
 
row0
, 
row1
, 
row2
, 
row3
, 
row4
, 
row5
, 
row6
, 
row7
;

2500 
__m128i
 
tmp
;

2503 
	#d˘_c⁄°
(
x
,
y
Ë
	`_mm_£å_ïi16
((x),(y),(x),(y),(x),(y),(x),(y))

	)

2507 
	#d˘_rŸ
(
out0
,
out1
, 
x
,
y
,
c0
,
c1
) \

2508 
__m128i
 
c0
##
lo
 = 
	`_mm_u≈acklo_ïi16
((
x
),(
y
)); \

2509 
__m128i
 
c0
##
hi
 = 
	`_mm_u≈ackhi_ïi16
((
x
),(
y
)); \

2510 
__m128i
 
out0
##
_l
 = 
	`_mm_madd_ïi16
(
c0
##
lo
, c0); \

2511 
__m128i
 
out0
##
_h
 = 
	`_mm_madd_ïi16
(
c0
##
hi
, c0); \

2512 
__m128i
 
out1
##
_l
 = 
	`_mm_madd_ïi16
(
c0
##
lo
, 
c1
); \

2513 
__m128i
 
out1
##
_h
 = 
	`_mm_madd_ïi16
(
c0
##
hi
, 
c1
)

	)

2516 
	#d˘_widí
(
out
, 
ö
) \

2517 
__m128i
 
out
##
_l
 = 
	`_mm_§ai_ïi32
(
	`_mm_u≈acklo_ïi16
(
	`_mm_£tzîo_si128
(), (
ö
)), 4); \

2518 
__m128i
 
out
##
_h
 = 
	`_mm_§ai_ïi32
(
	`_mm_u≈ackhi_ïi16
(
	`_mm_£tzîo_si128
(), (
ö
)), 4)

	)

2521 
	#d˘_wadd
(
out
, 
a
, 
b
) \

2522 
__m128i
 
out
##
_l
 = 
	`_mm_add_ïi32
(
a
##_l, 
b
##_l); \

2523 
__m128i
 
out
##
_h
 = 
	`_mm_add_ïi32
(
a
##_h, 
b
##_h)

	)

2526 
	#d˘_wsub
(
out
, 
a
, 
b
) \

2527 
__m128i
 
out
##
_l
 = 
	`_mm_sub_ïi32
(
a
##_l, 
b
##_l); \

2528 
__m128i
 
out
##
_h
 = 
	`_mm_sub_ïi32
(
a
##_h, 
b
##_h)

	)

2531 
	#d˘_bÊy32o
(
out0
, 
out1
, 
a
,
b
,
büs
,
s
) \

2533 
__m128i
 
abü£d_l
 = 
	`_mm_add_ïi32
(
a
##
_l
, 
büs
); \

2534 
__m128i
 
abü£d_h
 = 
	`_mm_add_ïi32
(
a
##
_h
, 
büs
); \

2535 
	`d˘_wadd
(
sum
, 
abü£d
, 
b
); \

2536 
	`d˘_wsub
(
dif
, 
abü£d
, 
b
); \

2537 
out0
 = 
	`_mm_∑cks_ïi32
(
	`_mm_§ai_ïi32
(
sum_l
, 
s
), _mm_§ai_ïi32(
sum_h
, s)); \

2538 
out1
 = 
	`_mm_∑cks_ïi32
(
	`_mm_§ai_ïi32
(
dif_l
, 
s
), _mm_§ai_ïi32(
dif_h
, s)); \

2539 }

	)

2542 
	#d˘_öãæóve8
(
a
, 
b
) \

2543 
tmp
 = 
a
; \

2544 
a
 = 
	`_mm_u≈acklo_ïi8
◊, 
b
); \

2545 
b
 = 
	`_mm_u≈ackhi_ïi8
(
tmp
, b)

	)

2548 
	#d˘_öãæóve16
(
a
, 
b
) \

2549 
tmp
 = 
a
; \

2550 
a
 = 
	`_mm_u≈acklo_ïi16
◊, 
b
); \

2551 
b
 = 
	`_mm_u≈ackhi_ïi16
(
tmp
, b)

	)

2553 
	#d˘_∑ss
(
büs
,
shi·
) \

2556 
	`d˘_rŸ
(
t2e
,
t3e
, 
row2
,
row6
, 
rŸ0_0
,
rŸ0_1
); \

2557 
__m128i
 
sum04
 = 
	`_mm_add_ïi16
(
row0
, 
row4
); \

2558 
__m128i
 
dif04
 = 
	`_mm_sub_ïi16
(
row0
, 
row4
); \

2559 
	`d˘_widí
(
t0e
, 
sum04
); \

2560 
	`d˘_widí
(
t1e
, 
dif04
); \

2561 
	`d˘_wadd
(
x0
, 
t0e
, 
t3e
); \

2562 
	`d˘_wsub
(
x3
, 
t0e
, 
t3e
); \

2563 
	`d˘_wadd
(
x1
, 
t1e
, 
t2e
); \

2564 
	`d˘_wsub
(
x2
, 
t1e
, 
t2e
); \

2566 
	`d˘_rŸ
(
y0o
,
y2o
, 
row7
,
row3
, 
rŸ2_0
,
rŸ2_1
); \

2567 
	`d˘_rŸ
(
y1o
,
y3o
, 
row5
,
row1
, 
rŸ3_0
,
rŸ3_1
); \

2568 
__m128i
 
sum17
 = 
	`_mm_add_ïi16
(
row1
, 
row7
); \

2569 
__m128i
 
sum35
 = 
	`_mm_add_ïi16
(
row3
, 
row5
); \

2570 
	`d˘_rŸ
(
y4o
,
y5o
, 
sum17
,
sum35
, 
rŸ1_0
,
rŸ1_1
); \

2571 
	`d˘_wadd
(
x4
, 
y0o
, 
y4o
); \

2572 
	`d˘_wadd
(
x5
, 
y1o
, 
y5o
); \

2573 
	`d˘_wadd
(
x6
, 
y2o
, 
y5o
); \

2574 
	`d˘_wadd
(
x7
, 
y3o
, 
y4o
); \

2575 
	`d˘_bÊy32o
(
row0
,
row7
, 
x0
,
x7
,
büs
,
shi·
); \

2576 
	`d˘_bÊy32o
(
row1
,
row6
, 
x1
,
x6
,
büs
,
shi·
); \

2577 
	`d˘_bÊy32o
(
row2
,
row5
, 
x2
,
x5
,
büs
,
shi·
); \

2578 
	`d˘_bÊy32o
(
row3
,
row4
, 
x3
,
x4
,
büs
,
shi·
); \

2579 }

	)

2581 
__m128i
 
rŸ0_0
 = 
	`d˘_c⁄°
(
	`°bi__f2f
(0.5411961f), stbi__f2f(0.5411961f) + stbi__f2f(-1.847759065f));

2582 
__m128i
 
rŸ0_1
 = 
	`d˘_c⁄°
(
	`°bi__f2f
(0.5411961f) + stbi__f2f( 0.765366865f), stbi__f2f(0.5411961f));

2583 
__m128i
 
rŸ1_0
 = 
	`d˘_c⁄°
(
	`°bi__f2f
(1.175875602f) + stbi__f2f(-0.899976223f), stbi__f2f(1.175875602f));

2584 
__m128i
 
rŸ1_1
 = 
	`d˘_c⁄°
(
	`°bi__f2f
(1.175875602f), stbi__f2f(1.175875602f) + stbi__f2f(-2.562915447f));

2585 
__m128i
 
rŸ2_0
 = 
	`d˘_c⁄°
(
	`°bi__f2f
(-1.961570560f) + stbi__f2f( 0.298631336f), stbi__f2f(-1.961570560f));

2586 
__m128i
 
rŸ2_1
 = 
	`d˘_c⁄°
(
	`°bi__f2f
(-1.961570560f), stbi__f2f(-1.961570560f) + stbi__f2f( 3.072711026f));

2587 
__m128i
 
rŸ3_0
 = 
	`d˘_c⁄°
(
	`°bi__f2f
(-0.390180644f) + stbi__f2f( 2.053119869f), stbi__f2f(-0.390180644f));

2588 
__m128i
 
rŸ3_1
 = 
	`d˘_c⁄°
(
	`°bi__f2f
(-0.390180644f), stbi__f2f(-0.390180644f) + stbi__f2f( 1.501321110f));

2591 
__m128i
 
büs_0
 = 
	`_mm_£t1_ïi32
(512);

2592 
__m128i
 
büs_1
 = 
	`_mm_£t1_ïi32
(65536 + (128<<17));

2595 
row0
 = 
	`_mm_lﬂd_si128
((c⁄° 
__m128i
 *Ë(
d©a
 + 0*8));

2596 
row1
 = 
	`_mm_lﬂd_si128
((c⁄° 
__m128i
 *Ë(
d©a
 + 1*8));

2597 
row2
 = 
	`_mm_lﬂd_si128
((c⁄° 
__m128i
 *Ë(
d©a
 + 2*8));

2598 
row3
 = 
	`_mm_lﬂd_si128
((c⁄° 
__m128i
 *Ë(
d©a
 + 3*8));

2599 
row4
 = 
	`_mm_lﬂd_si128
((c⁄° 
__m128i
 *Ë(
d©a
 + 4*8));

2600 
row5
 = 
	`_mm_lﬂd_si128
((c⁄° 
__m128i
 *Ë(
d©a
 + 5*8));

2601 
row6
 = 
	`_mm_lﬂd_si128
((c⁄° 
__m128i
 *Ë(
d©a
 + 6*8));

2602 
row7
 = 
	`_mm_lﬂd_si128
((c⁄° 
__m128i
 *Ë(
d©a
 + 7*8));

2605 
	`d˘_∑ss
(
büs_0
, 10);

2609 
	`d˘_öãæóve16
(
row0
, 
row4
);

2610 
	`d˘_öãæóve16
(
row1
, 
row5
);

2611 
	`d˘_öãæóve16
(
row2
, 
row6
);

2612 
	`d˘_öãæóve16
(
row3
, 
row7
);

2615 
	`d˘_öãæóve16
(
row0
, 
row2
);

2616 
	`d˘_öãæóve16
(
row1
, 
row3
);

2617 
	`d˘_öãæóve16
(
row4
, 
row6
);

2618 
	`d˘_öãæóve16
(
row5
, 
row7
);

2621 
	`d˘_öãæóve16
(
row0
, 
row1
);

2622 
	`d˘_öãæóve16
(
row2
, 
row3
);

2623 
	`d˘_öãæóve16
(
row4
, 
row5
);

2624 
	`d˘_öãæóve16
(
row6
, 
row7
);

2628 
	`d˘_∑ss
(
büs_1
, 17);

2632 
__m128i
 
p0
 = 
	`_mm_∑ckus_ïi16
(
row0
, 
row1
);

2633 
__m128i
 
p1
 = 
	`_mm_∑ckus_ïi16
(
row2
, 
row3
);

2634 
__m128i
 
p2
 = 
	`_mm_∑ckus_ïi16
(
row4
, 
row5
);

2635 
__m128i
 
p3
 = 
	`_mm_∑ckus_ïi16
(
row6
, 
row7
);

2638 
	`d˘_öãæóve8
(
p0
, 
p2
);

2639 
	`d˘_öãæóve8
(
p1
, 
p3
);

2642 
	`d˘_öãæóve8
(
p0
, 
p1
);

2643 
	`d˘_öãæóve8
(
p2
, 
p3
);

2646 
	`d˘_öãæóve8
(
p0
, 
p2
);

2647 
	`d˘_öãæóve8
(
p1
, 
p3
);

2650 
	`_mm_°‹ñ_ïi64
((
__m128i
 *Ë
out
, 
p0
); ouà+
out_°ride
;

2651 
	`_mm_°‹ñ_ïi64
((
__m128i
 *Ë
out
, 
	`_mm_shufÊe_ïi32
(
p0
, 0x4e)); ouà+
out_°ride
;

2652 
	`_mm_°‹ñ_ïi64
((
__m128i
 *Ë
out
, 
p2
); ouà+
out_°ride
;

2653 
	`_mm_°‹ñ_ïi64
((
__m128i
 *Ë
out
, 
	`_mm_shufÊe_ïi32
(
p2
, 0x4e)); ouà+
out_°ride
;

2654 
	`_mm_°‹ñ_ïi64
((
__m128i
 *Ë
out
, 
p1
); ouà+
out_°ride
;

2655 
	`_mm_°‹ñ_ïi64
((
__m128i
 *Ë
out
, 
	`_mm_shufÊe_ïi32
(
p1
, 0x4e)); ouà+
out_°ride
;

2656 
	`_mm_°‹ñ_ïi64
((
__m128i
 *Ë
out
, 
p3
); ouà+
out_°ride
;

2657 
	`_mm_°‹ñ_ïi64
((
__m128i
 *Ë
out
, 
	`_mm_shufÊe_ïi32
(
p3
, 0x4e));

2660 #unde‡
d˘_c⁄°


2661 #unde‡
d˘_rŸ


2662 #unde‡
d˘_widí


2663 #unde‡
d˘_wadd


2664 #unde‡
d˘_wsub


2665 #unde‡
d˘_bÊy32o


2666 #unde‡
d˘_öãæóve8


2667 #unde‡
d˘_öãæóve16


2668 #unde‡
d˘_∑ss


2669 
	}
}

2673 #ifde‡
STBI_NEON


2677 
	$°bi__id˘_simd
(
°bi_uc
 *
out
, 
out_°ride
, 
d©a
[64])

2679 
öt16x8_t
 
row0
, 
row1
, 
row2
, 
row3
, 
row4
, 
row5
, 
row6
, 
row7
;

2681 
öt16x4_t
 
rŸ0_0
 = 
	`vdup_n_s16
(
	`°bi__f2f
(0.5411961f));

2682 
öt16x4_t
 
rŸ0_1
 = 
	`vdup_n_s16
(
	`°bi__f2f
(-1.847759065f));

2683 
öt16x4_t
 
rŸ0_2
 = 
	`vdup_n_s16
(
	`°bi__f2f
( 0.765366865f));

2684 
öt16x4_t
 
rŸ1_0
 = 
	`vdup_n_s16
(
	`°bi__f2f
( 1.175875602f));

2685 
öt16x4_t
 
rŸ1_1
 = 
	`vdup_n_s16
(
	`°bi__f2f
(-0.899976223f));

2686 
öt16x4_t
 
rŸ1_2
 = 
	`vdup_n_s16
(
	`°bi__f2f
(-2.562915447f));

2687 
öt16x4_t
 
rŸ2_0
 = 
	`vdup_n_s16
(
	`°bi__f2f
(-1.961570560f));

2688 
öt16x4_t
 
rŸ2_1
 = 
	`vdup_n_s16
(
	`°bi__f2f
(-0.390180644f));

2689 
öt16x4_t
 
rŸ3_0
 = 
	`vdup_n_s16
(
	`°bi__f2f
( 0.298631336f));

2690 
öt16x4_t
 
rŸ3_1
 = 
	`vdup_n_s16
(
	`°bi__f2f
( 2.053119869f));

2691 
öt16x4_t
 
rŸ3_2
 = 
	`vdup_n_s16
(
	`°bi__f2f
( 3.072711026f));

2692 
öt16x4_t
 
rŸ3_3
 = 
	`vdup_n_s16
(
	`°bi__f2f
( 1.501321110f));

2694 
	#d˘_l⁄g_mul
(
out
, 
öq
, 
c€ff
) \

2695 
öt32x4_t
 
out
##
_l
 = 
	`vmuŒ_s16
(
	`vgë_low_s16
(
öq
), 
c€ff
); \

2696 
öt32x4_t
 
out
##
_h
 = 
	`vmuŒ_s16
(
	`vgë_high_s16
(
öq
), 
c€ff
)

	)

2698 
	#d˘_l⁄g_mac
(
out
, 
acc
, 
öq
, 
c€ff
) \

2699 
öt32x4_t
 
out
##
_l
 = 
	`vmœl_s16
(
acc
##_l, 
	`vgë_low_s16
(
öq
), 
c€ff
); \

2700 
öt32x4_t
 
out
##
_h
 = 
	`vmœl_s16
(
acc
##_h, 
	`vgë_high_s16
(
öq
), 
c€ff
)

	)

2702 
	#d˘_widí
(
out
, 
öq
) \

2703 
öt32x4_t
 
out
##
_l
 = 
	`vshŒ_n_s16
(
	`vgë_low_s16
(
öq
), 12); \

2704 
öt32x4_t
 
out
##
_h
 = 
	`vshŒ_n_s16
(
	`vgë_high_s16
(
öq
), 12)

	)

2707 
	#d˘_wadd
(
out
, 
a
, 
b
) \

2708 
öt32x4_t
 
out
##
_l
 = 
	`vaddq_s32
(
a
##_l, 
b
##_l); \

2709 
öt32x4_t
 
out
##
_h
 = 
	`vaddq_s32
(
a
##_h, 
b
##_h)

	)

2712 
	#d˘_wsub
(
out
, 
a
, 
b
) \

2713 
öt32x4_t
 
out
##
_l
 = 
	`vsubq_s32
(
a
##_l, 
b
##_l); \

2714 
öt32x4_t
 
out
##
_h
 = 
	`vsubq_s32
(
a
##_h, 
b
##_h)

	)

2717 
	#d˘_bÊy32o
(
out0
,
out1
, 
a
,
b
,
shi·›
,
s
) \

2719 
	`d˘_wadd
(
sum
, 
a
, 
b
); \

2720 
	`d˘_wsub
(
dif
, 
a
, 
b
); \

2721 
out0
 = 
	`vcomböe_s16
(
	`shi·›
(
sum_l
, 
s
), shi·›(
sum_h
, s)); \

2722 
out1
 = 
	`vcomböe_s16
(
	`shi·›
(
dif_l
, 
s
), shi·›(
dif_h
, s)); \

2723 }

	)

2725 
	#d˘_∑ss
(
shi·›
, 
shi·
) \

2728 
öt16x8_t
 
sum26
 = 
	`vaddq_s16
(
row2
, 
row6
); \

2729 
	`d˘_l⁄g_mul
(
p1e
, 
sum26
, 
rŸ0_0
); \

2730 
	`d˘_l⁄g_mac
(
t2e
, 
p1e
, 
row6
, 
rŸ0_1
); \

2731 
	`d˘_l⁄g_mac
(
t3e
, 
p1e
, 
row2
, 
rŸ0_2
); \

2732 
öt16x8_t
 
sum04
 = 
	`vaddq_s16
(
row0
, 
row4
); \

2733 
öt16x8_t
 
dif04
 = 
	`vsubq_s16
(
row0
, 
row4
); \

2734 
	`d˘_widí
(
t0e
, 
sum04
); \

2735 
	`d˘_widí
(
t1e
, 
dif04
); \

2736 
	`d˘_wadd
(
x0
, 
t0e
, 
t3e
); \

2737 
	`d˘_wsub
(
x3
, 
t0e
, 
t3e
); \

2738 
	`d˘_wadd
(
x1
, 
t1e
, 
t2e
); \

2739 
	`d˘_wsub
(
x2
, 
t1e
, 
t2e
); \

2741 
öt16x8_t
 
sum15
 = 
	`vaddq_s16
(
row1
, 
row5
); \

2742 
öt16x8_t
 
sum17
 = 
	`vaddq_s16
(
row1
, 
row7
); \

2743 
öt16x8_t
 
sum35
 = 
	`vaddq_s16
(
row3
, 
row5
); \

2744 
öt16x8_t
 
sum37
 = 
	`vaddq_s16
(
row3
, 
row7
); \

2745 
öt16x8_t
 
sumodd
 = 
	`vaddq_s16
(
sum17
, 
sum35
); \

2746 
	`d˘_l⁄g_mul
(
p5o
, 
sumodd
, 
rŸ1_0
); \

2747 
	`d˘_l⁄g_mac
(
p1o
, 
p5o
, 
sum17
, 
rŸ1_1
); \

2748 
	`d˘_l⁄g_mac
(
p2o
, 
p5o
, 
sum35
, 
rŸ1_2
); \

2749 
	`d˘_l⁄g_mul
(
p3o
, 
sum37
, 
rŸ2_0
); \

2750 
	`d˘_l⁄g_mul
(
p4o
, 
sum15
, 
rŸ2_1
); \

2751 
	`d˘_wadd
(
sump13o
, 
p1o
, 
p3o
); \

2752 
	`d˘_wadd
(
sump24o
, 
p2o
, 
p4o
); \

2753 
	`d˘_wadd
(
sump23o
, 
p2o
, 
p3o
); \

2754 
	`d˘_wadd
(
sump14o
, 
p1o
, 
p4o
); \

2755 
	`d˘_l⁄g_mac
(
x4
, 
sump13o
, 
row7
, 
rŸ3_0
); \

2756 
	`d˘_l⁄g_mac
(
x5
, 
sump24o
, 
row5
, 
rŸ3_1
); \

2757 
	`d˘_l⁄g_mac
(
x6
, 
sump23o
, 
row3
, 
rŸ3_2
); \

2758 
	`d˘_l⁄g_mac
(
x7
, 
sump14o
, 
row1
, 
rŸ3_3
); \

2759 
	`d˘_bÊy32o
(
row0
,
row7
, 
x0
,
x7
,
shi·›
,
shi·
); \

2760 
	`d˘_bÊy32o
(
row1
,
row6
, 
x1
,
x6
,
shi·›
,
shi·
); \

2761 
	`d˘_bÊy32o
(
row2
,
row5
, 
x2
,
x5
,
shi·›
,
shi·
); \

2762 
	`d˘_bÊy32o
(
row3
,
row4
, 
x3
,
x4
,
shi·›
,
shi·
); \

2763 }

	)

2766 
row0
 = 
	`vld1q_s16
(
d©a
 + 0*8);

2767 
row1
 = 
	`vld1q_s16
(
d©a
 + 1*8);

2768 
row2
 = 
	`vld1q_s16
(
d©a
 + 2*8);

2769 
row3
 = 
	`vld1q_s16
(
d©a
 + 3*8);

2770 
row4
 = 
	`vld1q_s16
(
d©a
 + 4*8);

2771 
row5
 = 
	`vld1q_s16
(
d©a
 + 5*8);

2772 
row6
 = 
	`vld1q_s16
(
d©a
 + 6*8);

2773 
row7
 = 
	`vld1q_s16
(
d©a
 + 7*8);

2776 
row0
 = 
	`vaddq_s16
‘ow0, 
	`v£tq_œ√_s16
(1024, 
	`vdupq_n_s16
(0), 0));

2779 
	`d˘_∑ss
(
vrsh∫_n_s32
, 10);

2785 
	#d˘_ån16
(
x
, 
y
Ë{ 
öt16x8x2_t
 
t
 = 
	`vånq_s16
(x, y); x =Å.
vÆ
[0]; y =Å.vÆ[1]; }

	)

2786 
	#d˘_ån32
(
x
, 
y
Ë{ 
öt32x4x2_t
 
t
 = 
	`vånq_s32
(
	`vªöãΩªtq_s32_s16
(x), vªöãΩªtq_s32_s16(y)); x = 
	`vªöãΩªtq_s16_s32
—.
vÆ
[0]); y = vªöãΩªtq_s16_s32—.vÆ[1]); }

	)

2787 
	#d˘_ån64
(
x
, 
y
Ë{ 
öt16x8_t
 
x0
 = x; i¡16x8_à
y0
 = y; x = 
	`vcomböe_s16
(
	`vgë_low_s16
(x0), vgë_low_s16(y0)); y = vcomböe_s16(
	`vgë_high_s16
(x0), vgë_high_s16(y0)); }

	)

2790 
	`d˘_ån16
(
row0
, 
row1
);

2791 
	`d˘_ån16
(
row2
, 
row3
);

2792 
	`d˘_ån16
(
row4
, 
row5
);

2793 
	`d˘_ån16
(
row6
, 
row7
);

2796 
	`d˘_ån32
(
row0
, 
row2
);

2797 
	`d˘_ån32
(
row1
, 
row3
);

2798 
	`d˘_ån32
(
row4
, 
row6
);

2799 
	`d˘_ån32
(
row5
, 
row7
);

2802 
	`d˘_ån64
(
row0
, 
row4
);

2803 
	`d˘_ån64
(
row1
, 
row5
);

2804 
	`d˘_ån64
(
row2
, 
row6
);

2805 
	`d˘_ån64
(
row3
, 
row7
);

2807 #unde‡
d˘_ån16


2808 #unde‡
d˘_ån32


2809 #unde‡
d˘_ån64


2816 
	`d˘_∑ss
(
vsh∫_n_s32
, 16);

2820 
uöt8x8_t
 
p0
 = 
	`vqrshrun_n_s16
(
row0
, 1);

2821 
uöt8x8_t
 
p1
 = 
	`vqrshrun_n_s16
(
row1
, 1);

2822 
uöt8x8_t
 
p2
 = 
	`vqrshrun_n_s16
(
row2
, 1);

2823 
uöt8x8_t
 
p3
 = 
	`vqrshrun_n_s16
(
row3
, 1);

2824 
uöt8x8_t
 
p4
 = 
	`vqrshrun_n_s16
(
row4
, 1);

2825 
uöt8x8_t
 
p5
 = 
	`vqrshrun_n_s16
(
row5
, 1);

2826 
uöt8x8_t
 
p6
 = 
	`vqrshrun_n_s16
(
row6
, 1);

2827 
uöt8x8_t
 
p7
 = 
	`vqrshrun_n_s16
(
row7
, 1);

2830 
	#d˘_ån8_8
(
x
, 
y
Ë{ 
uöt8x8x2_t
 
t
 = 
	`vån_u8
(x, y); x =Å.
vÆ
[0]; y =Å.vÆ[1]; }

	)

2831 
	#d˘_ån8_16
(
x
, 
y
Ë{ 
uöt16x4x2_t
 
t
 = 
	`vån_u16
(
	`vªöãΩªt_u16_u8
(x), vªöãΩªt_u16_u8(y)); x = 
	`vªöãΩªt_u8_u16
—.
vÆ
[0]); y = vªöãΩªt_u8_u16—.vÆ[1]); }

	)

2832 
	#d˘_ån8_32
(
x
, 
y
Ë{ 
uöt32x2x2_t
 
t
 = 
	`vån_u32
(
	`vªöãΩªt_u32_u8
(x), vªöãΩªt_u32_u8(y)); x = 
	`vªöãΩªt_u8_u32
—.
vÆ
[0]); y = vªöãΩªt_u8_u32—.vÆ[1]); }

	)

2838 
	`d˘_ån8_8
(
p0
, 
p1
);

2839 
	`d˘_ån8_8
(
p2
, 
p3
);

2840 
	`d˘_ån8_8
(
p4
, 
p5
);

2841 
	`d˘_ån8_8
(
p6
, 
p7
);

2844 
	`d˘_ån8_16
(
p0
, 
p2
);

2845 
	`d˘_ån8_16
(
p1
, 
p3
);

2846 
	`d˘_ån8_16
(
p4
, 
p6
);

2847 
	`d˘_ån8_16
(
p5
, 
p7
);

2850 
	`d˘_ån8_32
(
p0
, 
p4
);

2851 
	`d˘_ån8_32
(
p1
, 
p5
);

2852 
	`d˘_ån8_32
(
p2
, 
p6
);

2853 
	`d˘_ån8_32
(
p3
, 
p7
);

2856 
	`v°1_u8
(
out
, 
p0
); ouà+
out_°ride
;

2857 
	`v°1_u8
(
out
, 
p1
); ouà+
out_°ride
;

2858 
	`v°1_u8
(
out
, 
p2
); ouà+
out_°ride
;

2859 
	`v°1_u8
(
out
, 
p3
); ouà+
out_°ride
;

2860 
	`v°1_u8
(
out
, 
p4
); ouà+
out_°ride
;

2861 
	`v°1_u8
(
out
, 
p5
); ouà+
out_°ride
;

2862 
	`v°1_u8
(
out
, 
p6
); ouà+
out_°ride
;

2863 
	`v°1_u8
(
out
, 
p7
);

2865 #unde‡
d˘_ån8_8


2866 #unde‡
d˘_ån8_16


2867 #unde‡
d˘_ån8_32


2870 #unde‡
d˘_l⁄g_mul


2871 #unde‡
d˘_l⁄g_mac


2872 #unde‡
d˘_widí


2873 #unde‡
d˘_wadd


2874 #unde‡
d˘_wsub


2875 #unde‡
d˘_bÊy32o


2876 #unde‡
d˘_∑ss


2877 
	}
}

2881 
	#STBI__MARKER_n⁄e
 0xff

	)

2885 
°bi_uc
 
	$°bi__gë_m¨kî
(
°bi__j≥g
 *
j
)

2887 
°bi_uc
 
x
;

2888 i‡(
j
->
m¨kî
 !
STBI__MARKER_n⁄e
Ë{ 
x
 = j->marker; j->marker = STBI__MARKER_none;  x; }

2889 
x
 = 
	`°bi__gë8
(
j
->
s
);

2890 i‡(
x
 !0xffË 
STBI__MARKER_n⁄e
;

2891 
x
 == 0xff)

2892 
x
 = 
	`°bi__gë8
(
j
->
s
);

2893  
x
;

2894 
	}
}

2898 
	#STBI__RESTART
(
x
Ë((xË>0xd0 && (xË<0xd7)

	)

2902 
	$°bi__j≥g_ª£t
(
°bi__j≥g
 *
j
)

2904 
j
->
code_bôs
 = 0;

2905 
j
->
code_buf„r
 = 0;

2906 
j
->
nom‹e
 = 0;

2907 
j
->
img_comp
[0].
dc_¥ed
 = j->img_comp[1].dc_pred = j->img_comp[2].dc_pred = j->img_comp[3].dc_pred = 0;

2908 
j
->
m¨kî
 = 
STBI__MARKER_n⁄e
;

2909 
j
->
todo
 = j->
ª°¨t_öãrvÆ
 ? j->restart_interval : 0x7fffffff;

2910 
j
->
eob_run
 = 0;

2913 
	}
}

2915 
	$°bi__∑r£_íå›y_coded_d©a
(
°bi__j≥g
 *
z
)

2917 
	`°bi__j≥g_ª£t
(
z
);

2918 i‡(!
z
->
¥ogªssive
) {

2919 i‡(
z
->
sˇn_n
 == 1) {

2920 
i
,
j
;

2921 
	`STBI_SIMD_ALIGN
(, 
d©a
[64]);

2922 
n
 = 
z
->
‹dî
[0];

2927 
w
 = (
z
->
img_comp
[
n
].
x
+7) >> 3;

2928 
h
 = (
z
->
img_comp
[
n
].
y
+7) >> 3;

2929 
j
=0; j < 
h
; ++j) {

2930 
i
=0; i < 
w
; ++i) {

2931 
ha
 = 
z
->
img_comp
[
n
].ha;

2932 i‡(!
	`°bi__j≥g_decode_block
(
z
, 
d©a
, z->
huff_dc
+z->
img_comp
[
n
].
hd
, z->
huff_ac
+
ha
, z->
Á°_ac
[ha],Ç, z->
dequ™t
[z->img_comp[n].
tq
]))  0;

2933 
z
->
	`id˘_block_kî√l
(z->
img_comp
[
n
].
d©a
+z->img_comp[n].
w2
*
j
*8+
i
*8, z->img_comp[n].w2, data);

2935 i‡(--
z
->
todo
 <= 0) {

2936 i‡(
z
->
code_bôs
 < 24Ë
	`°bi__grow_buf„r_unß„
(z);

2939 i‡(!
	`STBI__RESTART
(
z
->
m¨kî
))  1;

2940 
	`°bi__j≥g_ª£t
(
z
);

2946 
i
,
j
,
k
,
x
,
y
;

2947 
	`STBI_SIMD_ALIGN
(, 
d©a
[64]);

2948 
j
=0; j < 
z
->
img_mcu_y
; ++j) {

2949 
i
=0; i < 
z
->
img_mcu_x
; ++i) {

2951 
k
=0; k < 
z
->
sˇn_n
; ++k) {

2952 
n
 = 
z
->
‹dî
[
k
];

2955 
y
=0; y < 
z
->
img_comp
[
n
].
v
; ++y) {

2956 
x
=0; x < 
z
->
img_comp
[
n
].
h
; ++x) {

2957 
x2
 = (
i
*
z
->
img_comp
[
n
].
h
 + 
x
)*8;

2958 
y2
 = (
j
*
z
->
img_comp
[
n
].
v
 + 
y
)*8;

2959 
ha
 = 
z
->
img_comp
[
n
].ha;

2960 i‡(!
	`°bi__j≥g_decode_block
(
z
, 
d©a
, z->
huff_dc
+z->
img_comp
[
n
].
hd
, z->
huff_ac
+
ha
, z->
Á°_ac
[ha],Ç, z->
dequ™t
[z->img_comp[n].
tq
]))  0;

2961 
z
->
	`id˘_block_kî√l
(z->
img_comp
[
n
].
d©a
+z->img_comp[n].
w2
*
y2
+
x2
, z->img_comp[n].w2, data);

2967 i‡(--
z
->
todo
 <= 0) {

2968 i‡(
z
->
code_bôs
 < 24Ë
	`°bi__grow_buf„r_unß„
(z);

2969 i‡(!
	`STBI__RESTART
(
z
->
m¨kî
))  1;

2970 
	`°bi__j≥g_ª£t
(
z
);

2977 i‡(
z
->
sˇn_n
 == 1) {

2978 
i
,
j
;

2979 
n
 = 
z
->
‹dî
[0];

2984 
w
 = (
z
->
img_comp
[
n
].
x
+7) >> 3;

2985 
h
 = (
z
->
img_comp
[
n
].
y
+7) >> 3;

2986 
j
=0; j < 
h
; ++j) {

2987 
i
=0; i < 
w
; ++i) {

2988 *
d©a
 = 
z
->
img_comp
[
n
].
c€ff
 + 64 * (
i
 + 
j
 * z->img_comp[n].
c€ff_w
);

2989 i‡(
z
->
•ec_°¨t
 == 0) {

2990 i‡(!
	`°bi__j≥g_decode_block_¥og_dc
(
z
, 
d©a
, &z->
huff_dc
[z->
img_comp
[
n
].
hd
],Ç))

2993 
ha
 = 
z
->
img_comp
[
n
].ha;

2994 i‡(!
	`°bi__j≥g_decode_block_¥og_ac
(
z
, 
d©a
, &z->
huff_ac
[
ha
], z->
Á°_ac
[ha]))

2998 i‡(--
z
->
todo
 <= 0) {

2999 i‡(
z
->
code_bôs
 < 24Ë
	`°bi__grow_buf„r_unß„
(z);

3000 i‡(!
	`STBI__RESTART
(
z
->
m¨kî
))  1;

3001 
	`°bi__j≥g_ª£t
(
z
);

3007 
i
,
j
,
k
,
x
,
y
;

3008 
j
=0; j < 
z
->
img_mcu_y
; ++j) {

3009 
i
=0; i < 
z
->
img_mcu_x
; ++i) {

3011 
k
=0; k < 
z
->
sˇn_n
; ++k) {

3012 
n
 = 
z
->
‹dî
[
k
];

3015 
y
=0; y < 
z
->
img_comp
[
n
].
v
; ++y) {

3016 
x
=0; x < 
z
->
img_comp
[
n
].
h
; ++x) {

3017 
x2
 = (
i
*
z
->
img_comp
[
n
].
h
 + 
x
);

3018 
y2
 = (
j
*
z
->
img_comp
[
n
].
v
 + 
y
);

3019 *
d©a
 = 
z
->
img_comp
[
n
].
c€ff
 + 64 * (
x2
 + 
y2
 * z->img_comp[n].
c€ff_w
);

3020 i‡(!
	`°bi__j≥g_decode_block_¥og_dc
(
z
, 
d©a
, &z->
huff_dc
[z->
img_comp
[
n
].
hd
],Ç))

3027 i‡(--
z
->
todo
 <= 0) {

3028 i‡(
z
->
code_bôs
 < 24Ë
	`°bi__grow_buf„r_unß„
(z);

3029 i‡(!
	`STBI__RESTART
(
z
->
m¨kî
))  1;

3030 
	`°bi__j≥g_ª£t
(
z
);

3037 
	}
}

3039 
	$°bi__j≥g_dequ™tize
(*
d©a
, 
°bi__uöt16
 *
dequ™t
)

3041 
i
;

3042 
i
=0; i < 64; ++i)

3043 
d©a
[
i
] *
dequ™t
[i];

3044 
	}
}

3046 
	$°bi__j≥g_föish
(
°bi__j≥g
 *
z
)

3048 i‡(
z
->
¥ogªssive
) {

3050 
i
,
j
,
n
;

3051 
n
=0;Ç < 
z
->
s
->
img_n
; ++n) {

3052 
w
 = (
z
->
img_comp
[
n
].
x
+7) >> 3;

3053 
h
 = (
z
->
img_comp
[
n
].
y
+7) >> 3;

3054 
j
=0; j < 
h
; ++j) {

3055 
i
=0; i < 
w
; ++i) {

3056 *
d©a
 = 
z
->
img_comp
[
n
].
c€ff
 + 64 * (
i
 + 
j
 * z->img_comp[n].
c€ff_w
);

3057 
	`°bi__j≥g_dequ™tize
(
d©a
, 
z
->
dequ™t
[z->
img_comp
[
n
].
tq
]);

3058 
z
->
	`id˘_block_kî√l
(z->
img_comp
[
n
].
d©a
+z->img_comp[n].
w2
*
j
*8+
i
*8, z->img_comp[n].w2, data);

3063 
	}
}

3065 
	$°bi__¥o˚ss_m¨kî
(
°bi__j≥g
 *
z
, 
m
)

3067 
L
;

3068 
m
) {

3069 
STBI__MARKER_n⁄e
:

3070  
	`°bi__îr
("expected marker","Corrupt JPEG");

3073 i‡(
	`°bi__gë16be
(
z
->
s
Ë!4Ë 
	`°bi__îr
("bad DRIÜen","Corrupt JPEG");

3074 
z
->
ª°¨t_öãrvÆ
 = 
	`°bi__gë16be
(z->
s
);

3078 
L
 = 
	`°bi__gë16be
(
z
->
s
)-2;

3079 
L
 > 0) {

3080 
q
 = 
	`°bi__gë8
(
z
->
s
);

3081 
p
 = 
q
 >> 4, 
sixãí
 = (p != 0);

3082 
t
 = 
q
 & 15,
i
;

3083 i‡(
p
 !0 &&Ö !1Ë 
	`°bi__îr
("bad DQTÅype","Corrupt JPEG");

3084 i‡(
t
 > 3Ë 
	`°bi__îr
("bad DQTÅable","Corrupt JPEG");

3086 
i
=0; i < 64; ++i)

3087 
z
->
dequ™t
[
t
][
°bi__j≥g_dezigzag
[
i
]] = (
°bi__uöt16
)(
sixãí
 ? 
	`°bi__gë16be
(z->
s
Ë: 
	`°bi__gë8
(z->s));

3088 
L
 -(
sixãí
 ? 129 : 65);

3090  
L
==0;

3093 
L
 = 
	`°bi__gë16be
(
z
->
s
)-2;

3094 
L
 > 0) {

3095 
°bi_uc
 *
v
;

3096 
sizes
[16],
i
,
n
=0;

3097 
q
 = 
	`°bi__gë8
(
z
->
s
);

3098 
tc
 = 
q
 >> 4;

3099 
th
 = 
q
 & 15;

3100 i‡(
tc
 > 1 || 
th
 > 3Ë 
	`°bi__îr
("bad DHT header","Corrupt JPEG");

3101 
i
=0; i < 16; ++i) {

3102 
sizes
[
i
] = 
	`°bi__gë8
(
z
->
s
);

3103 
n
 +
sizes
[
i
];

3105 
L
 -= 17;

3106 i‡(
tc
 == 0) {

3107 i‡(!
	`°bi__buûd_huffm™
(
z
->
huff_dc
+
th
, 
sizes
))  0;

3108 
v
 = 
z
->
huff_dc
[
th
].
vÆues
;

3110 i‡(!
	`°bi__buûd_huffm™
(
z
->
huff_ac
+
th
, 
sizes
))  0;

3111 
v
 = 
z
->
huff_ac
[
th
].
vÆues
;

3113 
i
=0; i < 
n
; ++i)

3114 
v
[
i
] = 
	`°bi__gë8
(
z
->
s
);

3115 i‡(
tc
 != 0)

3116 
	`°bi__buûd_Á°_ac
(
z
->
Á°_ac
[
th
], z->
huff_ac
 +Åh);

3117 
L
 -
n
;

3119  
L
==0;

3123 i‡((
m
 >= 0xE0 && m <= 0xEF) || m == 0xFE) {

3124 
L
 = 
	`°bi__gë16be
(
z
->
s
);

3125 i‡(
L
 < 2) {

3126 i‡(
m
 == 0xFE)

3127  
	`°bi__îr
("bad COMÜen","Corrupt JPEG");

3129  
	`°bi__îr
("bad APPÜen","Corrupt JPEG");

3131 
L
 -= 2;

3133 i‡(
m
 =0xE0 && 
L
 >= 5) {

3134 c⁄° 
èg
[5] = {'J','F','I','F','\0'};

3135 
ok
 = 1;

3136 
i
;

3137 
i
=0; i < 5; ++i)

3138 i‡(
	`°bi__gë8
(
z
->
s
Ë!
èg
[
i
])

3139 
ok
 = 0;

3140 
L
 -= 5;

3141 i‡(
ok
)

3142 
z
->
jfif
 = 1;

3143 } i‡(
m
 =0xEE && 
L
 >= 12) {

3144 c⁄° 
èg
[6] = {'A','d','o','b','e','\0'};

3145 
ok
 = 1;

3146 
i
;

3147 
i
=0; i < 6; ++i)

3148 i‡(
	`°bi__gë8
(
z
->
s
Ë!
èg
[
i
])

3149 
ok
 = 0;

3150 
L
 -= 6;

3151 i‡(
ok
) {

3152 
	`°bi__gë8
(
z
->
s
);

3153 
	`°bi__gë16be
(
z
->
s
);

3154 
	`°bi__gë16be
(
z
->
s
);

3155 
z
->
≠p14_cﬁ‹_å™sf‹m
 = 
	`°bi__gë8
(z->
s
);

3156 
L
 -= 6;

3160 
	`°bi__skù
(
z
->
s
, 
L
);

3164  
	`°bi__îr
("unknown marker","Corrupt JPEG");

3165 
	}
}

3168 
	$°bi__¥o˚ss_sˇn_hódî
(
°bi__j≥g
 *
z
)

3170 
i
;

3171 
Ls
 = 
	`°bi__gë16be
(
z
->
s
);

3172 
z
->
sˇn_n
 = 
	`°bi__gë8
(z->
s
);

3173 i‡(
z
->
sˇn_n
 < 1 || z->sˇn_¿> 4 || z->sˇn_¿> (Ëz->
s
->
img_n
Ë 
	`°bi__îr
("bad SOS component count","Corrupt JPEG");

3174 i‡(
Ls
 !6+2*
z
->
sˇn_n
Ë 
	`°bi__îr
("bad SOSÜen","Corrupt JPEG");

3175 
i
=0; i < 
z
->
sˇn_n
; ++i) {

3176 
id
 = 
	`°bi__gë8
(
z
->
s
), 
which
;

3177 
q
 = 
	`°bi__gë8
(
z
->
s
);

3178 
which
 = 0; which < 
z
->
s
->
img_n
; ++which)

3179 i‡(
z
->
img_comp
[
which
].
id
 == id)

3181 i‡(
which
 =
z
->
s
->
img_n
)  0;

3182 
z
->
img_comp
[
which
].
hd
 = 
q
 >> 4; i‡(z->img_comp[which].hd > 3Ë 
	`°bi__îr
("bad DC huff","Corrupt JPEG");

3183 
z
->
img_comp
[
which
].
ha
 = 
q
 & 15; i‡(z->img_comp[which].h®> 3Ë 
	`°bi__îr
("bad AC huff","Corrupt JPEG");

3184 
z
->
‹dî
[
i
] = 
which
;

3188 
Ø
;

3189 
z
->
•ec_°¨t
 = 
	`°bi__gë8
(z->
s
);

3190 
z
->
•ec_íd
 = 
	`°bi__gë8
(z->
s
);

3191 
Ø
 = 
	`°bi__gë8
(
z
->
s
);

3192 
z
->
succ_high
 = (
Ø
 >> 4);

3193 
z
->
succ_low
 = (
Ø
 & 15);

3194 i‡(
z
->
¥ogªssive
) {

3195 i‡(
z
->
•ec_°¨t
 > 63 || z->
•ec_íd
 > 63 || z->•ec_°¨à> z->•ec_íd || z->
succ_high
 > 13 || z->
succ_low
 > 13)

3196  
	`°bi__îr
("bad SOS", "Corrupt JPEG");

3198 i‡(
z
->
•ec_°¨t
 !0Ë 
	`°bi__îr
("bad SOS","Corrupt JPEG");

3199 i‡(
z
->
succ_high
 !0 || z->
succ_low
 !0Ë 
	`°bi__îr
("bad SOS","Corrupt JPEG");

3200 
z
->
•ec_íd
 = 63;

3205 
	}
}

3207 
	$°bi__‰ì_j≥g_comp⁄íts
(
°bi__j≥g
 *
z
, 
ncomp
, 
why
)

3209 
i
;

3210 
i
=0; i < 
ncomp
; ++i) {

3211 i‡(
z
->
img_comp
[
i
].
øw_d©a
) {

3212 
	`STBI_FREE
(
z
->
img_comp
[
i
].
øw_d©a
);

3213 
z
->
img_comp
[
i
].
øw_d©a
 = 
NULL
;

3214 
z
->
img_comp
[
i
].
d©a
 = 
NULL
;

3216 i‡(
z
->
img_comp
[
i
].
øw_c€ff
) {

3217 
	`STBI_FREE
(
z
->
img_comp
[
i
].
øw_c€ff
);

3218 
z
->
img_comp
[
i
].
øw_c€ff
 = 0;

3219 
z
->
img_comp
[
i
].
c€ff
 = 0;

3221 i‡(
z
->
img_comp
[
i
].
löebuf
) {

3222 
	`STBI_FREE
(
z
->
img_comp
[
i
].
löebuf
);

3223 
z
->
img_comp
[
i
].
löebuf
 = 
NULL
;

3226  
why
;

3227 
	}
}

3229 
	$°bi__¥o˚ss_‰ame_hódî
(
°bi__j≥g
 *
z
, 
sˇn
)

3231 
°bi__c⁄ãxt
 *
s
 = 
z
->s;

3232 
Lf
,
p
,
i
,
q
, 
h_max
=1,
v_max
=1,
c
;

3233 
Lf
 = 
	`°bi__gë16be
(
s
); i‡(L‡< 11Ë 
	`°bi__îr
("bad SOFÜen","Corrupt JPEG");

3234 
p
 = 
	`°bi__gë8
(
s
); i‡’ !8Ë 
	`°bi__îr
("only 8-bit","JPEG formatÇot supported: 8-bit only");

3235 
s
->
img_y
 = 
	`°bi__gë16be
(s); i‡(s->img_y =0Ë 
	`°bi__îr
("no header height", "JPEG formatÇot supported: delayed height");

3236 
s
->
img_x
 = 
	`°bi__gë16be
(s); i‡(s->img_x =0Ë 
	`°bi__îr
("0 width","Corrupt JPEG");

3237 i‡(
s
->
img_y
 > 
STBI_MAX_DIMENSIONS
Ë 
	`°bi__îr
("tooÜarge","VeryÜarge image (corrupt?)");

3238 i‡(
s
->
img_x
 > 
STBI_MAX_DIMENSIONS
Ë 
	`°bi__îr
("tooÜarge","VeryÜarge image (corrupt?)");

3239 
c
 = 
	`°bi__gë8
(
s
);

3240 i‡(
c
 !3 && c !1 && c !4Ë 
	`°bi__îr
("bad component count","Corrupt JPEG");

3241 
s
->
img_n
 = 
c
;

3242 
i
=0; i < 
c
; ++i) {

3243 
z
->
img_comp
[
i
].
d©a
 = 
NULL
;

3244 
z
->
img_comp
[
i
].
löebuf
 = 
NULL
;

3247 i‡(
Lf
 !8+3*
s
->
img_n
Ë 
	`°bi__îr
("bad SOFÜen","Corrupt JPEG");

3249 
z
->
rgb
 = 0;

3250 
i
=0; i < 
s
->
img_n
; ++i) {

3251 c⁄° 
rgb
[3] = { 'R', 'G', 'B' };

3252 
z
->
img_comp
[
i
].
id
 = 
	`°bi__gë8
(
s
);

3253 i‡(
s
->
img_n
 =3 && 
z
->
img_comp
[
i
].
id
 =
rgb
[i])

3254 ++
z
->
rgb
;

3255 
q
 = 
	`°bi__gë8
(
s
);

3256 
z
->
img_comp
[
i
].
h
 = (
q
 >> 4); i‡(!z->img_comp[i].h || z->img_comp[i].h > 4Ë 
	`°bi__îr
("bad H","Corrupt JPEG");

3257 
z
->
img_comp
[
i
].
v
 = 
q
 & 15; i‡(!z->img_comp[i].v || z->img_comp[i].v > 4Ë 
	`°bi__îr
("bad V","Corrupt JPEG");

3258 
z
->
img_comp
[
i
].
tq
 = 
	`°bi__gë8
(
s
); i‡(z->img_comp[i].tq > 3Ë 
	`°bi__îr
("bad TQ","Corrupt JPEG");

3261 i‡(
sˇn
 !
STBI__SCAN_lﬂd
)  1;

3263 i‡(!
	`°bi__mad3sizes_vÆid
(
s
->
img_x
, s->
img_y
, s->
img_n
, 0)Ë 
	`°bi__îr
("tooÜarge", "ImageÅooÜargeÅo decode");

3265 
i
=0; i < 
s
->
img_n
; ++i) {

3266 i‡(
z
->
img_comp
[
i
].
h
 > 
h_max
) h_max = z->img_comp[i].h;

3267 i‡(
z
->
img_comp
[
i
].
v
 > 
v_max
) v_max = z->img_comp[i].v;

3272 
i
=0; i < 
s
->
img_n
; ++i) {

3273 i‡(
h_max
 % 
z
->
img_comp
[
i
].
h
 !0Ë 
	`°bi__îr
("bad H","Corrupt JPEG");

3274 i‡(
v_max
 % 
z
->
img_comp
[
i
].
v
 !0Ë 
	`°bi__îr
("bad V","Corrupt JPEG");

3278 
z
->
img_h_max
 = 
h_max
;

3279 
z
->
img_v_max
 = 
v_max
;

3280 
z
->
img_mcu_w
 = 
h_max
 * 8;

3281 
z
->
img_mcu_h
 = 
v_max
 * 8;

3283 
z
->
img_mcu_x
 = (
s
->
img_x
 + z->
img_mcu_w
-1) / z->img_mcu_w;

3284 
z
->
img_mcu_y
 = (
s
->
img_y
 + z->
img_mcu_h
-1) / z->img_mcu_h;

3286 
i
=0; i < 
s
->
img_n
; ++i) {

3288 
z
->
img_comp
[
i
].
x
 = (
s
->
img_x
 * z->img_comp[i].
h
 + 
h_max
-1) / h_max;

3289 
z
->
img_comp
[
i
].
y
 = (
s
->
img_y
 * z->img_comp[i].
v
 + 
v_max
-1) / v_max;

3297 
z
->
img_comp
[
i
].
w2
 = z->
img_mcu_x
 * z->img_comp[i].
h
 * 8;

3298 
z
->
img_comp
[
i
].
h2
 = z->
img_mcu_y
 * z->img_comp[i].
v
 * 8;

3299 
z
->
img_comp
[
i
].
c€ff
 = 0;

3300 
z
->
img_comp
[
i
].
øw_c€ff
 = 0;

3301 
z
->
img_comp
[
i
].
löebuf
 = 
NULL
;

3302 
z
->
img_comp
[
i
].
øw_d©a
 = 
	`°bi__mÆloc_mad2
(z->img_comp[i].
w2
, z->img_comp[i].
h2
, 15);

3303 i‡(
z
->
img_comp
[
i
].
øw_d©a
 =
NULL
)

3304  
	`°bi__‰ì_j≥g_comp⁄íts
(
z
, 
i
+1, 
	`°bi__îr
("outofmem", "Out of memory"));

3306 
z
->
img_comp
[
i
].
d©a
 = (
°bi_uc
*Ë(((
size_t
Ëz->img_comp[i].
øw_d©a
 + 15) & ~15);

3307 i‡(
z
->
¥ogªssive
) {

3309 
z
->
img_comp
[
i
].
c€ff_w
 = z->img_comp[i].
w2
 / 8;

3310 
z
->
img_comp
[
i
].
c€ff_h
 = z->img_comp[i].
h2
 / 8;

3311 
z
->
img_comp
[
i
].
øw_c€ff
 = 
	`°bi__mÆloc_mad3
(z->img_comp[i].
w2
, z->img_comp[i].
h2
, (), 15);

3312 i‡(
z
->
img_comp
[
i
].
øw_c€ff
 =
NULL
)

3313  
	`°bi__‰ì_j≥g_comp⁄íts
(
z
, 
i
+1, 
	`°bi__îr
("outofmem", "Out of memory"));

3314 
z
->
img_comp
[
i
].
c€ff
 = (*Ë(((
size_t
Ëz->img_comp[i].
øw_c€ff
 + 15) & ~15);

3319 
	}
}

3322 
	#°bi__DNL
(
x
Ë((xË=0xdc)

	)

3323 
	#°bi__SOI
(
x
Ë((xË=0xd8)

	)

3324 
	#°bi__EOI
(
x
Ë((xË=0xd9)

	)

3325 
	#°bi__SOF
(
x
Ë((xË=0xc0 || (xË=0xc1 || (xË=0xc2)

	)

3326 
	#°bi__SOS
(
x
Ë((xË=0xda)

	)

3328 
	#°bi__SOF_¥ogªssive
(
x
Ë((xË=0xc2)

	)

3330 
	$°bi__decode_j≥g_hódî
(
°bi__j≥g
 *
z
, 
sˇn
)

3332 
m
;

3333 
z
->
jfif
 = 0;

3334 
z
->
≠p14_cﬁ‹_å™sf‹m
 = -1;

3335 
z
->
m¨kî
 = 
STBI__MARKER_n⁄e
;

3336 
m
 = 
	`°bi__gë_m¨kî
(
z
);

3337 i‡(!
	`°bi__SOI
(
m
)Ë 
	`°bi__îr
("no SOI","Corrupt JPEG");

3338 i‡(
sˇn
 =
STBI__SCAN_ty≥
)  1;

3339 
m
 = 
	`°bi__gë_m¨kî
(
z
);

3340 !
	`°bi__SOF
(
m
)) {

3341 i‡(!
	`°bi__¥o˚ss_m¨kî
(
z
,
m
))  0;

3342 
m
 = 
	`°bi__gë_m¨kî
(
z
);

3343 
m
 =
STBI__MARKER_n⁄e
) {

3345 i‡(
	`°bi__©_eof
(
z
->
s
)Ë 
	`°bi__îr
("no SOF", "Corrupt JPEG");

3346 
m
 = 
	`°bi__gë_m¨kî
(
z
);

3349 
z
->
¥ogªssive
 = 
	`°bi__SOF_¥ogªssive
(
m
);

3350 i‡(!
	`°bi__¥o˚ss_‰ame_hódî
(
z
, 
sˇn
))  0;

3352 
	}
}

3355 
	$°bi__decode_j≥g_image
(
°bi__j≥g
 *
j
)

3357 
m
;

3358 
m
 = 0; m < 4; m++) {

3359 
j
->
img_comp
[
m
].
øw_d©a
 = 
NULL
;

3360 
j
->
img_comp
[
m
].
øw_c€ff
 = 
NULL
;

3362 
j
->
ª°¨t_öãrvÆ
 = 0;

3363 i‡(!
	`°bi__decode_j≥g_hódî
(
j
, 
STBI__SCAN_lﬂd
))  0;

3364 
m
 = 
	`°bi__gë_m¨kî
(
j
);

3365 !
	`°bi__EOI
(
m
)) {

3366 i‡(
	`°bi__SOS
(
m
)) {

3367 i‡(!
	`°bi__¥o˚ss_sˇn_hódî
(
j
))  0;

3368 i‡(!
	`°bi__∑r£_íå›y_coded_d©a
(
j
))  0;

3369 i‡(
j
->
m¨kî
 =
STBI__MARKER_n⁄e
 ) {

3371 !
	`°bi__©_eof
(
j
->
s
)) {

3372 
x
 = 
	`°bi__gë8
(
j
->
s
);

3373 i‡(
x
 == 255) {

3374 
j
->
m¨kî
 = 
	`°bi__gë8
(j->
s
);

3380 } i‡(
	`°bi__DNL
(
m
)) {

3381 
Ld
 = 
	`°bi__gë16be
(
j
->
s
);

3382 
°bi__uöt32
 
NL
 = 
	`°bi__gë16be
(
j
->
s
);

3383 i‡(
Ld
 !4Ë 
	`°bi__îr
("bad DNLÜen", "Corrupt JPEG");

3384 i‡(
NL
 !
j
->
s
->
img_y
Ë 
	`°bi__îr
("bad DNL height", "Corrupt JPEG");

3386 i‡(!
	`°bi__¥o˚ss_m¨kî
(
j
, 
m
))  0;

3388 
m
 = 
	`°bi__gë_m¨kî
(
j
);

3390 i‡(
j
->
¥ogªssive
)

3391 
	`°bi__j≥g_föish
(
j
);

3393 
	}
}

3397 
	g°bi_uc
 *(*
	tªßm∂e_row_func
)(
	t°bi_uc
 *
	tout
, stbi_u¯*
	tö0
, stbi_u¯*
	tö1
,

3398 
	tw
, 
	ths
);

3400 
	#°bi__div4
(
x
Ë((
°bi_uc
Ë((xË>> 2))

	)

3402 
°bi_uc
 *
	$ªßm∂e_row_1
(
°bi_uc
 *
out
, stbi_u¯*
ö_√¨
, stbi_u¯*
ö_Ár
, 
w
, 
hs
)

3404 
	`STBI_NOTUSED
(
out
);

3405 
	`STBI_NOTUSED
(
ö_Ár
);

3406 
	`STBI_NOTUSED
(
w
);

3407 
	`STBI_NOTUSED
(
hs
);

3408  
ö_√¨
;

3409 
	}
}

3411 
°bi_uc
* 
	$°bi__ªßm∂e_row_v_2
(
°bi_uc
 *
out
, stbi_u¯*
ö_√¨
, stbi_u¯*
ö_Ár
, 
w
, 
hs
)

3414 
i
;

3415 
	`STBI_NOTUSED
(
hs
);

3416 
i
=0; i < 
w
; ++i)

3417 
out
[
i
] = 
	`°bi__div4
(3*
ö_√¨
[i] + 
ö_Ár
[i] + 2);

3418  
out
;

3419 
	}
}

3421 
°bi_uc
* 
	$°bi__ªßm∂e_row_h_2
(
°bi_uc
 *
out
, stbi_u¯*
ö_√¨
, stbi_u¯*
ö_Ár
, 
w
, 
hs
)

3424 
i
;

3425 
°bi_uc
 *
öput
 = 
ö_√¨
;

3427 i‡(
w
 == 1) {

3429 
out
[0] = out[1] = 
öput
[0];

3430  
out
;

3433 
out
[0] = 
öput
[0];

3434 
out
[1] = 
	`°bi__div4
(
öput
[0]*3 + input[1] + 2);

3435 
i
=1; i < 
w
-1; ++i) {

3436 
n
 = 3*
öput
[
i
]+2;

3437 
out
[
i
*2+0] = 
	`°bi__div4
(
n
+
öput
[i-1]);

3438 
out
[
i
*2+1] = 
	`°bi__div4
(
n
+
öput
[i+1]);

3440 
out
[
i
*2+0] = 
	`°bi__div4
(
öput
[
w
-2]*3 + input[w-1] + 2);

3441 
out
[
i
*2+1] = 
öput
[
w
-1];

3443 
	`STBI_NOTUSED
(
ö_Ár
);

3444 
	`STBI_NOTUSED
(
hs
);

3446  
out
;

3447 
	}
}

3449 
	#°bi__div16
(
x
Ë((
°bi_uc
Ë((xË>> 4))

	)

3451 
°bi_uc
 *
	$°bi__ªßm∂e_row_hv_2
(
°bi_uc
 *
out
, stbi_u¯*
ö_√¨
, stbi_u¯*
ö_Ár
, 
w
, 
hs
)

3454 
i
,
t0
,
t1
;

3455 i‡(
w
 == 1) {

3456 
out
[0] = out[1] = 
	`°bi__div4
(3*
ö_√¨
[0] + 
ö_Ár
[0] + 2);

3457  
out
;

3460 
t1
 = 3*
ö_√¨
[0] + 
ö_Ár
[0];

3461 
out
[0] = 
	`°bi__div4
(
t1
+2);

3462 
i
=1; i < 
w
; ++i) {

3463 
t0
 = 
t1
;

3464 
t1
 = 3*
ö_√¨
[
i
]+
ö_Ár
[i];

3465 
out
[
i
*2-1] = 
	`°bi__div16
(3*
t0
 + 
t1
 + 8);

3466 
out
[
i
*2 ] = 
	`°bi__div16
(3*
t1
 + 
t0
 + 8);

3468 
out
[
w
*2-1] = 
	`°bi__div4
(
t1
+2);

3470 
	`STBI_NOTUSED
(
hs
);

3472  
out
;

3473 
	}
}

3475 #i‡
deföed
(
STBI_SSE2
Ë|| deföed(
STBI_NEON
)

3476 
°bi_uc
 *
	$°bi__ªßm∂e_row_hv_2_simd
(
°bi_uc
 *
out
, stbi_u¯*
ö_√¨
, stbi_u¯*
ö_Ár
, 
w
, 
hs
)

3479 
i
=0,
t0
,
t1
;

3481 i‡(
w
 == 1) {

3482 
out
[0] = out[1] = 
	`°bi__div4
(3*
ö_√¨
[0] + 
ö_Ár
[0] + 2);

3483  
out
;

3486 
t1
 = 3*
ö_√¨
[0] + 
ö_Ár
[0];

3490 ; 
i
 < ((
w
-1) & ~7); i += 8) {

3491 #i‡
	`deföed
(
STBI_SSE2
)

3494 
__m128i
 
zîo
 = 
	`_mm_£tzîo_si128
();

3495 
__m128i
 
Árb
 = 
	`_mm_lﬂdl_ïi64
((__m128ò*Ë(
ö_Ár
 + 
i
));

3496 
__m128i
 
√¨b
 = 
	`_mm_lﬂdl_ïi64
((__m128ò*Ë(
ö_√¨
 + 
i
));

3497 
__m128i
 
Árw
 = 
	`_mm_u≈acklo_ïi8
(
Árb
, 
zîo
);

3498 
__m128i
 
√¨w
 = 
	`_mm_u≈acklo_ïi8
(
√¨b
, 
zîo
);

3499 
__m128i
 
diff
 = 
	`_mm_sub_ïi16
(
Árw
, 
√¨w
);

3500 
__m128i
 
√¨s
 = 
	`_mm_¶li_ïi16
(
√¨w
, 2);

3501 
__m128i
 
cuº
 = 
	`_mm_add_ïi16
(
√¨s
, 
diff
);

3508 
__m128i
 
¥v0
 = 
	`_mm_¶li_si128
(
cuº
, 2);

3509 
__m128i
 
nxt0
 = 
	`_mm_§li_si128
(
cuº
, 2);

3510 
__m128i
 
¥ev
 = 
	`_mm_ö£π_ïi16
(
¥v0
, 
t1
, 0);

3511 
__m128i
 
√xt
 = 
	`_mm_ö£π_ïi16
(
nxt0
, 3*
ö_√¨
[
i
+8] + 
ö_Ár
[i+8], 7);

3517 
__m128i
 
büs
 = 
	`_mm_£t1_ïi16
(8);

3518 
__m128i
 
curs
 = 
	`_mm_¶li_ïi16
(
cuº
, 2);

3519 
__m128i
 
¥vd
 = 
	`_mm_sub_ïi16
(
¥ev
, 
cuº
);

3520 
__m128i
 
nxtd
 = 
	`_mm_sub_ïi16
(
√xt
, 
cuº
);

3521 
__m128i
 
curb
 = 
	`_mm_add_ïi16
(
curs
, 
büs
);

3522 
__m128i
 
eví
 = 
	`_mm_add_ïi16
(
¥vd
, 
curb
);

3523 
__m128i
 
odd
 = 
	`_mm_add_ïi16
(
nxtd
, 
curb
);

3526 
__m128i
 
öt0
 = 
	`_mm_u≈acklo_ïi16
(
eví
, 
odd
);

3527 
__m128i
 
öt1
 = 
	`_mm_u≈ackhi_ïi16
(
eví
, 
odd
);

3528 
__m128i
 
de0
 = 
	`_mm_§li_ïi16
(
öt0
, 4);

3529 
__m128i
 
de1
 = 
	`_mm_§li_ïi16
(
öt1
, 4);

3532 
__m128i
 
outv
 = 
	`_mm_∑ckus_ïi16
(
de0
, 
de1
);

3533 
	`_mm_°‹eu_si128
((
__m128i
 *Ë(
out
 + 
i
*2), 
outv
);

3534 #ñi‡
	`deföed
(
STBI_NEON
)

3537 
uöt8x8_t
 
Árb
 = 
	`vld1_u8
(
ö_Ár
 + 
i
);

3538 
uöt8x8_t
 
√¨b
 = 
	`vld1_u8
(
ö_√¨
 + 
i
);

3539 
öt16x8_t
 
diff
 = 
	`vªöãΩªtq_s16_u16
(
	`vsubl_u8
(
Árb
, 
√¨b
));

3540 
öt16x8_t
 
√¨s
 = 
	`vªöãΩªtq_s16_u16
(
	`vshŒ_n_u8
(
√¨b
, 2));

3541 
öt16x8_t
 
cuº
 = 
	`vaddq_s16
(
√¨s
, 
diff
);

3548 
öt16x8_t
 
¥v0
 = 
	`vextq_s16
(
cuº
, curr, 7);

3549 
öt16x8_t
 
nxt0
 = 
	`vextq_s16
(
cuº
, curr, 1);

3550 
öt16x8_t
 
¥ev
 = 
	`v£tq_œ√_s16
(
t1
, 
¥v0
, 0);

3551 
öt16x8_t
 
√xt
 = 
	`v£tq_œ√_s16
(3*
ö_√¨
[
i
+8] + 
ö_Ár
[i+8], 
nxt0
, 7);

3557 
öt16x8_t
 
curs
 = 
	`vshlq_n_s16
(
cuº
, 2);

3558 
öt16x8_t
 
¥vd
 = 
	`vsubq_s16
(
¥ev
, 
cuº
);

3559 
öt16x8_t
 
nxtd
 = 
	`vsubq_s16
(
√xt
, 
cuº
);

3560 
öt16x8_t
 
eví
 = 
	`vaddq_s16
(
curs
, 
¥vd
);

3561 
öt16x8_t
 
odd
 = 
	`vaddq_s16
(
curs
, 
nxtd
);

3564 
uöt8x8x2_t
 
o
;

3565 
o
.
vÆ
[0] = 
	`vqrshrun_n_s16
(
eví
, 4);

3566 
o
.
vÆ
[1] = 
	`vqrshrun_n_s16
(
odd
, 4);

3567 
	`v°2_u8
(
out
 + 
i
*2, 
o
);

3571 
t1
 = 3*
ö_√¨
[
i
+7] + 
ö_Ár
[i+7];

3574 
t0
 = 
t1
;

3575 
t1
 = 3*
ö_√¨
[
i
] + 
ö_Ár
[i];

3576 
out
[
i
*2] = 
	`°bi__div16
(3*
t1
 + 
t0
 + 8);

3578 ++
i
; i < 
w
; ++i) {

3579 
t0
 = 
t1
;

3580 
t1
 = 3*
ö_√¨
[
i
]+
ö_Ár
[i];

3581 
out
[
i
*2-1] = 
	`°bi__div16
(3*
t0
 + 
t1
 + 8);

3582 
out
[
i
*2 ] = 
	`°bi__div16
(3*
t1
 + 
t0
 + 8);

3584 
out
[
w
*2-1] = 
	`°bi__div4
(
t1
+2);

3586 
	`STBI_NOTUSED
(
hs
);

3588  
out
;

3589 
	}
}

3592 
°bi_uc
 *
	$°bi__ªßm∂e_row_gíîic
(
°bi_uc
 *
out
, stbi_u¯*
ö_√¨
, stbi_u¯*
ö_Ár
, 
w
, 
hs
)

3595 
i
,
j
;

3596 
	`STBI_NOTUSED
(
ö_Ár
);

3597 
i
=0; i < 
w
; ++i)

3598 
j
=0; j < 
hs
; ++j)

3599 
out
[
i
*
hs
+
j
] = 
ö_√¨
[i];

3600  
out
;

3601 
	}
}

3605 
	#°bi__Êﬂt2fixed
(
x
Ë(((Ë((xË* 4096.0‡+ 0.5f)Ë<< 8)

	)

3606 
	$°bi__YCbCr_to_RGB_row
(
°bi_uc
 *
out
, c⁄° stbi_u¯*
y
, c⁄° stbi_u¯*
pcb
, c⁄° stbi_u¯*
p¸
, 
cou¡
, 
°ï
)

3608 
i
;

3609 
i
=0; i < 
cou¡
; ++i) {

3610 
y_fixed
 = (
y
[
i
] << 20) + (1<<19);

3611 
r
,
g
,
b
;

3612 
¸
 = 
p¸
[
i
] - 128;

3613 
cb
 = 
pcb
[
i
] - 128;

3614 
r
 = 
y_fixed
 + 
¸
* 
	`°bi__Êﬂt2fixed
(1.40200f);

3615 
g
 = 
y_fixed
 + (
¸
*-
	`°bi__Êﬂt2fixed
(0.71414f)Ë+ ((
cb
*-stbi__float2fixed(0.34414f)) & 0xffff0000);

3616 
b
 = 
y_fixed
 + 
cb
* 
	`°bi__Êﬂt2fixed
(1.77200f);

3617 
r
 >>= 20;

3618 
g
 >>= 20;

3619 
b
 >>= 20;

3620 i‡((Ë
r
 > 255) { if (r < 0)Ñ = 0; r = 255; }

3621 i‡((Ë
g
 > 255) { if (g < 0) g = 0; g = 255; }

3622 i‡((Ë
b
 > 255) { if (b < 0) b = 0; b = 255; }

3623 
out
[0] = (
°bi_uc
)
r
;

3624 
out
[1] = (
°bi_uc
)
g
;

3625 
out
[2] = (
°bi_uc
)
b
;

3626 
out
[3] = 255;

3627 
out
 +
°ï
;

3629 
	}
}

3631 #i‡
deföed
(
STBI_SSE2
Ë|| deföed(
STBI_NEON
)

3632 
	$°bi__YCbCr_to_RGB_simd
(
°bi_uc
 *
out
, stbi_u¯c⁄° *
y
, stbi_u¯c⁄° *
pcb
, stbi_u¯c⁄° *
p¸
, 
cou¡
, 
°ï
)

3634 
i
 = 0;

3636 #ifde‡
STBI_SSE2


3640 i‡(
°ï
 == 4) {

3642 
__m128i
 
signÊù
 = 
	`_mm_£t1_ïi8
(-0x80);

3643 
__m128i
 
¸_c⁄°0
 = 
	`_mm_£t1_ïi16
( () ( 1.40200f*4096.0f+0.5f));

3644 
__m128i
 
¸_c⁄°1
 = 
	`_mm_£t1_ïi16
( - () ( 0.71414f*4096.0f+0.5f));

3645 
__m128i
 
cb_c⁄°0
 = 
	`_mm_£t1_ïi16
( - () ( 0.34414f*4096.0f+0.5f));

3646 
__m128i
 
cb_c⁄°1
 = 
	`_mm_£t1_ïi16
( () ( 1.77200f*4096.0f+0.5f));

3647 
__m128i
 
y_büs
 = 
	`_mm_£t1_ïi8
(() () 128);

3648 
__m128i
 
xw
 = 
	`_mm_£t1_ïi16
(255);

3650 ; 
i
+7 < 
cou¡
; i += 8) {

3652 
__m128i
 
y_byãs
 = 
	`_mm_lﬂdl_ïi64
((__m128ò*Ë(
y
+
i
));

3653 
__m128i
 
¸_byãs
 = 
	`_mm_lﬂdl_ïi64
((__m128ò*Ë(
p¸
+
i
));

3654 
__m128i
 
cb_byãs
 = 
	`_mm_lﬂdl_ïi64
((__m128ò*Ë(
pcb
+
i
));

3655 
__m128i
 
¸_bü£d
 = 
	`_mm_x‹_si128
(
¸_byãs
, 
signÊù
);

3656 
__m128i
 
cb_bü£d
 = 
	`_mm_x‹_si128
(
cb_byãs
, 
signÊù
);

3659 
__m128i
 
yw
 = 
	`_mm_u≈acklo_ïi8
(
y_büs
, 
y_byãs
);

3660 
__m128i
 
¸w
 = 
	`_mm_u≈acklo_ïi8
(
	`_mm_£tzîo_si128
(), 
¸_bü£d
);

3661 
__m128i
 
cbw
 = 
	`_mm_u≈acklo_ïi8
(
	`_mm_£tzîo_si128
(), 
cb_bü£d
);

3664 
__m128i
 
yws
 = 
	`_mm_§li_ïi16
(
yw
, 4);

3665 
__m128i
 
¸0
 = 
	`_mm_mulhi_ïi16
(
¸_c⁄°0
, 
¸w
);

3666 
__m128i
 
cb0
 = 
	`_mm_mulhi_ïi16
(
cb_c⁄°0
, 
cbw
);

3667 
__m128i
 
cb1
 = 
	`_mm_mulhi_ïi16
(
cbw
, 
cb_c⁄°1
);

3668 
__m128i
 
¸1
 = 
	`_mm_mulhi_ïi16
(
¸w
, 
¸_c⁄°1
);

3669 
__m128i
 
rws
 = 
	`_mm_add_ïi16
(
¸0
, 
yws
);

3670 
__m128i
 
gwt
 = 
	`_mm_add_ïi16
(
cb0
, 
yws
);

3671 
__m128i
 
bws
 = 
	`_mm_add_ïi16
(
yws
, 
cb1
);

3672 
__m128i
 
gws
 = 
	`_mm_add_ïi16
(
gwt
, 
¸1
);

3675 
__m128i
 
rw
 = 
	`_mm_§ai_ïi16
(
rws
, 4);

3676 
__m128i
 
bw
 = 
	`_mm_§ai_ïi16
(
bws
, 4);

3677 
__m128i
 
gw
 = 
	`_mm_§ai_ïi16
(
gws
, 4);

3680 
__m128i
 
brb
 = 
	`_mm_∑ckus_ïi16
(
rw
, 
bw
);

3681 
__m128i
 
gxb
 = 
	`_mm_∑ckus_ïi16
(
gw
, 
xw
);

3684 
__m128i
 
t0
 = 
	`_mm_u≈acklo_ïi8
(
brb
, 
gxb
);

3685 
__m128i
 
t1
 = 
	`_mm_u≈ackhi_ïi8
(
brb
, 
gxb
);

3686 
__m128i
 
o0
 = 
	`_mm_u≈acklo_ïi16
(
t0
, 
t1
);

3687 
__m128i
 
o1
 = 
	`_mm_u≈ackhi_ïi16
(
t0
, 
t1
);

3690 
	`_mm_°‹eu_si128
((
__m128i
 *Ë(
out
 + 0), 
o0
);

3691 
	`_mm_°‹eu_si128
((
__m128i
 *Ë(
out
 + 16), 
o1
);

3692 
out
 += 32;

3697 #ifde‡
STBI_NEON


3699 i‡(
°ï
 == 4) {

3701 
uöt8x8_t
 
signÊù
 = 
	`vdup_n_u8
(0x80);

3702 
öt16x8_t
 
¸_c⁄°0
 = 
	`vdupq_n_s16
( () ( 1.40200f*4096.0f+0.5f));

3703 
öt16x8_t
 
¸_c⁄°1
 = 
	`vdupq_n_s16
( - () ( 0.71414f*4096.0f+0.5f));

3704 
öt16x8_t
 
cb_c⁄°0
 = 
	`vdupq_n_s16
( - () ( 0.34414f*4096.0f+0.5f));

3705 
öt16x8_t
 
cb_c⁄°1
 = 
	`vdupq_n_s16
( () ( 1.77200f*4096.0f+0.5f));

3707 ; 
i
+7 < 
cou¡
; i += 8) {

3709 
uöt8x8_t
 
y_byãs
 = 
	`vld1_u8
(
y
 + 
i
);

3710 
uöt8x8_t
 
¸_byãs
 = 
	`vld1_u8
(
p¸
 + 
i
);

3711 
uöt8x8_t
 
cb_byãs
 = 
	`vld1_u8
(
pcb
 + 
i
);

3712 
öt8x8_t
 
¸_bü£d
 = 
	`vªöãΩªt_s8_u8
(
	`vsub_u8
(
¸_byãs
, 
signÊù
));

3713 
öt8x8_t
 
cb_bü£d
 = 
	`vªöãΩªt_s8_u8
(
	`vsub_u8
(
cb_byãs
, 
signÊù
));

3716 
öt16x8_t
 
yws
 = 
	`vªöãΩªtq_s16_u16
(
	`vshŒ_n_u8
(
y_byãs
, 4));

3717 
öt16x8_t
 
¸w
 = 
	`vshŒ_n_s8
(
¸_bü£d
, 7);

3718 
öt16x8_t
 
cbw
 = 
	`vshŒ_n_s8
(
cb_bü£d
, 7);

3721 
öt16x8_t
 
¸0
 = 
	`vqdmulhq_s16
(
¸w
, 
¸_c⁄°0
);

3722 
öt16x8_t
 
cb0
 = 
	`vqdmulhq_s16
(
cbw
, 
cb_c⁄°0
);

3723 
öt16x8_t
 
¸1
 = 
	`vqdmulhq_s16
(
¸w
, 
¸_c⁄°1
);

3724 
öt16x8_t
 
cb1
 = 
	`vqdmulhq_s16
(
cbw
, 
cb_c⁄°1
);

3725 
öt16x8_t
 
rws
 = 
	`vaddq_s16
(
yws
, 
¸0
);

3726 
öt16x8_t
 
gws
 = 
	`vaddq_s16
(vaddq_s16(
yws
, 
cb0
), 
¸1
);

3727 
öt16x8_t
 
bws
 = 
	`vaddq_s16
(
yws
, 
cb1
);

3730 
uöt8x8x4_t
 
o
;

3731 
o
.
vÆ
[0] = 
	`vqrshrun_n_s16
(
rws
, 4);

3732 
o
.
vÆ
[1] = 
	`vqrshrun_n_s16
(
gws
, 4);

3733 
o
.
vÆ
[2] = 
	`vqrshrun_n_s16
(
bws
, 4);

3734 
o
.
vÆ
[3] = 
	`vdup_n_u8
(255);

3737 
	`v°4_u8
(
out
, 
o
);

3738 
out
 += 8*4;

3743 ; 
i
 < 
cou¡
; ++i) {

3744 
y_fixed
 = (
y
[
i
] << 20) + (1<<19);

3745 
r
,
g
,
b
;

3746 
¸
 = 
p¸
[
i
] - 128;

3747 
cb
 = 
pcb
[
i
] - 128;

3748 
r
 = 
y_fixed
 + 
¸
* 
	`°bi__Êﬂt2fixed
(1.40200f);

3749 
g
 = 
y_fixed
 + 
¸
*-
	`°bi__Êﬂt2fixed
(0.71414fË+ ((
cb
*-stbi__float2fixed(0.34414f)) & 0xffff0000);

3750 
b
 = 
y_fixed
 + 
cb
* 
	`°bi__Êﬂt2fixed
(1.77200f);

3751 
r
 >>= 20;

3752 
g
 >>= 20;

3753 
b
 >>= 20;

3754 i‡((Ë
r
 > 255) { if (r < 0)Ñ = 0; r = 255; }

3755 i‡((Ë
g
 > 255) { if (g < 0) g = 0; g = 255; }

3756 i‡((Ë
b
 > 255) { if (b < 0) b = 0; b = 255; }

3757 
out
[0] = (
°bi_uc
)
r
;

3758 
out
[1] = (
°bi_uc
)
g
;

3759 
out
[2] = (
°bi_uc
)
b
;

3760 
out
[3] = 255;

3761 
out
 +
°ï
;

3763 
	}
}

3767 
	$°bi__£tup_j≥g
(
°bi__j≥g
 *
j
)

3769 
j
->
id˘_block_kî√l
 = 
°bi__id˘_block
;

3770 
j
->
YCbCr_to_RGB_kî√l
 = 
°bi__YCbCr_to_RGB_row
;

3771 
j
->
ªßm∂e_row_hv_2_kî√l
 = 
°bi__ªßm∂e_row_hv_2
;

3773 #ifde‡
STBI_SSE2


3774 i‡(
	`°bi__s£2_avaûabÀ
()) {

3775 
j
->
id˘_block_kî√l
 = 
°bi__id˘_simd
;

3776 
j
->
YCbCr_to_RGB_kî√l
 = 
°bi__YCbCr_to_RGB_simd
;

3777 
j
->
ªßm∂e_row_hv_2_kî√l
 = 
°bi__ªßm∂e_row_hv_2_simd
;

3781 #ifde‡
STBI_NEON


3782 
j
->
id˘_block_kî√l
 = 
°bi__id˘_simd
;

3783 
j
->
YCbCr_to_RGB_kî√l
 = 
°bi__YCbCr_to_RGB_simd
;

3784 
j
->
ªßm∂e_row_hv_2_kî√l
 = 
°bi__ªßm∂e_row_hv_2_simd
;

3786 
	}
}

3789 
	$°bi__˛ónup_j≥g
(
°bi__j≥g
 *
j
)

3791 
	`°bi__‰ì_j≥g_comp⁄íts
(
j
, j->
s
->
img_n
, 0);

3792 
	}
}

3796 
ªßm∂e_row_func
 
	mªßm∂e
;

3797 
°bi_uc
 *
	mlöe0
,*
	mlöe1
;

3798 
	mhs
,
	mvs
;

3799 
	mw_l‹es
;

3800 
	my°ï
;

3801 
	mypos
;

3802 } 
	t°bi__ªßm∂e
;

3805 
°bi_uc
 
	$°bi__blön_8x8
(
°bi_uc
 
x
, stbi_u¯
y
)

3807 
t
 = 
x
*
y
 + 128;

3808  (
°bi_uc
Ë((
t
 + (t >>8)) >> 8);

3809 
	}
}

3811 
°bi_uc
 *
	$lﬂd_j≥g_image
(
°bi__j≥g
 *
z
, *
out_x
, *
out_y
, *
comp
, 
ªq_comp
)

3813 
n
, 
decode_n
, 
is_rgb
;

3814 
z
->
s
->
img_n
 = 0;

3817 i‡(
ªq_comp
 < 0 ||Ñeq_com∞> 4Ë 
	`°bi__îΩuc
("badÑeq_comp", "InternalÉrror");

3820 i‡(!
	`°bi__decode_j≥g_image
(
z
)Ë{ 
	`°bi__˛ónup_j≥g
(z);  
NULL
; }

3823 
n
 = 
ªq_comp
 ?Ñeq_com∞: 
z
->
s
->
img_n
 >= 3 ? 3 : 1;

3825 
is_rgb
 = 
z
->
s
->
img_n
 =3 && (z->
rgb
 =3 || (z->
≠p14_cﬁ‹_å™sf‹m
 =0 && !z->
jfif
));

3827 i‡(
z
->
s
->
img_n
 =3 && 
n
 < 3 && !
is_rgb
)

3828 
decode_n
 = 1;

3830 
decode_n
 = 
z
->
s
->
img_n
;

3834 i‡(
decode_n
 <0Ë{ 
	`°bi__˛ónup_j≥g
(
z
);  
NULL
; }

3838 
k
;

3839 
i
,
j
;

3840 
°bi_uc
 *
ouçut
;

3841 
°bi_uc
 *
couçut
[4] = { 
NULL
, NULL, NULL, NULL };

3843 
°bi__ªßm∂e
 
ªs_comp
[4];

3845 
k
=0; k < 
decode_n
; ++k) {

3846 
°bi__ªßm∂e
 *
r
 = &
ªs_comp
[
k
];

3850 
z
->
img_comp
[
k
].
löebuf
 = (
°bi_uc
 *Ë
	`°bi__mÆloc
(z->
s
->
img_x
 + 3);

3851 i‡(!
z
->
img_comp
[
k
].
löebuf
Ë{ 
	`°bi__˛ónup_j≥g
(z);  
	`°bi__îΩuc
("outofmem", "Out of memory"); }

3853 
r
->
hs
 = 
z
->
img_h_max
 / z->
img_comp
[
k
].
h
;

3854 
r
->
vs
 = 
z
->
img_v_max
 / z->
img_comp
[
k
].
v
;

3855 
r
->
y°ï
 =Ñ->
vs
 >> 1;

3856 
r
->
w_l‹es
 = (
z
->
s
->
img_x
 +Ñ->
hs
-1) /Ñ->hs;

3857 
r
->
ypos
 = 0;

3858 
r
->
löe0
 =Ñ->
löe1
 = 
z
->
img_comp
[
k
].
d©a
;

3860 i‡(
r
->
hs
 =1 &&Ñ->
vs
 =1Ër->
ªßm∂e
 = 
ªßm∂e_row_1
;

3861 i‡(
r
->
hs
 =1 &&Ñ->
vs
 =2Ër->
ªßm∂e
 = 
°bi__ªßm∂e_row_v_2
;

3862 i‡(
r
->
hs
 =2 &&Ñ->
vs
 =1Ër->
ªßm∂e
 = 
°bi__ªßm∂e_row_h_2
;

3863 i‡(
r
->
hs
 =2 &&Ñ->
vs
 =2Ër->
ªßm∂e
 = 
z
->
ªßm∂e_row_hv_2_kî√l
;

3864 
r
->
ªßm∂e
 = 
°bi__ªßm∂e_row_gíîic
;

3868 
ouçut
 = (
°bi_uc
 *Ë
	`°bi__mÆloc_mad3
(
n
, 
z
->
s
->
img_x
, z->s->
img_y
, 1);

3869 i‡(!
ouçut
Ë{ 
	`°bi__˛ónup_j≥g
(
z
);  
	`°bi__îΩuc
("outofmem", "Out of memory"); }

3872 
j
=0; j < 
z
->
s
->
img_y
; ++j) {

3873 
°bi_uc
 *
out
 = 
ouçut
 + 
n
 * 
z
->
s
->
img_x
 * 
j
;

3874 
k
=0; k < 
decode_n
; ++k) {

3875 
°bi__ªßm∂e
 *
r
 = &
ªs_comp
[
k
];

3876 
y_bŸ
 = 
r
->
y°ï
 >‘->
vs
 >> 1);

3877 
couçut
[
k
] = 
r
->
	`ªßm∂e
(
z
->
img_comp
[k].
löebuf
,

3878 
y_bŸ
 ? 
r
->
löe1
 :Ñ->
löe0
,

3879 
y_bŸ
 ? 
r
->
löe0
 :Ñ->
löe1
,

3880 
r
->
w_l‹es
,Ñ->
hs
);

3881 i‡(++
r
->
y°ï
 >r->
vs
) {

3882 
r
->
y°ï
 = 0;

3883 
r
->
löe0
 =Ñ->
löe1
;

3884 i‡(++
r
->
ypos
 < 
z
->
img_comp
[
k
].
y
)

3885 
r
->
löe1
 +
z
->
img_comp
[
k
].
w2
;

3888 i‡(
n
 >= 3) {

3889 
°bi_uc
 *
y
 = 
couçut
[0];

3890 i‡(
z
->
s
->
img_n
 == 3) {

3891 i‡(
is_rgb
) {

3892 
i
=0; i < 
z
->
s
->
img_x
; ++i) {

3893 
out
[0] = 
y
[
i
];

3894 
out
[1] = 
couçut
[1][
i
];

3895 
out
[2] = 
couçut
[2][
i
];

3896 
out
[3] = 255;

3897 
out
 +
n
;

3900 
z
->
	`YCbCr_to_RGB_kî√l
(
out
, 
y
, 
couçut
[1], couçut[2], z->
s
->
img_x
, 
n
);

3902 } i‡(
z
->
s
->
img_n
 == 4) {

3903 i‡(
z
->
≠p14_cﬁ‹_å™sf‹m
 == 0) {

3904 
i
=0; i < 
z
->
s
->
img_x
; ++i) {

3905 
°bi_uc
 
m
 = 
couçut
[3][
i
];

3906 
out
[0] = 
	`°bi__blön_8x8
(
couçut
[0][
i
], 
m
);

3907 
out
[1] = 
	`°bi__blön_8x8
(
couçut
[1][
i
], 
m
);

3908 
out
[2] = 
	`°bi__blön_8x8
(
couçut
[2][
i
], 
m
);

3909 
out
[3] = 255;

3910 
out
 +
n
;

3912 } i‡(
z
->
≠p14_cﬁ‹_å™sf‹m
 == 2) {

3913 
z
->
	`YCbCr_to_RGB_kî√l
(
out
, 
y
, 
couçut
[1], couçut[2], z->
s
->
img_x
, 
n
);

3914 
i
=0; i < 
z
->
s
->
img_x
; ++i) {

3915 
°bi_uc
 
m
 = 
couçut
[3][
i
];

3916 
out
[0] = 
	`°bi__blön_8x8
(255 - out[0], 
m
);

3917 
out
[1] = 
	`°bi__blön_8x8
(255 - out[1], 
m
);

3918 
out
[2] = 
	`°bi__blön_8x8
(255 - out[2], 
m
);

3919 
out
 +
n
;

3922 
z
->
	`YCbCr_to_RGB_kî√l
(
out
, 
y
, 
couçut
[1], couçut[2], z->
s
->
img_x
, 
n
);

3925 
i
=0; i < 
z
->
s
->
img_x
; ++i) {

3926 
out
[0] = out[1] = out[2] = 
y
[
i
];

3927 
out
[3] = 255;

3928 
out
 +
n
;

3931 i‡(
is_rgb
) {

3932 i‡(
n
 == 1)

3933 
i
=0; i < 
z
->
s
->
img_x
; ++i)

3934 *
out
++ = 
	`°bi__compuã_y
(
couçut
[0][
i
], coutput[1][i], coutput[2][i]);

3936 
i
=0; i < 
z
->
s
->
img_x
; ++i, 
out
 += 2) {

3937 
out
[0] = 
	`°bi__compuã_y
(
couçut
[0][
i
], coutput[1][i], coutput[2][i]);

3938 
out
[1] = 255;

3941 } i‡(
z
->
s
->
img_n
 =4 && z->
≠p14_cﬁ‹_å™sf‹m
 == 0) {

3942 
i
=0; i < 
z
->
s
->
img_x
; ++i) {

3943 
°bi_uc
 
m
 = 
couçut
[3][
i
];

3944 
°bi_uc
 
r
 = 
	`°bi__blön_8x8
(
couçut
[0][
i
], 
m
);

3945 
°bi_uc
 
g
 = 
	`°bi__blön_8x8
(
couçut
[1][
i
], 
m
);

3946 
°bi_uc
 
b
 = 
	`°bi__blön_8x8
(
couçut
[2][
i
], 
m
);

3947 
out
[0] = 
	`°bi__compuã_y
(
r
, 
g
, 
b
);

3948 
out
[1] = 255;

3949 
out
 +
n
;

3951 } i‡(
z
->
s
->
img_n
 =4 && z->
≠p14_cﬁ‹_å™sf‹m
 == 2) {

3952 
i
=0; i < 
z
->
s
->
img_x
; ++i) {

3953 
out
[0] = 
	`°bi__blön_8x8
(255 - 
couçut
[0][
i
], coutput[3][i]);

3954 
out
[1] = 255;

3955 
out
 +
n
;

3958 
°bi_uc
 *
y
 = 
couçut
[0];

3959 i‡(
n
 == 1)

3960 
i
=0; i < 
z
->
s
->
img_x
; ++iË
out
[i] = 
y
[i];

3962 
i
=0; i < 
z
->
s
->
img_x
; ++iË{ *
out
++ = 
y
[i]; *out++ = 255; }

3966 
	`°bi__˛ónup_j≥g
(
z
);

3967 *
out_x
 = 
z
->
s
->
img_x
;

3968 *
out_y
 = 
z
->
s
->
img_y
;

3969 i‡(
comp
Ë*com∞
z
->
s
->
img_n
 >= 3 ? 3 : 1;

3970  
ouçut
;

3972 
	}
}

3974 *
	$°bi__j≥g_lﬂd
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
)

3976 * 
ªsu…
;

3977 
°bi__j≥g
* 
j
 = (°bi__j≥g*Ë
	`°bi__mÆloc
((stbi__jpeg));

3978 i‡(!
j
Ë 
	`°bi__îΩuc
("outofmem", "Out of memory");

3979 
	`STBI_NOTUSED
(
ri
);

3980 
j
->
s
 = s;

3981 
	`°bi__£tup_j≥g
(
j
);

3982 
ªsu…
 = 
	`lﬂd_j≥g_image
(
j
, 
x
,
y
,
comp
,
ªq_comp
);

3983 
	`STBI_FREE
(
j
);

3984  
ªsu…
;

3985 
	}
}

3987 
	$°bi__j≥g_ã°
(
°bi__c⁄ãxt
 *
s
)

3989 
r
;

3990 
°bi__j≥g
* 
j
 = (°bi__j≥g*)
	`°bi__mÆloc
((stbi__jpeg));

3991 i‡(!
j
Ë 
	`°bi__îr
("outofmem", "Out of memory");

3992 
j
->
s
 = s;

3993 
	`°bi__£tup_j≥g
(
j
);

3994 
r
 = 
	`°bi__decode_j≥g_hódî
(
j
, 
STBI__SCAN_ty≥
);

3995 
	`°bi__ªwöd
(
s
);

3996 
	`STBI_FREE
(
j
);

3997  
r
;

3998 
	}
}

4000 
	$°bi__j≥g_öfo_øw
(
°bi__j≥g
 *
j
, *
x
, *
y
, *
comp
)

4002 i‡(!
	`°bi__decode_j≥g_hódî
(
j
, 
STBI__SCAN_hódî
)) {

4003 
	`°bi__ªwöd
–
j
->
s
 );

4006 i‡(
x
Ë*x = 
j
->
s
->
img_x
;

4007 i‡(
y
Ë*y = 
j
->
s
->
img_y
;

4008 i‡(
comp
Ë*com∞
j
->
s
->
img_n
 >= 3 ? 3 : 1;

4010 
	}
}

4012 
	$°bi__j≥g_öfo
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
)

4014 
ªsu…
;

4015 
°bi__j≥g
* 
j
 = (°bi__j≥g*Ë(
	`°bi__mÆloc
((stbi__jpeg)));

4016 i‡(!
j
Ë 
	`°bi__îr
("outofmem", "Out of memory");

4017 
j
->
s
 = s;

4018 
ªsu…
 = 
	`°bi__j≥g_öfo_øw
(
j
, 
x
, 
y
, 
comp
);

4019 
	`STBI_FREE
(
j
);

4020  
ªsu…
;

4021 
	}
}

4031 #i‚de‡
STBI_NO_ZLIB


4034 
	#STBI__ZFAST_BITS
 9

4035 
	#STBI__ZFAST_MASK
 ((1 << 
STBI__ZFAST_BITS
Ë- 1)

	)

4036 
	#STBI__ZNSYMS
 288

4037 

	)

4042 
°bi__uöt16
 
	mÁ°
[1 << 
STBI__ZFAST_BITS
];

4043 
°bi__uöt16
 
	mfú°code
[16];

4044 
	mmaxcode
[17];

4045 
°bi__uöt16
 
	mfú°symbﬁ
[16];

4046 
°bi_uc
 
	msize
[
STBI__ZNSYMS
];

4047 
°bi__uöt16
 
	mvÆue
[
STBI__ZNSYMS
];

4048 } 
	t°bi__zhuffm™
;

4050 
°bi_ölöe
 
	$°bi__bôªvî£16
(
n
)

4052 
n
 = ((n & 0xAAAA) >> 1) | ((n & 0x5555) << 1);

4053 
n
 = ((n & 0xCCCC) >> 2) | ((n & 0x3333) << 2);

4054 
n
 = ((n & 0xF0F0) >> 4) | ((n & 0x0F0F) << 4);

4055 
n
 = ((n & 0xFF00) >> 8) | ((n & 0x00FF) << 8);

4056  
n
;

4057 
	}
}

4059 
°bi_ölöe
 
	$°bi__bô_ªvî£
(
v
, 
bôs
)

4061 
	`STBI_ASSERT
(
bôs
 <= 16);

4064  
	`°bi__bôªvî£16
(
v
Ë>> (16-
bôs
);

4065 
	}
}

4067 
	$°bi__zbuûd_huffm™
(
°bi__zhuffm™
 *
z
, c⁄° 
°bi_uc
 *
sizñi°
, 
num
)

4069 
i
,
k
=0;

4070 
code
, 
√xt_code
[16], 
sizes
[17];

4073 
	`mem£t
(
sizes
, 0, (sizes));

4074 
	`mem£t
(
z
->
Á°
, 0, (z->fast));

4075 
i
=0; i < 
num
; ++i)

4076 ++
sizes
[
sizñi°
[
i
]];

4077 
sizes
[0] = 0;

4078 
i
=1; i < 16; ++i)

4079 i‡(
sizes
[
i
] > (1 << i))

4080  
	`°bi__îr
("bad sizes", "Corrupt PNG");

4081 
code
 = 0;

4082 
i
=1; i < 16; ++i) {

4083 
√xt_code
[
i
] = 
code
;

4084 
z
->
fú°code
[
i
] = (
°bi__uöt16
Ë
code
;

4085 
z
->
fú°symbﬁ
[
i
] = (
°bi__uöt16
Ë
k
;

4086 
code
 = (codê+ 
sizes
[
i
]);

4087 i‡(
sizes
[
i
])

4088 i‡(
code
-1 >(1 << 
i
)Ë 
	`°bi__îr
("bad codelengths","Corrupt PNG");

4089 
z
->
maxcode
[
i
] = 
code
 << (16-i);

4090 
code
 <<= 1;

4091 
k
 +
sizes
[
i
];

4093 
z
->
maxcode
[16] = 0x10000;

4094 
i
=0; i < 
num
; ++i) {

4095 
s
 = 
sizñi°
[
i
];

4096 i‡(
s
) {

4097 
c
 = 
√xt_code
[
s
] - 
z
->
fú°code
[s] + z->
fú°symbﬁ
[s];

4098 
°bi__uöt16
 
Á°v
 = (°bi__uöt16Ë((
s
 << 9Ë| 
i
);

4099 
z
->
size
 [
c
] = (
°bi_uc
 ) 
s
;

4100 
z
->
vÆue
[
c
] = (
°bi__uöt16
Ë
i
;

4101 i‡(
s
 <
STBI__ZFAST_BITS
) {

4102 
j
 = 
	`°bi__bô_ªvî£
(
√xt_code
[
s
],s);

4103 
j
 < (1 << 
STBI__ZFAST_BITS
)) {

4104 
z
->
Á°
[
j
] = 
Á°v
;

4105 
j
 +(1 << 
s
);

4108 ++
√xt_code
[
s
];

4112 
	}
}

4122 
°bi_uc
 *
	mzbuf„r
, *
	mzbuf„r_íd
;

4123 
	mnum_bôs
;

4124 
°bi__uöt32
 
	mcode_buf„r
;

4126 *
	mzout
;

4127 *
	mzout_°¨t
;

4128 *
	mzout_íd
;

4129 
	mz_ex∑ndabÀ
;

4131 
°bi__zhuffm™
 
	mz_Àngth
, 
	mz_di°™˚
;

4132 } 
	t°bi__zbuf
;

4134 
°bi_ölöe
 
	$°bi__zeof
(
°bi__zbuf
 *
z
)

4136  (
z
->
zbuf„r
 >z->
zbuf„r_íd
);

4137 
	}
}

4139 
°bi_ölöe
 
°bi_uc
 
	$°bi__zgë8
(
°bi__zbuf
 *
z
)

4141  
	`°bi__zeof
(
z
Ë? 0 : *z->
zbuf„r
++;

4142 
	}
}

4144 
	$°bi__fûl_bôs
(
°bi__zbuf
 *
z
)

4147 i‡(
z
->
code_buf„r
 >(1U << z->
num_bôs
)) {

4148 
z
->
zbuf„r
 = z->
zbuf„r_íd
;

4151 
z
->
code_buf„r
 |(Ë
	`°bi__zgë8
(zË<< z->
num_bôs
;

4152 
z
->
num_bôs
 += 8;

4153 } 
z
->
num_bôs
 <= 24);

4154 
	}
}

4156 
°bi_ölöe
 
	$°bi__zª˚ive
(
°bi__zbuf
 *
z
, 
n
)

4158 
k
;

4159 i‡(
z
->
num_bôs
 < 
n
Ë
	`°bi__fûl_bôs
(z);

4160 
k
 = 
z
->
code_buf„r
 & ((1 << 
n
) - 1);

4161 
z
->
code_buf„r
 >>
n
;

4162 
z
->
num_bôs
 -
n
;

4163  
k
;

4164 
	}
}

4166 
	$°bi__zhuffm™_decode_¶ow∑th
(
°bi__zbuf
 *
a
, 
°bi__zhuffm™
 *
z
)

4168 
b
,
s
,
k
;

4171 
k
 = 
	`°bi__bô_ªvî£
(
a
->
code_buf„r
, 16);

4172 
s
=
STBI__ZFAST_BITS
+1; ; ++s)

4173 i‡(
k
 < 
z
->
maxcode
[
s
])

4175 i‡(
s
 >= 16)  -1;

4177 
b
 = (
k
 >> (16-
s
)Ë- 
z
->
fú°code
[s] + z->
fú°symbﬁ
[s];

4178 i‡(
b
 >
STBI__ZNSYMS
)  -1;

4179 i‡(
z
->
size
[
b
] !
s
)  -1;

4180 
a
->
code_buf„r
 >>
s
;

4181 
a
->
num_bôs
 -
s
;

4182  
z
->
vÆue
[
b
];

4183 
	}
}

4185 
°bi_ölöe
 
	$°bi__zhuffm™_decode
(
°bi__zbuf
 *
a
, 
°bi__zhuffm™
 *
z
)

4187 
b
,
s
;

4188 i‡(
a
->
num_bôs
 < 16) {

4189 i‡(
	`°bi__zeof
(
a
)) {

4192 
	`°bi__fûl_bôs
(
a
);

4194 
b
 = 
z
->
Á°
[
a
->
code_buf„r
 & 
STBI__ZFAST_MASK
];

4195 i‡(
b
) {

4196 
s
 = 
b
 >> 9;

4197 
a
->
code_buf„r
 >>
s
;

4198 
a
->
num_bôs
 -
s
;

4199  
b
 & 511;

4201  
	`°bi__zhuffm™_decode_¶ow∑th
(
a
, 
z
);

4202 
	}
}

4204 
	$°bi__zex∑nd
(
°bi__zbuf
 *
z
, *
zout
, 
n
)

4206 *
q
;

4207 
cur
, 
limô
, 
ﬁd_limô
;

4208 
z
->
zout
 = zout;

4209 i‡(!
z
->
z_ex∑ndabÀ
Ë 
	`°bi__îr
("output bufferÜimit","Corrupt PNG");

4210 
cur
 = (Ë(
z
->
zout
 - z->
zout_°¨t
);

4211 
limô
 = 
ﬁd_limô
 = (Ë(
z
->
zout_íd
 - z->
zout_°¨t
);

4212 i‡(
UINT_MAX
 - 
cur
 < (Ë
n
Ë 
	`°bi__îr
("outofmem", "Out of memory");

4213 
cur
 + 
n
 > 
limô
) {

4214 if(
limô
 > 
UINT_MAX
 / 2Ë 
	`°bi__îr
("outofmem", "Out of memory");

4215 
limô
 *= 2;

4217 
q
 = (*Ë
	`STBI_REALLOC_SIZED
(
z
->
zout_°¨t
, 
ﬁd_limô
, 
limô
);

4218 
	`STBI_NOTUSED
(
ﬁd_limô
);

4219 i‡(
q
 =
NULL
Ë 
	`°bi__îr
("outofmem", "Out of memory");

4220 
z
->
zout_°¨t
 = 
q
;

4221 
z
->
zout
 = 
q
 + 
cur
;

4222 
z
->
zout_íd
 = 
q
 + 
limô
;

4224 
	}
}

4226 c⁄° 
	g°bi__zÀngth_ba£
[31] = {

4231 c⁄° 
	g°bi__zÀngth_exåa
[31]=

4234 c⁄° 
	g°bi__zdi°_ba£
[32] = { 1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,

4237 c⁄° 
	g°bi__zdi°_exåa
[32] =

4240 
	$°bi__∑r£_huffm™_block
(
°bi__zbuf
 *
a
)

4242 *
zout
 = 
a
->zout;

4244 
z
 = 
	`°bi__zhuffm™_decode
(
a
, &a->
z_Àngth
);

4245 i‡(
z
 < 256) {

4246 i‡(
z
 < 0Ë 
	`°bi__îr
("bad huffman code","Corrupt PNG");

4247 i‡(
zout
 >
a
->
zout_íd
) {

4248 i‡(!
	`°bi__zex∑nd
(
a
, 
zout
, 1))  0;

4249 
zout
 = 
a
->zout;

4251 *
zout
++ = (Ë
z
;

4253 
°bi_uc
 *
p
;

4254 
Àn
,
di°
;

4255 i‡(
z
 == 256) {

4256 
a
->
zout
 = zout;

4259 
z
 -= 257;

4260 
Àn
 = 
°bi__zÀngth_ba£
[
z
];

4261 i‡(
°bi__zÀngth_exåa
[
z
]Ë
Àn
 +
	`°bi__zª˚ive
(
a
, stbi__zlength_extra[z]);

4262 
z
 = 
	`°bi__zhuffm™_decode
(
a
, &a->
z_di°™˚
);

4263 i‡(
z
 < 0Ë 
	`°bi__îr
("bad huffman code","Corrupt PNG");

4264 
di°
 = 
°bi__zdi°_ba£
[
z
];

4265 i‡(
°bi__zdi°_exåa
[
z
]Ë
di°
 +
	`°bi__zª˚ive
(
a
, stbi__zdist_extra[z]);

4266 i‡(
zout
 - 
a
->
zout_°¨t
 < 
di°
Ë 
	`°bi__îr
("bad dist","Corrupt PNG");

4267 i‡(
zout
 + 
Àn
 > 
a
->
zout_íd
) {

4268 i‡(!
	`°bi__zex∑nd
(
a
, 
zout
, 
Àn
))  0;

4269 
zout
 = 
a
->zout;

4271 
p
 = (
°bi_uc
 *Ë(
zout
 - 
di°
);

4272 i‡(
di°
 == 1) {

4273 
°bi_uc
 
v
 = *
p
;

4274 i‡(
Àn
Ë{ dÿ*
zout
++ = 
v
; --len); }

4276 i‡(
Àn
Ë{ dÿ*
zout
++ = *
p
++; --len); }

4280 
	}
}

4282 
	$°bi__compuã_huffm™_codes
(
°bi__zbuf
 *
a
)

4284 c⁄° 
°bi_uc
 
Àngth_dezigzag
[19] = { 16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15 };

4285 
°bi__zhuffm™
 
z_codñígth
;

4286 
°bi_uc
 
Àncodes
[286+32+137];

4287 
°bi_uc
 
codñígth_sizes
[19];

4288 
i
,
n
;

4290 
hlô
 = 
	`°bi__zª˚ive
(
a
,5) + 257;

4291 
hdi°
 = 
	`°bi__zª˚ive
(
a
,5) + 1;

4292 
h˛í
 = 
	`°bi__zª˚ive
(
a
,4) + 4;

4293 
¡Ÿ
 = 
hlô
 + 
hdi°
;

4295 
	`mem£t
(
codñígth_sizes
, 0, (codelength_sizes));

4296 
i
=0; i < 
h˛í
; ++i) {

4297 
s
 = 
	`°bi__zª˚ive
(
a
,3);

4298 
codñígth_sizes
[
Àngth_dezigzag
[
i
]] = (
°bi_uc
Ë
s
;

4300 i‡(!
	`°bi__zbuûd_huffm™
(&
z_codñígth
, 
codñígth_sizes
, 19))  0;

4302 
n
 = 0;

4303 
n
 < 
¡Ÿ
) {

4304 
c
 = 
	`°bi__zhuffm™_decode
(
a
, &
z_codñígth
);

4305 i‡(
c
 < 0 || c >19Ë 
	`°bi__îr
("bad codelengths", "Corrupt PNG");

4306 i‡(
c
 < 16)

4307 
Àncodes
[
n
++] = (
°bi_uc
Ë
c
;

4309 
°bi_uc
 
fûl
 = 0;

4310 i‡(
c
 == 16) {

4311 
c
 = 
	`°bi__zª˚ive
(
a
,2)+3;

4312 i‡(
n
 =0Ë 
	`°bi__îr
("bad codelengths", "Corrupt PNG");

4313 
fûl
 = 
Àncodes
[
n
-1];

4314 } i‡(
c
 == 17) {

4315 
c
 = 
	`°bi__zª˚ive
(
a
,3)+3;

4316 } i‡(
c
 == 18) {

4317 
c
 = 
	`°bi__zª˚ive
(
a
,7)+11;

4319  
	`°bi__îr
("bad codelengths", "Corrupt PNG");

4321 i‡(
¡Ÿ
 - 
n
 < 
c
Ë 
	`°bi__îr
("bad codelengths", "Corrupt PNG");

4322 
	`mem£t
(
Àncodes
+
n
, 
fûl
, 
c
);

4323 
n
 +
c
;

4326 i‡(
n
 !
¡Ÿ
Ë 
	`°bi__îr
("bad codelengths","Corrupt PNG");

4327 i‡(!
	`°bi__zbuûd_huffm™
(&
a
->
z_Àngth
, 
Àncodes
, 
hlô
))  0;

4328 i‡(!
	`°bi__zbuûd_huffm™
(&
a
->
z_di°™˚
, 
Àncodes
+
hlô
, 
hdi°
))  0;

4330 
	}
}

4332 
	$°bi__∑r£_uncom¥es£d_block
(
°bi__zbuf
 *
a
)

4334 
°bi_uc
 
hódî
[4];

4335 
Àn
,
∆í
,
k
;

4336 i‡(
a
->
num_bôs
 & 7)

4337 
	`°bi__zª˚ive
(
a
,á->
num_bôs
 & 7);

4339 
k
 = 0;

4340 
a
->
num_bôs
 > 0) {

4341 
hódî
[
k
++] = (
°bi_uc
Ë(
a
->
code_buf„r
 & 255);

4342 
a
->
code_buf„r
 >>= 8;

4343 
a
->
num_bôs
 -= 8;

4345 i‡(
a
->
num_bôs
 < 0Ë 
	`°bi__îr
("zlib corrupt","Corrupt PNG");

4347 
k
 < 4)

4348 
hódî
[
k
++] = 
	`°bi__zgë8
(
a
);

4349 
Àn
 = 
hódî
[1] * 256 + header[0];

4350 
∆í
 = 
hódî
[3] * 256 + header[2];

4351 i‡(
∆í
 !(
Àn
 ^ 0xffff)Ë 
	`°bi__îr
("zlib corrupt","Corrupt PNG");

4352 i‡(
a
->
zbuf„r
 + 
Àn
 >á->
zbuf„r_íd
Ë 
	`°bi__îr
("readÖast buffer","Corrupt PNG");

4353 i‡(
a
->
zout
 + 
Àn
 >á->
zout_íd
)

4354 i‡(!
	`°bi__zex∑nd
(
a
,á->
zout
, 
Àn
))  0;

4355 
	`mem˝y
(
a
->
zout
,á->
zbuf„r
, 
Àn
);

4356 
a
->
zbuf„r
 +
Àn
;

4357 
a
->
zout
 +
Àn
;

4359 
	}
}

4361 
	$°bi__∑r£_zlib_hódî
(
°bi__zbuf
 *
a
)

4363 
cmf
 = 
	`°bi__zgë8
(
a
);

4364 
cm
 = 
cmf
 & 15;

4366 
Êg
 = 
	`°bi__zgë8
(
a
);

4367 i‡(
	`°bi__zeof
(
a
)Ë 
	`°bi__îr
("bad zlib header","Corrupt PNG");

4368 i‡((
cmf
*256+
Êg
Ë% 31 !0Ë 
	`°bi__îr
("bad zlib header","Corrupt PNG");

4369 i‡(
Êg
 & 32Ë 
	`°bi__îr
("noÖreset dict","Corrupt PNG");

4370 i‡(
cm
 !8Ë 
	`°bi__îr
("bad compression","Corrupt PNG");

4373 
	}
}

4375 c⁄° 
°bi_uc
 
	g°bi__zdeÁu…_Àngth
[
STBI__ZNSYMS
] =

4387 c⁄° 
°bi_uc
 
	g°bi__zdeÁu…_di°™˚
[32] =

4404 
	$°bi__∑r£_zlib
(
°bi__zbuf
 *
a
, 
∑r£_hódî
)

4406 
föÆ
, 
ty≥
;

4407 i‡(
∑r£_hódî
)

4408 i‡(!
	`°bi__∑r£_zlib_hódî
(
a
))  0;

4409 
a
->
num_bôs
 = 0;

4410 
a
->
code_buf„r
 = 0;

4412 
föÆ
 = 
	`°bi__zª˚ive
(
a
,1);

4413 
ty≥
 = 
	`°bi__zª˚ive
(
a
,2);

4414 i‡(
ty≥
 == 0) {

4415 i‡(!
	`°bi__∑r£_uncom¥es£d_block
(
a
))  0;

4416 } i‡(
ty≥
 == 3) {

4419 i‡(
ty≥
 == 1) {

4421 i‡(!
	`°bi__zbuûd_huffm™
(&
a
->
z_Àngth
 , 
°bi__zdeÁu…_Àngth
 , 
STBI__ZNSYMS
))  0;

4422 i‡(!
	`°bi__zbuûd_huffm™
(&
a
->
z_di°™˚
, 
°bi__zdeÁu…_di°™˚
, 32))  0;

4424 i‡(!
	`°bi__compuã_huffm™_codes
(
a
))  0;

4426 i‡(!
	`°bi__∑r£_huffm™_block
(
a
))  0;

4428 } !
föÆ
);

4430 
	}
}

4432 
	$°bi__do_zlib
(
°bi__zbuf
 *
a
, *
obuf
, 
ﬁí
, 
exp
, 
∑r£_hódî
)

4434 
a
->
zout_°¨t
 = 
obuf
;

4435 
a
->
zout
 = 
obuf
;

4436 
a
->
zout_íd
 = 
obuf
 + 
ﬁí
;

4437 
a
->
z_ex∑ndabÀ
 = 
exp
;

4439  
	`°bi__∑r£_zlib
(
a
, 
∑r£_hódî
);

4440 
	}
}

4442 
STBIDEF
 *
	$°bi_zlib_decode_mÆloc_guesssize
(c⁄° *
buf„r
, 
Àn
, 
öôül_size
, *
ouéí
)

4444 
°bi__zbuf
 
a
;

4445 *
p
 = (*Ë
	`°bi__mÆloc
(
öôül_size
);

4446 i‡(
p
 =
NULL
)  NULL;

4447 
a
.
zbuf„r
 = (
°bi_uc
 *Ë
buf„r
;

4448 
a
.
zbuf„r_íd
 = (
°bi_uc
 *Ë
buf„r
 + 
Àn
;

4449 i‡(
	`°bi__do_zlib
(&
a
, 
p
, 
öôül_size
, 1, 1)) {

4450 i‡(
ouéí
Ë*ouéí = (Ë(
a
.
zout
 -á.
zout_°¨t
);

4451  
a
.
zout_°¨t
;

4453 
	`STBI_FREE
(
a
.
zout_°¨t
);

4454  
NULL
;

4456 
	}
}

4458 
STBIDEF
 *
	$°bi_zlib_decode_mÆloc
(c⁄° *
buf„r
, 
Àn
, *
ouéí
)

4460  
	`°bi_zlib_decode_mÆloc_guesssize
(
buf„r
, 
Àn
, 16384, 
ouéí
);

4461 
	}
}

4463 
STBIDEF
 *
	$°bi_zlib_decode_mÆloc_guesssize_hódîÊag
(c⁄° *
buf„r
, 
Àn
, 
öôül_size
, *
ouéí
, 
∑r£_hódî
)

4465 
°bi__zbuf
 
a
;

4466 *
p
 = (*Ë
	`°bi__mÆloc
(
öôül_size
);

4467 i‡(
p
 =
NULL
)  NULL;

4468 
a
.
zbuf„r
 = (
°bi_uc
 *Ë
buf„r
;

4469 
a
.
zbuf„r_íd
 = (
°bi_uc
 *Ë
buf„r
 + 
Àn
;

4470 i‡(
	`°bi__do_zlib
(&
a
, 
p
, 
öôül_size
, 1, 
∑r£_hódî
)) {

4471 i‡(
ouéí
Ë*ouéí = (Ë(
a
.
zout
 -á.
zout_°¨t
);

4472  
a
.
zout_°¨t
;

4474 
	`STBI_FREE
(
a
.
zout_°¨t
);

4475  
NULL
;

4477 
	}
}

4479 
STBIDEF
 
	$°bi_zlib_decode_buf„r
(*
obuf„r
, 
ﬁí
, c⁄° *
ibuf„r
, 
ûí
)

4481 
°bi__zbuf
 
a
;

4482 
a
.
zbuf„r
 = (
°bi_uc
 *Ë
ibuf„r
;

4483 
a
.
zbuf„r_íd
 = (
°bi_uc
 *Ë
ibuf„r
 + 
ûí
;

4484 i‡(
	`°bi__do_zlib
(&
a
, 
obuf„r
, 
ﬁí
, 0, 1))

4485  (Ë(
a
.
zout
 -á.
zout_°¨t
);

4488 
	}
}

4490 
STBIDEF
 *
	$°bi_zlib_decode_nohódî_mÆloc
(c⁄° *
buf„r
, 
Àn
, *
ouéí
)

4492 
°bi__zbuf
 
a
;

4493 *
p
 = (*Ë
	`°bi__mÆloc
(16384);

4494 i‡(
p
 =
NULL
)  NULL;

4495 
a
.
zbuf„r
 = (
°bi_uc
 *Ë
buf„r
;

4496 
a
.
zbuf„r_íd
 = (
°bi_uc
 *Ë
buf„r
+
Àn
;

4497 i‡(
	`°bi__do_zlib
(&
a
, 
p
, 16384, 1, 0)) {

4498 i‡(
ouéí
Ë*ouéí = (Ë(
a
.
zout
 -á.
zout_°¨t
);

4499  
a
.
zout_°¨t
;

4501 
	`STBI_FREE
(
a
.
zout_°¨t
);

4502  
NULL
;

4504 
	}
}

4506 
STBIDEF
 
	$°bi_zlib_decode_nohódî_buf„r
(*
obuf„r
, 
ﬁí
, c⁄° *
ibuf„r
, 
ûí
)

4508 
°bi__zbuf
 
a
;

4509 
a
.
zbuf„r
 = (
°bi_uc
 *Ë
ibuf„r
;

4510 
a
.
zbuf„r_íd
 = (
°bi_uc
 *Ë
ibuf„r
 + 
ûí
;

4511 i‡(
	`°bi__do_zlib
(&
a
, 
obuf„r
, 
ﬁí
, 0, 0))

4512  (Ë(
a
.
zout
 -á.
zout_°¨t
);

4515 
	}
}

4528 #i‚de‡
STBI_NO_PNG


4531 
°bi__uöt32
 
	mÀngth
;

4532 
°bi__uöt32
 
	mty≥
;

4533 } 
	t°bi__≤gchunk
;

4535 
°bi__≤gchunk
 
	$°bi__gë_chunk_hódî
(
°bi__c⁄ãxt
 *
s
)

4537 
°bi__≤gchunk
 
c
;

4538 
c
.
Àngth
 = 
	`°bi__gë32be
(
s
);

4539 
c
.
ty≥
 = 
	`°bi__gë32be
(
s
);

4540  
c
;

4541 
	}
}

4543 
	$°bi__check_≤g_hódî
(
°bi__c⁄ãxt
 *
s
)

4545 c⁄° 
°bi_uc
 
≤g_sig
[8] = { 137,80,78,71,13,10,26,10 };

4546 
i
;

4547 
i
=0; i < 8; ++i)

4548 i‡(
	`°bi__gë8
(
s
Ë!
≤g_sig
[
i
]Ë 
	`°bi__îr
("badÖng sig","Notá PNG");

4550 
	}
}

4554 
°bi__c⁄ãxt
 *
	ms
;

4555 
°bi_uc
 *
	mid©a
, *
	mex∑nded
, *
	mout
;

4556 
	mdïth
;

4557 } 
	t°bi__≤g
;

4561 
	mSTBI__F_n⁄e
=0,

4562 
	mSTBI__F_sub
=1,

4563 
	mSTBI__F_up
=2,

4564 
	mSTBI__F_avg
=3,

4565 
	mSTBI__F_∑ëh
=4,

4567 
	mSTBI__F_avg_fú°
,

4568 
	mSTBI__F_∑ëh_fú°


4571 
°bi_uc
 
	gfú°_row_fûãr
[5] =

4573 
STBI__F_n⁄e
,

4574 
STBI__F_sub
,

4575 
STBI__F_n⁄e
,

4576 
STBI__F_avg_fú°
,

4577 
STBI__F_∑ëh_fú°


4580 
	$°bi__∑ëh
(
a
, 
b
, 
c
)

4582 
p
 = 
a
 + 
b
 - 
c
;

4583 
∑
 = 
	`abs
(
p
-
a
);

4584 
pb
 = 
	`abs
(
p
-
b
);

4585 
pc
 = 
	`abs
(
p
-
c
);

4586 i‡(
∑
 <
pb
 &&Ö®<
pc
Ë 
a
;

4587 i‡(
pb
 <
pc
Ë 
b
;

4588  
c
;

4589 
	}
}

4591 c⁄° 
°bi_uc
 
	g°bi__dïth_sˇÀ_èbÀ
[9] = { 0, 0xff, 0x55, 0, 0x11, 0,0,0, 0x01 };

4594 
	$°bi__¸óã_≤g_image_øw
(
°bi__≤g
 *
a
, 
°bi_uc
 *
øw
, 
°bi__uöt32
 
øw_Àn
, 
out_n
, stbi__uöt32 
x
, stbi__uöt32 
y
, 
dïth
, 
cﬁ‹
)

4596 
byãs
 = (
dïth
 == 16? 2 : 1);

4597 
°bi__c⁄ãxt
 *
s
 = 
a
->s;

4598 
°bi__uöt32
 
i
,
j
,
°ride
 = 
x
*
out_n
*
byãs
;

4599 
°bi__uöt32
 
img_Àn
, 
img_width_byãs
;

4600 
k
;

4601 
img_n
 = 
s
->img_n;

4603 
ouçut_byãs
 = 
out_n
*
byãs
;

4604 
fûãr_byãs
 = 
img_n
*
byãs
;

4605 
width
 = 
x
;

4607 
	`STBI_ASSERT
(
out_n
 =
s
->
img_n
 || out_n == s->img_n+1);

4608 
a
->
out
 = (
°bi_uc
 *Ë
	`°bi__mÆloc_mad3
(
x
, 
y
, 
ouçut_byãs
, 0);

4609 i‡(!
a
->
out
Ë 
	`°bi__îr
("outofmem", "Out of memory");

4611 i‡(!
	`°bi__mad3sizes_vÆid
(
img_n
, 
x
, 
dïth
, 7)Ë 
	`°bi__îr
("tooÜarge", "Corrupt PNG");

4612 
img_width_byãs
 = (((
img_n
 * 
x
 * 
dïth
) + 7) >> 3);

4613 
img_Àn
 = (
img_width_byãs
 + 1Ë* 
y
;

4618 i‡(
øw_Àn
 < 
img_Àn
Ë 
	`°bi__îr
("notÉnoughÖixels","Corrupt PNG");

4620 
j
=0; j < 
y
; ++j) {

4621 
°bi_uc
 *
cur
 = 
a
->
out
 + 
°ride
*
j
;

4622 
°bi_uc
 *
¥i‹
;

4623 
fûãr
 = *
øw
++;

4625 i‡(
fûãr
 > 4)

4626  
	`°bi__îr
("invalid filter","Corrupt PNG");

4628 i‡(
dïth
 < 8) {

4629 i‡(
img_width_byãs
 > 
x
Ë 
	`°bi__îr
("invalid width","Corrupt PNG");

4630 
cur
 +
x
*
out_n
 - 
img_width_byãs
;

4631 
fûãr_byãs
 = 1;

4632 
width
 = 
img_width_byãs
;

4634 
¥i‹
 = 
cur
 - 
°ride
;

4637 i‡(
j
 =0Ë
fûãr
 = 
fú°_row_fûãr
[filter];

4640 
k
=0; k < 
fûãr_byãs
; ++k) {

4641 
fûãr
) {

4642 
STBI__F_n⁄e
 : 
cur
[
k
] = 
øw
[k]; ;

4643 
STBI__F_sub
 : 
cur
[
k
] = 
øw
[k]; ;

4644 
STBI__F_up
 : 
cur
[
k
] = 
	`STBI__BYTECAST
(
øw
[k] + 
¥i‹
[k]); ;

4645 
STBI__F_avg
 : 
cur
[
k
] = 
	`STBI__BYTECAST
(
øw
[k] + (
¥i‹
[k]>>1)); ;

4646 
STBI__F_∑ëh
 : 
cur
[
k
] = 
	`STBI__BYTECAST
(
øw
[k] + 
	`°bi__∑ëh
(0,
¥i‹
[k],0)); ;

4647 
STBI__F_avg_fú°
 : 
cur
[
k
] = 
øw
[k]; ;

4648 
STBI__F_∑ëh_fú°
: 
cur
[
k
] = 
øw
[k]; ;

4652 i‡(
dïth
 == 8) {

4653 i‡(
img_n
 !
out_n
)

4654 
cur
[
img_n
] = 255;

4655 
øw
 +
img_n
;

4656 
cur
 +
out_n
;

4657 
¥i‹
 +
out_n
;

4658 } i‡(
dïth
 == 16) {

4659 i‡(
img_n
 !
out_n
) {

4660 
cur
[
fûãr_byãs
] = 255;

4661 
cur
[
fûãr_byãs
+1] = 255;

4663 
øw
 +
fûãr_byãs
;

4664 
cur
 +
ouçut_byãs
;

4665 
¥i‹
 +
ouçut_byãs
;

4667 
øw
 += 1;

4668 
cur
 += 1;

4669 
¥i‹
 += 1;

4673 i‡(
dïth
 < 8 || 
img_n
 =
out_n
) {

4674 
nk
 = (
width
 - 1)*
fûãr_byãs
;

4675 
	#STBI__CASE
(
f
) \

4676 
f
: \

4677 
k
=0; k < 
nk
; ++k)

	)

4678 
fûãr
) {

4680 
STBI__F_n⁄e
: 
	`mem˝y
(
cur
, 
øw
, 
nk
); ;

4681 
	`STBI__CASE
(
STBI__F_sub
Ë{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
øw
[k] + cur[k-
fûãr_byãs
]); } ;

4682 
	`STBI__CASE
(
STBI__F_up
Ë{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
øw
[k] + 
¥i‹
[k]); } ;

4683 
	`STBI__CASE
(
STBI__F_avg
Ë{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
øw
[k] + ((
¥i‹
[k] + cur[k-
fûãr_byãs
])>>1)); } ;

4684 
	`STBI__CASE
(
STBI__F_∑ëh
Ë{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
øw
[k] + 
	`°bi__∑ëh
(cur[k-
fûãr_byãs
],
¥i‹
[k],prior[k-filter_bytes])); } ;

4685 
	`STBI__CASE
(
STBI__F_avg_fú°
Ë{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
øw
[k] + (cur[k-
fûãr_byãs
] >> 1)); } ;

4686 
	`STBI__CASE
(
STBI__F_∑ëh_fú°
Ë{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
øw
[k] + 
	`°bi__∑ëh
(cur[k-
fûãr_byãs
],0,0)); } ;

4688 #unde‡
STBI__CASE


4689 
øw
 +
nk
;

4691 
	`STBI_ASSERT
(
img_n
+1 =
out_n
);

4692 
	#STBI__CASE
(
f
) \

4693 
f
: \

4694 
i
=
x
-1; i >1; --i, 
cur
[
fûãr_byãs
]=255,
øw
+=fûãr_byãs,cur+=
ouçut_byãs
,
¥i‹
+=output_bytes) \

4695 
k
=0; k < 
fûãr_byãs
; ++k)

	)

4696 
fûãr
) {

4697 
	`STBI__CASE
(
STBI__F_n⁄e
Ë{ 
cur
[
k
] = 
øw
[k]; } ;

4698 
	`STBI__CASE
(
STBI__F_sub
Ë{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
øw
[k] + cur[k- 
ouçut_byãs
]); } ;

4699 
	`STBI__CASE
(
STBI__F_up
Ë{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
øw
[k] + 
¥i‹
[k]); } ;

4700 
	`STBI__CASE
(
STBI__F_avg
Ë{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
øw
[k] + ((
¥i‹
[k] + cur[k- 
ouçut_byãs
])>>1)); } ;

4701 
	`STBI__CASE
(
STBI__F_∑ëh
Ë{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
øw
[k] + 
	`°bi__∑ëh
(cur[k- 
ouçut_byãs
],
¥i‹
[k],prior[k- output_bytes])); } ;

4702 
	`STBI__CASE
(
STBI__F_avg_fú°
Ë{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
øw
[k] + (cur[k- 
ouçut_byãs
] >> 1)); } ;

4703 
	`STBI__CASE
(
STBI__F_∑ëh_fú°
Ë{ 
cur
[
k
] = 
	`STBI__BYTECAST
(
øw
[k] + 
	`°bi__∑ëh
(cur[k- 
ouçut_byãs
],0,0)); } ;

4705 #unde‡
STBI__CASE


4709 i‡(
dïth
 == 16) {

4710 
cur
 = 
a
->
out
 + 
°ride
*
j
;

4711 
i
=0; i < 
x
; ++i,
cur
+=
ouçut_byãs
) {

4712 
cur
[
fûãr_byãs
+1] = 255;

4721 i‡(
dïth
 < 8) {

4722 
j
=0; j < 
y
; ++j) {

4723 
°bi_uc
 *
cur
 = 
a
->
out
 + 
°ride
*
j
;

4724 
°bi_uc
 *
ö
 = 
a
->
out
 + 
°ride
*
j
 + 
x
*
out_n
 - 
img_width_byãs
;

4727 
°bi_uc
 
sˇÀ
 = (
cﬁ‹
 =0Ë? 
°bi__dïth_sˇÀ_èbÀ
[
dïth
] : 1;

4735 i‡(
dïth
 == 4) {

4736 
k
=
x
*
img_n
; k >2; k-=2, ++
ö
) {

4737 *
cur
++ = 
sˇÀ
 * ((*
ö
 >> 4) );

4738 *
cur
++ = 
sˇÀ
 * ((*
ö
 ) & 0x0f);

4740 i‡(
k
 > 0Ë*
cur
++ = 
sˇÀ
 * ((*
ö
 >> 4) );

4741 } i‡(
dïth
 == 2) {

4742 
k
=
x
*
img_n
; k >4; k-=4, ++
ö
) {

4743 *
cur
++ = 
sˇÀ
 * ((*
ö
 >> 6) );

4744 *
cur
++ = 
sˇÀ
 * ((*
ö
 >> 4) & 0x03);

4745 *
cur
++ = 
sˇÀ
 * ((*
ö
 >> 2) & 0x03);

4746 *
cur
++ = 
sˇÀ
 * ((*
ö
 ) & 0x03);

4748 i‡(
k
 > 0Ë*
cur
++ = 
sˇÀ
 * ((*
ö
 >> 6) );

4749 i‡(
k
 > 1Ë*
cur
++ = 
sˇÀ
 * ((*
ö
 >> 4) & 0x03);

4750 i‡(
k
 > 2Ë*
cur
++ = 
sˇÀ
 * ((*
ö
 >> 2) & 0x03);

4751 } i‡(
dïth
 == 1) {

4752 
k
=
x
*
img_n
; k >8; k-=8, ++
ö
) {

4753 *
cur
++ = 
sˇÀ
 * ((*
ö
 >> 7) );

4754 *
cur
++ = 
sˇÀ
 * ((*
ö
 >> 6) & 0x01);

4755 *
cur
++ = 
sˇÀ
 * ((*
ö
 >> 5) & 0x01);

4756 *
cur
++ = 
sˇÀ
 * ((*
ö
 >> 4) & 0x01);

4757 *
cur
++ = 
sˇÀ
 * ((*
ö
 >> 3) & 0x01);

4758 *
cur
++ = 
sˇÀ
 * ((*
ö
 >> 2) & 0x01);

4759 *
cur
++ = 
sˇÀ
 * ((*
ö
 >> 1) & 0x01);

4760 *
cur
++ = 
sˇÀ
 * ((*
ö
 ) & 0x01);

4762 i‡(
k
 > 0Ë*
cur
++ = 
sˇÀ
 * ((*
ö
 >> 7) );

4763 i‡(
k
 > 1Ë*
cur
++ = 
sˇÀ
 * ((*
ö
 >> 6) & 0x01);

4764 i‡(
k
 > 2Ë*
cur
++ = 
sˇÀ
 * ((*
ö
 >> 5) & 0x01);

4765 i‡(
k
 > 3Ë*
cur
++ = 
sˇÀ
 * ((*
ö
 >> 4) & 0x01);

4766 i‡(
k
 > 4Ë*
cur
++ = 
sˇÀ
 * ((*
ö
 >> 3) & 0x01);

4767 i‡(
k
 > 5Ë*
cur
++ = 
sˇÀ
 * ((*
ö
 >> 2) & 0x01);

4768 i‡(
k
 > 6Ë*
cur
++ = 
sˇÀ
 * ((*
ö
 >> 1) & 0x01);

4770 i‡(
img_n
 !
out_n
) {

4771 
q
;

4773 
cur
 = 
a
->
out
 + 
°ride
*
j
;

4774 i‡(
img_n
 == 1) {

4775 
q
=
x
-1; q >= 0; --q) {

4776 
cur
[
q
*2+1] = 255;

4777 
cur
[
q
*2+0] = cur[q];

4780 
	`STBI_ASSERT
(
img_n
 == 3);

4781 
q
=
x
-1; q >= 0; --q) {

4782 
cur
[
q
*4+3] = 255;

4783 
cur
[
q
*4+2] = cur[q*3+2];

4784 
cur
[
q
*4+1] = cur[q*3+1];

4785 
cur
[
q
*4+0] = cur[q*3+0];

4790 } i‡(
dïth
 == 16) {

4795 
°bi_uc
 *
cur
 = 
a
->
out
;

4796 
°bi__uöt16
 *
cur16
 = (°bi__uöt16*)
cur
;

4798 
i
=0; i < 
x
*
y
*
out_n
; ++i,
cur16
++,
cur
+=2) {

4799 *
cur16
 = (
cur
[0] << 8) | cur[1];

4804 
	}
}

4806 
	$°bi__¸óã_≤g_image
(
°bi__≤g
 *
a
, 
°bi_uc
 *
image_d©a
, 
°bi__uöt32
 
image_d©a_Àn
, 
out_n
, 
dïth
, 
cﬁ‹
, 
öãæa˚d
)

4808 
byãs
 = (
dïth
 == 16 ? 2 : 1);

4809 
out_byãs
 = 
out_n
 * 
byãs
;

4810 
°bi_uc
 *
föÆ
;

4811 
p
;

4812 i‡(!
öãæa˚d
)

4813  
	`°bi__¸óã_≤g_image_øw
(
a
, 
image_d©a
, 
image_d©a_Àn
, 
out_n
,á->
s
->
img_x
,á->s->
img_y
, 
dïth
, 
cﬁ‹
);

4816 
föÆ
 = (
°bi_uc
 *Ë
	`°bi__mÆloc_mad3
(
a
->
s
->
img_x
,á->s->
img_y
, 
out_byãs
, 0);

4817 i‡(!
föÆ
Ë 
	`°bi__îr
("outofmem", "Out of memory");

4818 
p
=0;Ö < 7; ++p) {

4819 
x‹ig
[] = { 0,4,0,2,0,1,0 };

4820 
y‹ig
[] = { 0,0,4,0,2,0,1 };

4821 
x•c
[] = { 8,8,4,4,2,2,1 };

4822 
y•c
[] = { 8,8,8,4,4,2,2 };

4823 
i
,
j
,
x
,
y
;

4825 
x
 = (
a
->
s
->
img_x
 - 
x‹ig
[
p
] + 
x•c
[p]-1) / xspc[p];

4826 
y
 = (
a
->
s
->
img_y
 - 
y‹ig
[
p
] + 
y•c
[p]-1) / yspc[p];

4827 i‡(
x
 && 
y
) {

4828 
°bi__uöt32
 
img_Àn
 = ((((
a
->
s
->
img_n
 * 
x
 * 
dïth
Ë+ 7Ë>> 3Ë+ 1Ë* 
y
;

4829 i‡(!
	`°bi__¸óã_≤g_image_øw
(
a
, 
image_d©a
, 
image_d©a_Àn
, 
out_n
, 
x
, 
y
, 
dïth
, 
cﬁ‹
)) {

4830 
	`STBI_FREE
(
föÆ
);

4833 
j
=0; j < 
y
; ++j) {

4834 
i
=0; i < 
x
; ++i) {

4835 
out_y
 = 
j
*
y•c
[
p
]+
y‹ig
[p];

4836 
out_x
 = 
i
*
x•c
[
p
]+
x‹ig
[p];

4837 
	`mem˝y
(
föÆ
 + 
out_y
*
a
->
s
->
img_x
*
out_byãs
 + 
out_x
*out_bytes,

4838 
a
->
out
 + (
j
*
x
+
i
)*
out_byãs
, out_bytes);

4841 
	`STBI_FREE
(
a
->
out
);

4842 
image_d©a
 +
img_Àn
;

4843 
image_d©a_Àn
 -
img_Àn
;

4846 
a
->
out
 = 
föÆ
;

4849 
	}
}

4851 
	$°bi__compuã_å™•¨ícy
(
°bi__≤g
 *
z
, 
°bi_uc
 
tc
[3], 
out_n
)

4853 
°bi__c⁄ãxt
 *
s
 = 
z
->s;

4854 
°bi__uöt32
 
i
, 
pixñ_cou¡
 = 
s
->
img_x
 * s->
img_y
;

4855 
°bi_uc
 *
p
 = 
z
->
out
;

4859 
	`STBI_ASSERT
(
out_n
 == 2 || out_n == 4);

4861 i‡(
out_n
 == 2) {

4862 
i
=0; i < 
pixñ_cou¡
; ++i) {

4863 
p
[1] = (p[0] =
tc
[0] ? 0 : 255);

4864 
p
 += 2;

4867 
i
=0; i < 
pixñ_cou¡
; ++i) {

4868 i‡(
p
[0] =
tc
[0] &&Ö[1] ==Åc[1] &&Ö[2] ==Åc[2])

4869 
p
[3] = 0;

4870 
p
 += 4;

4874 
	}
}

4876 
	$°bi__compuã_å™•¨ícy16
(
°bi__≤g
 *
z
, 
°bi__uöt16
 
tc
[3], 
out_n
)

4878 
°bi__c⁄ãxt
 *
s
 = 
z
->s;

4879 
°bi__uöt32
 
i
, 
pixñ_cou¡
 = 
s
->
img_x
 * s->
img_y
;

4880 
°bi__uöt16
 *
p
 = (°bi__uöt16*Ë
z
->
out
;

4884 
	`STBI_ASSERT
(
out_n
 == 2 || out_n == 4);

4886 i‡(
out_n
 == 2) {

4887 
i
 = 0; i < 
pixñ_cou¡
; ++i) {

4888 
p
[1] = (p[0] =
tc
[0] ? 0 : 65535);

4889 
p
 += 2;

4892 
i
 = 0; i < 
pixñ_cou¡
; ++i) {

4893 i‡(
p
[0] =
tc
[0] &&Ö[1] ==Åc[1] &&Ö[2] ==Åc[2])

4894 
p
[3] = 0;

4895 
p
 += 4;

4899 
	}
}

4901 
	$°bi__ex∑nd_≤g_∑Àâe
(
°bi__≤g
 *
a
, 
°bi_uc
 *
∑Àâe
, 
Àn
, 
∑l_img_n
)

4903 
°bi__uöt32
 
i
, 
pixñ_cou¡
 = 
a
->
s
->
img_x
 *á->s->
img_y
;

4904 
°bi_uc
 *
p
, *
ãmp_out
, *
‹ig
 = 
a
->
out
;

4906 
p
 = (
°bi_uc
 *Ë
	`°bi__mÆloc_mad2
(
pixñ_cou¡
, 
∑l_img_n
, 0);

4907 i‡(
p
 =
NULL
Ë 
	`°bi__îr
("outofmem", "Out of memory");

4910 
ãmp_out
 = 
p
;

4912 i‡(
∑l_img_n
 == 3) {

4913 
i
=0; i < 
pixñ_cou¡
; ++i) {

4914 
n
 = 
‹ig
[
i
]*4;

4915 
p
[0] = 
∑Àâe
[
n
 ];

4916 
p
[1] = 
∑Àâe
[
n
+1];

4917 
p
[2] = 
∑Àâe
[
n
+2];

4918 
p
 += 3;

4921 
i
=0; i < 
pixñ_cou¡
; ++i) {

4922 
n
 = 
‹ig
[
i
]*4;

4923 
p
[0] = 
∑Àâe
[
n
 ];

4924 
p
[1] = 
∑Àâe
[
n
+1];

4925 
p
[2] = 
∑Àâe
[
n
+2];

4926 
p
[3] = 
∑Àâe
[
n
+3];

4927 
p
 += 4;

4930 
	`STBI_FREE
(
a
->
out
);

4931 
a
->
out
 = 
ãmp_out
;

4933 
	`STBI_NOTUSED
(
Àn
);

4936 
	}
}

4938 
	g°bi__u≈ªmu…ùly_⁄_lﬂd_globÆ
 = 0;

4939 
	g°bi__de_ùh⁄e_Êag_globÆ
 = 0;

4941 
STBIDEF
 
	$°bi_£t_u≈ªmu…ùly_⁄_lﬂd
(
Êag_åue_if_should_u≈ªmu…ùly
)

4943 
°bi__u≈ªmu…ùly_⁄_lﬂd_globÆ
 = 
Êag_åue_if_should_u≈ªmu…ùly
;

4944 
	}
}

4946 
STBIDEF
 
	$°bi_c⁄vît_ùh⁄e_≤g_to_rgb
(
Êag_åue_if_should_c⁄vît
)

4948 
°bi__de_ùh⁄e_Êag_globÆ
 = 
Êag_åue_if_should_c⁄vît
;

4949 
	}
}

4951 #i‚de‡
STBI_THREAD_LOCAL


4952 
	#°bi__u≈ªmu…ùly_⁄_lﬂd
 
°bi__u≈ªmu…ùly_⁄_lﬂd_globÆ


	)

4953 
	#°bi__de_ùh⁄e_Êag
 
°bi__de_ùh⁄e_Êag_globÆ


	)

4955 
STBI_THREAD_LOCAL
 
	g°bi__u≈ªmu…ùly_⁄_lﬂd_loˇl
, 
	g°bi__u≈ªmu…ùly_⁄_lﬂd_£t
;

4956 
STBI_THREAD_LOCAL
 
	g°bi__de_ùh⁄e_Êag_loˇl
, 
	g°bi__de_ùh⁄e_Êag_£t
;

4958 
STBIDEF
 
	$°bi__u≈ªmu…ùly_⁄_lﬂd_thªad
(
Êag_åue_if_should_u≈ªmu…ùly
)

4960 
°bi__u≈ªmu…ùly_⁄_lﬂd_loˇl
 = 
Êag_åue_if_should_u≈ªmu…ùly
;

4961 
°bi__u≈ªmu…ùly_⁄_lﬂd_£t
 = 1;

4962 
	}
}

4964 
STBIDEF
 
	$°bi_c⁄vît_ùh⁄e_≤g_to_rgb_thªad
(
Êag_åue_if_should_c⁄vît
)

4966 
°bi__de_ùh⁄e_Êag_loˇl
 = 
Êag_åue_if_should_c⁄vît
;

4967 
°bi__de_ùh⁄e_Êag_£t
 = 1;

4968 
	}
}

4970 
	#°bi__u≈ªmu…ùly_⁄_lﬂd
 (
°bi__u≈ªmu…ùly_⁄_lﬂd_£t
 \

4971 ? 
°bi__u≈ªmu…ùly_⁄_lﬂd_loˇl
 \

4972 : 
°bi__u≈ªmu…ùly_⁄_lﬂd_globÆ
)

	)

4973 
	#°bi__de_ùh⁄e_Êag
 (
°bi__de_ùh⁄e_Êag_£t
 \

4974 ? 
°bi__de_ùh⁄e_Êag_loˇl
 \

4975 : 
°bi__de_ùh⁄e_Êag_globÆ
)

	)

4978 
	$°bi__de_ùh⁄e
(
°bi__≤g
 *
z
)

4980 
°bi__c⁄ãxt
 *
s
 = 
z
->s;

4981 
°bi__uöt32
 
i
, 
pixñ_cou¡
 = 
s
->
img_x
 * s->
img_y
;

4982 
°bi_uc
 *
p
 = 
z
->
out
;

4984 i‡(
s
->
img_out_n
 == 3) {

4985 
i
=0; i < 
pixñ_cou¡
; ++i) {

4986 
°bi_uc
 
t
 = 
p
[0];

4987 
p
[0] =Ö[2];

4988 
p
[2] = 
t
;

4989 
p
 += 3;

4992 
	`STBI_ASSERT
(
s
->
img_out_n
 == 4);

4993 i‡(
°bi__u≈ªmu…ùly_⁄_lﬂd
) {

4995 
i
=0; i < 
pixñ_cou¡
; ++i) {

4996 
°bi_uc
 
a
 = 
p
[3];

4997 
°bi_uc
 
t
 = 
p
[0];

4998 i‡(
a
) {

4999 
°bi_uc
 
hÆf
 = 
a
 / 2;

5000 
p
[0] = (p[2] * 255 + 
hÆf
Ë/ 
a
;

5001 
p
[1] = (p[1] * 255 + 
hÆf
Ë/ 
a
;

5002 
p
[2] = ( 
t
 * 255 + 
hÆf
Ë/ 
a
;

5004 
p
[0] =Ö[2];

5005 
p
[2] = 
t
;

5007 
p
 += 4;

5011 
i
=0; i < 
pixñ_cou¡
; ++i) {

5012 
°bi_uc
 
t
 = 
p
[0];

5013 
p
[0] =Ö[2];

5014 
p
[2] = 
t
;

5015 
p
 += 4;

5019 
	}
}

5021 
	#STBI__PNG_TYPE
(
a
,
b
,
c
,
d
Ë(((Ë◊Ë<< 24Ë+ ((Ë(bË<< 16Ë+ ((Ë(cË<< 8Ë+ (Ë(d))

	)

5023 
	$°bi__∑r£_≤g_fûe
(
°bi__≤g
 *
z
, 
sˇn
, 
ªq_comp
)

5025 
°bi_uc
 
∑Àâe
[1024], 
∑l_img_n
=0;

5026 
°bi_uc
 
has_å™s
=0, 
tc
[3]={0};

5027 
°bi__uöt16
 
tc16
[3];

5028 
°bi__uöt32
 
ioff
=0, 
id©a_limô
=0, 
i
, 
∑l_Àn
=0;

5029 
fú°
=1,
k
,
öãæa˚
=0, 
cﬁ‹
=0, 
is_ùh⁄e
=0;

5030 
°bi__c⁄ãxt
 *
s
 = 
z
->s;

5032 
z
->
ex∑nded
 = 
NULL
;

5033 
z
->
id©a
 = 
NULL
;

5034 
z
->
out
 = 
NULL
;

5036 i‡(!
	`°bi__check_≤g_hódî
(
s
))  0;

5038 i‡(
sˇn
 =
STBI__SCAN_ty≥
)  1;

5041 
°bi__≤gchunk
 
c
 = 
	`°bi__gë_chunk_hódî
(
s
);

5042 
c
.
ty≥
) {

5043 
	`STBI__PNG_TYPE
('C','g','B','I'):

5044 
is_ùh⁄e
 = 1;

5045 
	`°bi__skù
(
s
, 
c
.
Àngth
);

5047 
	`STBI__PNG_TYPE
('I','H','D','R'): {

5048 
comp
,
fûãr
;

5049 i‡(!
fú°
Ë 
	`°bi__îr
("multiple IHDR","Corrupt PNG");

5050 
fú°
 = 0;

5051 i‡(
c
.
Àngth
 !13Ë 
	`°bi__îr
("bad IHDRÜen","Corrupt PNG");

5052 
s
->
img_x
 = 
	`°bi__gë32be
(s);

5053 
s
->
img_y
 = 
	`°bi__gë32be
(s);

5054 i‡(
s
->
img_y
 > 
STBI_MAX_DIMENSIONS
Ë 
	`°bi__îr
("tooÜarge","VeryÜarge image (corrupt?)");

5055 i‡(
s
->
img_x
 > 
STBI_MAX_DIMENSIONS
Ë 
	`°bi__îr
("tooÜarge","VeryÜarge image (corrupt?)");

5056 
z
->
dïth
 = 
	`°bi__gë8
(
s
); i‡(z->dïth !1 && z->dïth !2 && z->dïth !4 && z->dïth !8 && z->dïth !16Ë 
	`°bi__îr
("1/2/4/8/16-bit only","PNGÇot supported: 1/2/4/8/16-bit only");

5057 
cﬁ‹
 = 
	`°bi__gë8
(
s
); i‡(cﬁ‹ > 6Ë 
	`°bi__îr
("bad ctype","Corrupt PNG");

5058 i‡(
cﬁ‹
 =3 && 
z
->
dïth
 =16Ë 
	`°bi__îr
("bad ctype","Corrupt PNG");

5059 i‡(
cﬁ‹
 =3Ë
∑l_img_n
 = 3; i‡(cﬁ‹ & 1Ë 
	`°bi__îr
("bad ctype","Corrupt PNG");

5060 
comp
 = 
	`°bi__gë8
(
s
); i‡(compË 
	`°bi__îr
("bad comp method","Corrupt PNG");

5061 
fûãr

	`°bi__gë8
(
s
); i‡(fûãrË 
	`°bi__îr
("bad filter method","Corrupt PNG");

5062 
öãæa˚
 = 
	`°bi__gë8
(
s
); i‡(öãæa˚>1Ë 
	`°bi__îr
("bad interlace method","Corrupt PNG");

5063 i‡(!
s
->
img_x
 || !s->
img_y
Ë 
	`°bi__îr
("0-pixel image","Corrupt PNG");

5064 i‡(!
∑l_img_n
) {

5065 
s
->
img_n
 = (
cﬁ‹
 & 2 ? 3 : 1) + (color & 4 ? 1 : 0);

5066 i‡((1 << 30Ë/ 
s
->
img_x
 / s->
img_n
 < s->
img_y
Ë 
	`°bi__îr
("tooÜarge", "ImageÅooÜargeÅo decode");

5067 i‡(
sˇn
 =
STBI__SCAN_hódî
)  1;

5071 
s
->
img_n
 = 1;

5072 i‡((1 << 30Ë/ 
s
->
img_x
 / 4 < s->
img_y
Ë 
	`°bi__îr
("tooÜarge","Corrupt PNG");

5078 
	`STBI__PNG_TYPE
('P','L','T','E'): {

5079 i‡(
fú°
Ë 
	`°bi__îr
("firstÇot IHDR", "Corrupt PNG");

5080 i‡(
c
.
Àngth
 > 256*3Ë 
	`°bi__îr
("invalid PLTE","Corrupt PNG");

5081 
∑l_Àn
 = 
c
.
Àngth
 / 3;

5082 i‡(
∑l_Àn
 * 3 !
c
.
Àngth
Ë 
	`°bi__îr
("invalid PLTE","Corrupt PNG");

5083 
i
=0; i < 
∑l_Àn
; ++i) {

5084 
∑Àâe
[
i
*4+0] = 
	`°bi__gë8
(
s
);

5085 
∑Àâe
[
i
*4+1] = 
	`°bi__gë8
(
s
);

5086 
∑Àâe
[
i
*4+2] = 
	`°bi__gë8
(
s
);

5087 
∑Àâe
[
i
*4+3] = 255;

5092 
	`STBI__PNG_TYPE
('t','R','N','S'): {

5093 i‡(
fú°
Ë 
	`°bi__îr
("firstÇot IHDR", "Corrupt PNG");

5094 i‡(
z
->
id©a
Ë 
	`°bi__îr
("tRNSáfter IDAT","Corrupt PNG");

5095 i‡(
∑l_img_n
) {

5096 i‡(
sˇn
 =
STBI__SCAN_hódî
Ë{ 
s
->
img_n
 = 4;  1; }

5097 i‡(
∑l_Àn
 =0Ë 
	`°bi__îr
("tRNS before PLTE","Corrupt PNG");

5098 i‡(
c
.
Àngth
 > 
∑l_Àn
Ë 
	`°bi__îr
("badÅRNSÜen","Corrupt PNG");

5099 
∑l_img_n
 = 4;

5100 
i
=0; i < 
c
.
Àngth
; ++i)

5101 
∑Àâe
[
i
*4+3] = 
	`°bi__gë8
(
s
);

5103 i‡(!(
s
->
img_n
 & 1)Ë 
	`°bi__îr
("tRNS withálpha","Corrupt PNG");

5104 i‡(
c
.
Àngth
 !(
°bi__uöt32
Ë
s
->
img_n
*2Ë 
	`°bi__îr
("badÅRNSÜen","Corrupt PNG");

5105 
has_å™s
 = 1;

5106 i‡(
z
->
dïth
 == 16) {

5107 
k
 = 0; k < 
s
->
img_n
; ++kË
tc16
[k] = (
°bi__uöt16
)
	`°bi__gë16be
(s);

5109 
k
 = 0; k < 
s
->
img_n
; ++kË
tc
[k] = (
°bi_uc
)(
	`°bi__gë16be
(sË& 255Ë* 
°bi__dïth_sˇÀ_èbÀ
[
z
->
dïth
];

5115 
	`STBI__PNG_TYPE
('I','D','A','T'): {

5116 i‡(
fú°
Ë 
	`°bi__îr
("firstÇot IHDR", "Corrupt PNG");

5117 i‡(
∑l_img_n
 && !
∑l_Àn
Ë 
	`°bi__îr
("no PLTE","Corrupt PNG");

5118 i‡(
sˇn
 =
STBI__SCAN_hódî
Ë{ 
s
->
img_n
 = 
∑l_img_n
;  1; }

5119 i‡(()(
ioff
 + 
c
.
Àngth
) < ()ioff)  0;

5120 i‡(
ioff
 + 
c
.
Àngth
 > 
id©a_limô
) {

5121 
°bi__uöt32
 
id©a_limô_ﬁd
 = 
id©a_limô
;

5122 
°bi_uc
 *
p
;

5123 i‡(
id©a_limô
 =0Ëid©a_limô = 
c
.
Àngth
 > 4096 ? c.length : 4096;

5124 
ioff
 + 
c
.
Àngth
 > 
id©a_limô
)

5125 
id©a_limô
 *= 2;

5126 
	`STBI_NOTUSED
(
id©a_limô_ﬁd
);

5127 
p
 = (
°bi_uc
 *Ë
	`STBI_REALLOC_SIZED
(
z
->
id©a
, 
id©a_limô_ﬁd
, 
id©a_limô
); i‡’ =
NULL
Ë 
	`°bi__îr
("outofmem", "Out of memory");

5128 
z
->
id©a
 = 
p
;

5130 i‡(!
	`°bi__gën
(
s
, 
z
->
id©a
+
ioff
,
c
.
Àngth
)Ë 
	`°bi__îr
("outofdata","Corrupt PNG");

5131 
ioff
 +
c
.
Àngth
;

5135 
	`STBI__PNG_TYPE
('I','E','N','D'): {

5136 
°bi__uöt32
 
øw_Àn
, 
b∂
;

5137 i‡(
fú°
Ë 
	`°bi__îr
("firstÇot IHDR", "Corrupt PNG");

5138 i‡(
sˇn
 !
STBI__SCAN_lﬂd
)  1;

5139 i‡(
z
->
id©a
 =
NULL
Ë 
	`°bi__îr
("no IDAT","Corrupt PNG");

5141 
b∂
 = (
s
->
img_x
 * 
z
->
dïth
 + 7) / 8;

5142 
øw_Àn
 = 
b∂
 * 
s
->
img_y
 * s->
img_n
 + s->img_y ;

5143 
z
->
ex∑nded
 = (
°bi_uc
 *Ë
	`°bi_zlib_decode_mÆloc_guesssize_hódîÊag
((*Ëz->
id©a
, 
ioff
, 
øw_Àn
, (*Ë&øw_Àn, !
is_ùh⁄e
);

5144 i‡(
z
->
ex∑nded
 =
NULL
)  0;

5145 
	`STBI_FREE
(
z
->
id©a
); z->id©®
NULL
;

5146 i‡((
ªq_comp
 =
s
->
img_n
+1 &&Ñeq_com∞!3 && !
∑l_img_n
Ë|| 
has_å™s
)

5147 
s
->
img_out_n
 = s->
img_n
+1;

5149 
s
->
img_out_n
 = s->
img_n
;

5150 i‡(!
	`°bi__¸óã_≤g_image
(
z
, z->
ex∑nded
, 
øw_Àn
, 
s
->
img_out_n
, z->
dïth
, 
cﬁ‹
, 
öãæa˚
))  0;

5151 i‡(
has_å™s
) {

5152 i‡(
z
->
dïth
 == 16) {

5153 i‡(!
	`°bi__compuã_å™•¨ícy16
(
z
, 
tc16
, 
s
->
img_out_n
))  0;

5155 i‡(!
	`°bi__compuã_å™•¨ícy
(
z
, 
tc
, 
s
->
img_out_n
))  0;

5158 i‡(
is_ùh⁄e
 && 
°bi__de_ùh⁄e_Êag
 && 
s
->
img_out_n
 > 2)

5159 
	`°bi__de_ùh⁄e
(
z
);

5160 i‡(
∑l_img_n
) {

5162 
s
->
img_n
 = 
∑l_img_n
;

5163 
s
->
img_out_n
 = 
∑l_img_n
;

5164 i‡(
ªq_comp
 >3Ë
s
->
img_out_n
 =Ñeq_comp;

5165 i‡(!
	`°bi__ex∑nd_≤g_∑Àâe
(
z
, 
∑Àâe
, 
∑l_Àn
, 
s
->
img_out_n
))

5167 } i‡(
has_å™s
) {

5169 ++
s
->
img_n
;

5171 
	`STBI_FREE
(
z
->
ex∑nded
); z->ex∑nded = 
NULL
;

5173 
	`°bi__gë32be
(
s
);

5179 i‡(
fú°
Ë 
	`°bi__îr
("firstÇot IHDR", "Corrupt PNG");

5180 i‡((
c
.
ty≥
 & (1 << 29)) == 0) {

5181 #i‚de‡
STBI_NO_FAILURE_STRINGS


5183 
övÆid_chunk
[] = "XXXX PNG chunkÇot known";

5184 
övÆid_chunk
[0] = 
	`STBI__BYTECAST
(
c
.
ty≥
 >> 24);

5185 
övÆid_chunk
[1] = 
	`STBI__BYTECAST
(
c
.
ty≥
 >> 16);

5186 
övÆid_chunk
[2] = 
	`STBI__BYTECAST
(
c
.
ty≥
 >> 8);

5187 
övÆid_chunk
[3] = 
	`STBI__BYTECAST
(
c
.
ty≥
 >> 0);

5189  
	`°bi__îr
(
övÆid_chunk
, "PNGÇot supported: unknown PNG chunkÅype");

5191 
	`°bi__skù
(
s
, 
c
.
Àngth
);

5195 
	`°bi__gë32be
(
s
);

5197 
	}
}

5199 *
	$°bi__do_≤g
(
°bi__≤g
 *
p
, *
x
, *
y
, *
n
, 
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
)

5201 *
ªsu…
=
NULL
;

5202 i‡(
ªq_comp
 < 0 ||Ñeq_com∞> 4Ë 
	`°bi__îΩuc
("badÑeq_comp", "InternalÉrror");

5203 i‡(
	`°bi__∑r£_≤g_fûe
(
p
, 
STBI__SCAN_lﬂd
, 
ªq_comp
)) {

5204 i‡(
p
->
dïth
 <= 8)

5205 
ri
->
bôs_≥r_ch™√l
 = 8;

5206 i‡(
p
->
dïth
 == 16)

5207 
ri
->
bôs_≥r_ch™√l
 = 16;

5209  
	`°bi__îΩuc
("bad bits_per_channel", "PNGÇot supported: unsupported color depth");

5210 
ªsu…
 = 
p
->
out
;

5211 
p
->
out
 = 
NULL
;

5212 i‡(
ªq_comp
 &&Ñeq_com∞!
p
->
s
->
img_out_n
) {

5213 i‡(
ri
->
bôs_≥r_ch™√l
 == 8)

5214 
ªsu…
 = 
	`°bi__c⁄vît_f‹m©
((*Ëªsu…, 
p
->
s
->
img_out_n
, 
ªq_comp
,Ö->s->
img_x
,Ö->s->
img_y
);

5216 
ªsu…
 = 
	`°bi__c⁄vît_f‹m©16
((
°bi__uöt16
 *Ëªsu…, 
p
->
s
->
img_out_n
, 
ªq_comp
,Ö->s->
img_x
,Ö->s->
img_y
);

5217 
p
->
s
->
img_out_n
 = 
ªq_comp
;

5218 i‡(
ªsu…
 =
NULL
) Ñesult;

5220 *
x
 = 
p
->
s
->
img_x
;

5221 *
y
 = 
p
->
s
->
img_y
;

5222 i‡(
n
Ë*¿
p
->
s
->
img_n
;

5224 
	`STBI_FREE
(
p
->
out
);Ö->ouà
NULL
;

5225 
	`STBI_FREE
(
p
->
ex∑nded
);Ö->ex∑nded = 
NULL
;

5226 
	`STBI_FREE
(
p
->
id©a
);Ö->id©®
NULL
;

5228  
ªsu…
;

5229 
	}
}

5231 *
	$°bi__≤g_lﬂd
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
)

5233 
°bi__≤g
 
p
;

5234 
p
.
s
 = s;

5235  
	`°bi__do_≤g
(&
p
, 
x
,
y
,
comp
,
ªq_comp
, 
ri
);

5236 
	}
}

5238 
	$°bi__≤g_ã°
(
°bi__c⁄ãxt
 *
s
)

5240 
r
;

5241 
r
 = 
	`°bi__check_≤g_hódî
(
s
);

5242 
	`°bi__ªwöd
(
s
);

5243  
r
;

5244 
	}
}

5246 
	$°bi__≤g_öfo_øw
(
°bi__≤g
 *
p
, *
x
, *
y
, *
comp
)

5248 i‡(!
	`°bi__∑r£_≤g_fûe
(
p
, 
STBI__SCAN_hódî
, 0)) {

5249 
	`°bi__ªwöd
–
p
->
s
 );

5252 i‡(
x
Ë*x = 
p
->
s
->
img_x
;

5253 i‡(
y
Ë*y = 
p
->
s
->
img_y
;

5254 i‡(
comp
Ë*com∞
p
->
s
->
img_n
;

5256 
	}
}

5258 
	$°bi__≤g_öfo
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
)

5260 
°bi__≤g
 
p
;

5261 
p
.
s
 = s;

5262  
	`°bi__≤g_öfo_øw
(&
p
, 
x
, 
y
, 
comp
);

5263 
	}
}

5265 
	$°bi__≤g_is16
(
°bi__c⁄ãxt
 *
s
)

5267 
°bi__≤g
 
p
;

5268 
p
.
s
 = s;

5269 i‡(!
	`°bi__≤g_öfo_øw
(&
p
, 
NULL
, NULL, NULL))

5271 i‡(
p
.
dïth
 != 16) {

5272 
	`°bi__ªwöd
(
p
.
s
);

5276 
	}
}

5281 #i‚de‡
STBI_NO_BMP


5282 
	$°bi__bmp_ã°_øw
(
°bi__c⁄ãxt
 *
s
)

5284 
r
;

5285 
sz
;

5286 i‡(
	`°bi__gë8
(
s
) != 'B')  0;

5287 i‡(
	`°bi__gë8
(
s
) != 'M')  0;

5288 
	`°bi__gë32À
(
s
);

5289 
	`°bi__gë16À
(
s
);

5290 
	`°bi__gë16À
(
s
);

5291 
	`°bi__gë32À
(
s
);

5292 
sz
 = 
	`°bi__gë32À
(
s
);

5293 
r
 = (
sz
 == 12 || sz == 40 || sz == 56 || sz == 108 || sz == 124);

5294  
r
;

5295 
	}
}

5297 
	$°bi__bmp_ã°
(
°bi__c⁄ãxt
 *
s
)

5299 
r
 = 
	`°bi__bmp_ã°_øw
(
s
);

5300 
	`°bi__ªwöd
(
s
);

5301  
r
;

5302 
	}
}

5306 
	$°bi__high_bô
(
z
)

5308 
n
=0;

5309 i‡(
z
 == 0)  -1;

5310 i‡(
z
 >0x10000Ë{ 
n
 += 16; z >>= 16; }

5311 i‡(
z
 >0x00100Ë{ 
n
 += 8; z >>= 8; }

5312 i‡(
z
 >0x00010Ë{ 
n
 += 4; z >>= 4; }

5313 i‡(
z
 >0x00004Ë{ 
n
 += 2; z >>= 2; }

5314 i‡(
z
 >0x00002Ë{ 
n
 += 1; }

5315  
n
;

5316 
	}
}

5318 
	$°bi__bôcou¡
(
a
)

5320 
a
 = (a & 0x55555555) + ((a >> 1) & 0x55555555);

5321 
a
 = (a & 0x33333333) + ((a >> 2) & 0x33333333);

5322 
a
 = (a + (a >> 4)) & 0x0f0f0f0f;

5323 
a
 = (a + (a >> 8));

5324 
a
 = (a + (a >> 16));

5325  
a
 & 0xff;

5326 
	}
}

5331 
	$°bi__shi·sig√d
(
v
, 
shi·
, 
bôs
)

5333 
mul_èbÀ
[9] = {

5338 
shi·_èbÀ
[9] = {

5341 i‡(
shi·
 < 0)

5342 
v
 <<-
shi·
;

5344 
v
 >>
shi·
;

5345 
	`STBI_ASSERT
(
v
 < 256);

5346 
v
 >>(8-
bôs
);

5347 
	`STBI_ASSERT
(
bôs
 >= 0 && bits <= 8);

5348  (Ë((Ë
v
 * 
mul_èbÀ
[
bôs
]Ë>> 
shi·_èbÀ
[bits];

5349 
	}
}

5353 
	mbµ
, 
	moff£t
, 
	mhsz
;

5354 
	mmr
,
	mmg
,
	mmb
,
	mma
, 
	mÆl_a
;

5355 
	mexåa_ªad
;

5356 } 
	t°bi__bmp_d©a
;

5358 
	$°bi__bmp_£t_mask_deÁu…s
(
°bi__bmp_d©a
 *
öfo
, 
com¥ess
)

5361 i‡(
com¥ess
 == 3)

5364 i‡(
com¥ess
 == 0) {

5365 i‡(
öfo
->
bµ
 == 16) {

5366 
öfo
->
mr
 = 31u << 10;

5367 
öfo
->
mg
 = 31u << 5;

5368 
öfo
->
mb
 = 31u << 0;

5369 } i‡(
öfo
->
bµ
 == 32) {

5370 
öfo
->
mr
 = 0xffu << 16;

5371 
öfo
->
mg
 = 0xffu << 8;

5372 
öfo
->
mb
 = 0xffu << 0;

5373 
öfo
->
ma
 = 0xffu << 24;

5374 
öfo
->
Æl_a
 = 0;

5377 
öfo
->
mr
 = info->
mg
 = info->
mb
 = info->
ma
 = 0;

5382 
	}
}

5384 *
	$°bi__bmp_∑r£_hódî
(
°bi__c⁄ãxt
 *
s
, 
°bi__bmp_d©a
 *
öfo
)

5386 
hsz
;

5387 i‡(
	`°bi__gë8
(
s
Ë!'B' || stbi__gë8(sË!'M'Ë 
	`°bi__îΩuc
("not BMP", "Corrupt BMP");

5388 
	`°bi__gë32À
(
s
);

5389 
	`°bi__gë16À
(
s
);

5390 
	`°bi__gë16À
(
s
);

5391 
öfo
->
off£t
 = 
	`°bi__gë32À
(
s
);

5392 
öfo
->
hsz
 = hsz = 
	`°bi__gë32À
(
s
);

5393 
öfo
->
mr
 = info->
mg
 = info->
mb
 = info->
ma
 = 0;

5394 
öfo
->
exåa_ªad
 = 14;

5396 i‡(
öfo
->
off£t
 < 0Ë 
	`°bi__îΩuc
("bad BMP", "bad BMP");

5398 i‡(
hsz
 !12 && hsz !40 && hsz !56 && hsz !108 && hsz !124Ë 
	`°bi__îΩuc
("unknown BMP", "BMPÅypeÇot supported: unknown");

5399 i‡(
hsz
 == 12) {

5400 
s
->
img_x
 = 
	`°bi__gë16À
(s);

5401 
s
->
img_y
 = 
	`°bi__gë16À
(s);

5403 
s
->
img_x
 = 
	`°bi__gë32À
(s);

5404 
s
->
img_y
 = 
	`°bi__gë32À
(s);

5406 i‡(
	`°bi__gë16À
(
s
Ë!1Ë 
	`°bi__îΩuc
("bad BMP", "bad BMP");

5407 
öfo
->
bµ
 = 
	`°bi__gë16À
(
s
);

5408 i‡(
hsz
 != 12) {

5409 
com¥ess
 = 
	`°bi__gë32À
(
s
);

5410 i‡(
com¥ess
 =1 || com¥es†=2Ë 
	`°bi__îΩuc
("BMP RLE", "BMPÅypeÇot supported: RLE");

5411 i‡(
com¥ess
 >4Ë 
	`°bi__îΩuc
("BMP JPEG/PNG", "BMPÅypeÇot supported: unsupported compression");

5412 i‡(
com¥ess
 =3 && 
öfo
->
bµ
 !16 && info->bµ !32Ë 
	`°bi__îΩuc
("bad BMP", "bad BMP");

5413 
	`°bi__gë32À
(
s
);

5414 
	`°bi__gë32À
(
s
);

5415 
	`°bi__gë32À
(
s
);

5416 
	`°bi__gë32À
(
s
);

5417 
	`°bi__gë32À
(
s
);

5418 i‡(
hsz
 == 40 || hsz == 56) {

5419 i‡(
hsz
 == 56) {

5420 
	`°bi__gë32À
(
s
);

5421 
	`°bi__gë32À
(
s
);

5422 
	`°bi__gë32À
(
s
);

5423 
	`°bi__gë32À
(
s
);

5425 i‡(
öfo
->
bµ
 == 16 || info->bpp == 32) {

5426 i‡(
com¥ess
 == 0) {

5427 
	`°bi__bmp_£t_mask_deÁu…s
(
öfo
, 
com¥ess
);

5428 } i‡(
com¥ess
 == 3) {

5429 
öfo
->
mr
 = 
	`°bi__gë32À
(
s
);

5430 
öfo
->
mg
 = 
	`°bi__gë32À
(
s
);

5431 
öfo
->
mb
 = 
	`°bi__gë32À
(
s
);

5432 
öfo
->
exåa_ªad
 += 12;

5434 i‡(
öfo
->
mr
 =öfo->
mg
 && info->mg =öfo->
mb
) {

5436  
	`°bi__îΩuc
("bad BMP", "bad BMP");

5439  
	`°bi__îΩuc
("bad BMP", "bad BMP");

5443 
i
;

5444 i‡(
hsz
 != 108 && hsz != 124)

5445  
	`°bi__îΩuc
("bad BMP", "bad BMP");

5446 
öfo
->
mr
 = 
	`°bi__gë32À
(
s
);

5447 
öfo
->
mg
 = 
	`°bi__gë32À
(
s
);

5448 
öfo
->
mb
 = 
	`°bi__gë32À
(
s
);

5449 
öfo
->
ma
 = 
	`°bi__gë32À
(
s
);

5450 i‡(
com¥ess
 != 3)

5451 
	`°bi__bmp_£t_mask_deÁu…s
(
öfo
, 
com¥ess
);

5452 
	`°bi__gë32À
(
s
);

5453 
i
=0; i < 12; ++i)

5454 
	`°bi__gë32À
(
s
);

5455 i‡(
hsz
 == 124) {

5456 
	`°bi__gë32À
(
s
);

5457 
	`°bi__gë32À
(
s
);

5458 
	`°bi__gë32À
(
s
);

5459 
	`°bi__gë32À
(
s
);

5464 
	}
}

5467 *
	$°bi__bmp_lﬂd
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
)

5469 
°bi_uc
 *
out
;

5470 
mr
=0,
mg
=0,
mb
=0,
ma
=0, 
Æl_a
;

5471 
°bi_uc
 
∑l
[256][4];

5472 
psize
=0,
i
,
j
,
width
;

5473 
Êù_vîtiˇŒy
, 
∑d
, 
èrgë
;

5474 
°bi__bmp_d©a
 
öfo
;

5475 
	`STBI_NOTUSED
(
ri
);

5477 
öfo
.
Æl_a
 = 255;

5478 i‡(
	`°bi__bmp_∑r£_hódî
(
s
, &
öfo
Ë=
NULL
)

5479  
NULL
;

5481 
Êù_vîtiˇŒy
 = ((Ë
s
->
img_y
) > 0;

5482 
s
->
img_y
 = 
	`abs
(() s->img_y);

5484 i‡(
s
->
img_y
 > 
STBI_MAX_DIMENSIONS
Ë 
	`°bi__îΩuc
("tooÜarge","VeryÜarge image (corrupt?)");

5485 i‡(
s
->
img_x
 > 
STBI_MAX_DIMENSIONS
Ë 
	`°bi__îΩuc
("tooÜarge","VeryÜarge image (corrupt?)");

5487 
mr
 = 
öfo
.mr;

5488 
mg
 = 
öfo
.mg;

5489 
mb
 = 
öfo
.mb;

5490 
ma
 = 
öfo
.ma;

5491 
Æl_a
 = 
öfo
.all_a;

5493 i‡(
öfo
.
hsz
 == 12) {

5494 i‡(
öfo
.
bµ
 < 24)

5495 
psize
 = (
öfo
.
off£t
 - info.
exåa_ªad
 - 24) / 3;

5497 i‡(
öfo
.
bµ
 < 16)

5498 
psize
 = (
öfo
.
off£t
 - info.
exåa_ªad
 - info.
hsz
) >> 2;

5500 i‡(
psize
 == 0) {

5501 i‡(
öfo
.
off£t
 !
s
->
ˇŒback_Æªady_ªad
 + (s->
img_buf„r
 - s->
img_buf„r_‹igöÆ
)) {

5502  
	`°bi__îΩuc
("bad offset", "Corrupt BMP");

5506 i‡(
öfo
.
bµ
 =24 && 
ma
 == 0xff000000)

5507 
s
->
img_n
 = 3;

5509 
s
->
img_n
 = 
ma
 ? 4 : 3;

5510 i‡(
ªq_comp
 &&Ñeq_comp >= 3)

5511 
èrgë
 = 
ªq_comp
;

5513 
èrgë
 = 
s
->
img_n
;

5516 i‡(!
	`°bi__mad3sizes_vÆid
(
èrgë
, 
s
->
img_x
, s->
img_y
, 0))

5517  
	`°bi__îΩuc
("tooÜarge", "Corrupt BMP");

5519 
out
 = (
°bi_uc
 *Ë
	`°bi__mÆloc_mad3
(
èrgë
, 
s
->
img_x
, s->
img_y
, 0);

5520 i‡(!
out
Ë 
	`°bi__îΩuc
("outofmem", "Out of memory");

5521 i‡(
öfo
.
bµ
 < 16) {

5522 
z
=0;

5523 i‡(
psize
 =0 ||Ösizê> 256Ë{ 
	`STBI_FREE
(
out
);  
	`°bi__îΩuc
("invalid", "Corrupt BMP"); }

5524 
i
=0; i < 
psize
; ++i) {

5525 
∑l
[
i
][2] = 
	`°bi__gë8
(
s
);

5526 
∑l
[
i
][1] = 
	`°bi__gë8
(
s
);

5527 
∑l
[
i
][0] = 
	`°bi__gë8
(
s
);

5528 i‡(
öfo
.
hsz
 !12Ë
	`°bi__gë8
(
s
);

5529 
∑l
[
i
][3] = 255;

5531 
	`°bi__skù
(
s
, 
öfo
.
off£t
 - info.
exåa_ªad
 - info.
hsz
 - 
psize
 * (info.hsz == 12 ? 3 : 4));

5532 i‡(
öfo
.
bµ
 =1Ë
width
 = (
s
->
img_x
 + 7) >> 3;

5533 i‡(
öfo
.
bµ
 =4Ë
width
 = (
s
->
img_x
 + 1) >> 1;

5534 i‡(
öfo
.
bµ
 =8Ë
width
 = 
s
->
img_x
;

5535 { 
	`STBI_FREE
(
out
);  
	`°bi__îΩuc
("bad bpp", "Corrupt BMP"); }

5536 
∑d
 = (-
width
)&3;

5537 i‡(
öfo
.
bµ
 == 1) {

5538 
j
=0; j < (Ë
s
->
img_y
; ++j) {

5539 
bô_off£t
 = 7, 
v
 = 
	`°bi__gë8
(
s
);

5540 
i
=0; i < (Ë
s
->
img_x
; ++i) {

5541 
cﬁ‹
 = (
v
>>
bô_off£t
)&0x1;

5542 
out
[
z
++] = 
∑l
[
cﬁ‹
][0];

5543 
out
[
z
++] = 
∑l
[
cﬁ‹
][1];

5544 
out
[
z
++] = 
∑l
[
cﬁ‹
][2];

5545 i‡(
èrgë
 =4Ë
out
[
z
++] = 255;

5546 i‡(
i
+1 =(Ë
s
->
img_x
) ;

5547 if((--
bô_off£t
) < 0) {

5548 
bô_off£t
 = 7;

5549 
v
 = 
	`°bi__gë8
(
s
);

5552 
	`°bi__skù
(
s
, 
∑d
);

5555 
j
=0; j < (Ë
s
->
img_y
; ++j) {

5556 
i
=0; i < (Ë
s
->
img_x
; i += 2) {

5557 
v
=
	`°bi__gë8
(
s
),
v2
=0;

5558 i‡(
öfo
.
bµ
 == 4) {

5559 
v2
 = 
v
 & 15;

5560 
v
 >>= 4;

5562 
out
[
z
++] = 
∑l
[
v
][0];

5563 
out
[
z
++] = 
∑l
[
v
][1];

5564 
out
[
z
++] = 
∑l
[
v
][2];

5565 i‡(
èrgë
 =4Ë
out
[
z
++] = 255;

5566 i‡(
i
+1 =(Ë
s
->
img_x
) ;

5567 
v
 = (
öfo
.
bµ
 =8Ë? 
	`°bi__gë8
(
s
Ë: 
v2
;

5568 
out
[
z
++] = 
∑l
[
v
][0];

5569 
out
[
z
++] = 
∑l
[
v
][1];

5570 
out
[
z
++] = 
∑l
[
v
][2];

5571 i‡(
èrgë
 =4Ë
out
[
z
++] = 255;

5573 
	`°bi__skù
(
s
, 
∑d
);

5577 
rshi·
=0,
gshi·
=0,
bshi·
=0,
ashi·
=0,
rcou¡
=0,
gcou¡
=0,
bcou¡
=0,
acou¡
=0;

5578 
z
 = 0;

5579 
ósy
=0;

5580 
	`°bi__skù
(
s
, 
öfo
.
off£t
 - info.
exåa_ªad
 - info.
hsz
);

5581 i‡(
öfo
.
bµ
 =24Ë
width
 = 3 * 
s
->
img_x
;

5582 i‡(
öfo
.
bµ
 =16Ë
width
 = 2*
s
->
img_x
;

5583 
width
=0;

5584 
∑d
 = (-
width
) & 3;

5585 i‡(
öfo
.
bµ
 == 24) {

5586 
ósy
 = 1;

5587 } i‡(
öfo
.
bµ
 == 32) {

5588 i‡(
mb
 =0xf‡&& 
mg
 =0xff00 && 
mr
 =0x00ff0000 && 
ma
 == 0xff000000)

5589 
ósy
 = 2;

5591 i‡(!
ósy
) {

5592 i‡(!
mr
 || !
mg
 || !
mb
Ë{ 
	`STBI_FREE
(
out
);  
	`°bi__îΩuc
("bad masks", "Corrupt BMP"); }

5594 
rshi·
 = 
	`°bi__high_bô
(
mr
)-7; 
rcou¡
 = 
	`°bi__bôcou¡
(mr);

5595 
gshi·
 = 
	`°bi__high_bô
(
mg
)-7; 
gcou¡
 = 
	`°bi__bôcou¡
(mg);

5596 
bshi·
 = 
	`°bi__high_bô
(
mb
)-7; 
bcou¡
 = 
	`°bi__bôcou¡
(mb);

5597 
ashi·
 = 
	`°bi__high_bô
(
ma
)-7; 
acou¡
 = 
	`°bi__bôcou¡
(ma);

5598 i‡(
rcou¡
 > 8 || 
gcou¡
 > 8 || 
bcou¡
 > 8 || 
acou¡
 > 8Ë{ 
	`STBI_FREE
(
out
);  
	`°bi__îΩuc
("bad masks", "Corrupt BMP"); }

5600 
j
=0; j < (Ë
s
->
img_y
; ++j) {

5601 i‡(
ósy
) {

5602 
i
=0; i < (Ë
s
->
img_x
; ++i) {

5603 
a
;

5604 
out
[
z
+2] = 
	`°bi__gë8
(
s
);

5605 
out
[
z
+1] = 
	`°bi__gë8
(
s
);

5606 
out
[
z
+0] = 
	`°bi__gë8
(
s
);

5607 
z
 += 3;

5608 
a
 = (
ósy
 =2 ? 
	`°bi__gë8
(
s
) : 255);

5609 
Æl_a
 |
a
;

5610 i‡(
èrgë
 =4Ë
out
[
z
++] = 
a
;

5613 
bµ
 = 
öfo
.bpp;

5614 
i
=0; i < (Ë
s
->
img_x
; ++i) {

5615 
°bi__uöt32
 
v
 = (
bµ
 =16 ? (°bi__uöt32Ë
	`°bi__gë16À
(
s
Ë: 
	`°bi__gë32À
(s));

5616 
a
;

5617 
out
[
z
++] = 
	`STBI__BYTECAST
(
	`°bi__shi·sig√d
(
v
 & 
mr
, 
rshi·
, 
rcou¡
));

5618 
out
[
z
++] = 
	`STBI__BYTECAST
(
	`°bi__shi·sig√d
(
v
 & 
mg
, 
gshi·
, 
gcou¡
));

5619 
out
[
z
++] = 
	`STBI__BYTECAST
(
	`°bi__shi·sig√d
(
v
 & 
mb
, 
bshi·
, 
bcou¡
));

5620 
a
 = (
ma
 ? 
	`°bi__shi·sig√d
(
v
 & ma, 
ashi·
, 
acou¡
) : 255);

5621 
Æl_a
 |
a
;

5622 i‡(
èrgë
 =4Ë
out
[
z
++] = 
	`STBI__BYTECAST
(
a
);

5625 
	`°bi__skù
(
s
, 
∑d
);

5630 i‡(
èrgë
 =4 && 
Æl_a
 == 0)

5631 
i
=4*
s
->
img_x
*s->
img_y
-1; i >= 0; i -= 4)

5632 
out
[
i
] = 255;

5634 i‡(
Êù_vîtiˇŒy
) {

5635 
°bi_uc
 
t
;

5636 
j
=0; j < (Ë
s
->
img_y
>>1; ++j) {

5637 
°bi_uc
 *
p1
 = 
out
 + 
j
 *
s
->
img_x
*
èrgë
;

5638 
°bi_uc
 *
p2
 = 
out
 + (
s
->
img_y
-1-
j
)*s->
img_x
*
èrgë
;

5639 
i
=0; i < (Ë
s
->
img_x
*
èrgë
; ++i) {

5640 
t
 = 
p1
[
i
];Ö1[i] = 
p2
[i];Ö2[i] =Å;

5645 i‡(
ªq_comp
 &&Ñeq_com∞!
èrgë
) {

5646 
out
 = 
	`°bi__c⁄vît_f‹m©
(out, 
èrgë
, 
ªq_comp
, 
s
->
img_x
, s->
img_y
);

5647 i‡(
out
 =
NULL
)  out;

5650 *
x
 = 
s
->
img_x
;

5651 *
y
 = 
s
->
img_y
;

5652 i‡(
comp
Ë*com∞
s
->
img_n
;

5653  
out
;

5654 
	}
}

5659 #i‚de‡
STBI_NO_TGA


5661 
	$°bi__tga_gë_comp
(
bôs_≥r_pixñ
, 
is_gªy
, * 
is_rgb16
)

5664 i‡(
is_rgb16
) *is_rgb16 = 0;

5665 
bôs_≥r_pixñ
) {

5666 8:  
STBI_gªy
;

5667 16: if(
is_gªy
Ë 
STBI_gªy_Æpha
;

5669 15: if(
is_rgb16
) *is_rgb16 = 1;

5670  
STBI_rgb
;

5672 32:  
bôs_≥r_pixñ
/8;

5675 
	}
}

5677 
	$°bi__tga_öfo
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
)

5679 
tga_w
, 
tga_h
, 
tga_comp
, 
tga_image_ty≥
, 
tga_bôs_≥r_pixñ
, 
tga_cﬁ‹m≠_bµ
;

5680 
sz
, 
tga_cﬁ‹m≠_ty≥
;

5681 
	`°bi__gë8
(
s
);

5682 
tga_cﬁ‹m≠_ty≥
 = 
	`°bi__gë8
(
s
);

5683 if–
tga_cﬁ‹m≠_ty≥
 > 1 ) {

5684 
	`°bi__ªwöd
(
s
);

5687 
tga_image_ty≥
 = 
	`°bi__gë8
(
s
);

5688 i‡–
tga_cﬁ‹m≠_ty≥
 == 1 ) {

5689 i‡(
tga_image_ty≥
 != 1 &&Åga_image_type != 9) {

5690 
	`°bi__ªwöd
(
s
);

5693 
	`°bi__skù
(
s
,4);

5694 
sz
 = 
	`°bi__gë8
(
s
);

5695 i‡–(
sz
 != 8) && (sz != 15) && (sz != 16) && (sz != 24) && (sz != 32) ) {

5696 
	`°bi__ªwöd
(
s
);

5699 
	`°bi__skù
(
s
,4);

5700 
tga_cﬁ‹m≠_bµ
 = 
sz
;

5702 i‡–(
tga_image_ty≥
 != 2) && (tga_image_type != 3) && (tga_image_type != 10) && (tga_image_type != 11) ) {

5703 
	`°bi__ªwöd
(
s
);

5706 
	`°bi__skù
(
s
,9);

5707 
tga_cﬁ‹m≠_bµ
 = 0;

5709 
tga_w
 = 
	`°bi__gë16À
(
s
);

5710 if–
tga_w
 < 1 ) {

5711 
	`°bi__ªwöd
(
s
);

5714 
tga_h
 = 
	`°bi__gë16À
(
s
);

5715 if–
tga_h
 < 1 ) {

5716 
	`°bi__ªwöd
(
s
);

5719 
tga_bôs_≥r_pixñ
 = 
	`°bi__gë8
(
s
);

5720 
	`°bi__gë8
(
s
);

5721 i‡(
tga_cﬁ‹m≠_bµ
 != 0) {

5722 if((
tga_bôs_≥r_pixñ
 != 8) && (tga_bits_per_pixel != 16)) {

5725 
	`°bi__ªwöd
(
s
);

5728 
tga_comp
 = 
	`°bi__tga_gë_comp
(
tga_cﬁ‹m≠_bµ
, 0, 
NULL
);

5730 
tga_comp
 = 
	`°bi__tga_gë_comp
(
tga_bôs_≥r_pixñ
, (
tga_image_ty≥
 =3Ë|| (tga_image_ty≥ =11), 
NULL
);

5732 if(!
tga_comp
) {

5733 
	`°bi__ªwöd
(
s
);

5736 i‡(
x
Ë*x = 
tga_w
;

5737 i‡(
y
Ë*y = 
tga_h
;

5738 i‡(
comp
Ë*com∞
tga_comp
;

5740 
	}
}

5742 
	$°bi__tga_ã°
(
°bi__c⁄ãxt
 *
s
)

5744 
ªs
 = 0;

5745 
sz
, 
tga_cﬁ‹_ty≥
;

5746 
	`°bi__gë8
(
s
);

5747 
tga_cﬁ‹_ty≥
 = 
	`°bi__gë8
(
s
);

5748 i‡–
tga_cﬁ‹_ty≥
 > 1 ) 
îr‹End
;

5749 
sz
 = 
	`°bi__gë8
(
s
);

5750 i‡–
tga_cﬁ‹_ty≥
 == 1 ) {

5751 i‡(
sz
 !1 && sz !9Ë
îr‹End
;

5752 
	`°bi__skù
(
s
,4);

5753 
sz
 = 
	`°bi__gë8
(
s
);

5754 i‡–(
sz
 !8Ë&& (sz !15Ë&& (sz !16Ë&& (sz !24Ë&& (sz !32ËË
îr‹End
;

5755 
	`°bi__skù
(
s
,4);

5757 i‡–(
sz
 !2Ë&& (sz !3Ë&& (sz !10Ë&& (sz !11ËË
îr‹End
;

5758 
	`°bi__skù
(
s
,9);

5760 i‡–
	`°bi__gë16À
(
s
Ë< 1 ) 
îr‹End
;

5761 i‡–
	`°bi__gë16À
(
s
Ë< 1 ) 
îr‹End
;

5762 
sz
 = 
	`°bi__gë8
(
s
);

5763 i‡–(
tga_cﬁ‹_ty≥
 =1Ë&& (
sz
 !8Ë&& (sz !16ËË
îr‹End
;

5764 i‡–(
sz
 !8Ë&& (sz !15Ë&& (sz !16Ë&& (sz !24Ë&& (sz !32ËË
îr‹End
;

5766 
ªs
 = 1;

5768 
îr‹End
:

5769 
	`°bi__ªwöd
(
s
);

5770  
ªs
;

5771 
	}
}

5774 
	$°bi__tga_ªad_rgb16
(
°bi__c⁄ãxt
 *
s
, 
°bi_uc
* 
out
)

5776 
°bi__uöt16
 
px
 = (°bi__uöt16)
	`°bi__gë16À
(
s
);

5777 
°bi__uöt16
 
fiveBôMask
 = 31;

5779 
r
 = (
px
 >> 10Ë& 
fiveBôMask
;

5780 
g
 = (
px
 >> 5Ë& 
fiveBôMask
;

5781 
b
 = 
px
 & 
fiveBôMask
;

5783 
out
[0] = (
°bi_uc
)((
r
 * 255)/31);

5784 
out
[1] = (
°bi_uc
)((
g
 * 255)/31);

5785 
out
[2] = (
°bi_uc
)((
b
 * 255)/31);

5791 
	}
}

5793 *
	$°bi__tga_lﬂd
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
)

5796 
tga_off£t
 = 
	`°bi__gë8
(
s
);

5797 
tga_ödexed
 = 
	`°bi__gë8
(
s
);

5798 
tga_image_ty≥
 = 
	`°bi__gë8
(
s
);

5799 
tga_is_RLE
 = 0;

5800 
tga_∑Àâe_°¨t
 = 
	`°bi__gë16À
(
s
);

5801 
tga_∑Àâe_Àn
 = 
	`°bi__gë16À
(
s
);

5802 
tga_∑Àâe_bôs
 = 
	`°bi__gë8
(
s
);

5803 
tga_x_‹igö
 = 
	`°bi__gë16À
(
s
);

5804 
tga_y_‹igö
 = 
	`°bi__gë16À
(
s
);

5805 
tga_width
 = 
	`°bi__gë16À
(
s
);

5806 
tga_height
 = 
	`°bi__gë16À
(
s
);

5807 
tga_bôs_≥r_pixñ
 = 
	`°bi__gë8
(
s
);

5808 
tga_comp
, 
tga_rgb16
=0;

5809 
tga_övîãd
 = 
	`°bi__gë8
(
s
);

5812 *
tga_d©a
;

5813 *
tga_∑Àâe
 = 
NULL
;

5814 
i
, 
j
;

5815 
øw_d©a
[4] = {0};

5816 
RLE_cou¡
 = 0;

5817 
RLE_ª≥©ög
 = 0;

5818 
ªad_√xt_pixñ
 = 1;

5819 
	`STBI_NOTUSED
(
ri
);

5820 
	`STBI_NOTUSED
(
tga_x_‹igö
);

5821 
	`STBI_NOTUSED
(
tga_y_‹igö
);

5823 i‡(
tga_height
 > 
STBI_MAX_DIMENSIONS
Ë 
	`°bi__îΩuc
("tooÜarge","VeryÜarge image (corrupt?)");

5824 i‡(
tga_width
 > 
STBI_MAX_DIMENSIONS
Ë 
	`°bi__îΩuc
("tooÜarge","VeryÜarge image (corrupt?)");

5827 i‡–
tga_image_ty≥
 >= 8 )

5829 
tga_image_ty≥
 -= 8;

5830 
tga_is_RLE
 = 1;

5832 
tga_övîãd
 = 1 - ((tga_inverted >> 5) & 1);

5835 i‡–
tga_ödexed
 ) 
tga_comp
 = 
	`°bi__tga_gë_comp
(
tga_∑Àâe_bôs
, 0, &
tga_rgb16
);

5836 
tga_comp
 = 
	`°bi__tga_gë_comp
(
tga_bôs_≥r_pixñ
, (
tga_image_ty≥
 =3), &
tga_rgb16
);

5838 if(!
tga_comp
)

5839  
	`°bi__îΩuc
("bad format", "Can't find out TGAÖixelformat");

5842 *
x
 = 
tga_width
;

5843 *
y
 = 
tga_height
;

5844 i‡(
comp
Ë*com∞
tga_comp
;

5846 i‡(!
	`°bi__mad3sizes_vÆid
(
tga_width
, 
tga_height
, 
tga_comp
, 0))

5847  
	`°bi__îΩuc
("tooÜarge", "Corrupt TGA");

5849 
tga_d©a
 = (*)
	`°bi__mÆloc_mad3
(
tga_width
, 
tga_height
, 
tga_comp
, 0);

5850 i‡(!
tga_d©a
Ë 
	`°bi__îΩuc
("outofmem", "Out of memory");

5853 
	`°bi__skù
(
s
, 
tga_off£t
 );

5855 i‡–!
tga_ödexed
 && !
tga_is_RLE
 && !
tga_rgb16
 ) {

5856 
i
=0; i < 
tga_height
; ++i) {

5857 
row
 = 
tga_övîãd
 ? 
tga_height
 -
i
 - 1 : i;

5858 
°bi_uc
 *
tga_row
 = 
tga_d©a
 + 
row
*
tga_width
*
tga_comp
;

5859 
	`°bi__gën
(
s
, 
tga_row
, 
tga_width
 * 
tga_comp
);

5863 i‡–
tga_ödexed
)

5865 i‡(
tga_∑Àâe_Àn
 == 0) {

5866 
	`STBI_FREE
(
tga_d©a
);

5867  
	`°bi__îΩuc
("badÖalette", "Corrupt TGA");

5871 
	`°bi__skù
(
s
, 
tga_∑Àâe_°¨t
 );

5873 
tga_∑Àâe
 = (*)
	`°bi__mÆloc_mad2
(
tga_∑Àâe_Àn
, 
tga_comp
, 0);

5874 i‡(!
tga_∑Àâe
) {

5875 
	`STBI_FREE
(
tga_d©a
);

5876  
	`°bi__îΩuc
("outofmem", "Out of memory");

5878 i‡(
tga_rgb16
) {

5879 
°bi_uc
 *
∑l_íåy
 = 
tga_∑Àâe
;

5880 
	`STBI_ASSERT
(
tga_comp
 =
STBI_rgb
);

5881 
i
=0; i < 
tga_∑Àâe_Àn
; ++i) {

5882 
	`°bi__tga_ªad_rgb16
(
s
, 
∑l_íåy
);

5883 
∑l_íåy
 +
tga_comp
;

5885 } i‡(!
	`°bi__gën
(
s
, 
tga_∑Àâe
, 
tga_∑Àâe_Àn
 * 
tga_comp
)) {

5886 
	`STBI_FREE
(
tga_d©a
);

5887 
	`STBI_FREE
(
tga_∑Àâe
);

5888  
	`°bi__îΩuc
("badÖalette", "Corrupt TGA");

5892 
i
=0; i < 
tga_width
 * 
tga_height
; ++i)

5895 i‡–
tga_is_RLE
 )

5897 i‡–
RLE_cou¡
 == 0 )

5900 
RLE_cmd
 = 
	`°bi__gë8
(
s
);

5901 
RLE_cou¡
 = 1 + (
RLE_cmd
 & 127);

5902 
RLE_ª≥©ög
 = 
RLE_cmd
 >> 7;

5903 
ªad_√xt_pixñ
 = 1;

5904 } i‡–!
RLE_ª≥©ög
 )

5906 
ªad_√xt_pixñ
 = 1;

5910 
ªad_√xt_pixñ
 = 1;

5913 i‡–
ªad_√xt_pixñ
 )

5916 i‡–
tga_ödexed
 )

5919 
∑l_idx
 = (
tga_bôs_≥r_pixñ
 =8Ë? 
	`°bi__gë8
(
s
Ë: 
	`°bi__gë16À
(s);

5920 i‡–
∑l_idx
 >
tga_∑Àâe_Àn
 ) {

5922 
∑l_idx
 = 0;

5924 
∑l_idx
 *
tga_comp
;

5925 
j
 = 0; j < 
tga_comp
; ++j) {

5926 
øw_d©a
[
j
] = 
tga_∑Àâe
[
∑l_idx
+j];

5928 } if(
tga_rgb16
) {

5929 
	`STBI_ASSERT
(
tga_comp
 =
STBI_rgb
);

5930 
	`°bi__tga_ªad_rgb16
(
s
, 
øw_d©a
);

5933 
j
 = 0; j < 
tga_comp
; ++j) {

5934 
øw_d©a
[
j
] = 
	`°bi__gë8
(
s
);

5938 
ªad_√xt_pixñ
 = 0;

5942 
j
 = 0; j < 
tga_comp
; ++j)

5943 
tga_d©a
[
i
*
tga_comp
+
j
] = 
øw_d©a
[j];

5946 --
RLE_cou¡
;

5949 i‡–
tga_övîãd
 )

5951 
j
 = 0; j*2 < 
tga_height
; ++j)

5953 
ödex1
 = 
j
 * 
tga_width
 * 
tga_comp
;

5954 
ödex2
 = (
tga_height
 - 1 - 
j
Ë* 
tga_width
 * 
tga_comp
;

5955 
i
 = 
tga_width
 * 
tga_comp
; i > 0; --i)

5957 
ãmp
 = 
tga_d©a
[
ödex1
];

5958 
tga_d©a
[
ödex1
] =Åga_d©a[
ödex2
];

5959 
tga_d©a
[
ödex2
] = 
ãmp
;

5960 ++
ödex1
;

5961 ++
ödex2
;

5966 i‡–
tga_∑Àâe
 !
NULL
 )

5968 
	`STBI_FREE
–
tga_∑Àâe
 );

5973 i‡(
tga_comp
 >3 && !
tga_rgb16
)

5975 * 
tga_pixñ
 = 
tga_d©a
;

5976 
i
=0; i < 
tga_width
 * 
tga_height
; ++i)

5978 
ãmp
 = 
tga_pixñ
[0];

5979 
tga_pixñ
[0] =Åga_pixel[2];

5980 
tga_pixñ
[2] = 
ãmp
;

5981 
tga_pixñ
 +
tga_comp
;

5986 i‡(
ªq_comp
 &&Ñeq_com∞!
tga_comp
)

5987 
tga_d©a
 = 
	`°bi__c⁄vît_f‹m©
—ga_d©a, 
tga_comp
, 
ªq_comp
, 
tga_width
, 
tga_height
);

5991 
tga_∑Àâe_°¨t
 = 
tga_∑Àâe_Àn
 = 
tga_∑Àâe_bôs
 =

5992 
tga_x_‹igö
 = 
tga_y_‹igö
 = 0;

5993 
	`STBI_NOTUSED
(
tga_∑Àâe_°¨t
);

5995  
tga_d©a
;

5996 
	}
}

6002 #i‚de‡
STBI_NO_PSD


6003 
	$°bi__psd_ã°
(
°bi__c⁄ãxt
 *
s
)

6005 
r
 = (
	`°bi__gë32be
(
s
) == 0x38425053);

6006 
	`°bi__ªwöd
(
s
);

6007  
r
;

6008 
	}
}

6010 
	$°bi__psd_decode_æe
(
°bi__c⁄ãxt
 *
s
, 
°bi_uc
 *
p
, 
pixñCou¡
)

6012 
cou¡
, 
∆e·
, 
Àn
;

6014 
cou¡
 = 0;

6015 (
∆e·
 = 
pixñCou¡
 - 
cou¡
) > 0) {

6016 
Àn
 = 
	`°bi__gë8
(
s
);

6017 i‡(
Àn
 == 128) {

6019 } i‡(
Àn
 < 128) {

6021 
Àn
++;

6022 i‡(
Àn
 > 
∆e·
)  0;

6023 
cou¡
 +
Àn
;

6024 
Àn
) {

6025 *
p
 = 
	`°bi__gë8
(
s
);

6026 
p
 += 4;

6027 
Àn
--;

6029 } i‡(
Àn
 > 128) {

6030 
°bi_uc
 
vÆ
;

6033 
Àn
 = 257 -Üen;

6034 i‡(
Àn
 > 
∆e·
)  0;

6035 
vÆ
 = 
	`°bi__gë8
(
s
);

6036 
cou¡
 +
Àn
;

6037 
Àn
) {

6038 *
p
 = 
vÆ
;

6039 
p
 += 4;

6040 
Àn
--;

6046 
	}
}

6048 *
	$°bi__psd_lﬂd
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
, 
bpc
)

6050 
pixñCou¡
;

6051 
ch™√lCou¡
, 
com¥essi⁄
;

6052 
ch™√l
, 
i
;

6053 
bôdïth
;

6054 
w
,
h
;

6055 
°bi_uc
 *
out
;

6056 
	`STBI_NOTUSED
(
ri
);

6059 i‡(
	`°bi__gë32be
(
s
) != 0x38425053)

6060  
	`°bi__îΩuc
("not PSD", "Corrupt PSD image");

6063 i‡(
	`°bi__gë16be
(
s
) != 1)

6064  
	`°bi__îΩuc
("wrong version", "Unsupported version of PSD image");

6067 
	`°bi__skù
(
s
, 6 );

6070 
ch™√lCou¡
 = 
	`°bi__gë16be
(
s
);

6071 i‡(
ch™√lCou¡
 < 0 || channelCount > 16)

6072  
	`°bi__îΩuc
("wrong channel count", "UnsupportedÇumber of channels in PSD image");

6075 
h
 = 
	`°bi__gë32be
(
s
);

6076 
w
 = 
	`°bi__gë32be
(
s
);

6078 i‡(
h
 > 
STBI_MAX_DIMENSIONS
Ë 
	`°bi__îΩuc
("tooÜarge","VeryÜarge image (corrupt?)");

6079 i‡(
w
 > 
STBI_MAX_DIMENSIONS
Ë 
	`°bi__îΩuc
("tooÜarge","VeryÜarge image (corrupt?)");

6082 
bôdïth
 = 
	`°bi__gë16be
(
s
);

6083 i‡(
bôdïth
 != 8 && bitdepth != 16)

6084  
	`°bi__îΩuc
("unsupported bit depth", "PSD bit depth isÇot 8 or 16 bit");

6096 i‡(
	`°bi__gë16be
(
s
) != 3)

6097  
	`°bi__îΩuc
("wrong color format", "PSD isÇot in RGB color format");

6100 
	`°bi__skù
(
s
,
	`°bi__gë32be
(s) );

6103 
	`°bi__skù
(
s
, 
	`°bi__gë32be
(s) );

6106 
	`°bi__skù
(
s
, 
	`°bi__gë32be
(s) );

6112 
com¥essi⁄
 = 
	`°bi__gë16be
(
s
);

6113 i‡(
com¥essi⁄
 > 1)

6114  
	`°bi__îΩuc
("bad compression", "PSD hasán unknown compression format");

6117 i‡(!
	`°bi__mad3sizes_vÆid
(4, 
w
, 
h
, 0))

6118  
	`°bi__îΩuc
("tooÜarge", "Corrupt PSD");

6122 i‡(!
com¥essi⁄
 && 
bôdïth
 =16 && 
bpc
 == 16) {

6123 
out
 = (
°bi_uc
 *Ë
	`°bi__mÆloc_mad3
(8, 
w
, 
h
, 0);

6124 
ri
->
bôs_≥r_ch™√l
 = 16;

6126 
out
 = (
°bi_uc
 *Ë
	`°bi__mÆloc
(4 * 
w
*
h
);

6128 i‡(!
out
Ë 
	`°bi__îΩuc
("outofmem", "Out of memory");

6129 
pixñCou¡
 = 
w
*
h
;

6135 i‡(
com¥essi⁄
) {

6146 
	`°bi__skù
(
s
, 
h
 * 
ch™√lCou¡
 * 2 );

6149 
ch™√l
 = 0; channel < 4; channel++) {

6150 
°bi_uc
 *
p
;

6152 
p
 = 
out
+
ch™√l
;

6153 i‡(
ch™√l
 >
ch™√lCou¡
) {

6155 
i
 = 0; i < 
pixñCou¡
; i++, 
p
 += 4)

6156 *
p
 = (
ch™√l
 == 3 ? 255 : 0);

6159 i‡(!
	`°bi__psd_decode_æe
(
s
, 
p
, 
pixñCou¡
)) {

6160 
	`STBI_FREE
(
out
);

6161  
	`°bi__îΩuc
("corrupt", "bad RLE data");

6171 
ch™√l
 = 0; channel < 4; channel++) {

6172 i‡(
ch™√l
 >
ch™√lCou¡
) {

6174 i‡(
bôdïth
 =16 && 
bpc
 == 16) {

6175 
°bi__uöt16
 *
q
 = ((°bi__uöt16 *Ë
out
Ë+ 
ch™√l
;

6176 
°bi__uöt16
 
vÆ
 = 
ch™√l
 == 3 ? 65535 : 0;

6177 
i
 = 0; i < 
pixñCou¡
; i++, 
q
 += 4)

6178 *
q
 = 
vÆ
;

6180 
°bi_uc
 *
p
 = 
out
+
ch™√l
;

6181 
°bi_uc
 
vÆ
 = 
ch™√l
 == 3 ? 255 : 0;

6182 
i
 = 0; i < 
pixñCou¡
; i++, 
p
 += 4)

6183 *
p
 = 
vÆ
;

6186 i‡(
ri
->
bôs_≥r_ch™√l
 == 16) {

6187 
°bi__uöt16
 *
q
 = ((°bi__uöt16 *Ë
out
Ë+ 
ch™√l
;

6188 
i
 = 0; i < 
pixñCou¡
; i++, 
q
 += 4)

6189 *
q
 = (
°bi__uöt16
Ë
	`°bi__gë16be
(
s
);

6191 
°bi_uc
 *
p
 = 
out
+
ch™√l
;

6192 i‡(
bôdïth
 == 16) {

6193 
i
 = 0; i < 
pixñCou¡
; i++, 
p
 += 4)

6194 *
p
 = (
°bi_uc
Ë(
	`°bi__gë16be
(
s
) >> 8);

6196 
i
 = 0; i < 
pixñCou¡
; i++, 
p
 += 4)

6197 *
p
 = 
	`°bi__gë8
(
s
);

6205 i‡(
ch™√lCou¡
 >= 4) {

6206 i‡(
ri
->
bôs_≥r_ch™√l
 == 16) {

6207 
i
=0; i < 
w
*
h
; ++i) {

6208 
°bi__uöt16
 *
pixñ
 = (°bi__uöt16 *Ë
out
 + 4*
i
;

6209 i‡(
pixñ
[3] != 0 &&Öixel[3] != 65535) {

6210 
a
 = 
pixñ
[3] / 65535.0f;

6211 
ø
 = 1.0‡/ 
a
;

6212 
öv_a
 = 65535.0‡* (1 - 
ø
);

6213 
pixñ
[0] = (
°bi__uöt16
Ë’ixñ[0]*
ø
 + 
öv_a
);

6214 
pixñ
[1] = (
°bi__uöt16
Ë’ixñ[1]*
ø
 + 
öv_a
);

6215 
pixñ
[2] = (
°bi__uöt16
Ë’ixñ[2]*
ø
 + 
öv_a
);

6219 
i
=0; i < 
w
*
h
; ++i) {

6220 *
pixñ
 = 
out
 + 4*
i
;

6221 i‡(
pixñ
[3] != 0 &&Öixel[3] != 255) {

6222 
a
 = 
pixñ
[3] / 255.0f;

6223 
ø
 = 1.0‡/ 
a
;

6224 
öv_a
 = 255.0‡* (1 - 
ø
);

6225 
pixñ
[0] = (Ë’ixñ[0]*
ø
 + 
öv_a
);

6226 
pixñ
[1] = (Ë’ixñ[1]*
ø
 + 
öv_a
);

6227 
pixñ
[2] = (Ë’ixñ[2]*
ø
 + 
öv_a
);

6234 i‡(
ªq_comp
 &&Ñeq_comp != 4) {

6235 i‡(
ri
->
bôs_≥r_ch™√l
 == 16)

6236 
out
 = (
°bi_uc
 *Ë
	`°bi__c⁄vît_f‹m©16
((
°bi__uöt16
 *Ëout, 4, 
ªq_comp
, 
w
, 
h
);

6238 
out
 = 
	`°bi__c⁄vît_f‹m©
(out, 4, 
ªq_comp
, 
w
, 
h
);

6239 i‡(
out
 =
NULL
)  out;

6242 i‡(
comp
) *comp = 4;

6243 *
y
 = 
h
;

6244 *
x
 = 
w
;

6246  
out
;

6247 
	}
}

6257 #i‚de‡
STBI_NO_PIC


6258 
	$°bi__pic_is4
(
°bi__c⁄ãxt
 *
s
,c⁄° *
°r
)

6260 
i
;

6261 
i
=0; i<4; ++i)

6262 i‡(
	`°bi__gë8
(
s
Ë!(
°bi_uc
)
°r
[
i
])

6266 
	}
}

6268 
	$°bi__pic_ã°_c‹e
(
°bi__c⁄ãxt
 *
s
)

6270 
i
;

6272 i‡(!
	`°bi__pic_is4
(
s
,"\x53\x80\xF6\x34"))

6275 
i
=0;i<84;++i)

6276 
	`°bi__gë8
(
s
);

6278 i‡(!
	`°bi__pic_is4
(
s
,"PICT"))

6282 
	}
}

6286 
°bi_uc
 
	msize
,
	mty≥
,
	mch™√l
;

6287 } 
	t°bi__pic_∑ckë
;

6289 
°bi_uc
 *
	$°bi__ªadvÆ
(
°bi__c⁄ãxt
 *
s
, 
ch™√l
, 
°bi_uc
 *
de°
)

6291 
mask
=0x80, 
i
;

6293 
i
=0; i<4; ++i, 
mask
>>=1) {

6294 i‡(
ch™√l
 & 
mask
) {

6295 i‡(
	`°bi__©_eof
(
s
)Ë 
	`°bi__îΩuc
("bad file","PIC fileÅoo short");

6296 
de°
[
i
]=
	`°bi__gë8
(
s
);

6300  
de°
;

6301 
	}
}

6303 
	$°bi__c›yvÆ
(
ch™√l
,
°bi_uc
 *
de°
,c⁄° stbi_u¯*
§c
)

6305 
mask
=0x80,
i
;

6307 
i
=0;i<4; ++i, 
mask
>>=1)

6308 i‡(
ch™√l
&
mask
)

6309 
de°
[
i
]=
§c
[i];

6310 
	}
}

6312 
°bi_uc
 *
	$°bi__pic_lﬂd_c‹e
(
°bi__c⁄ãxt
 *
s
,
width
,
height
,*
comp
, 
°bi_uc
 *
ªsu…
)

6314 
a˘_comp
=0,
num_∑ckës
=0,
y
,
chaöed
;

6315 
°bi__pic_∑ckë
 
∑ckës
[10];

6320 
°bi__pic_∑ckë
 *
∑ckë
;

6322 i‡(
num_∑ckës
==(
∑ckës
)/(packets[0]))

6323  
	`°bi__îΩuc
("bad format","too manyÖackets");

6325 
∑ckë
 = &
∑ckës
[
num_∑ckës
++];

6327 
chaöed
 = 
	`°bi__gë8
(
s
);

6328 
∑ckë
->
size
 = 
	`°bi__gë8
(
s
);

6329 
∑ckë
->
ty≥
 = 
	`°bi__gë8
(
s
);

6330 
∑ckë
->
ch™√l
 = 
	`°bi__gë8
(
s
);

6332 
a˘_comp
 |
∑ckë
->
ch™√l
;

6334 i‡(
	`°bi__©_eof
(
s
)Ë 
	`°bi__îΩuc
("bad file","fileÅoo short (readingÖackets)");

6335 i‡(
∑ckë
->
size
 !8Ë 
	`°bi__îΩuc
("bad format","packet isn't 8bpp");

6336 } 
chaöed
);

6338 *
comp
 = (
a˘_comp
 & 0x10 ? 4 : 3);

6340 
y
=0; y<
height
; ++y) {

6341 
∑ckë_idx
;

6343 
∑ckë_idx
=0;Öackë_idx < 
num_∑ckës
; ++packet_idx) {

6344 
°bi__pic_∑ckë
 *
∑ckë
 = &
∑ckës
[
∑ckë_idx
];

6345 
°bi_uc
 *
de°
 = 
ªsu…
+
y
*
width
*4;

6347 
∑ckë
->
ty≥
) {

6349  
	`°bi__îΩuc
("bad format","packet has bad compressionÅype");

6352 
x
;

6354 
x
=0;x<
width
;++x, 
de°
+=4)

6355 i‡(!
	`°bi__ªadvÆ
(
s
,
∑ckë
->
ch™√l
,
de°
))

6362 
À·
=
width
, 
i
;

6364 
À·
>0) {

6365 
°bi_uc
 
cou¡
,
vÆue
[4];

6367 
cou¡
=
	`°bi__gë8
(
s
);

6368 i‡(
	`°bi__©_eof
(
s
)Ë 
	`°bi__îΩuc
("bad file","fileÅoo short (pureÑead count)");

6370 i‡(
cou¡
 > 
À·
)

6371 
cou¡
 = (
°bi_uc
Ë
À·
;

6373 i‡(!
	`°bi__ªadvÆ
(
s
,
∑ckë
->
ch™√l
,
vÆue
))  0;

6375 
i
=0; i<
cou¡
; ++i,
de°
+=4)

6376 
	`°bi__c›yvÆ
(
∑ckë
->
ch™√l
,
de°
,
vÆue
);

6377 
À·
 -
cou¡
;

6383 
À·
=
width
;

6384 
À·
>0) {

6385 
cou¡
 = 
	`°bi__gë8
(
s
), 
i
;

6386 i‡(
	`°bi__©_eof
(
s
)Ë 
	`°bi__îΩuc
("bad file","fileÅoo short (mixedÑead count)");

6388 i‡(
cou¡
 >= 128) {

6389 
°bi_uc
 
vÆue
[4];

6391 i‡(
cou¡
==128)

6392 
cou¡
 = 
	`°bi__gë16be
(
s
);

6394 
cou¡
 -= 127;

6395 i‡(
cou¡
 > 
À·
)

6396  
	`°bi__îΩuc
("bad file","scanline overrun");

6398 i‡(!
	`°bi__ªadvÆ
(
s
,
∑ckë
->
ch™√l
,
vÆue
))

6401 
i
=0;i<
cou¡
;++i, 
de°
 += 4)

6402 
	`°bi__c›yvÆ
(
∑ckë
->
ch™√l
,
de°
,
vÆue
);

6404 ++
cou¡
;

6405 i‡(
cou¡
>
À·
Ë 
	`°bi__îΩuc
("bad file","scanline overrun");

6407 
i
=0;i<
cou¡
;++i, 
de°
+=4)

6408 i‡(!
	`°bi__ªadvÆ
(
s
,
∑ckë
->
ch™√l
,
de°
))

6411 
À·
-=
cou¡
;

6419  
ªsu…
;

6420 
	}
}

6422 *
	$°bi__pic_lﬂd
(
°bi__c⁄ãxt
 *
s
,*
px
,*
py
,*
comp
,
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
)

6424 
°bi_uc
 *
ªsu…
;

6425 
i
, 
x
,
y
, 
öã∫Æ_comp
;

6426 
	`STBI_NOTUSED
(
ri
);

6428 i‡(!
comp
Ëcom∞&
öã∫Æ_comp
;

6430 
i
=0; i<92; ++i)

6431 
	`°bi__gë8
(
s
);

6433 
x
 = 
	`°bi__gë16be
(
s
);

6434 
y
 = 
	`°bi__gë16be
(
s
);

6436 i‡(
y
 > 
STBI_MAX_DIMENSIONS
Ë 
	`°bi__îΩuc
("tooÜarge","VeryÜarge image (corrupt?)");

6437 i‡(
x
 > 
STBI_MAX_DIMENSIONS
Ë 
	`°bi__îΩuc
("tooÜarge","VeryÜarge image (corrupt?)");

6439 i‡(
	`°bi__©_eof
(
s
)Ë 
	`°bi__îΩuc
("bad file","fileÅoo short (pic header)");

6440 i‡(!
	`°bi__mad3sizes_vÆid
(
x
, 
y
, 4, 0)Ë 
	`°bi__îΩuc
("tooÜarge", "PIC imageÅooÜargeÅo decode");

6442 
	`°bi__gë32be
(
s
);

6443 
	`°bi__gë16be
(
s
);

6444 
	`°bi__gë16be
(
s
);

6447 
ªsu…
 = (
°bi_uc
 *Ë
	`°bi__mÆloc_mad3
(
x
, 
y
, 4, 0);

6448 i‡(!
ªsu…
Ë 
	`°bi__îΩuc
("outofmem", "Out of memory");

6449 
	`mem£t
(
ªsu…
, 0xff, 
x
*
y
*4);

6451 i‡(!
	`°bi__pic_lﬂd_c‹e
(
s
,
x
,
y
,
comp
, 
ªsu…
)) {

6452 
	`STBI_FREE
(
ªsu…
);

6453 
ªsu…
=0;

6455 *
px
 = 
x
;

6456 *
py
 = 
y
;

6457 i‡(
ªq_comp
 =0Ëªq_com∞*
comp
;

6458 
ªsu…
=
	`°bi__c⁄vît_f‹m©
‘esu…,4,
ªq_comp
,
x
,
y
);

6460  
ªsu…
;

6461 
	}
}

6463 
	$°bi__pic_ã°
(
°bi__c⁄ãxt
 *
s
)

6465 
r
 = 
	`°bi__pic_ã°_c‹e
(
s
);

6466 
	`°bi__ªwöd
(
s
);

6467  
r
;

6468 
	}
}

6474 #i‚de‡
STBI_NO_GIF


6477 
°bi__öt16
 
	m¥efix
;

6478 
°bi_uc
 
	mfú°
;

6479 
°bi_uc
 
	msuffix
;

6480 } 
	t°bi__gif_lzw
;

6484 
	mw
,
	mh
;

6485 
°bi_uc
 *
	mout
;

6486 
°bi_uc
 *
	mbackground
;

6487 
°bi_uc
 *
	mhi°‹y
;

6488 
	mÊags
, 
	mbgödex
, 
	møtio
, 
	må™•¨ít
, 
	meÊags
;

6489 
°bi_uc
 
	m∑l
[256][4];

6490 
°bi_uc
 
	mÕÆ
[256][4];

6491 
°bi__gif_lzw
 
	mcodes
[8192];

6492 
°bi_uc
 *
	mcﬁ‹_èbÀ
;

6493 
	m∑r£
, 
	m°ï
;

6494 
	mlÊags
;

6495 
	m°¨t_x
, 
	m°¨t_y
;

6496 
	mmax_x
, 
	mmax_y
;

6497 
	mcur_x
, 
	mcur_y
;

6498 
	mlöe_size
;

6499 
	mdñay
;

6500 } 
	t°bi__gif
;

6502 
	$°bi__gif_ã°_øw
(
°bi__c⁄ãxt
 *
s
)

6504 
sz
;

6505 i‡(
	`°bi__gë8
(
s
) != 'G' || stbi__get8(s) != 'I' || stbi__get8(s) != 'F' || stbi__get8(s) != '8')  0;

6506 
sz
 = 
	`°bi__gë8
(
s
);

6507 i‡(
sz
 != '9' && sz != '7')  0;

6508 i‡(
	`°bi__gë8
(
s
) != 'a')  0;

6510 
	}
}

6512 
	$°bi__gif_ã°
(
°bi__c⁄ãxt
 *
s
)

6514 
r
 = 
	`°bi__gif_ã°_øw
(
s
);

6515 
	`°bi__ªwöd
(
s
);

6516  
r
;

6517 
	}
}

6519 
	$°bi__gif_∑r£_cﬁ‹èbÀ
(
°bi__c⁄ãxt
 *
s
, 
°bi_uc
 
∑l
[256][4], 
num_íåõs
, 
å™•
)

6521 
i
;

6522 
i
=0; i < 
num_íåõs
; ++i) {

6523 
∑l
[
i
][2] = 
	`°bi__gë8
(
s
);

6524 
∑l
[
i
][1] = 
	`°bi__gë8
(
s
);

6525 
∑l
[
i
][0] = 
	`°bi__gë8
(
s
);

6526 
∑l
[
i
][3] = 
å™•
 == i ? 0 : 255;

6528 
	}
}

6530 
	$°bi__gif_hódî
(
°bi__c⁄ãxt
 *
s
, 
°bi__gif
 *
g
, *
comp
, 
is_öfo
)

6532 
°bi_uc
 
vîsi⁄
;

6533 i‡(
	`°bi__gë8
(
s
) != 'G' || stbi__get8(s) != 'I' || stbi__get8(s) != 'F' || stbi__get8(s) != '8')

6534  
	`°bi__îr
("not GIF", "Corrupt GIF");

6536 
vîsi⁄
 = 
	`°bi__gë8
(
s
);

6537 i‡(
vîsi⁄
 !'7' && vîsi⁄ !'9'Ë 
	`°bi__îr
("not GIF", "Corrupt GIF");

6538 i‡(
	`°bi__gë8
(
s
Ë!'a'Ë 
	`°bi__îr
("not GIF", "Corrupt GIF");

6540 
°bi__g_Áûuª_ªas⁄
 = "";

6541 
g
->
w
 = 
	`°bi__gë16À
(
s
);

6542 
g
->
h
 = 
	`°bi__gë16À
(
s
);

6543 
g
->
Êags
 = 
	`°bi__gë8
(
s
);

6544 
g
->
bgödex
 = 
	`°bi__gë8
(
s
);

6545 
g
->
øtio
 = 
	`°bi__gë8
(
s
);

6546 
g
->
å™•¨ít
 = -1;

6548 i‡(
g
->
w
 > 
STBI_MAX_DIMENSIONS
Ë 
	`°bi__îr
("tooÜarge","VeryÜarge image (corrupt?)");

6549 i‡(
g
->
h
 > 
STBI_MAX_DIMENSIONS
Ë 
	`°bi__îr
("tooÜarge","VeryÜarge image (corrupt?)");

6551 i‡(
comp
 != 0) *comp = 4;

6553 i‡(
is_öfo
)  1;

6555 i‡(
g
->
Êags
 & 0x80)

6556 
	`°bi__gif_∑r£_cﬁ‹èbÀ
(
s
,
g
->
∑l
, 2 << (g->
Êags
 & 7), -1);

6559 
	}
}

6561 
	$°bi__gif_öfo_øw
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
)

6563 
°bi__gif
* 
g
 = (°bi__gif*Ë
	`°bi__mÆloc
((stbi__gif));

6564 i‡(!
g
Ë 
	`°bi__îr
("outofmem", "Out of memory");

6565 i‡(!
	`°bi__gif_hódî
(
s
, 
g
, 
comp
, 1)) {

6566 
	`STBI_FREE
(
g
);

6567 
	`°bi__ªwöd
–
s
 );

6570 i‡(
x
Ë*x = 
g
->
w
;

6571 i‡(
y
Ë*y = 
g
->
h
;

6572 
	`STBI_FREE
(
g
);

6574 
	}
}

6576 
	$°bi__out_gif_code
(
°bi__gif
 *
g
, 
°bi__uöt16
 
code
)

6578 
°bi_uc
 *
p
, *
c
;

6579 
idx
;

6583 i‡(
g
->
codes
[
code
].
¥efix
 >= 0)

6584 
	`°bi__out_gif_code
(
g
, g->
codes
[
code
].
¥efix
);

6586 i‡(
g
->
cur_y
 >g->
max_y
) ;

6588 
idx
 = 
g
->
cur_x
 + g->
cur_y
;

6589 
p
 = &
g
->
out
[
idx
];

6590 
g
->
hi°‹y
[
idx
 / 4] = 1;

6592 
c
 = &
g
->
cﬁ‹_èbÀ
[g->
codes
[
code
].
suffix
 * 4];

6593 i‡(
c
[3] > 128) {

6594 
p
[0] = 
c
[2];

6595 
p
[1] = 
c
[1];

6596 
p
[2] = 
c
[0];

6597 
p
[3] = 
c
[3];

6599 
g
->
cur_x
 += 4;

6601 i‡(
g
->
cur_x
 >g->
max_x
) {

6602 
g
->
cur_x
 = g->
°¨t_x
;

6603 
g
->
cur_y
 +g->
°ï
;

6605 
g
->
cur_y
 >g->
max_y
 && g->
∑r£
 > 0) {

6606 
g
->
°ï
 = (1 << g->
∑r£
Ë* g->
löe_size
;

6607 
g
->
cur_y
 = g->
°¨t_y
 + (g->
°ï
 >> 1);

6608 --
g
->
∑r£
;

6611 
	}
}

6613 
°bi_uc
 *
	$°bi__¥o˚ss_gif_ø°î
(
°bi__c⁄ãxt
 *
s
, 
°bi__gif
 *
g
)

6615 
°bi_uc
 
lzw_cs
;

6616 
°bi__öt32
 
Àn
, 
öô_code
;

6617 
°bi__uöt32
 
fú°
;

6618 
°bi__öt32
 
codesize
, 
codemask
, 
avaû
, 
ﬁdcode
, 
bôs
, 
vÆid_bôs
, 
˛ór
;

6619 
°bi__gif_lzw
 *
p
;

6621 
lzw_cs
 = 
	`°bi__gë8
(
s
);

6622 i‡(
lzw_cs
 > 12Ë 
NULL
;

6623 
˛ór
 = 1 << 
lzw_cs
;

6624 
fú°
 = 1;

6625 
codesize
 = 
lzw_cs
 + 1;

6626 
codemask
 = (1 << 
codesize
) - 1;

6627 
bôs
 = 0;

6628 
vÆid_bôs
 = 0;

6629 
öô_code
 = 0; inô_codê< 
˛ór
; init_code++) {

6630 
g
->
codes
[
öô_code
].
¥efix
 = -1;

6631 
g
->
codes
[
öô_code
].
fú°
 = (
°bi_uc
) init_code;

6632 
g
->
codes
[
öô_code
].
suffix
 = (
°bi_uc
) init_code;

6636 
avaû
 = 
˛ór
+2;

6637 
ﬁdcode
 = -1;

6639 
Àn
 = 0;

6641 i‡(
vÆid_bôs
 < 
codesize
) {

6642 i‡(
Àn
 == 0) {

6643 
Àn
 = 
	`°bi__gë8
(
s
);

6644 i‡(
Àn
 == 0)

6645  
g
->
out
;

6647 --
Àn
;

6648 
bôs
 |(
°bi__öt32
Ë
	`°bi__gë8
(
s
Ë<< 
vÆid_bôs
;

6649 
vÆid_bôs
 += 8;

6651 
°bi__öt32
 
code
 = 
bôs
 & 
codemask
;

6652 
bôs
 >>
codesize
;

6653 
vÆid_bôs
 -
codesize
;

6655 i‡(
code
 =
˛ór
) {

6656 
codesize
 = 
lzw_cs
 + 1;

6657 
codemask
 = (1 << 
codesize
) - 1;

6658 
avaû
 = 
˛ór
 + 2;

6659 
ﬁdcode
 = -1;

6660 
fú°
 = 0;

6661 } i‡(
code
 =
˛ór
 + 1) {

6662 
	`°bi__skù
(
s
, 
Àn
);

6663 (
Àn
 = 
	`°bi__gë8
(
s
)) > 0)

6664 
	`°bi__skù
(
s
,
Àn
);

6665  
g
->
out
;

6666 } i‡(
code
 <
avaû
) {

6667 i‡(
fú°
) {

6668  
	`°bi__îΩuc
("no clear code", "Corrupt GIF");

6671 i‡(
ﬁdcode
 >= 0) {

6672 
p
 = &
g
->
codes
[
avaû
++];

6673 i‡(
avaû
 > 8192) {

6674  
	`°bi__îΩuc
("too many codes", "Corrupt GIF");

6677 
p
->
¥efix
 = (
°bi__öt16
Ë
ﬁdcode
;

6678 
p
->
fú°
 = 
g
->
codes
[
ﬁdcode
].first;

6679 
p
->
suffix
 = (
code
 =
avaû
Ë?Ö->
fú°
 : 
g
->
codes
[code].first;

6680 } i‡(
code
 =
avaû
)

6681  
	`°bi__îΩuc
("illegal code inÑaster", "Corrupt GIF");

6683 
	`°bi__out_gif_code
(
g
, (
°bi__uöt16
Ë
code
);

6685 i‡((
avaû
 & 
codemask
) == 0 &&ávail <= 0x0FFF) {

6686 
codesize
++;

6687 
codemask
 = (1 << 
codesize
) - 1;

6690 
ﬁdcode
 = 
code
;

6692  
	`°bi__îΩuc
("illegal code inÑaster", "Corrupt GIF");

6696 
	}
}

6700 
°bi_uc
 *
	$°bi__gif_lﬂd_√xt
(
°bi__c⁄ãxt
 *
s
, 
°bi__gif
 *
g
, *
comp
, 
ªq_comp
, 
°bi_uc
 *
two_back
)

6702 
di•o£
;

6703 
fú°_‰ame
;

6704 
pi
;

6705 
pcou¡
;

6706 
	`STBI_NOTUSED
(
ªq_comp
);

6709 
fú°_‰ame
 = 0;

6710 i‡(
g
->
out
 == 0) {

6711 i‡(!
	`°bi__gif_hódî
(
s
, 
g
, 
comp
,0))  0;

6712 i‡(!
	`°bi__mad3sizes_vÆid
(4, 
g
->
w
, g->
h
, 0))

6713  
	`°bi__îΩuc
("tooÜarge", "GIF image isÅooÜarge");

6714 
pcou¡
 = 
g
->
w
 * g->
h
;

6715 
g
->
out
 = (
°bi_uc
 *Ë
	`°bi__mÆloc
(4 * 
pcou¡
);

6716 
g
->
background
 = (
°bi_uc
 *Ë
	`°bi__mÆloc
(4 * 
pcou¡
);

6717 
g
->
hi°‹y
 = (
°bi_uc
 *Ë
	`°bi__mÆloc
(
pcou¡
);

6718 i‡(!
g
->
out
 || !g->
background
 || !g->
hi°‹y
)

6719  
	`°bi__îΩuc
("outofmem", "Out of memory");

6724 
	`mem£t
(
g
->
out
, 0x00, 4 * 
pcou¡
);

6725 
	`mem£t
(
g
->
background
, 0x00, 4 * 
pcou¡
);

6726 
	`mem£t
(
g
->
hi°‹y
, 0x00, 
pcou¡
);

6727 
fú°_‰ame
 = 1;

6730 
di•o£
 = (
g
->
eÊags
 & 0x1C) >> 2;

6731 
pcou¡
 = 
g
->
w
 * g->
h
;

6733 i‡((
di•o£
 =3Ë&& (
two_back
 == 0)) {

6734 
di•o£
 = 2;

6737 i‡(
di•o£
 == 3) {

6738 
pi
 = 0;Öò< 
pcou¡
; ++pi) {

6739 i‡(
g
->
hi°‹y
[
pi
]) {

6740 
	`mem˝y
–&
g
->
out
[
pi
 * 4], &
two_back
[pi * 4], 4 );

6743 } i‡(
di•o£
 == 2) {

6745 
pi
 = 0;Öò< 
pcou¡
; ++pi) {

6746 i‡(
g
->
hi°‹y
[
pi
]) {

6747 
	`mem˝y
–&
g
->
out
[
pi
 * 4], &g->
background
[pi * 4], 4 );

6758 
	`mem˝y
–
g
->
background
, g->
out
, 4 * g->
w
 * g->
h
 );

6762 
	`mem£t
–
g
->
hi°‹y
, 0x00, g->
w
 * g->
h
 );

6765 
èg
 = 
	`°bi__gë8
(
s
);

6766 
èg
) {

6769 
°bi__öt32
 
x
, 
y
, 
w
, 
h
;

6770 
°bi_uc
 *
o
;

6772 
x
 = 
	`°bi__gë16À
(
s
);

6773 
y
 = 
	`°bi__gë16À
(
s
);

6774 
w
 = 
	`°bi__gë16À
(
s
);

6775 
h
 = 
	`°bi__gë16À
(
s
);

6776 i‡(((
x
 + 
w
Ë> (
g
->w)Ë|| ((
y
 + 
h
) > (g->h)))

6777  
	`°bi__îΩuc
("bad Image Descriptor", "Corrupt GIF");

6779 
g
->
löe_size
 = g->
w
 * 4;

6780 
g
->
°¨t_x
 = 
x
 * 4;

6781 
g
->
°¨t_y
 = 
y
 * g->
löe_size
;

6782 
g
->
max_x
 = g->
°¨t_x
 + 
w
 * 4;

6783 
g
->
max_y
 = g->
°¨t_y
 + 
h
 * g->
löe_size
;

6784 
g
->
cur_x
 = g->
°¨t_x
;

6785 
g
->
cur_y
 = g->
°¨t_y
;

6791 i‡(
w
 == 0)

6792 
g
->
cur_y
 = g->
max_y
;

6794 
g
->
lÊags
 = 
	`°bi__gë8
(
s
);

6796 i‡(
g
->
lÊags
 & 0x40) {

6797 
g
->
°ï
 = 8 * g->
löe_size
;

6798 
g
->
∑r£
 = 3;

6800 
g
->
°ï
 = g->
löe_size
;

6801 
g
->
∑r£
 = 0;

6804 i‡(
g
->
lÊags
 & 0x80) {

6805 
	`°bi__gif_∑r£_cﬁ‹èbÀ
(
s
,
g
->
ÕÆ
, 2 << (g->
lÊags
 & 7), g->
eÊags
 & 0x01 ? g->
å™•¨ít
 : -1);

6806 
g
->
cﬁ‹_èbÀ
 = (
°bi_uc
 *Ëg->
ÕÆ
;

6807 } i‡(
g
->
Êags
 & 0x80) {

6808 
g
->
cﬁ‹_èbÀ
 = (
°bi_uc
 *Ëg->
∑l
;

6810  
	`°bi__îΩuc
("missing colorÅable", "Corrupt GIF");

6812 
o
 = 
	`°bi__¥o˚ss_gif_ø°î
(
s
, 
g
);

6813 i‡(!
o
Ë 
NULL
;

6816 
pcou¡
 = 
g
->
w
 * g->
h
;

6817 i‡(
fú°_‰ame
 && (
g
->
bgödex
 > 0)) {

6819 
pi
 = 0;Öò< 
pcou¡
; ++pi) {

6820 i‡(
g
->
hi°‹y
[
pi
] == 0) {

6821 
g
->
∑l
[g->
bgödex
][3] = 255;

6822 
	`mem˝y
–&
g
->
out
[
pi
 * 4], &g->
∑l
[g->
bgödex
], 4 );

6827  
o
;

6832 
Àn
;

6833 
ext
 = 
	`°bi__gë8
(
s
);

6834 i‡(
ext
 == 0xF9) {

6835 
Àn
 = 
	`°bi__gë8
(
s
);

6836 i‡(
Àn
 == 4) {

6837 
g
->
eÊags
 = 
	`°bi__gë8
(
s
);

6838 
g
->
dñay
 = 10 * 
	`°bi__gë16À
(
s
);

6841 i‡(
g
->
å™•¨ít
 >= 0) {

6842 
g
->
∑l
[g->
å™•¨ít
][3] = 255;

6844 i‡(
g
->
eÊags
 & 0x01) {

6845 
g
->
å™•¨ít
 = 
	`°bi__gë8
(
s
);

6846 i‡(
g
->
å™•¨ít
 >= 0) {

6847 
g
->
∑l
[g->
å™•¨ít
][3] = 0;

6851 
	`°bi__skù
(
s
, 1);

6852 
g
->
å™•¨ít
 = -1;

6855 
	`°bi__skù
(
s
, 
Àn
);

6859 (
Àn
 = 
	`°bi__gë8
(
s
)) != 0) {

6860 
	`°bi__skù
(
s
, 
Àn
);

6866  (
°bi_uc
 *Ë
s
;

6869  
	`°bi__îΩuc
("unknown code", "Corrupt GIF");

6872 
	}
}

6874 *
	$°bi__lﬂd_gif_maö_outofmem
(
°bi__gif
 *
g
, 
°bi_uc
 *
out
, **
dñays
)

6876 
	`STBI_FREE
(
g
->
out
);

6877 
	`STBI_FREE
(
g
->
hi°‹y
);

6878 
	`STBI_FREE
(
g
->
background
);

6880 i‡(
out
Ë
	`STBI_FREE
(out);

6881 i‡(
dñays
 && *dñaysË
	`STBI_FREE
(*delays);

6882  
	`°bi__îΩuc
("outofmem", "Out of memory");

6883 
	}
}

6885 *
	$°bi__lﬂd_gif_maö
(
°bi__c⁄ãxt
 *
s
, **
dñays
, *
x
, *
y
, *
z
, *
comp
, 
ªq_comp
)

6887 i‡(
	`°bi__gif_ã°
(
s
)) {

6888 
œyîs
 = 0;

6889 
°bi_uc
 *
u
 = 0;

6890 
°bi_uc
 *
out
 = 0;

6891 
°bi_uc
 *
two_back
 = 0;

6892 
°bi__gif
 
g
;

6893 
°ride
;

6894 
out_size
 = 0;

6895 
dñays_size
 = 0;

6897 
	`STBI_NOTUSED
(
out_size
);

6898 
	`STBI_NOTUSED
(
dñays_size
);

6900 
	`mem£t
(&
g
, 0, (g));

6901 i‡(
dñays
) {

6902 *
dñays
 = 0;

6906 
u
 = 
	`°bi__gif_lﬂd_√xt
(
s
, &
g
, 
comp
, 
ªq_comp
, 
two_back
);

6907 i‡(
u
 =(
°bi_uc
 *Ë
s
) u = 0;

6909 i‡(
u
) {

6910 *
x
 = 
g
.
w
;

6911 *
y
 = 
g
.
h
;

6912 ++
œyîs
;

6913 
°ride
 = 
g
.
w
 * g.
h
 * 4;

6915 i‡(
out
) {

6916 *
tmp
 = (
°bi_uc
*Ë
	`STBI_REALLOC_SIZED
–
out
, 
out_size
, 
œyîs
 * 
°ride
 );

6917 i‡(!
tmp
)

6918  
	`°bi__lﬂd_gif_maö_outofmem
(&
g
, 
out
, 
dñays
);

6920 
out
 = (
°bi_uc
*Ë
tmp
;

6921 
out_size
 = 
œyîs
 * 
°ride
;

6924 i‡(
dñays
) {

6925 *
√w_dñays
 = (*Ë
	`STBI_REALLOC_SIZED
–*
dñays
, 
dñays_size
, (Ë* 
œyîs
 );

6926 i‡(!
√w_dñays
)

6927  
	`°bi__lﬂd_gif_maö_outofmem
(&
g
, 
out
, 
dñays
);

6928 *
dñays
 = 
√w_dñays
;

6929 
dñays_size
 = 
œyîs
 * ();

6932 
out
 = (
°bi_uc
*)
	`°bi__mÆloc
–
œyîs
 * 
°ride
 );

6933 i‡(!
out
)

6934  
	`°bi__lﬂd_gif_maö_outofmem
(&
g
, 
out
, 
dñays
);

6935 
out_size
 = 
œyîs
 * 
°ride
;

6936 i‡(
dñays
) {

6937 *
dñays
 = (*Ë
	`°bi__mÆloc
–
œyîs
 * () );

6938 i‡(!*
dñays
)

6939  
	`°bi__lﬂd_gif_maö_outofmem
(&
g
, 
out
, 
dñays
);

6940 
dñays_size
 = 
œyîs
 * ();

6943 
	`mem˝y
–
out
 + ((
œyîs
 - 1Ë* 
°ride
), 
u
, stride );

6944 i‡(
œyîs
 >= 2) {

6945 
two_back
 = 
out
 - 2 * 
°ride
;

6948 i‡(
dñays
) {

6949 (*
dñays
)[
œyîs
 - 1U] = 
g
.
dñay
;

6952 } 
u
 != 0);

6955 
	`STBI_FREE
(
g
.
out
);

6956 
	`STBI_FREE
(
g
.
hi°‹y
);

6957 
	`STBI_FREE
(
g
.
background
);

6960 i‡(
ªq_comp
 &&Ñeq_comp != 4)

6961 
out
 = 
	`°bi__c⁄vît_f‹m©
(out, 4, 
ªq_comp
, 
œyîs
 * 
g
.
w
, g.
h
);

6963 *
z
 = 
œyîs
;

6964  
out
;

6966  
	`°bi__îΩuc
("not GIF", "Image wasÇotásá gifÅype.");

6968 
	}
}

6970 *
	$°bi__gif_lﬂd
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
)

6972 
°bi_uc
 *
u
 = 0;

6973 
°bi__gif
 
g
;

6974 
	`mem£t
(&
g
, 0, (g));

6975 
	`STBI_NOTUSED
(
ri
);

6977 
u
 = 
	`°bi__gif_lﬂd_√xt
(
s
, &
g
, 
comp
, 
ªq_comp
, 0);

6978 i‡(
u
 =(
°bi_uc
 *Ë
s
) u = 0;

6979 i‡(
u
) {

6980 *
x
 = 
g
.
w
;

6981 *
y
 = 
g
.
h
;

6985 i‡(
ªq_comp
 &&Ñeq_comp != 4)

6986 
u
 = 
	`°bi__c⁄vît_f‹m©
(u, 4, 
ªq_comp
, 
g
.
w
, g.
h
);

6987 } i‡(
g
.
out
) {

6989 
	`STBI_FREE
(
g
.
out
);

6993 
	`STBI_FREE
(
g
.
hi°‹y
);

6994 
	`STBI_FREE
(
g
.
background
);

6996  
u
;

6997 
	}
}

6999 
	$°bi__gif_öfo
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
)

7001  
	`°bi__gif_öfo_øw
(
s
,
x
,
y
,
comp
);

7002 
	}
}

7008 #i‚de‡
STBI_NO_HDR


7009 
	$°bi__hdr_ã°_c‹e
(
°bi__c⁄ãxt
 *
s
, c⁄° *
sig«tuª
)

7011 
i
;

7012 
i
=0; 
sig«tuª
[i]; ++i)

7013 i‡(
	`°bi__gë8
(
s
Ë!
sig«tuª
[
i
])

7015 
	`°bi__ªwöd
(
s
);

7017 
	}
}

7019 
	$°bi__hdr_ã°
(
°bi__c⁄ãxt
* 
s
)

7021 
r
 = 
	`°bi__hdr_ã°_c‹e
(
s
, "#?RADIANCE\n");

7022 
	`°bi__ªwöd
(
s
);

7023 if(!
r
) {

7024 
r
 = 
	`°bi__hdr_ã°_c‹e
(
s
, "#?RGBE\n");

7025 
	`°bi__ªwöd
(
s
);

7027  
r
;

7028 
	}
}

7030 
	#STBI__HDR_BUFLEN
 1024

	)

7031 *
	$°bi__hdr_gëtokí
(
°bi__c⁄ãxt
 *
z
, *
buf„r
)

7033 
Àn
=0;

7034 
c
 = '\0';

7036 
c
 = (Ë
	`°bi__gë8
(
z
);

7038 !
	`°bi__©_eof
(
z
Ë&& 
c
 != '\n') {

7039 
buf„r
[
Àn
++] = 
c
;

7040 i‡(
Àn
 =
STBI__HDR_BUFLEN
-1) {

7042 !
	`°bi__©_eof
(
z
Ë&& 
	`°bi__gë8
(z) != '\n')

7046 
c
 = (Ë
	`°bi__gë8
(
z
);

7049 
buf„r
[
Àn
] = 0;

7050  
buf„r
;

7051 
	}
}

7053 
	$°bi__hdr_c⁄vît
(*
ouçut
, 
°bi_uc
 *
öput
, 
ªq_comp
)

7055 i‡–
öput
[3] != 0 ) {

7056 
f1
;

7058 
f1
 = (Ë
	`ldexp
(1.0f, 
öput
[3] - ()(128 + 8));

7059 i‡(
ªq_comp
 <= 2)

7060 
ouçut
[0] = (
öput
[0] + i≈ut[1] + i≈ut[2]Ë* 
f1
 / 3;

7062 
ouçut
[0] = 
öput
[0] * 
f1
;

7063 
ouçut
[1] = 
öput
[1] * 
f1
;

7064 
ouçut
[2] = 
öput
[2] * 
f1
;

7066 i‡(
ªq_comp
 =2Ë
ouçut
[1] = 1;

7067 i‡(
ªq_comp
 =4Ë
ouçut
[3] = 1;

7069 
ªq_comp
) {

7070 4: 
ouçut
[3] = 1;

7071 3: 
ouçut
[0] = output[1] = output[2] = 0;

7073 2: 
ouçut
[1] = 1;

7074 1: 
ouçut
[0] = 0;

7078 
	}
}

7080 *
	$°bi__hdr_lﬂd
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
)

7082 
buf„r
[
STBI__HDR_BUFLEN
];

7083 *
tokí
;

7084 
vÆid
 = 0;

7085 
width
, 
height
;

7086 
°bi_uc
 *
sˇ∆öe
;

7087 *
hdr_d©a
;

7088 
Àn
;

7089 
cou¡
, 
vÆue
;

7090 
i
, 
j
, 
k
, 
c1
,
c2
, 
z
;

7091 c⁄° *
hódîTokí
;

7092 
	`STBI_NOTUSED
(
ri
);

7095 
hódîTokí
 = 
	`°bi__hdr_gëtokí
(
s
,
buf„r
);

7096 i‡(
	`°rcmp
(
hódîTokí
, "#?RADIANCE") != 0 && strcmp(headerToken, "#?RGBE") != 0)

7097  
	`°bi__îΩf
("not HDR", "Corrupt HDR image");

7101 
tokí
 = 
	`°bi__hdr_gëtokí
(
s
,
buf„r
);

7102 i‡(
tokí
[0] == 0) ;

7103 i‡(
	`°rcmp
(
tokí
, "FORMAT=32-bô_æe_rgbe"Ë=0Ë
vÆid
 = 1;

7106 i‡(!
vÆid
Ë 
	`°bi__îΩf
("unsupported format", "Unsupported HDR format");

7110 
tokí
 = 
	`°bi__hdr_gëtokí
(
s
,
buf„r
);

7111 i‡(
	`°∫cmp
(
tokí
, "-Y ", 3)Ë 
	`°bi__îΩf
("unsupported dataÜayout", "Unsupported HDR format");

7112 
tokí
 += 3;

7113 
height
 = (Ë
	`°πﬁ
(
tokí
, &token, 10);

7114 *
tokí
 == ' ') ++token;

7115 i‡(
	`°∫cmp
(
tokí
, "+X ", 3)Ë 
	`°bi__îΩf
("unsupported dataÜayout", "Unsupported HDR format");

7116 
tokí
 += 3;

7117 
width
 = (Ë
	`°πﬁ
(
tokí
, 
NULL
, 10);

7119 i‡(
height
 > 
STBI_MAX_DIMENSIONS
Ë 
	`°bi__îΩf
("tooÜarge","VeryÜarge image (corrupt?)");

7120 i‡(
width
 > 
STBI_MAX_DIMENSIONS
Ë 
	`°bi__îΩf
("tooÜarge","VeryÜarge image (corrupt?)");

7122 *
x
 = 
width
;

7123 *
y
 = 
height
;

7125 i‡(
comp
) *comp = 3;

7126 i‡(
ªq_comp
 == 0)Ñeq_comp = 3;

7128 i‡(!
	`°bi__mad4sizes_vÆid
(
width
, 
height
, 
ªq_comp
, (), 0))

7129  
	`°bi__îΩf
("tooÜarge", "HDR image isÅooÜarge");

7132 
hdr_d©a
 = (*Ë
	`°bi__mÆloc_mad4
(
width
, 
height
, 
ªq_comp
, (), 0);

7133 i‡(!
hdr_d©a
)

7134  
	`°bi__îΩf
("outofmem", "Out of memory");

7138 i‡–
width
 < 8 || width >= 32768) {

7140 
j
=0; j < 
height
; ++j) {

7141 
i
=0; i < 
width
; ++i) {

7142 
°bi_uc
 
rgbe
[4];

7143 
maö_decode_lo›
:

7144 
	`°bi__gën
(
s
, 
rgbe
, 4);

7145 
	`°bi__hdr_c⁄vît
(
hdr_d©a
 + 
j
 * 
width
 * 
ªq_comp
 + 
i
 *Ñeq_comp, 
rgbe
,Ñeq_comp);

7150 
sˇ∆öe
 = 
NULL
;

7152 
j
 = 0; j < 
height
; ++j) {

7153 
c1
 = 
	`°bi__gë8
(
s
);

7154 
c2
 = 
	`°bi__gë8
(
s
);

7155 
Àn
 = 
	`°bi__gë8
(
s
);

7156 i‡(
c1
 !2 || 
c2
 !2 || (
Àn
 & 0x80)) {

7159 
°bi_uc
 
rgbe
[4];

7160 
rgbe
[0] = (
°bi_uc
Ë
c1
;

7161 
rgbe
[1] = (
°bi_uc
Ë
c2
;

7162 
rgbe
[2] = (
°bi_uc
Ë
Àn
;

7163 
rgbe
[3] = (
°bi_uc
Ë
	`°bi__gë8
(
s
);

7164 
	`°bi__hdr_c⁄vît
(
hdr_d©a
, 
rgbe
, 
ªq_comp
);

7165 
i
 = 1;

7166 
j
 = 0;

7167 
	`STBI_FREE
(
sˇ∆öe
);

7168 
maö_decode_lo›
;

7170 
Àn
 <<= 8;

7171 
Àn
 |
	`°bi__gë8
(
s
);

7172 i‡(
Àn
 !
width
Ë{ 
	`STBI_FREE
(
hdr_d©a
); STBI_FREE(
sˇ∆öe
);  
	`°bi__îΩf
("invalid decoded scanlineÜength", "corrupt HDR"); }

7173 i‡(
sˇ∆öe
 =
NULL
) {

7174 
sˇ∆öe
 = (
°bi_uc
 *Ë
	`°bi__mÆloc_mad2
(
width
, 4, 0);

7175 i‡(!
sˇ∆öe
) {

7176 
	`STBI_FREE
(
hdr_d©a
);

7177  
	`°bi__îΩf
("outofmem", "Out of memory");

7181 
k
 = 0; k < 4; ++k) {

7182 
∆e·
;

7183 
i
 = 0;

7184 (
∆e·
 = 
width
 - 
i
) > 0) {

7185 
cou¡
 = 
	`°bi__gë8
(
s
);

7186 i‡(
cou¡
 > 128) {

7188 
vÆue
 = 
	`°bi__gë8
(
s
);

7189 
cou¡
 -= 128;

7190 i‡(
cou¡
 > 
∆e·
Ë{ 
	`STBI_FREE
(
hdr_d©a
); STBI_FREE(
sˇ∆öe
);  
	`°bi__îΩf
("corrupt", "bad RLE data in HDR"); }

7191 
z
 = 0; z < 
cou¡
; ++z)

7192 
sˇ∆öe
[
i
++ * 4 + 
k
] = 
vÆue
;

7195 i‡(
cou¡
 > 
∆e·
Ë{ 
	`STBI_FREE
(
hdr_d©a
); STBI_FREE(
sˇ∆öe
);  
	`°bi__îΩf
("corrupt", "bad RLE data in HDR"); }

7196 
z
 = 0; z < 
cou¡
; ++z)

7197 
sˇ∆öe
[
i
++ * 4 + 
k
] = 
	`°bi__gë8
(
s
);

7201 
i
=0; i < 
width
; ++i)

7202 
	`°bi__hdr_c⁄vît
(
hdr_d©a
+(
j
*
width
 + 
i
)*
ªq_comp
, 
sˇ∆öe
 + i*4,Ñeq_comp);

7204 i‡(
sˇ∆öe
)

7205 
	`STBI_FREE
(
sˇ∆öe
);

7208  
hdr_d©a
;

7209 
	}
}

7211 
	$°bi__hdr_öfo
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
)

7213 
buf„r
[
STBI__HDR_BUFLEN
];

7214 *
tokí
;

7215 
vÆid
 = 0;

7216 
dummy
;

7218 i‡(!
x
Ëx = &
dummy
;

7219 i‡(!
y
Ëy = &
dummy
;

7220 i‡(!
comp
Ëcom∞&
dummy
;

7222 i‡(
	`°bi__hdr_ã°
(
s
) == 0) {

7223 
	`°bi__ªwöd
–
s
 );

7228 
tokí
 = 
	`°bi__hdr_gëtokí
(
s
,
buf„r
);

7229 i‡(
tokí
[0] == 0) ;

7230 i‡(
	`°rcmp
(
tokí
, "FORMAT=32-bô_æe_rgbe"Ë=0Ë
vÆid
 = 1;

7233 i‡(!
vÆid
) {

7234 
	`°bi__ªwöd
–
s
 );

7237 
tokí
 = 
	`°bi__hdr_gëtokí
(
s
,
buf„r
);

7238 i‡(
	`°∫cmp
(
tokí
, "-Y ", 3)) {

7239 
	`°bi__ªwöd
–
s
 );

7242 
tokí
 += 3;

7243 *
y
 = (Ë
	`°πﬁ
(
tokí
, &token, 10);

7244 *
tokí
 == ' ') ++token;

7245 i‡(
	`°∫cmp
(
tokí
, "+X ", 3)) {

7246 
	`°bi__ªwöd
–
s
 );

7249 
tokí
 += 3;

7250 *
x
 = (Ë
	`°πﬁ
(
tokí
, 
NULL
, 10);

7251 *
comp
 = 3;

7253 
	}
}

7256 #i‚de‡
STBI_NO_BMP


7257 
	$°bi__bmp_öfo
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
)

7259 *
p
;

7260 
°bi__bmp_d©a
 
öfo
;

7262 
öfo
.
Æl_a
 = 255;

7263 
p
 = 
	`°bi__bmp_∑r£_hódî
(
s
, &
öfo
);

7264 i‡(
p
 =
NULL
) {

7265 
	`°bi__ªwöd
–
s
 );

7268 i‡(
x
Ë*x = 
s
->
img_x
;

7269 i‡(
y
Ë*y = 
s
->
img_y
;

7270 i‡(
comp
) {

7271 i‡(
öfo
.
bµ
 =24 && info.
ma
 == 0xff000000)

7272 *
comp
 = 3;

7274 *
comp
 = 
öfo
.
ma
 ? 4 : 3;

7277 
	}
}

7280 #i‚de‡
STBI_NO_PSD


7281 
	$°bi__psd_öfo
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
)

7283 
ch™√lCou¡
, 
dummy
, 
dïth
;

7284 i‡(!
x
Ëx = &
dummy
;

7285 i‡(!
y
Ëy = &
dummy
;

7286 i‡(!
comp
Ëcom∞&
dummy
;

7287 i‡(
	`°bi__gë32be
(
s
) != 0x38425053) {

7288 
	`°bi__ªwöd
–
s
 );

7291 i‡(
	`°bi__gë16be
(
s
) != 1) {

7292 
	`°bi__ªwöd
–
s
 );

7295 
	`°bi__skù
(
s
, 6);

7296 
ch™√lCou¡
 = 
	`°bi__gë16be
(
s
);

7297 i‡(
ch™√lCou¡
 < 0 || channelCount > 16) {

7298 
	`°bi__ªwöd
–
s
 );

7301 *
y
 = 
	`°bi__gë32be
(
s
);

7302 *
x
 = 
	`°bi__gë32be
(
s
);

7303 
dïth
 = 
	`°bi__gë16be
(
s
);

7304 i‡(
dïth
 != 8 && depth != 16) {

7305 
	`°bi__ªwöd
–
s
 );

7308 i‡(
	`°bi__gë16be
(
s
) != 3) {

7309 
	`°bi__ªwöd
–
s
 );

7312 *
comp
 = 4;

7314 
	}
}

7316 
	$°bi__psd_is16
(
°bi__c⁄ãxt
 *
s
)

7318 
ch™√lCou¡
, 
dïth
;

7319 i‡(
	`°bi__gë32be
(
s
) != 0x38425053) {

7320 
	`°bi__ªwöd
–
s
 );

7323 i‡(
	`°bi__gë16be
(
s
) != 1) {

7324 
	`°bi__ªwöd
–
s
 );

7327 
	`°bi__skù
(
s
, 6);

7328 
ch™√lCou¡
 = 
	`°bi__gë16be
(
s
);

7329 i‡(
ch™√lCou¡
 < 0 || channelCount > 16) {

7330 
	`°bi__ªwöd
–
s
 );

7333 
	`STBI_NOTUSED
(
	`°bi__gë32be
(
s
));

7334 
	`STBI_NOTUSED
(
	`°bi__gë32be
(
s
));

7335 
dïth
 = 
	`°bi__gë16be
(
s
);

7336 i‡(
dïth
 != 16) {

7337 
	`°bi__ªwöd
–
s
 );

7341 
	}
}

7344 #i‚de‡
STBI_NO_PIC


7345 
	$°bi__pic_öfo
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
)

7347 
a˘_comp
=0,
num_∑ckës
=0,
chaöed
,
dummy
;

7348 
°bi__pic_∑ckë
 
∑ckës
[10];

7350 i‡(!
x
Ëx = &
dummy
;

7351 i‡(!
y
Ëy = &
dummy
;

7352 i‡(!
comp
Ëcom∞&
dummy
;

7354 i‡(!
	`°bi__pic_is4
(
s
,"\x53\x80\xF6\x34")) {

7355 
	`°bi__ªwöd
(
s
);

7359 
	`°bi__skù
(
s
, 88);

7361 *
x
 = 
	`°bi__gë16be
(
s
);

7362 *
y
 = 
	`°bi__gë16be
(
s
);

7363 i‡(
	`°bi__©_eof
(
s
)) {

7364 
	`°bi__ªwöd
–
s
);

7367 i‡–(*
x
Ë!0 && (1 << 28Ë/ (*xË< (*
y
)) {

7368 
	`°bi__ªwöd
–
s
 );

7372 
	`°bi__skù
(
s
, 8);

7375 
°bi__pic_∑ckë
 *
∑ckë
;

7377 i‡(
num_∑ckës
==(
∑ckës
)/(packets[0]))

7380 
∑ckë
 = &
∑ckës
[
num_∑ckës
++];

7381 
chaöed
 = 
	`°bi__gë8
(
s
);

7382 
∑ckë
->
size
 = 
	`°bi__gë8
(
s
);

7383 
∑ckë
->
ty≥
 = 
	`°bi__gë8
(
s
);

7384 
∑ckë
->
ch™√l
 = 
	`°bi__gë8
(
s
);

7385 
a˘_comp
 |
∑ckë
->
ch™√l
;

7387 i‡(
	`°bi__©_eof
(
s
)) {

7388 
	`°bi__ªwöd
–
s
 );

7391 i‡(
∑ckë
->
size
 != 8) {

7392 
	`°bi__ªwöd
–
s
 );

7395 } 
chaöed
);

7397 *
comp
 = (
a˘_comp
 & 0x10 ? 4 : 3);

7400 
	}
}

7414 #i‚de‡
STBI_NO_PNM


7416 
	$°bi__≤m_ã°
(
°bi__c⁄ãxt
 *
s
)

7418 
p
, 
t
;

7419 
p
 = (Ë
	`°bi__gë8
(
s
);

7420 
t
 = (Ë
	`°bi__gë8
(
s
);

7421 i‡(
p
 !'P' || (
t
 != '5' &&Å != '6')) {

7422 
	`°bi__ªwöd
–
s
 );

7426 
	}
}

7428 *
	$°bi__≤m_lﬂd
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
, 
ªq_comp
, 
°bi__ªsu…_öfo
 *
ri
)

7430 
°bi_uc
 *
out
;

7431 
	`STBI_NOTUSED
(
ri
);

7433 
ri
->
bôs_≥r_ch™√l
 = 
	`°bi__≤m_öfo
(
s
, (*)&s->
img_x
, (*)&s->
img_y
, (*)&s->
img_n
);

7434 i‡(
ri
->
bôs_≥r_ch™√l
 == 0)

7437 i‡(
s
->
img_y
 > 
STBI_MAX_DIMENSIONS
Ë 
	`°bi__îΩuc
("tooÜarge","VeryÜarge image (corrupt?)");

7438 i‡(
s
->
img_x
 > 
STBI_MAX_DIMENSIONS
Ë 
	`°bi__îΩuc
("tooÜarge","VeryÜarge image (corrupt?)");

7440 *
x
 = 
s
->
img_x
;

7441 *
y
 = 
s
->
img_y
;

7442 i‡(
comp
Ë*com∞
s
->
img_n
;

7444 i‡(!
	`°bi__mad4sizes_vÆid
(
s
->
img_n
, s->
img_x
, s->
img_y
, 
ri
->
bôs_≥r_ch™√l
 / 8, 0))

7445  
	`°bi__îΩuc
("tooÜarge", "PNMÅooÜarge");

7447 
out
 = (
°bi_uc
 *Ë
	`°bi__mÆloc_mad4
(
s
->
img_n
, s->
img_x
, s->
img_y
, 
ri
->
bôs_≥r_ch™√l
 / 8, 0);

7448 i‡(!
out
Ë 
	`°bi__îΩuc
("outofmem", "Out of memory");

7449 
	`°bi__gën
(
s
, 
out
, s->
img_n
 * s->
img_x
 * s->
img_y
 * (
ri
->
bôs_≥r_ch™√l
 / 8));

7451 i‡(
ªq_comp
 &&Ñeq_com∞!
s
->
img_n
) {

7452 
out
 = 
	`°bi__c⁄vît_f‹m©
(out, 
s
->
img_n
, 
ªq_comp
, s->
img_x
, s->
img_y
);

7453 i‡(
out
 =
NULL
)  out;

7455  
out
;

7456 
	}
}

7458 
	$°bi__≤m_is•a˚
(
c
)

7460  
c
 == ' ' || c == '\t' || c == '\n' || c == '\v' || c == '\f' || c == '\r';

7461 
	}
}

7463 
	$°bi__≤m_skù_whôe•a˚
(
°bi__c⁄ãxt
 *
s
, *
c
)

7466 !
	`°bi__©_eof
(
s
Ë&& 
	`°bi__≤m_is•a˚
(*
c
))

7467 *
c
 = (Ë
	`°bi__gë8
(
s
);

7469 i‡(
	`°bi__©_eof
(
s
Ë|| *
c
 != '#')

7472 !
	`°bi__©_eof
(
s
Ë&& *
c
 != '\n' && *c != '\r' )

7473 *
c
 = (Ë
	`°bi__gë8
(
s
);

7475 
	}
}

7477 
	$°bi__≤m_isdigô
(
c
)

7479  
c
 >= '0' && c <= '9';

7480 
	}
}

7482 
	$°bi__≤m_gëöãgî
(
°bi__c⁄ãxt
 *
s
, *
c
)

7484 
vÆue
 = 0;

7486 !
	`°bi__©_eof
(
s
Ë&& 
	`°bi__≤m_isdigô
(*
c
)) {

7487 
vÆue
 = vÆue*10 + (*
c
 - '0');

7488 *
c
 = (Ë
	`°bi__gë8
(
s
);

7491  
vÆue
;

7492 
	}
}

7494 
	$°bi__≤m_öfo
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
)

7496 
maxv
, 
dummy
;

7497 
c
, 
p
, 
t
;

7499 i‡(!
x
Ëx = &
dummy
;

7500 i‡(!
y
Ëy = &
dummy
;

7501 i‡(!
comp
Ëcom∞&
dummy
;

7503 
	`°bi__ªwöd
(
s
);

7506 
p
 = (Ë
	`°bi__gë8
(
s
);

7507 
t
 = (Ë
	`°bi__gë8
(
s
);

7508 i‡(
p
 !'P' || (
t
 != '5' &&Å != '6')) {

7509 
	`°bi__ªwöd
(
s
);

7513 *
comp
 = (
t
 == '6') ? 3 : 1;

7515 
c
 = (Ë
	`°bi__gë8
(
s
);

7516 
	`°bi__≤m_skù_whôe•a˚
(
s
, &
c
);

7518 *
x
 = 
	`°bi__≤m_gëöãgî
(
s
, &
c
);

7519 
	`°bi__≤m_skù_whôe•a˚
(
s
, &
c
);

7521 *
y
 = 
	`°bi__≤m_gëöãgî
(
s
, &
c
);

7522 
	`°bi__≤m_skù_whôe•a˚
(
s
, &
c
);

7524 
maxv
 = 
	`°bi__≤m_gëöãgî
(
s
, &
c
);

7525 i‡(
maxv
 > 65535)

7526  
	`°bi__îr
("max value > 65535", "PPM image supports only 8-bitánd 16-bit images");

7527 i‡(
maxv
 > 255)

7531 
	}
}

7533 
	$°bi__≤m_is16
(
°bi__c⁄ãxt
 *
s
)

7535 i‡(
	`°bi__≤m_öfo
(
s
, 
NULL
, NULL, NULL) == 16)

7538 
	}
}

7541 
	$°bi__öfo_maö
(
°bi__c⁄ãxt
 *
s
, *
x
, *
y
, *
comp
)

7543 #i‚de‡
STBI_NO_JPEG


7544 i‡(
	`°bi__j≥g_öfo
(
s
, 
x
, 
y
, 
comp
))  1;

7547 #i‚de‡
STBI_NO_PNG


7548 i‡(
	`°bi__≤g_öfo
(
s
, 
x
, 
y
, 
comp
))  1;

7551 #i‚de‡
STBI_NO_GIF


7552 i‡(
	`°bi__gif_öfo
(
s
, 
x
, 
y
, 
comp
))  1;

7555 #i‚de‡
STBI_NO_BMP


7556 i‡(
	`°bi__bmp_öfo
(
s
, 
x
, 
y
, 
comp
))  1;

7559 #i‚de‡
STBI_NO_PSD


7560 i‡(
	`°bi__psd_öfo
(
s
, 
x
, 
y
, 
comp
))  1;

7563 #i‚de‡
STBI_NO_PIC


7564 i‡(
	`°bi__pic_öfo
(
s
, 
x
, 
y
, 
comp
))  1;

7567 #i‚de‡
STBI_NO_PNM


7568 i‡(
	`°bi__≤m_öfo
(
s
, 
x
, 
y
, 
comp
))  1;

7571 #i‚de‡
STBI_NO_HDR


7572 i‡(
	`°bi__hdr_öfo
(
s
, 
x
, 
y
, 
comp
))  1;

7576 #i‚de‡
STBI_NO_TGA


7577 i‡(
	`°bi__tga_öfo
(
s
, 
x
, 
y
, 
comp
))

7580  
	`°bi__îr
("unknown imageÅype", "ImageÇot ofány knownÅype, or corrupt");

7581 
	}
}

7583 
	$°bi__is_16_maö
(
°bi__c⁄ãxt
 *
s
)

7585 #i‚de‡
STBI_NO_PNG


7586 i‡(
	`°bi__≤g_is16
(
s
))  1;

7589 #i‚de‡
STBI_NO_PSD


7590 i‡(
	`°bi__psd_is16
(
s
))  1;

7593 #i‚de‡
STBI_NO_PNM


7594 i‡(
	`°bi__≤m_is16
(
s
))  1;

7597 
	}
}

7599 #i‚de‡
STBI_NO_STDIO


7600 
STBIDEF
 
	$°bi_öfo
(c⁄° *
fûíame
, *
x
, *
y
, *
comp
)

7602 
FILE
 *
f
 = 
	`°bi__f›í
(
fûíame
, "rb");

7603 
ªsu…
;

7604 i‡(!
f
Ë 
	`°bi__îr
("can't fopen", "UnableÅo open file");

7605 
ªsu…
 = 
	`°bi_öfo_‰om_fûe
(
f
, 
x
, 
y
, 
comp
);

7606 
	`f˛o£
(
f
);

7607  
ªsu…
;

7608 
	}
}

7610 
STBIDEF
 
	$°bi_öfo_‰om_fûe
(
FILE
 *
f
, *
x
, *
y
, *
comp
)

7612 
r
;

7613 
°bi__c⁄ãxt
 
s
;

7614 
pos
 = 
	`·ñl
(
f
);

7615 
	`°bi__°¨t_fûe
(&
s
, 
f
);

7616 
r
 = 
	`°bi__öfo_maö
(&
s
,
x
,
y
,
comp
);

7617 
	`f£ek
(
f
,
pos
,
SEEK_SET
);

7618  
r
;

7619 
	}
}

7621 
STBIDEF
 
	$°bi_is_16_bô
(c⁄° *
fûíame
)

7623 
FILE
 *
f
 = 
	`°bi__f›í
(
fûíame
, "rb");

7624 
ªsu…
;

7625 i‡(!
f
Ë 
	`°bi__îr
("can't fopen", "UnableÅo open file");

7626 
ªsu…
 = 
	`°bi_is_16_bô_‰om_fûe
(
f
);

7627 
	`f˛o£
(
f
);

7628  
ªsu…
;

7629 
	}
}

7631 
STBIDEF
 
	$°bi_is_16_bô_‰om_fûe
(
FILE
 *
f
)

7633 
r
;

7634 
°bi__c⁄ãxt
 
s
;

7635 
pos
 = 
	`·ñl
(
f
);

7636 
	`°bi__°¨t_fûe
(&
s
, 
f
);

7637 
r
 = 
	`°bi__is_16_maö
(&
s
);

7638 
	`f£ek
(
f
,
pos
,
SEEK_SET
);

7639  
r
;

7640 
	}
}

7643 
STBIDEF
 
	$°bi_öfo_‰om_mem‹y
(
°bi_uc
 c⁄° *
buf„r
, 
Àn
, *
x
, *
y
, *
comp
)

7645 
°bi__c⁄ãxt
 
s
;

7646 
	`°bi__°¨t_mem
(&
s
,
buf„r
,
Àn
);

7647  
	`°bi__öfo_maö
(&
s
,
x
,
y
,
comp
);

7648 
	}
}

7650 
STBIDEF
 
	$°bi_öfo_‰om_ˇŒbacks
(
°bi_io_ˇŒbacks
 c⁄° *
c
, *
u£r
, *
x
, *
y
, *
comp
)

7652 
°bi__c⁄ãxt
 
s
;

7653 
	`°bi__°¨t_ˇŒbacks
(&
s
, (
°bi_io_ˇŒbacks
 *Ë
c
, 
u£r
);

7654  
	`°bi__öfo_maö
(&
s
,
x
,
y
,
comp
);

7655 
	}
}

7657 
STBIDEF
 
	$°bi_is_16_bô_‰om_mem‹y
(
°bi_uc
 c⁄° *
buf„r
, 
Àn
)

7659 
°bi__c⁄ãxt
 
s
;

7660 
	`°bi__°¨t_mem
(&
s
,
buf„r
,
Àn
);

7661  
	`°bi__is_16_maö
(&
s
);

7662 
	}
}

7664 
STBIDEF
 
	$°bi_is_16_bô_‰om_ˇŒbacks
(
°bi_io_ˇŒbacks
 c⁄° *
c
, *
u£r
)

7666 
°bi__c⁄ãxt
 
s
;

7667 
	`°bi__°¨t_ˇŒbacks
(&
s
, (
°bi_io_ˇŒbacks
 *Ë
c
, 
u£r
);

7668  
	`°bi__is_16_maö
(&
s
);

7669 
	}
}

	@include/stb_sprintf.h

29 #i‚de‡
STB_SPRINTF_H_INCLUDE


30 
	#STB_SPRINTF_H_INCLUDE


	)

145 #i‡
deföed
(
__˛™g__
)

146 #i‡
deföed
(
__has_„©uª
Ë&& deföed(
__has_©åibuã
)

147 #i‡
__has_„©uª
(
addªss_ßnôizî
)

148 #i‡
__has_©åibuã
(
__no_ßnôize__
)

149 
	#STBSP__ASAN
 
	`__©åibuã__
((
	`__no_ßnôize__
("addªss")))

	)

150 #ñi‡
__has_©åibuã
(
__no_ßnôize_addªss__
)

151 
	#STBSP__ASAN
 
	`__©åibuã__
((
__no_ßnôize_addªss__
))

	)

152 #ñi‡
__has_©åibuã
(
__no_addªss_ß„ty_™Æysis__
)

153 
	#STBSP__ASAN
 
	`__©åibuã__
((
__no_addªss_ß„ty_™Æysis__
))

	)

157 #ñi‡
deföed
(
__GNUC__
Ë&& (__GNUC__ >5 || (__GNUC__ =4 && 
__GNUC_MINOR__
 >= 8))

158 #i‡
deföed
(
__SANITIZE_ADDRESS__
) && __SANITIZE_ADDRESS__

159 
	#STBSP__ASAN
 
	`__©åibuã__
((
__no_ßnôize_addªss__
))

	)

163 #i‚de‡
STBSP__ASAN


164 
	#STBSP__ASAN


	)

167 #ifde‡
STB_SPRINTF_STATIC


168 
	#STBSP__PUBLICDEC
 

	)

169 
	#STBSP__PUBLICDEF
 
STBSP__ASAN


	)

171 #ifde‡
__˝lu•lus


172 
	#STBSP__PUBLICDEC
 "C"

	)

173 
	#STBSP__PUBLICDEF
 "C" 
STBSP__ASAN


	)

175 
	#STBSP__PUBLICDEC
 

	)

176 
	#STBSP__PUBLICDEF
 
STBSP__ASAN


	)

180 #i‡
deföed
(
__has_©åibuã
)

181 #i‡
__has_©åibuã
(
f‹m©
)

182 
	#STBSP__ATTRIBUTE_FORMAT
(
fmt
,
va
Ë
	`__©åibuã__
((
	`f‹m©
(
¥ötf
,fmt,va)))

	)

186 #i‚de‡
STBSP__ATTRIBUTE_FORMAT


187 
	#STBSP__ATTRIBUTE_FORMAT
(
fmt
,
va
)

	)

190 #ifde‡
_MSC_VER


191 
	#STBSP__NOTUSED
(
v
Ë()(v)

	)

193 
	#STBSP__NOTUSED
(
v
Ë()(v)

	)

196 
	~<°d¨g.h
>

197 
	~<°ddef.h
>

199 #i‚de‡
STB_SPRINTF_MIN


200 
	#STB_SPRINTF_MIN
 512

202 *
	tSTBSP_SPRINTFCB
(c⁄° *
	tbuf
, *
	tu£r
, 
	tÀn
);

	)

204 #i‚de‡
STB_SPRINTF_DECORATE


205 
	#STB_SPRINTF_DECORATE
(
«me
Ë
°b•_
##name

207 

	)

208 
STBSP__PUBLICDEC
 
	$STB_SPRINTF_DECORATE
(
v•rötf
)(*
buf
, c⁄° *
fmt
, 
va_li°
 
va
);

209 
STBSP__PUBLICDEC
 
	$STB_SPRINTF_DECORATE
(
v¢¥ötf
)(*
buf
, 
cou¡
, c⁄° *
fmt
, 
va_li°
 
va
);

210 
STBSP__PUBLICDEC
 
	$STB_SPRINTF_DECORATE
(
•rötf
)(*
buf
, c⁄° *
fmt
, ...Ë
	`STBSP__ATTRIBUTE_FORMAT
(2,3);

211 
STBSP__PUBLICDEC
 
	$STB_SPRINTF_DECORATE
(
¢¥ötf
)(*
buf
, 
cou¡
, c⁄° *
fmt
, ...Ë
	`STBSP__ATTRIBUTE_FORMAT
(3,4);

213 
STBSP__PUBLICDEC
 
	$STB_SPRINTF_DECORATE
(
v•rötfcb
)(
STBSP_SPRINTFCB
 *
ˇŒback
, *
u£r
, *
buf
, c⁄° *
fmt
, 
va_li°
 
va
);

214 
STBSP__PUBLICDEC
 
	$STB_SPRINTF_DECORATE
(
£t_£∑øt‹s
)(
comma
, 
≥riod
);

218 #ifde‡
STB_SPRINTF_IMPLEMENTATION


220 
	#°b•__uöt32
 

	)

221 
	#°b•__öt32
 sig√d 

	)

223 #ifde‡
_MSC_VER


224 
	#°b•__uöt64
 
__öt64


	)

225 
	#°b•__öt64
 sig√d 
__öt64


	)

227 
	#°b•__uöt64
 

	)

228 
	#°b•__öt64
 sig√d 

	)

230 
	#°b•__uöt16
 

	)

232 #i‚de‡
°b•__uöçå


233 #i‡
	`deföed
(
__µc64__
Ë|| deföed(
__powîpc64__
Ë|| deföed(
__Ørch64__
Ë|| deföed(
_M_X64
Ë|| deföed(
__x86_64__
Ë|| deföed(
__x86_64
Ë|| deföed(
__s390x__
)

234 
	#°b•__uöçå
 
°b•__uöt64


	)

236 
	#°b•__uöçå
 
°b•__uöt32


	)

240 #i‚de‡
STB_SPRINTF_MSVC_MODE


241 #i‡
	`deföed
(
_MSC_VER
) && (_MSC_VER < 1900)

242 
	#STB_SPRINTF_MSVC_MODE


	)

246 #ifde‡
STB_SPRINTF_NOUNALIGNED


247 
	#STBSP__UNALIGNED
(
code
)

	)

249 
	#STBSP__UNALIGNED
(
code
Ë
	)
code

252 #i‚de‡
STB_SPRINTF_NOFLOAT


254 
°b•__öt32
 
	`°b•__ªÆ_to_°r
(c⁄° **
°¨t
, 
°b•__uöt32
 *
Àn
, *
out
, stb•__öt32 *
decimÆ_pos
, 
vÆue
, stb•__uöt32 
‰ac_digôs
);

255 
°b•__öt32
 
	`°b•__ªÆ_to_∑πs
(
°b•__öt64
 *
bôs
, stb•__öt32 *
expo
, 
vÆue
);

256 
	#STBSP__SPECIAL
 0x7000

	)

259 
°b•__≥riod
 = '.';

260 
°b•__comma
 = ',';

263 
ãmp
;

264 
∑ú
[201];

265 } 
°b•__digô∑ú
 =

272 
	}
};

274 
STBSP__PUBLICDEF
 
	$STB_SPRINTF_DECORATE
(
£t_£∑øt‹s
)(
pcomma
, 
µîiod
)

276 
°b•__≥riod
 = 
µîiod
;

277 
°b•__comma
 = 
pcomma
;

278 
	}
}

280 
	#STBSP__LEFTJUST
 1

	)

281 
	#STBSP__LEADINGPLUS
 2

	)

282 
	#STBSP__LEADINGSPACE
 4

	)

283 
	#STBSP__LEADING_0X
 8

	)

284 
	#STBSP__LEADINGZERO
 16

	)

285 
	#STBSP__INTMAX
 32

	)

286 
	#STBSP__TRIPLET_COMMA
 64

	)

287 
	#STBSP__NEGATIVE
 128

	)

288 
	#STBSP__METRIC_SUFFIX
 256

	)

289 
	#STBSP__HALFWIDTH
 512

	)

290 
	#STBSP__METRIC_NOSPACE
 1024

	)

291 
	#STBSP__METRIC_1024
 2048

	)

292 
	#STBSP__METRIC_JEDEC
 4096

	)

294 
	$°b•__Àad_sign
(
°b•__uöt32
 
Ê
, *
sign
)

296 
sign
[0] = 0;

297 i‡(
Ê
 & 
STBSP__NEGATIVE
) {

298 
sign
[0] = 1;

299 
sign
[1] = '-';

300 } i‡(
Ê
 & 
STBSP__LEADINGSPACE
) {

301 
sign
[0] = 1;

302 
sign
[1] = ' ';

303 } i‡(
Ê
 & 
STBSP__LEADINGPLUS
) {

304 
sign
[0] = 1;

305 
sign
[1] = '+';

307 
	}
}

309 
STBSP__ASAN
 
°b•__uöt32
 
	$°b•__°æí_limôed
(c⁄° *
s
, 
°b•__uöt32
 
limô
)

311 c⁄° * 
¢
 = 
s
;

315 i‡(((
°b•__uöçå
)
¢
 & 3) == 0)

318 i‡(!
limô
 || *
¢
 == 0)

319  (
°b•__uöt32
)(
¢
 - 
s
);

321 ++
¢
;

322 --
limô
;

330 
limô
 >= 4) {

331 
°b•__uöt32
 
v
 = *(°b•__uöt32 *)
¢
;

333 i‡((
v
 - 0x01010101) & (~v) & 0x80808080UL)

336 
¢
 += 4;

337 
limô
 -= 4;

341 
limô
 && *
¢
) {

342 ++
¢
;

343 --
limô
;

346  (
°b•__uöt32
)(
¢
 - 
s
);

347 
	}
}

349 
STBSP__PUBLICDEF
 
	$STB_SPRINTF_DECORATE
(
v•rötfcb
)(
STBSP_SPRINTFCB
 *
ˇŒback
, *
u£r
, *
buf
, c⁄° *
fmt
, 
va_li°
 
va
)

351 
hex
[] = "0123456789abcdefxp";

352 
hexu
[] = "0123456789ABCDEFXP";

353 *
bf
;

354 c⁄° *
f
;

355 
éí
 = 0;

357 
bf
 = 
buf
;

358 
f
 = 
fmt
;

360 
°b•__öt32
 
fw
, 
¥
, 
tz
;

361 
°b•__uöt32
 
Ê
;

364 
	#°b•__chk_cb_bufL
(
byãs
) \

366 
Àn
 = ()(
bf
 - 
buf
); \

367 i‡((
Àn
 + (
byãs
)Ë>
STB_SPRINTF_MIN
) { \

368 
éí
 +
Àn
; \

369 i‡(0 =(
bf
 = 
buf
 = 
	`ˇŒback
(buf, 
u£r
, 
Àn
))) \

370 
d⁄e
; \

372 }

	)

373 
	#°b•__chk_cb_buf
(
byãs
) \

375 i‡(
ˇŒback
) { \

376 
	`°b•__chk_cb_bufL
(
byãs
); \

378 }

	)

379 
	#°b•__Êush_cb
() \

381 
	`°b•__chk_cb_bufL
(
STB_SPRINTF_MIN
 - 1); \

383 
	#°b•__cb_buf_˛amp
(
˛
, 
v
) \

384 
˛
 = 
v
; \

385 i‡(
ˇŒback
) { \

386 
lg
 = 
STB_SPRINTF_MIN
 - ()(
bf
 - 
buf
); \

387 i‡(
˛
 > 
lg
) \

388 
˛
 = 
lg
; \

389 }

	)

393 ((
°b•__uöçå
)
f
) & 3) {

394 
schk1
:

395 i‡(
f
[0] == '%')

396 
sˇndd
;

397 
schk2
:

398 i‡(
f
[0] == 0)

399 
ídfmt
;

400 
	`°b•__chk_cb_buf
(1);

401 *
bf
++ = 
f
[0];

402 ++
f
;

408 
°b•__uöt32
 
v
, 
c
;

409 
v
 = *(
°b•__uöt32
 *)
f
;

410 
c
 = (~
v
) & 0x80808080;

411 i‡(((
v
 ^ 0x25252525Ë- 0x01010101Ë& 
c
)

412 
schk1
;

413 i‡((
v
 - 0x01010101Ë& 
c
)

414 
schk2
;

415 i‡(
ˇŒback
)

416 i‡((
STB_SPRINTF_MIN
 - ()(
bf
 - 
buf
)) < 4)

417 
schk1
;

418 #ifde‡
STB_SPRINTF_NOUNALIGNED


419 if(((
°b•__uöçå
)
bf
) & 3) {

420 
bf
[0] = 
f
[0];

421 
bf
[1] = 
f
[1];

422 
bf
[2] = 
f
[2];

423 
bf
[3] = 
f
[3];

427 *(
°b•__uöt32
 *)
bf
 = 
v
;

429 
bf
 += 4;

430 
f
 += 4;

433 
sˇndd
:

435 ++
f
;

438 
fw
 = 0;

439 
¥
 = -1;

440 
Ê
 = 0;

441 
tz
 = 0;

445 
f
[0]) {

448 
Ê
 |
STBSP__LEFTJUST
;

449 ++
f
;

453 
Ê
 |
STBSP__LEADINGPLUS
;

454 ++
f
;

458 
Ê
 |
STBSP__LEADINGSPACE
;

459 ++
f
;

463 
Ê
 |
STBSP__LEADING_0X
;

464 ++
f
;

468 
Ê
 |
STBSP__TRIPLET_COMMA
;

469 ++
f
;

473 i‡(
Ê
 & 
STBSP__METRIC_SUFFIX
) {

474 i‡(
Ê
 & 
STBSP__METRIC_1024
) {

475 
Ê
 |
STBSP__METRIC_JEDEC
;

477 
Ê
 |
STBSP__METRIC_1024
;

480 
Ê
 |
STBSP__METRIC_SUFFIX
;

482 ++
f
;

486 
Ê
 |
STBSP__METRIC_NOSPACE
;

487 ++
f
;

491 
Ê
 |
STBSP__LEADINGZERO
;

492 ++
f
;

493 
Êags_d⁄e
;

494 : 
Êags_d⁄e
;

497 
Êags_d⁄e
:

500 i‡(
f
[0] == '*') {

501 
fw
 = 
	`va_¨g
(
va
, 
°b•__uöt32
);

502 ++
f
;

504 (
f
[0] >= '0') && (f[0] <= '9')) {

505 
fw
 = fw * 10 + 
f
[0] - '0';

506 
f
++;

510 i‡(
f
[0] == '.') {

511 ++
f
;

512 i‡(
f
[0] == '*') {

513 
¥
 = 
	`va_¨g
(
va
, 
°b•__uöt32
);

514 ++
f
;

516 
¥
 = 0;

517 (
f
[0] >= '0') && (f[0] <= '9')) {

518 
¥
 =Ö∏* 10 + 
f
[0] - '0';

519 
f
++;

525 
f
[0]) {

528 
Ê
 |
STBSP__HALFWIDTH
;

529 ++
f
;

530 i‡(
f
[0] == 'h')

531 ++
f
;

535 
Ê
 |(((Ë=8Ë? 
STBSP__INTMAX
 : 0);

536 ++
f
;

537 i‡(
f
[0] == 'l') {

538 
Ê
 |
STBSP__INTMAX
;

539 ++
f
;

544 
Ê
 |((
size_t
Ë=8Ë? 
STBSP__INTMAX
 : 0;

545 ++
f
;

549 
Ê
 |((
±rdiff_t
Ë=8Ë? 
STBSP__INTMAX
 : 0;

550 ++
f
;

553 
Ê
 |((
±rdiff_t
Ë=8Ë? 
STBSP__INTMAX
 : 0;

554 ++
f
;

558 i‡((
f
[1] == '6') && (f[2] == '4')) {

559 
Ê
 |
STBSP__INTMAX
;

560 
f
 += 3;

561 } i‡((
f
[1] == '3') && (f[2] == '2')) {

562 
f
 += 3;

564 
Ê
 |(((*Ë=8Ë? 
STBSP__INTMAX
 : 0);

565 ++
f
;

572 
f
[0]) {

573 
	#STBSP__NUMSZ
 512

574 
num
[
STBSP__NUMSZ
];

	)

575 
Àad
[8];

576 
èû
[8];

577 *
s
;

578 c⁄° *
h
;

579 
°b•__uöt32
 
l
, 
n
, 
cs
;

580 
°b•__uöt64
 
n64
;

581 #i‚de‡
STB_SPRINTF_NOFLOAT


582 
fv
;

584 
°b•__öt32
 
dp
;

585 c⁄° *
¢
;

589 
s
 = 
	`va_¨g
(
va
, *);

590 i‡(
s
 == 0)

591 
s
 = (*)"null";

594 
l
 = 
	`°b•__°æí_limôed
(
s
, (
¥
 >= 0) ?Ör : ~0u);

595 
Àad
[0] = 0;

596 
èû
[0] = 0;

597 
¥
 = 0;

598 
dp
 = 0;

599 
cs
 = 0;

601 
sc›y
;

605 
s
 = 
num
 + 
STBSP__NUMSZ
 - 1;

606 *
s
 = ()
	`va_¨g
(
va
, );

607 
l
 = 1;

608 
Àad
[0] = 0;

609 
èû
[0] = 0;

610 
¥
 = 0;

611 
dp
 = 0;

612 
cs
 = 0;

613 
sc›y
;

617 *
d
 = 
	`va_¨g
(
va
, *);

618 *
d
 = 
éí
 + ()(
bf
 - 
buf
);

621 #ifde‡
STB_SPRINTF_NOFLOAT


629 
	`va_¨g
(
va
, );

630 
s
 = (*)"No float";

631 
l
 = 8;

632 
Àad
[0] = 0;

633 
èû
[0] = 0;

634 
¥
 = 0;

635 
cs
 = 0;

636 
	`STBSP__NOTUSED
(
dp
);

637 
sc›y
;

641 
h
 = (
f
[0] ='A'Ë? 
hexu
 : 
hex
;

642 
fv
 = 
	`va_¨g
(
va
, );

643 i‡(
¥
 == -1)

644 
¥
 = 6;

646 i‡(
	`°b•__ªÆ_to_∑πs
((
°b•__öt64
 *)&
n64
, &
dp
, 
fv
))

647 
Ê
 |
STBSP__NEGATIVE
;

649 
s
 = 
num
 + 64;

651 
	`°b•__Àad_sign
(
Ê
, 
Àad
);

653 i‡(
dp
 == -1023)

654 
dp
 = (
n64
) ? -1022 : 0;

656 
n64
 |(((
°b•__uöt64
)1) << 52);

657 
n64
 <<= (64 - 56);

658 i‡(
¥
 < 15)

659 
n64
 +((((
°b•__uöt64
)8Ë<< 56Ë>> (
¥
 * 4));

662 #ifde‡
STB_SPRINTF_MSVC_MODE


663 *
s
++ = '0';

664 *
s
++ = 'x';

666 
Àad
[1 +Üead[0]] = '0';

667 
Àad
[2 +Üead[0]] = 'x';

668 
Àad
[0] += 2;

670 *
s
++ = 
h
[(
n64
 >> 60) & 15];

671 
n64
 <<= 4;

672 i‡(
¥
)

673 *
s
++ = 
°b•__≥riod
;

674 
¢
 = 
s
;

677 
n
 = 
¥
;

678 i‡(
n
 > 13)

679 
n
 = 13;

680 i‡(
¥
 > (
°b•__öt32
)
n
)

681 
tz
 = 
¥
 - 
n
;

682 
¥
 = 0;

683 
n
--) {

684 *
s
++ = 
h
[(
n64
 >> 60) & 15];

685 
n64
 <<= 4;

689 
èû
[1] = 
h
[17];

690 i‡(
dp
 < 0) {

691 
èû
[2] = '-';

692 
dp
 = -dp;

694 
èû
[2] = '+';

695 
n
 = (
dp
 >= 1000) ? 6 : ((dp >= 100) ? 5 : ((dp >= 10) ? 4 : 3));

696 
èû
[0] = ()
n
;

698 
èû
[
n
] = '0' + 
dp
 % 10;

699 i‡(
n
 <= 3)

701 --
n
;

702 
dp
 /= 10;

705 
dp
 = ()(
s
 - 
¢
);

706 
l
 = ()(
s
 - (
num
 + 64));

707 
s
 = 
num
 + 64;

708 
cs
 = 1 + (3 << 24);

709 
sc›y
;

713 
h
 = (
f
[0] ='G'Ë? 
hexu
 : 
hex
;

714 
fv
 = 
	`va_¨g
(
va
, );

715 i‡(
¥
 == -1)

716 
¥
 = 6;

717 i‡(
¥
 == 0)

718 
¥
 = 1;

720 i‡(
	`°b•__ªÆ_to_°r
(&
¢
, &
l
, 
num
, &
dp
, 
fv
, (
¥
 - 1) | 0x80000000))

721 
Ê
 |
STBSP__NEGATIVE
;

724 
n
 = 
¥
;

725 i‡(
l
 > (
°b•__uöt32
)
¥
)

726 
l
 = 
¥
;

727 (
l
 > 1Ë&& (
¥
Ë&& (
¢
[l - 1] == '0')) {

728 --
¥
;

729 --
l
;

733 i‡((
dp
 <-4Ë|| (d∞> (
°b•__öt32
)
n
)) {

734 i‡(
¥
 > (
°b•__öt32
)
l
)

735 
¥
 = 
l
 - 1;

736 i‡(
¥
)

737 --
¥
;

738 
d€xp‰omg
;

741 i‡(
dp
 > 0) {

742 
¥
 = (
dp
 < (
°b•__öt32
)
l
) ?Ü - dp : 0;

744 
¥
 = -
dp
 + (’∏> (
°b•__öt32
)
l
) ? (stbsp__int32)Ü :Ör);

746 
doÊﬂt‰omg
;

750 
h
 = (
f
[0] ='E'Ë? 
hexu
 : 
hex
;

751 
fv
 = 
	`va_¨g
(
va
, );

752 i‡(
¥
 == -1)

753 
¥
 = 6;

755 i‡(
	`°b•__ªÆ_to_°r
(&
¢
, &
l
, 
num
, &
dp
, 
fv
, 
¥
 | 0x80000000))

756 
Ê
 |
STBSP__NEGATIVE
;

757 
d€xp‰omg
:

758 
èû
[0] = 0;

759 
	`°b•__Àad_sign
(
Ê
, 
Àad
);

760 i‡(
dp
 =
STBSP__SPECIAL
) {

761 
s
 = (*)
¢
;

762 
cs
 = 0;

763 
¥
 = 0;

764 
sc›y
;

766 
s
 = 
num
 + 64;

768 *
s
++ = 
¢
[0];

770 i‡(
¥
)

771 *
s
++ = 
°b•__≥riod
;

774 i‡((
l
 - 1Ë> (
°b•__uöt32
)
¥
)

775 
l
 = 
¥
 + 1;

776 
n
 = 1;Ç < 
l
;Ç++)

777 *
s
++ = 
¢
[
n
];

779 
tz
 = 
¥
 - (
l
 - 1);

780 
¥
 = 0;

782 
èû
[1] = 
h
[0xe];

783 
dp
 -= 1;

784 i‡(
dp
 < 0) {

785 
èû
[2] = '-';

786 
dp
 = -dp;

788 
èû
[2] = '+';

789 #ifde‡
STB_SPRINTF_MSVC_MODE


790 
n
 = 5;

792 
n
 = (
dp
 >= 100) ? 5 : 4;

794 
èû
[0] = ()
n
;

796 
èû
[
n
] = '0' + 
dp
 % 10;

797 i‡(
n
 <= 3)

799 --
n
;

800 
dp
 /= 10;

802 
cs
 = 1 + (3 << 24);

803 
Êt_Àad
;

806 
fv
 = 
	`va_¨g
(
va
, );

807 
dﬂÊﬂt
:

809 i‡(
Ê
 & 
STBSP__METRIC_SUFFIX
) {

810 
divis‹
;

811 
divis‹
 = 1000.0f;

812 i‡(
Ê
 & 
STBSP__METRIC_1024
)

813 
divis‹
 = 1024.0;

814 
Ê
 < 0x4000000) {

815 i‡((
fv
 < 
divis‹
) && (fv > -divisor))

817 
fv
 /
divis‹
;

818 
Ê
 += 0x1000000;

821 i‡(
¥
 == -1)

822 
¥
 = 6;

824 i‡(
	`°b•__ªÆ_to_°r
(&
¢
, &
l
, 
num
, &
dp
, 
fv
, 
¥
))

825 
Ê
 |
STBSP__NEGATIVE
;

826 
doÊﬂt‰omg
:

827 
èû
[0] = 0;

828 
	`°b•__Àad_sign
(
Ê
, 
Àad
);

829 i‡(
dp
 =
STBSP__SPECIAL
) {

830 
s
 = (*)
¢
;

831 
cs
 = 0;

832 
¥
 = 0;

833 
sc›y
;

835 
s
 = 
num
 + 64;

838 i‡(
dp
 <= 0) {

839 
°b•__öt32
 
i
;

841 *
s
++ = '0';

842 i‡(
¥
)

843 *
s
++ = 
°b•__≥riod
;

844 
n
 = -
dp
;

845 i‡((
°b•__öt32
)
n
 > 
¥
)

846 
n
 = 
¥
;

847 
i
 = 
n
;

848 
i
) {

849 i‡((((
°b•__uöçå
)
s
) & 3) == 0)

851 *
s
++ = '0';

852 --
i
;

854 
i
 >= 4) {

855 *(
°b•__uöt32
 *)
s
 = 0x30303030;

856 
s
 += 4;

857 
i
 -= 4;

859 
i
) {

860 *
s
++ = '0';

861 --
i
;

863 i‡((
°b•__öt32
)(
l
 + 
n
Ë> 
¥
)

864 
l
 = 
¥
 - 
n
;

865 
i
 = 
l
;

866 
i
) {

867 *
s
++ = *
¢
++;

868 --
i
;

870 
tz
 = 
¥
 - (
n
 + 
l
);

871 
cs
 = 1 + (3 << 24);

873 
cs
 = (
Ê
 & 
STBSP__TRIPLET_COMMA
Ë? ((600 - (
°b•__uöt32
)
dp
) % 3) : 0;

874 i‡((
°b•__uöt32
)
dp
 >
l
) {

876 
n
 = 0;

878 i‡((
Ê
 & 
STBSP__TRIPLET_COMMA
Ë&& (++
cs
 == 4)) {

879 
cs
 = 0;

880 *
s
++ = 
°b•__comma
;

882 *
s
++ = 
¢
[
n
];

883 ++
n
;

884 i‡(
n
 >
l
)

888 i‡(
n
 < (
°b•__uöt32
)
dp
) {

889 
n
 = 
dp
 -Ç;

890 i‡((
Ê
 & 
STBSP__TRIPLET_COMMA
) == 0) {

891 
n
) {

892 i‡((((
°b•__uöçå
)
s
) & 3) == 0)

894 *
s
++ = '0';

895 --
n
;

897 
n
 >= 4) {

898 *(
°b•__uöt32
 *)
s
 = 0x30303030;

899 
s
 += 4;

900 
n
 -= 4;

903 
n
) {

904 i‡((
Ê
 & 
STBSP__TRIPLET_COMMA
Ë&& (++
cs
 == 4)) {

905 
cs
 = 0;

906 *
s
++ = 
°b•__comma
;

908 *
s
++ = '0';

909 --
n
;

913 
cs
 = ()(
s
 - (
num
 + 64)) + (3 << 24);

914 i‡(
¥
) {

915 *
s
++ = 
°b•__≥riod
;

916 
tz
 = 
¥
;

920 
n
 = 0;

922 i‡((
Ê
 & 
STBSP__TRIPLET_COMMA
Ë&& (++
cs
 == 4)) {

923 
cs
 = 0;

924 *
s
++ = 
°b•__comma
;

926 *
s
++ = 
¢
[
n
];

927 ++
n
;

928 i‡(
n
 >(
°b•__uöt32
)
dp
)

932 
cs
 = ()(
s
 - (
num
 + 64)) + (3 << 24);

933 i‡(
¥
)

934 *
s
++ = 
°b•__≥riod
;

935 i‡((
l
 - 
dp
Ë> (
°b•__uöt32
)
¥
)

936 
l
 = 
¥
 + 
dp
;

937 
n
 < 
l
) {

938 *
s
++ = 
¢
[
n
];

939 ++
n
;

941 
tz
 = 
¥
 - (
l
 - 
dp
);

944 
¥
 = 0;

947 i‡(
Ê
 & 
STBSP__METRIC_SUFFIX
) {

948 
idx
;

949 
idx
 = 1;

950 i‡(
Ê
 & 
STBSP__METRIC_NOSPACE
)

951 
idx
 = 0;

952 
èû
[0] = 
idx
;

953 
èû
[1] = ' ';

955 i‡(
Ê
 >> 24) {

956 i‡(
Ê
 & 
STBSP__METRIC_1024
)

957 
èû
[
idx
 + 1] = "_KMGT"[
Ê
 >> 24];

959 
èû
[
idx
 + 1] = "_kMGT"[
Ê
 >> 24];

960 
idx
++;

962 i‡(
Ê
 & 
STBSP__METRIC_1024
 && !(Ê & 
STBSP__METRIC_JEDEC
)) {

963 
èû
[
idx
 + 1] = 'i';

964 
idx
++;

966 
èû
[0] = 
idx
;

971 
Êt_Àad
:

973 
l
 = (
°b•__uöt32
)(
s
 - (
num
 + 64));

974 
s
 = 
num
 + 64;

975 
sc›y
;

980 
h
 = (
f
[0] ='B'Ë? 
hexu
 : 
hex
;

981 
Àad
[0] = 0;

982 i‡(
Ê
 & 
STBSP__LEADING_0X
) {

983 
Àad
[0] = 2;

984 
Àad
[1] = '0';

985 
Àad
[2] = 
h
[0xb];

987 
l
 = (8 << 4) | (1 << 8);

988 
ødixnum
;

991 
h
 = 
hexu
;

992 
Àad
[0] = 0;

993 i‡(
Ê
 & 
STBSP__LEADING_0X
) {

994 
Àad
[0] = 1;

995 
Àad
[1] = '0';

997 
l
 = (3 << 4) | (3 << 8);

998 
ødixnum
;

1001 
Ê
 |((*Ë=8Ë? 
STBSP__INTMAX
 : 0;

1002 
¥
 = (*) * 2;

1003 
Ê
 &~
STBSP__LEADINGZERO
;

1008 
h
 = (
f
[0] ='X'Ë? 
hexu
 : 
hex
;

1009 
l
 = (4 << 4) | (4 << 8);

1010 
Àad
[0] = 0;

1011 i‡(
Ê
 & 
STBSP__LEADING_0X
) {

1012 
Àad
[0] = 2;

1013 
Àad
[1] = '0';

1014 
Àad
[2] = 
h
[16];

1016 
ødixnum
:

1018 i‡(
Ê
 & 
STBSP__INTMAX
)

1019 
n64
 = 
	`va_¨g
(
va
, 
°b•__uöt64
);

1021 
n64
 = 
	`va_¨g
(
va
, 
°b•__uöt32
);

1023 
s
 = 
num
 + 
STBSP__NUMSZ
;

1024 
dp
 = 0;

1026 
èû
[0] = 0;

1027 i‡(
n64
 == 0) {

1028 
Àad
[0] = 0;

1029 i‡(
¥
 == 0) {

1030 
l
 = 0;

1031 
cs
 = 0;

1032 
sc›y
;

1037 *--
s
 = 
h
[
n64
 & ((1 << (
l
 >> 8)) - 1)];

1038 
n64
 >>(
l
 >> 8);

1039 i‡(!((
n64
Ë|| ((
°b•__öt32
)((
num
 + 
STBSP__NUMSZ
Ë- 
s
Ë< 
¥
)))

1041 i‡(
Ê
 & 
STBSP__TRIPLET_COMMA
) {

1042 ++
l
;

1043 i‡((
l
 & 15) == ((l >> 4) & 15)) {

1044 
l
 &= ~15;

1045 *--
s
 = 
°b•__comma
;

1050 
cs
 = (
°b•__uöt32
)((
num
 + 
STBSP__NUMSZ
Ë- 
s
Ë+ ((((
l
 >> 4) & 15)) << 24);

1052 
l
 = (
°b•__uöt32
)((
num
 + 
STBSP__NUMSZ
Ë- 
s
);

1054 
sc›y
;

1060 i‡(
Ê
 & 
STBSP__INTMAX
) {

1061 
°b•__öt64
 
i64
 = 
	`va_¨g
(
va
, stbsp__int64);

1062 
n64
 = (
°b•__uöt64
)
i64
;

1063 i‡((
f
[0] !'u'Ë&& (
i64
 < 0)) {

1064 
n64
 = (
°b•__uöt64
)-
i64
;

1065 
Ê
 |
STBSP__NEGATIVE
;

1068 
°b•__öt32
 
i
 = 
	`va_¨g
(
va
, stbsp__int32);

1069 
n64
 = (
°b•__uöt32
)
i
;

1070 i‡((
f
[0] !'u'Ë&& (
i
 < 0)) {

1071 
n64
 = (
°b•__uöt32
)-
i
;

1072 
Ê
 |
STBSP__NEGATIVE
;

1076 #i‚de‡
STB_SPRINTF_NOFLOAT


1077 i‡(
Ê
 & 
STBSP__METRIC_SUFFIX
) {

1078 i‡(
n64
 < 1024)

1079 
¥
 = 0;

1080 i‡(
¥
 == -1)

1081 
¥
 = 1;

1082 
fv
 = ()(
°b•__öt64
)
n64
;

1083 
dﬂÊﬂt
;

1088 
s
 = 
num
 + 
STBSP__NUMSZ
;

1089 
l
 = 0;

1093 *
o
 = 
s
 - 8;

1094 i‡(
n64
 >= 100000000) {

1095 
n
 = (
°b•__uöt32
)(
n64
 % 100000000);

1096 
n64
 /= 100000000;

1098 
n
 = (
°b•__uöt32
)
n64
;

1099 
n64
 = 0;

1101 i‡((
Ê
 & 
STBSP__TRIPLET_COMMA
) == 0) {

1103 
s
 -= 2;

1104 *(
°b•__uöt16
 *)
s
 = *(°b•__uöt16 *)&
°b•__digô∑ú
.
∑ú
[(
n
 % 100) * 2];

1105 
n
 /= 100;

1106 } 
n
);

1108 
n
) {

1109 i‡((
Ê
 & 
STBSP__TRIPLET_COMMA
Ë&& (
l
++ == 3)) {

1110 
l
 = 0;

1111 *--
s
 = 
°b•__comma
;

1112 --
o
;

1114 *--
s
 = ()(
n
 % 10) + '0';

1115 
n
 /= 10;

1118 i‡(
n64
 == 0) {

1119 i‡((
s
[0] ='0'Ë&& (†!(
num
 + 
STBSP__NUMSZ
)))

1120 ++
s
;

1123 
s
 !
o
)

1124 i‡((
Ê
 & 
STBSP__TRIPLET_COMMA
Ë&& (
l
++ == 3)) {

1125 
l
 = 0;

1126 *--
s
 = 
°b•__comma
;

1127 --
o
;

1129 *--
s
 = '0';

1133 
èû
[0] = 0;

1134 
	`°b•__Àad_sign
(
Ê
, 
Àad
);

1137 
l
 = (
°b•__uöt32
)((
num
 + 
STBSP__NUMSZ
Ë- 
s
);

1138 i‡(
l
 == 0) {

1139 *--
s
 = '0';

1140 
l
 = 1;

1142 
cs
 = 
l
 + (3 << 24);

1143 i‡(
¥
 < 0)

1144 
¥
 = 0;

1146 
sc›y
:

1148 i‡(
¥
 < (
°b•__öt32
)
l
)

1149 
¥
 = 
l
;

1150 
n
 = 
¥
 + 
Àad
[0] + 
èû
[0] + 
tz
;

1151 i‡(
fw
 < (
°b•__öt32
)
n
)

1152 
fw
 = 
n
;

1153 
fw
 -
n
;

1154 
¥
 -
l
;

1157 i‡((
Ê
 & 
STBSP__LEFTJUST
) == 0) {

1158 i‡(
Ê
 & 
STBSP__LEADINGZERO
)

1160 
¥
 = (
fw
 >Ör) ? fw :Ör;

1161 
fw
 = 0;

1163 
Ê
 &~
STBSP__TRIPLET_COMMA
;

1168 i‡(
fw
 + 
¥
) {

1169 
°b•__öt32
 
i
;

1170 
°b•__uöt32
 
c
;

1173 i‡((
Ê
 & 
STBSP__LEFTJUST
) == 0)

1174 
fw
 > 0) {

1175 
	`°b•__cb_buf_˛amp
(
i
, 
fw
);

1176 
fw
 -
i
;

1177 
i
) {

1178 i‡((((
°b•__uöçå
)
bf
) & 3) == 0)

1180 *
bf
++ = ' ';

1181 --
i
;

1183 
i
 >= 4) {

1184 *(
°b•__uöt32
 *)
bf
 = 0x20202020;

1185 
bf
 += 4;

1186 
i
 -= 4;

1188 
i
) {

1189 *
bf
++ = ' ';

1190 --
i
;

1192 
	`°b•__chk_cb_buf
(1);

1196 
¢
 = 
Àad
 + 1;

1197 
Àad
[0]) {

1198 
	`°b•__cb_buf_˛amp
(
i
, 
Àad
[0]);

1199 
Àad
[0] -()
i
;

1200 
i
) {

1201 *
bf
++ = *
¢
++;

1202 --
i
;

1204 
	`°b•__chk_cb_buf
(1);

1208 
c
 = 
cs
 >> 24;

1209 
cs
 &= 0xffffff;

1210 
cs
 = (
Ê
 & 
STBSP__TRIPLET_COMMA
Ë? ((
°b•__uöt32
)(
c
 - ((
¥
 + cs) % (c + 1)))) : 0;

1211 
¥
 > 0) {

1212 
	`°b•__cb_buf_˛amp
(
i
, 
¥
);

1213 
¥
 -
i
;

1214 i‡((
Ê
 & 
STBSP__TRIPLET_COMMA
) == 0) {

1215 
i
) {

1216 i‡((((
°b•__uöçå
)
bf
) & 3) == 0)

1218 *
bf
++ = '0';

1219 --
i
;

1221 
i
 >= 4) {

1222 *(
°b•__uöt32
 *)
bf
 = 0x30303030;

1223 
bf
 += 4;

1224 
i
 -= 4;

1227 
i
) {

1228 i‡((
Ê
 & 
STBSP__TRIPLET_COMMA
Ë&& (
cs
++ =
c
)) {

1229 
cs
 = 0;

1230 *
bf
++ = 
°b•__comma
;

1232 *
bf
++ = '0';

1233 --
i
;

1235 
	`°b•__chk_cb_buf
(1);

1240 
¢
 = 
Àad
 + 1;

1241 
Àad
[0]) {

1242 
°b•__öt32
 
i
;

1243 
	`°b•__cb_buf_˛amp
(
i
, 
Àad
[0]);

1244 
Àad
[0] -()
i
;

1245 
i
) {

1246 *
bf
++ = *
¢
++;

1247 --
i
;

1249 
	`°b•__chk_cb_buf
(1);

1253 
n
 = 
l
;

1254 
n
) {

1255 
°b•__öt32
 
i
;

1256 
	`°b•__cb_buf_˛amp
(
i
, 
n
);

1257 
n
 -
i
;

1258 
	`STBSP__UNALIGNED
(
i
 >= 4) {

1259 *(
°b•__uöt32
 vﬁ©ûê*)
bf
 = *(°b•__uöt32 vﬁ©ûê*)
s
;

1260 
bf
 += 4;

1261 
s
 += 4;

1262 
i
 -= 4;

1264 
i
) {

1265 *
bf
++ = *
s
++;

1266 --
i
;

1268 
	`°b•__chk_cb_buf
(1);

1272 
tz
) {

1273 
°b•__öt32
 
i
;

1274 
	`°b•__cb_buf_˛amp
(
i
, 
tz
);

1275 
tz
 -
i
;

1276 
i
) {

1277 i‡((((
°b•__uöçå
)
bf
) & 3) == 0)

1279 *
bf
++ = '0';

1280 --
i
;

1282 
i
 >= 4) {

1283 *(
°b•__uöt32
 *)
bf
 = 0x30303030;

1284 
bf
 += 4;

1285 
i
 -= 4;

1287 
i
) {

1288 *
bf
++ = '0';

1289 --
i
;

1291 
	`°b•__chk_cb_buf
(1);

1295 
¢
 = 
èû
 + 1;

1296 
èû
[0]) {

1297 
°b•__öt32
 
i
;

1298 
	`°b•__cb_buf_˛amp
(
i
, 
èû
[0]);

1299 
èû
[0] -()
i
;

1300 
i
) {

1301 *
bf
++ = *
¢
++;

1302 --
i
;

1304 
	`°b•__chk_cb_buf
(1);

1308 i‡(
Ê
 & 
STBSP__LEFTJUST
)

1309 i‡(
fw
 > 0) {

1310 
fw
) {

1311 
°b•__öt32
 
i
;

1312 
	`°b•__cb_buf_˛amp
(
i
, 
fw
);

1313 
fw
 -
i
;

1314 
i
) {

1315 i‡((((
°b•__uöçå
)
bf
) & 3) == 0)

1317 *
bf
++ = ' ';

1318 --
i
;

1320 
i
 >= 4) {

1321 *(
°b•__uöt32
 *)
bf
 = 0x20202020;

1322 
bf
 += 4;

1323 
i
 -= 4;

1325 
i
--)

1326 *
bf
++ = ' ';

1327 
	`°b•__chk_cb_buf
(1);

1333 
s
 = 
num
 + 
STBSP__NUMSZ
 - 1;

1334 *
s
 = 
f
[0];

1335 
l
 = 1;

1336 
fw
 = 
Ê
 = 0;

1337 
Àad
[0] = 0;

1338 
èû
[0] = 0;

1339 
¥
 = 0;

1340 
dp
 = 0;

1341 
cs
 = 0;

1342 
sc›y
;

1344 ++
f
;

1346 
ídfmt
:

1348 i‡(!
ˇŒback
)

1349 *
bf
 = 0;

1351 
	`°b•__Êush_cb
();

1353 
d⁄e
:

1354  
éí
 + ()(
bf
 - 
buf
);

1355 
	}
}

1358 #unde‡
STBSP__LEFTJUST


1359 #unde‡
STBSP__LEADINGPLUS


1360 #unde‡
STBSP__LEADINGSPACE


1361 #unde‡
STBSP__LEADING_0X


1362 #unde‡
STBSP__LEADINGZERO


1363 #unde‡
STBSP__INTMAX


1364 #unde‡
STBSP__TRIPLET_COMMA


1365 #unde‡
STBSP__NEGATIVE


1366 #unde‡
STBSP__METRIC_SUFFIX


1367 #unde‡
STBSP__NUMSZ


1368 #unde‡
°b•__chk_cb_bufL


1369 #unde‡
°b•__chk_cb_buf


1370 #unde‡
°b•__Êush_cb


1371 #unde‡
°b•__cb_buf_˛amp


1376 
STBSP__PUBLICDEF
 
	$STB_SPRINTF_DECORATE
(
•rötf
)(*
buf
, c⁄° *
fmt
, ...)

1378 
ªsu…
;

1379 
va_li°
 
va
;

1380 
	`va_°¨t
(
va
, 
fmt
);

1381 
ªsu…
 = 
	`STB_SPRINTF_DECORATE
(
v•rötfcb
)(0, 0, 
buf
, 
fmt
, 
va
);

1382 
	`va_íd
(
va
);

1383  
ªsu…
;

1384 
	}
}

1386 
	s°b•__c⁄ãxt
 {

1387 *
	mbuf
;

1388 
	mcou¡
;

1389 
	mÀngth
;

1390 
	mtmp
[
STB_SPRINTF_MIN
];

1391 } 
	t°b•__c⁄ãxt
;

1393 *
	$°b•__˛amp_ˇŒback
(c⁄° *
buf
, *
u£r
, 
Àn
)

1395 
°b•__c⁄ãxt
 *
c
 = (°b•__c⁄ãxà*)
u£r
;

1396 
c
->
Àngth
 +
Àn
;

1398 i‡(
Àn
 > 
c
->
cou¡
)

1399 
Àn
 = 
c
->
cou¡
;

1401 i‡(
Àn
) {

1402 i‡(
buf
 !
c
->buf) {

1403 c⁄° *
s
, *
£
;

1404 *
d
;

1405 
d
 = 
c
->
buf
;

1406 
s
 = 
buf
;

1407 
£
 = 
buf
 + 
Àn
;

1409 *
d
++ = *
s
++;

1410 } 
s
 < 
£
);

1412 
c
->
buf
 +
Àn
;

1413 
c
->
cou¡
 -
Àn
;

1416 i‡(
c
->
cou¡
 <= 0)

1417  
c
->
tmp
;

1418  (
c
->
cou¡
 >
STB_SPRINTF_MIN
Ë? c->
buf
 : c->
tmp
;

1419 
	}
}

1421 * 
	$°b•__cou¡_˛amp_ˇŒback
–c⁄° * 
buf
, * 
u£r
, 
Àn
 )

1423 
°b•__c⁄ãxt
 * 
c
 = (°b•__c⁄ãxt*)
u£r
;

1424 (Ë(
buf
);

1426 
c
->
Àngth
 +
Àn
;

1427  
c
->
tmp
;

1428 
	}
}

1430 
STBSP__PUBLICDEF
 
	$STB_SPRINTF_DECORATE
–
v¢¥ötf
 )–* 
buf
, 
cou¡
, c⁄° * 
fmt
, 
va_li°
 
va
 )

1432 
°b•__c⁄ãxt
 
c
;

1434 i‡–(
cou¡
 =0Ë&& !
buf
 )

1436 
c
.
Àngth
 = 0;

1438 
	`STB_SPRINTF_DECORATE
–
v•rötfcb
 )–
°b•__cou¡_˛amp_ˇŒback
, &
c
, c.
tmp
, 
fmt
, 
va
 );

1442 
l
;

1444 
c
.
buf
 = buf;

1445 
c
.
cou¡
 = count;

1446 
c
.
Àngth
 = 0;

1448 
	`STB_SPRINTF_DECORATE
–
v•rötfcb
 )–
°b•__˛amp_ˇŒback
, &
c
, 
	`°b•__˛amp_ˇŒback
(0,&c,0), 
fmt
, 
va
 );

1451 
l
 = ()–
c
.
buf
 - buf );

1452 i‡–
l
 >
cou¡
 )

1453 
l
 = 
cou¡
 - 1;

1454 
buf
[
l
] = 0;

1457  
c
.
Àngth
;

1458 
	}
}

1460 
STBSP__PUBLICDEF
 
	$STB_SPRINTF_DECORATE
(
¢¥ötf
)(*
buf
, 
cou¡
, c⁄° *
fmt
, ...)

1462 
ªsu…
;

1463 
va_li°
 
va
;

1464 
	`va_°¨t
(
va
, 
fmt
);

1466 
ªsu…
 = 
	`STB_SPRINTF_DECORATE
(
v¢¥ötf
)(
buf
, 
cou¡
, 
fmt
, 
va
);

1467 
	`va_íd
(
va
);

1469  
ªsu…
;

1470 
	}
}

1472 
STBSP__PUBLICDEF
 
	$STB_SPRINTF_DECORATE
(
v•rötf
)(*
buf
, c⁄° *
fmt
, 
va_li°
 
va
)

1474  
	`STB_SPRINTF_DECORATE
(
v•rötfcb
)(0, 0, 
buf
, 
fmt
, 
va
);

1475 
	}
}

1480 #i‚de‡
STB_SPRINTF_NOFLOAT


1483 
	#STBSP__COPYFP
(
de°
, 
§c
) \

1485 
˙
; \

1486 
˙
 = 0; cn < 8; cn++) \

1487 ((*)&
de°
)[
˙
] = ((*)&
§c
)[cn]; \

1488 }

	)

1491 
°b•__öt32
 
	$°b•__ªÆ_to_∑πs
(
°b•__öt64
 *
bôs
, 
°b•__öt32
 *
expo
, 
vÆue
)

1493 
d
;

1494 
°b•__öt64
 
b
 = 0;

1497 
d
 = 
vÆue
;

1499 
	`STBSP__COPYFP
(
b
, 
d
);

1501 *
bôs
 = 
b
 & ((((
°b•__uöt64
)1) << 52) - 1);

1502 *
expo
 = (
°b•__öt32
)(((
b
 >> 52) & 2047) - 1023);

1504  (
°b•__öt32
)((
°b•__uöt64
Ë
b
 >> 63);

1505 
	}
}

1507 c⁄° 
	g°b•__bŸ
[23] = {

1511 c⁄° 
	g°b•__√gbŸ
[22] = {

1515 c⁄° 
	g°b•__√gbŸîr
[22] = {

1521 c⁄° 
	g°b•__t›
[13] = {

1524 c⁄° 
	g°b•__√gt›
[13] = {

1527 c⁄° 
	g°b•__t›îr
[13] = {

1542 c⁄° 
	g°b•__√gt›îr
[13] = {

1549 #i‡
deföed
(
_MSC_VER
) && (_MSC_VER <= 1200)

1550 
°b•__uöt64
 c⁄° 
	g°b•__powãn
[20] = {

1572 
	#°b•__ã¡o19th
 ((
°b•__uöt64
)1000000000000000000)

	)

1574 
°b•__uöt64
 c⁄° 
	g°b•__powãn
[20] = {

1596 
	#°b•__ã¡o19th
 (1000000000000000000ULL)

	)

1599 
	#°b•__ddmu…hi
(
oh
, 
ﬁ
, 
xh
, 
yh
) \

1601 
ahi
 = 0, 
Æo
, 
bhi
 = 0, 
blo
; \

1602 
°b•__öt64
 
bt
; \

1603 
oh
 = 
xh
 * 
yh
; \

1604 
	`STBSP__COPYFP
(
bt
, 
xh
); \

1605 
bt
 &((~(
°b•__uöt64
)0) << 27); \

1606 
	`STBSP__COPYFP
(
ahi
, 
bt
); \

1607 
Æo
 = 
xh
 - 
ahi
; \

1608 
	`STBSP__COPYFP
(
bt
, 
yh
); \

1609 
bt
 &((~(
°b•__uöt64
)0) << 27); \

1610 
	`STBSP__COPYFP
(
bhi
, 
bt
); \

1611 
blo
 = 
yh
 - 
bhi
; \

1612 
ﬁ
 = ((
ahi
 * 
bhi
 - 
oh
Ë+áhò* 
blo
 + 
Æo
 * bhi) +álo * blo; \

1613 }

	)

1615 
	#°b•__ddtoS64
(
ob
, 
xh
, 
xl
) \

1617 
ahi
 = 0, 
Æo
, 
vh
, 
t
; \

1618 
ob
 = (
°b•__öt64
)
xh
; \

1619 
vh
 = ()
ob
; \

1620 
ahi
 = (
xh
 - 
vh
); \

1621 
t
 = (
ahi
 - 
xh
); \

1622 
Æo
 = (
xh
 - (
ahi
 - 
t
)Ë- (
vh
 +Å); \

1623 
ob
 +(
°b•__öt64
)(
ahi
 + 
Æo
 + 
xl
); \

1624 }

	)

1626 
	#°b•__ddªn‹m
(
oh
, 
ﬁ
) \

1628 
s
; \

1629 
s
 = 
oh
 + 
ﬁ
; \

1630 
ﬁ
 = o»- (
s
 - 
oh
); \

1631 
oh
 = 
s
; \

1632 }

	)

1634 
	#°b•__ddmu…lo
(
oh
, 
ﬁ
, 
xh
, 
xl
, 
yh
, 
yl
Ëﬁ = o»+ (xh * y»+ x»* yh);

	)

1636 
	#°b•__ddmu…los
(
oh
, 
ﬁ
, 
xh
, 
yl
Ëﬁ = o»+ (xh * yl);

	)

1638 
	$°b•__øi£_to_powî10
(*
ohi
, *
ﬁo
, 
d
, 
°b•__öt32
 
powî
)

1640 
ph
, 
∂
;

1641 i‡((
powî
 >= 0) && (power <= 22)) {

1642 
	`°b•__ddmu…hi
(
ph
, 
∂
, 
d
, 
°b•__bŸ
[
powî
]);

1644 
°b•__öt32
 
e
, 
ë
, 
eb
;

1645 
p2h
, 
p2l
;

1647 
e
 = 
powî
;

1648 i‡(
powî
 < 0)

1649 
e
 = -e;

1650 
ë
 = (
e
 * 0x2c9) >> 14;

1651 i‡(
ë
 > 13)

1652 
ë
 = 13;

1653 
eb
 = 
e
 - (
ë
 * 23);

1655 
ph
 = 
d
;

1656 
∂
 = 0.0;

1657 i‡(
powî
 < 0) {

1658 i‡(
eb
) {

1659 --
eb
;

1660 
	`°b•__ddmu…hi
(
ph
, 
∂
, 
d
, 
°b•__√gbŸ
[
eb
]);

1661 
	`°b•__ddmu…los
(
ph
, 
∂
, 
d
, 
°b•__√gbŸîr
[
eb
]);

1663 i‡(
ë
) {

1664 
	`°b•__ddªn‹m
(
ph
, 
∂
);

1665 --
ë
;

1666 
	`°b•__ddmu…hi
(
p2h
, 
p2l
, 
ph
, 
°b•__√gt›
[
ë
]);

1667 
	`°b•__ddmu…lo
(
p2h
, 
p2l
, 
ph
, 
∂
, 
°b•__√gt›
[
ë
], 
°b•__√gt›îr
[et]);

1668 
ph
 = 
p2h
;

1669 
∂
 = 
p2l
;

1672 i‡(
eb
) {

1673 
e
 = 
eb
;

1674 i‡(
eb
 > 22)

1675 
eb
 = 22;

1676 
e
 -
eb
;

1677 
	`°b•__ddmu…hi
(
ph
, 
∂
, 
d
, 
°b•__bŸ
[
eb
]);

1678 i‡(
e
) {

1679 
	`°b•__ddªn‹m
(
ph
, 
∂
);

1680 
	`°b•__ddmu…hi
(
p2h
, 
p2l
, 
ph
, 
°b•__bŸ
[
e
]);

1681 
	`°b•__ddmu…los
(
p2h
, 
p2l
, 
°b•__bŸ
[
e
], 
∂
);

1682 
ph
 = 
p2h
;

1683 
∂
 = 
p2l
;

1686 i‡(
ë
) {

1687 
	`°b•__ddªn‹m
(
ph
, 
∂
);

1688 --
ë
;

1689 
	`°b•__ddmu…hi
(
p2h
, 
p2l
, 
ph
, 
°b•__t›
[
ë
]);

1690 
	`°b•__ddmu…lo
(
p2h
, 
p2l
, 
ph
, 
∂
, 
°b•__t›
[
ë
], 
°b•__t›îr
[et]);

1691 
ph
 = 
p2h
;

1692 
∂
 = 
p2l
;

1696 
	`°b•__ddªn‹m
(
ph
, 
∂
);

1697 *
ohi
 = 
ph
;

1698 *
ﬁo
 = 
∂
;

1699 
	}
}

1705 
°b•__öt32
 
	$°b•__ªÆ_to_°r
(c⁄° **
°¨t
, 
°b•__uöt32
 *
Àn
, *
out
, 
°b•__öt32
 *
decimÆ_pos
, 
vÆue
, stb•__uöt32 
‰ac_digôs
)

1707 
d
;

1708 
°b•__öt64
 
bôs
 = 0;

1709 
°b•__öt32
 
expo
, 
e
, 
ng
, 
ãns
;

1711 
d
 = 
vÆue
;

1712 
	`STBSP__COPYFP
(
bôs
, 
d
);

1713 
expo
 = (
°b•__öt32
)((
bôs
 >> 52) & 2047);

1714 
ng
 = (
°b•__öt32
)((
°b•__uöt64
Ë
bôs
 >> 63);

1715 i‡(
ng
)

1716 
d
 = -d;

1718 i‡(
expo
 == 2047)

1720 *
°¨t
 = (
bôs
 & ((((
°b•__uöt64
)1) << 52) - 1)) ? "NaN" : "Inf";

1721 *
decimÆ_pos
 = 
STBSP__SPECIAL
;

1722 *
Àn
 = 3;

1723  
ng
;

1726 i‡(
expo
 == 0)

1728 i‡(((
°b•__uöt64
Ë
bôs
 << 1) == 0)

1730 *
decimÆ_pos
 = 1;

1731 *
°¨t
 = 
out
;

1732 
out
[0] = '0';

1733 *
Àn
 = 1;

1734  
ng
;

1738 
°b•__öt64
 
v
 = ((
°b•__uöt64
)1) << 51;

1739 (
bôs
 & 
v
) == 0) {

1740 --
expo
;

1741 
v
 >>= 1;

1748 
ph
, 
∂
;

1751 
ãns
 = 
expo
 - 1023;

1752 
ãns
 = (tens < 0) ? ((tens * 617) / 2048) : (((tens * 1233) / 4096) + 1);

1755 
	`°b•__øi£_to_powî10
(&
ph
, &
∂
, 
d
, 18 - 
ãns
);

1758 
	`°b•__ddtoS64
(
bôs
, 
ph
, 
∂
);

1761 i‡(((
°b•__uöt64
)
bôs
Ë>
°b•__ã¡o19th
)

1762 ++
ãns
;

1766 
‰ac_digôs
 = (‰ac_digô†& 0x80000000Ë? ((‰ac_digô†& 0x7ffffffË+ 1Ë: (
ãns
 + frac_digits);

1767 i‡((
‰ac_digôs
 < 24)) {

1768 
°b•__uöt32
 
dg
 = 1;

1769 i‡((
°b•__uöt64
)
bôs
 >
°b•__powãn
[9])

1770 
dg
 = 10;

1771 (
°b•__uöt64
)
bôs
 >
°b•__powãn
[
dg
]) {

1772 ++
dg
;

1773 i‡(
dg
 == 20)

1774 
n‹ound
;

1776 i‡(
‰ac_digôs
 < 
dg
) {

1777 
°b•__uöt64
 
r
;

1779 
e
 = 
dg
 - 
‰ac_digôs
;

1780 i‡((
°b•__uöt32
)
e
 >= 24)

1781 
n‹ound
;

1782 
r
 = 
°b•__powãn
[
e
];

1783 
bôs
 = bô†+ (
r
 / 2);

1784 i‡((
°b•__uöt64
)
bôs
 >
°b•__powãn
[
dg
])

1785 ++
ãns
;

1786 
bôs
 /
r
;

1788 
n‹ound
:;

1792 i‡(
bôs
) {

1793 
°b•__uöt32
 
n
;

1795 i‡(
bôs
 <= 0xffffffff)

1797 i‡(
bôs
 % 1000)

1798 
d⁄ez
;

1799 
bôs
 /= 1000;

1801 
n
 = (
°b•__uöt32
)
bôs
;

1802 (
n
 % 1000) == 0)

1803 
n
 /= 1000;

1804 
bôs
 = 
n
;

1805 
d⁄ez
:;

1809 
out
 += 64;

1810 
e
 = 0;

1812 
°b•__uöt32
 
n
;

1813 *
o
 = 
out
 - 8;

1815 i‡(
bôs
 >= 100000000) {

1816 
n
 = (
°b•__uöt32
)(
bôs
 % 100000000);

1817 
bôs
 /= 100000000;

1819 
n
 = (
°b•__uöt32
)
bôs
;

1820 
bôs
 = 0;

1822 
n
) {

1823 
out
 -= 2;

1824 *(
°b•__uöt16
 *)
out
 = *(°b•__uöt16 *)&
°b•__digô∑ú
.
∑ú
[(
n
 % 100) * 2];

1825 
n
 /= 100;

1826 
e
 += 2;

1828 i‡(
bôs
 == 0) {

1829 i‡((
e
Ë&& (
out
[0] == '0')) {

1830 ++
out
;

1831 --
e
;

1835 
out
 !
o
) {

1836 *--
out
 = '0';

1837 ++
e
;

1841 *
decimÆ_pos
 = 
ãns
;

1842 *
°¨t
 = 
out
;

1843 *
Àn
 = 
e
;

1844  
ng
;

1845 
	}
}

1847 #unde‡
°b•__ddmu…hi


1848 #unde‡
°b•__ddªn‹m


1849 #unde‡
°b•__ddmu…lo


1850 #unde‡
°b•__ddmu…los


1851 #unde‡
STBSP__SPECIAL


1852 #unde‡
STBSP__COPYFP


1857 #unde‡
°b•__uöt16


1858 #unde‡
°b•__uöt32


1859 #unde‡
°b•__öt32


1860 #unde‡
°b•__uöt64


1861 #unde‡
°b•__öt64


1862 #unde‡
STBSP__UNALIGNED


	@math.h

1 
	~<m©h.h
>

3 
	#Abs
(
a
Ë(◊Ë> 0 ? (aË: -◊))

	)

4 
	#Mod
(
a
, 
m
Ë((◊Ë% (m)Ë>0 ? (◊Ë% (m)Ë: ((◊Ë% (m)Ë+ (m)))

	)

6 
	$DegToRad
(
degªes
Ë{  degªe†* (
PI32
/180.0f); 
	}
}

7 
	$RadToDeg
(
ødüns
Ë{ Ñadün†* (180/
PI32
); 
	}
}

8 
	$InR™ge
(
vÆ
, 
mö
, 
max
Ë{  (vÆ > möË&& (vÆ < max); 
	}
}

9 
	$InR™geMöInc
(
vÆ
, 
mö
, 
max
Ë{  (vÆ >möË&& (vÆ < max); 
	}
}

10 
	$InR™geMaxInc
(
vÆ
, 
mö
, 
max
Ë{  (vÆ > möË&& (vÆ <max); 
	}
}

11 
	$InR™geMöMaxInc
(
vÆ
, 
mö
, 
max
Ë{  (vÆ >möË&& (vÆ <max); 
	}
}

14 
	sVec2u
 {

17 
u32
 
	mx
;

18 
u32
 
	my
;

20 
u32
 
	mñem
[2];

24 
	sVec2
 {

27 
	mx
;

28 
	my
;

30 
	mñem
[2];

34 
	sVec3
 {

37 
	mx
;

38 
	my
;

39 
	mz
;

41 
	mñem
[3];

45 
	sVec4
 {

48 
	mx
;

49 
	my
;

50 
	mz
;

51 
	mw
;

54 
Vec3
 
	mxyz
;

55 
	mz
;

57 
	mñem
[4];

61 
	sQu©
 {

64 
	mx
, 
	my
, 
	mz
, 
	mw
;

67 
Vec3
 
	mxyz
;

68 
	mz
;

70 
	mñem
[4];

75 
	sM©4
 {

76 
	mñem
[4][4];

79 
	sTønsf‹m
 {

80 
Vec3
 
	mposôi⁄
;

81 
Qu©
 
	mrŸ©i⁄
;

82 
Vec3
 
	msˇÀ
;

86 
Vec2
 
	$V2
(
x
, 
y
Ë{  
Vec2
 { x, y }; 
	}
}

87 
Vec2
 
	$V2I
(Ë{  
Vec2
 { 1.0f, 1.0‡}; 
	}
}

88 
Vec2
 
	$V2Z
(Ë{  
Vec2
 { 0.0f, 0.0‡}; 
	}
}

90 
Vec3
 
	$V3
(
x
, 
y
, 
z
Ë{  
Vec3
 { x, y, z }; 
	}
}

91 
Vec3
 
	$V3I
(Ë{  
Vec3
 { 1.0f, 1.0f, 1.0‡}; 
	}
}

92 
Vec3
 
	$V3Z
(Ë{  
Vec3
 { 0.0f, 0.0f, 0.0‡}; 
	}
}

93 
Vec3
 
	$V3Up
(Ë{  
Vec3
 { 0.0f, 1.0f, 0.0‡}; 
	}
}

94 
Vec3
 
	$V3Right
(Ë{  
Vec3
 { 1.0f, 0.0f, 0.0‡}; 
	}
}

95 
Vec3
 
	$V3F‹w¨d
(Ë{  
Vec3
 { 0.0f, 0.0f, 1.0‡}; 
	}
}

97 
Vec4
 
	$V4
(
x
, 
y
, 
z
, 
w
Ë{  
Vec4
 { x, y, z, w }; 
	}
}

98 
Vec4
 
	$V4FromV3
(
Vec3
 
xyz
, 
w
Ë{  
Vec4
 { xyz.
x
, xyz.
y
, xyz.
z
, w }; 
	}
}

99 
Vec4
 
	$V4I
(Ë{  
Vec4
 { 1.0f, 1.0f, 1.0f, 1.0‡}; 
	}
}

100 
Vec4
 
	$V4Z
(Ë{  
Vec4
 { 0.0f, 0.0f, 0.0f, 0.0‡}; 
	}
}

102 
Qu©
 
	$MakeQu©
(
x
, 
y
, 
z
, 
w
Ë{  
Qu©
 { x, y, z, w}; 
	}
}

103 
Qu©
 
	$MakeQu©FromV3
(
Vec3
 
vec
Ë{  
Qu©
 { vec.
x
, vec.
y
, vec.
z
, 1 }; 
	}
}

104 
Qu©
 
	$MakeQu©FromV4
(
Vec4
 
vec
Ë{  
Qu©
 { vec.
x
, vec.
y
, vec.
z
, vec.
w
 }; 
	}
}

105 
Qu©
 
	$Qu©I
(Ë{  
Qu©
 { 0.0f, 0.0f, 0.0f, 1.0‡}; 
	}
}

107 
	#BLACK
 
	`V3
(0.0f, 0.0f, 0.0f)

	)

108 
	#WHITE
 
	`V3
(1.0f, 1.0f, 1.0f)

	)

109 
	#GREY
 
	`V3
(0.5f, 0.5f, 0.5f)

	)

110 
	#SILVER
 
	`V3
(0.75f, 0.75f, 0.75f)

	)

112 
	#BLUE
 
	`V3
(0.0f, 0.0f, 1.0f)

	)

113 
	#CYAN
 
	`V3
(0.0f, 1.0f, 1.0f)

	)

114 
	#TEAL
 
	`V3
(0.0f, 0.5f, 0.5f)

	)

116 
	#RED
 
	`V3
(1.0f, 0.0f, 0.0f)

	)

117 
	#MAROON
 
	`V3
(0.5f, 0.0f, 0.0f)

	)

118 
	#CRIMSON
 
	`V3
(0.8f, 0.1f, 0.2f)

	)

120 
	#LIME
 
	`V3
(0.0f, 1.0f, 0.0f)

	)

121 
	#GREEN
 
	`V3
(0.0f, 0.5f, 0.0f)

	)

123 
	#OLIVE
 
	`V3
(0.5f, 0.5f, 0.0f)

	)

124 
	#YELLOW
 
	`V3
(1.0f, 1.0f, 0.0f)

	)

125 
	#ORANGE
 
	`V3
(1.0f, 0.6f, 0.0f)

	)

127 
	#MAGENTA
 
	`V3
(1.0f, 0.0f, 1.0f)

	)

128 
	#PURPLE
 
	`V3
(0.5f, 0.0f, 0.5f)

	)

130 
Tønsf‹m
 
	$Tønsf‹mI
(Ë{  
Tønsf‹m
 { 
	`V3Z
(), 
	`Qu©I
(), 
	`V3I
(Ë}; 
	}
}

132 
Vec2
 
	$V2Add
(
Vec2
 
À·
, Vec2 
right
) {

133  
Vec2
 { 
À·
.
x
 + 
right
.x,Üe·.
y
 +Ñight.y };

134 
	}
}

135 
Vec2
 
	$V2Sub
(
Vec2
 
À·
, Vec2 
right
) {

136  
Vec2
 { 
À·
.
x
 - 
right
.x,Üe·.
y
 -Ñight.y };

137 
	}
}

138 
Vec2
 
	$V2Mul
(
Vec2
 
À·
, Vec2 
right
) {

139  
Vec2
 { 
À·
.
x
 * 
right
.x,Üe·.
y
 *Ñight.y };

140 
	}
}

141 
Vec2
 
	$V2Div
(
Vec2
 
À·
, Vec2 
right
) {

142  
Vec2
 { 
À·
.
x
/
right
.x,Üe·.
y
/right.y };

143 
	}
}

144 
Vec2
 
	$V2AddF
(
Vec2
 
À·
, 
sˇœr
) {

145  
Vec2
 { 
À·
.
x
 + 
sˇœr
,Üe·.
y
 + scalar };

146 
	}
}

147 
Vec2
 
	$V2SubF
(
Vec2
 
À·
, 
sˇœr
) {

148  
Vec2
 { 
À·
.
x
 - 
sˇœr
,Üe·.
y
 - scalar };

149 
	}
}

150 
Vec2
 
	$V2MulF
(
Vec2
 
À·
, 
sˇœr
) {

151  
Vec2
 { 
À·
.
x
*
sˇœr
,Üe·.
y
*scalar };

152 
	}
}

153 
Vec2
 
	$V2DivF
(
Vec2
 
À·
, 
sˇœr
) {

154  
Vec2
 { 
À·
.
x
/
sˇœr
,Üe·.
y
/scalar };

155 
	}
}

156 
	$V2DŸ
(
Vec2
 
À·
, Vec2 
right
) {

157  
À·
.
x
*
right
.x +Üe·.
y
*right.y;

158 
	}
}

160 
Vec3
 
	$V3Add
(
Vec3
 
À·
, Vec3 
right
) {

161  
Vec3
 { 
À·
.
x
 + 
right
.x,Üe·.
y
 +Ñight.y,Üe·.
z
 +Ñight.z };

162 
	}
}

163 
Vec3
 
	$V3Sub
(
Vec3
 
À·
, Vec3 
right
) {

164  
Vec3
 { 
À·
.
x
 - 
right
.x,Üe·.
y
 -Ñight.y,Üe·.
z
 -Ñight.z };

165 
	}
}

166 
Vec3
 
	$V3Mul
(
Vec3
 
À·
, Vec3 
right
) {

167  
Vec3
 { 
À·
.
x
 * 
right
.x,Üe·.
y
 *Ñight.y,Üe·.
z
 *Ñight.z };

168 
	}
}

169 
Vec3
 
	$V3Div
(
Vec3
 
À·
, Vec3 
right
) {

170  
Vec3
 { 
À·
.
x
 / 
right
.x,Üe·.
y
 /Ñight.y,Üe·.
z
 /Ñight.z };

171 
	}
}

172 
Vec3
 
	$V3AddF
(
Vec3
 
À·
, 
sˇœr
) {

173  
Vec3
 { 
À·
.
x
 + 
sˇœr
,Üe·.
y
 + sˇœr,Üe·.
z
 + scalar };

174 
	}
}

175 
Vec3
 
	$V3SubF
(
Vec3
 
À·
, 
sˇœr
) {

176  
Vec3
 { 
À·
.
x
 - 
sˇœr
,Üe·.
y
 - sˇœr,Üe·.
z
 - scalar };

177 
	}
}

178 
Vec3
 
	$V3MulF
(
Vec3
 
À·
, 
sˇœr
) {

179  
Vec3
 { 
À·
.
x
*
sˇœr
,Üe·.
y
*sˇœr,Üe·.
z
*scalar };

180 
	}
}

181 
Vec3
 
	$V3DivF
(
Vec3
 
À·
, 
sˇœr
) {

182  
Vec3
 { 
À·
.
x
/
sˇœr
,Üe·.
y
/sˇœr,Üe·.
z
/scalar };

183 
	}
}

184 
boﬁ
 
	$Vec3EquÆs
(
Vec3
 
À·
, Vec3 
right
) {

185  (
À·
.
x
 =
right
.xË&& (À·.
y
 =right.yË&& (À·.
z
 ==Ñight.z);

186 
	}
}

187 
	$V3MagSqu¨ed
(
Vec3
 
vec
) {

188  (
vec
.
x
*vec.xË+ (vec.
y
*vec.yË+ (vec.
z
*vec.z);

189 
	}
}

190 
Vec3
 
	$V3Neg
(
Vec3
 
vec
Ë{  
	`V3Sub
(
	`V3Z
(), vec); 
	}
}

192 
	$V3Mag
(
Vec3
 
vec
) {

193  
	`sqπf
(
	`V3MagSqu¨ed
(
vec
));

194 
	}
}

195 
Vec3
 
	$V3N‹m
(
Vec3
 
vec
) {

196 
Vec3
 
ªsu…
 = {};

197 
mag
 = 
	`V3Mag
(
vec
);

198 if(
mag
) {

199 
ªsu…
.
x
 = 
vec
.x * (1.0‡/ 
mag
);

200 
ªsu…
.
y
 = 
vec
.y * (1.0‡/ 
mag
);

201 
ªsu…
.
z
 = 
vec
.z * (1.0‡/ 
mag
);

203  
ªsu…
;

204 
	}
}

205 
Vec3
 
	$V3Cross
(
Vec3
 
À·
, Vec3 
right
) {

206  
Vec3
 { (
À·
.
y
*
right
.
z
) - (left.z*right.y),

207 (
À·
.
z
*
right
.
x
) - (left.x*right.z),

208 (
À·
.
x
*
right
.
y
) - (left.y*right.x) };

209 
	}
}

210 
	$V3DŸ
(
Vec3
 
À·
, Vec3 
right
) {

211  
À·
.
x
*
right
.x +Üe·.
y
*right.y +Üe·.
z
*right.z;

212 
	}
}

214 
M©4
 
	$M4I
() {

215  
M©4
 { 1.0f, 0.0f, 0.0f, 0.0f,

219 
	}
}

221 
M©4
 
	$M4Tøn•o£
(
M©4
 
m©
) {

222 
M©4
 
ªsu…
 = 
	`M4I
();

223 
u8
 
cﬁ
=0; col<4; col++)

224 
u8
 
row
=0;Ñow<4;Ñow++)

225 
ªsu…
.
ñem
[
cﬁ
][
row
] = 
m©
.elem[row][col];

226  
ªsu…
;

227 
	}
}

229 
M©4
 
	$M4Mul
(
M©4
 
À·
, M©4 
right
) {

230 
M©4
 
ªsu…
 = 
	`M4I
();

231 
u8
 
cﬁ
 = 0; col < 4; col++) {

232 
u8
 
row
 = 0;Ñow < 4;Ñow++) {

233 
sum
 = 0;

234 
u8
 
k
 = 0; k < 4; k++Ë
sum
 +
À·
.
ñem
[k][
row
] * 
right
.ñem[
cﬁ
][k];

235 
ªsu…
.
ñem
[
cﬁ
][
row
] = 
sum
;

238  
ªsu…
;

239 
	}
}

241 
M©4
 
	$M4MulF
(
M©4
 
m©
, 
sˇœr
) {

242 
M©4
 
ªsu…
 = 
	`M4I
();

243 
u8
 
cﬁ
=0; col<4; col++)

244 
u8
 
row
=0;Ñow<4;Ñow++)

245 
ªsu…
.
ñem
[
cﬁ
][
row
] = 
m©
.ñem[cﬁ][row] * 
sˇœr
;

246  
ªsu…
;

247 
	}
}

249 
Vec4
 
	$M4MulV
(
M©4
 
m©
, 
Vec4
 
vec
) {

250 
Vec4
 
ªsu…
 = {};

251 
u8
 
row
=0;Ñow<4;Ñow++) {

252 
sum
 = 0;

253 
u8
 
cﬁ
=0; cﬁ<4; cﬁ++Ë
sum
 +
m©
.
ñem
[cﬁ][
row
] * 
vec
.elem[col];

254 
ªsu…
.
ñem
[
row
] = 
sum
;

256  
ªsu…
;

257 
	}
}

259 
M©4
 
	$M4Oπhogøphic
(
À·
, 
right
, 
bŸtom
,

260 
t›
, 
Nór
, 
F¨
) {

261 
M©4
 
ªsu…
 = 
	`M4I
();

263 
ªsu…
.
ñem
[0][0] = 2.0‡/ (
right
-
À·
);

264 
ªsu…
.
ñem
[1][1] = 2.0‡/ (
t›
-
bŸtom
);

265 
ªsu…
.
ñem
[2][2] = 2.0‡/ (
Nór
-
F¨
);

266 
ªsu…
.
ñem
[3][3] = 1.0f;

268 
ªsu…
.
ñem
[3][0] = (
À·
+
right
) / (left-right);

269 
ªsu…
.
ñem
[3][1] = (
bŸtom
+
t›
) / (bottom-top);

270 
ªsu…
.
ñem
[3][2] = (
F¨
+
Nór
) / (Near-Far);

272  
ªsu…
;

273 
	}
}

275 
M©4
 
	$M4Pî•e˘ive
(
fov
, 
a•e˘_øtio
, 
Nór
, 
F¨
) {

276 
M©4
 
ªsu…
 ={};

277 
cŸ
 = 1.0‡/ 
	`ènf
(
fov
 * (
PI32
/360.0f));

278 
ªsu…
.
ñem
[0][0] = 
cŸ
 / 
a•e˘_øtio
;

279 
ªsu…
.
ñem
[1][1] = 
cŸ
;

280 
ªsu…
.
ñem
[2][3] = -1.0f;

281 
ªsu…
.
ñem
[2][2] = (
Nór
+
F¨
) / (Near-Far);

282 
ªsu…
.
ñem
[3][2] = (2.0f*
Nór
*
F¨
) / (Near-Far);

283 
ªsu…
.
ñem
[3][3] = 0.0f;

284  
ªsu…
;

285 
	}
}

287 
M©4
 
	$M4Tøn¶©e
(
Vec3
 
å™¶©i⁄
) {

288 
M©4
 
ªsu…
 = 
	`M4I
();

289 
ªsu…
.
ñem
[3][0] = 
å™¶©i⁄
.
x
;

290 
ªsu…
.
ñem
[3][1] = 
å™¶©i⁄
.
y
;

291 
ªsu…
.
ñem
[3][2] = 
å™¶©i⁄
.
z
;

292  
ªsu…
;

293 
	}
}

295 
M©4
 
	$M4RŸ©e
(
Vec3
 
axis
, 
™gÀ
) {

296 
M©4
 
ªsu…
 = 
	`M4I
();

297 
axis
 = 
	`V3N‹m
(axis);

298 
sö
 = 
	`söf
(
	`DegToRad
(
™gÀ
));

299 
cos
 = 
	`cosf
(
	`DegToRad
(
™gÀ
));

300 
⁄e_möus_cos
 = 1.0‡- 
cos
;

302 
ªsu…
.
ñem
[0][0] = (
axis
.
x
*axis.x*
⁄e_möus_cos
Ë+ 
cos
;

303 
ªsu…
.
ñem
[0][1] = (
axis
.
x
*axis.
y
*
⁄e_möus_cos
Ë+ (axis.
z
*
sö
);

304 
ªsu…
.
ñem
[0][2] = (
axis
.
x
*axis.
z
*
⁄e_möus_cos
Ë- (axis.
y
*
sö
);

306 
ªsu…
.
ñem
[1][0] = (
axis
.
y
*axis.
x
*
⁄e_möus_cos
Ë- (axis.
z
*
sö
);

307 
ªsu…
.
ñem
[1][1] = (
axis
.
y
*axis.y*
⁄e_möus_cos
Ë+ 
cos
;

308 
ªsu…
.
ñem
[1][2] = (
axis
.
y
*axis.
z
*
⁄e_möus_cos
Ë+ (axis.
x
*
sö
);

310 
ªsu…
.
ñem
[2][0] = (
axis
.
z
*axis.
x
*
⁄e_möus_cos
Ë+ (axis.
y
*
sö
);

311 
ªsu…
.
ñem
[2][1] = (
axis
.
z
*axis.
y
*
⁄e_möus_cos
Ë- (axis.
x
*
sö
);

312 
ªsu…
.
ñem
[2][2] = (
axis
.
z
*axis.z*
⁄e_möus_cos
Ë+ 
cos
;

314  
ªsu…
;

315 
	}
}

317 
M©4
 
	$M4SˇÀ
(
Vec3
 
sˇÀ
) {

318 
M©4
 
ªsu…
 = 
	`M4I
();

319 
ªsu…
.
ñem
[0][0] = 
sˇÀ
.
x
;

320 
ªsu…
.
ñem
[1][1] = 
sˇÀ
.
y
;

321 
ªsu…
.
ñem
[2][2] = 
sˇÀ
.
z
;

322  
ªsu…
;

323 
	}
}

325 
M©4
 
	$M4LookAt
(
Vec3
 
pos
, Vec3 
èrgë
, Vec3 
Up
) {

326 
M©4
 
ªsu…
 = 
	`M4I
();

328 
Vec3
 
F
 = 
	`V3N‹m
(
	`V3Sub
(
èrgë
, 
pos
));

329 
Vec3
 
S
 = 
	`V3N‹m
(
	`V3Cross
(
F
, 
Up
));

330 
Vec3
 
U
 = 
	`V3Cross
(
S
, 
F
);

332 
ªsu…
.
ñem
[0][0] = 
S
.
x
;

333 
ªsu…
.
ñem
[0][1] = 
U
.
x
;

334 
ªsu…
.
ñem
[0][2] = -
F
.
x
;

335 
ªsu…
.
ñem
[0][3] = 0.0f;

337 
ªsu…
.
ñem
[1][0] = 
S
.
y
;

338 
ªsu…
.
ñem
[1][1] = 
U
.
y
;

339 
ªsu…
.
ñem
[1][2] = -
F
.
y
;

340 
ªsu…
.
ñem
[1][3] = 0.0f;

342 
ªsu…
.
ñem
[2][0] = 
S
.
z
;

343 
ªsu…
.
ñem
[2][1] = 
U
.
z
;

344 
ªsu…
.
ñem
[2][2] = -
F
.
z
;

345 
ªsu…
.
ñem
[2][3] = 0.0f;

347 
ªsu…
.
ñem
[3][0] = -
	`V3DŸ
(
S
, 
pos
);

348 
ªsu…
.
ñem
[3][1] = -
	`V3DŸ
(
U
, 
pos
);

349 
ªsu…
.
ñem
[3][2] = 
	`V3DŸ
(
F
, 
pos
);

350 
ªsu…
.
ñem
[3][3] = 1.0f;

352  
ªsu…
;

353 
	}
}

355 
Qu©
 
	$Qu©Add
(
Qu©
 
À·
, Qu© 
right
) {

356  
Qu©
 { 
À·
.
x
+
right
.x,Üe·.
y
+right.y,Üe·.
z
+right.z,Üe·.
w
+right.w };

357 
	}
}

358 
Qu©
 
	$Qu©Sub
(
Qu©
 
À·
, Qu© 
right
) {

359  
Qu©
 { 
À·
.
x
-
right
.x,Üe·.
y
-right.y,Üe·.
z
-right.z,Üe·.
w
-right.w };

360 
	}
}

363 
Qu©
 
	$Qu©Mul
(
Qu©
 
À·
, Qu© 
right
) {

364 
Qu©
 
ªsu…
 = {};

365 
ªsu…
.
x
 = (
À·
.x*
right
.
w
Ë+ (À·.
y
*right.
z
) - (left.z*right.y) + (left.w*right.x);

366 
ªsu…
.
y
 = (-
À·
.
x
*
right
.
z
Ë+ (À·.y*right.
w
) + (left.z*right.x) + (left.w*right.y);

367 
ªsu…
.
z
 = (
À·
.
x
*
right
.
y
Ë- (À·.y*right.xË+ (À·.z*right.
w
) + (left.w*right.z);

368 
ªsu…
.
w
 = (-
À·
.
x
*
right
.xË- (À·.
y
*right.yË- (À·.
z
*right.z) + (left.w*right.w);

369  
ªsu…
;

370 
	}
}

371 
Qu©
 
	$Qu©MulF
(
Qu©
 
qu©
, 
sˇœr
) {

372  
Qu©
 { 
qu©
.
x
*
sˇœr
, qu©.
y
*sˇœr, qu©.
z
*sˇœr, qu©.
w
*scalar };

373 
	}
}

374 
Qu©
 
	$Qu©DivF
(
Qu©
 
qu©
, 
sˇœr
) {

375  
Qu©
 { 
qu©
.
x
/
sˇœr
, qu©.
y
/sˇœr, qu©.
z
/sˇœr, qu©.
w
/scalar };

376 
	}
}

377 
	$Qu©DŸ
(
Qu©
 
À·
, Qu© 
right
) {

378  (
À·
.
x
*
right
.xË+ (À·.
y
*right.yË+ (À·.
z
*right.zË+ (À·.
w
*right.w);

379 
	}
}

380 
Qu©
 
	$Qu©Invî£
(
Qu©
 
qu©
) {

381 
Qu©
 
ªsu…
 = { -
qu©
.
x
, -qu©.
y
, -qu©.
z
, qu©.
w
 };

382 
ªsu…
 = 
	`Qu©DivF
‘esu…, 
	`Qu©DŸ
(
qu©
, quat));

383  
ªsu…
;

384 
	}
}

385 
Qu©
 
	$Qu©N‹m
(
Qu©
 
qu©
) {

386 
Qu©
 
ªsu…
 = {};

387 
mag
 = 
	`sqπf
(
	`Qu©DŸ
(
qu©
, quat));

388 
ªsu…
 = 
	`Qu©DivF
(
qu©
, 
mag
);

389  
ªsu…
;

390 
	}
}

392 
M©4
 
	$M4FromQu©
(
Qu©
 
qu©
) {

393 
M©4
 
ªsu…
 = 
	`M4I
();

394 
Qu©
 
qu©_n‹m
 = 
	`Qu©N‹m
(
qu©
);

395 
xx
, 
yy
, 
zz
, 
xy
, 
xz
, 
yz
, 
wx
, 
wy
, 
wz
;

396 
xx
 = 
qu©_n‹m
.
x
 * quat_norm.x;

397 
yy
 = 
qu©_n‹m
.
y
 * quat_norm.y;

398 
zz
 = 
qu©_n‹m
.
z
 * quat_norm.z;

399 
xy
 = 
qu©_n‹m
.
x
 * qu©_n‹m.
y
;

400 
xz
 = 
qu©_n‹m
.
x
 * qu©_n‹m.
z
;

401 
yz
 = 
qu©_n‹m
.
y
 * qu©_n‹m.
z
;

402 
wx
 = 
qu©_n‹m
.
w
 * qu©_n‹m.
x
;

403 
wy
 = 
qu©_n‹m
.
w
 * qu©_n‹m.
y
;

404 
wz
 = 
qu©_n‹m
.
w
 * qu©_n‹m.
z
;

406 
ªsu…
.
ñem
[0][0] = 1.0‡- 2.0f*(
yy
+
zz
);

407 
ªsu…
.
ñem
[0][1] = 2.0‡* (
xy
+
wz
);

408 
ªsu…
.
ñem
[0][2] = 2.0‡* (
xz
-
wy
);

409 
ªsu…
.
ñem
[0][3] = 0.0f;

411 
ªsu…
.
ñem
[1][0] = 2.0‡* (
xy
-
wz
);

412 
ªsu…
.
ñem
[1][1] = 1.0‡- 2.0f*(
xx
+
zz
);

413 
ªsu…
.
ñem
[1][2] = 2.0‡* (
yz
+
wx
);

414 
ªsu…
.
ñem
[1][3] = 0.0f;

416 
ªsu…
.
ñem
[2][0] = 2.0‡* (
xz
+
wy
);

417 
ªsu…
.
ñem
[2][1] = 2.0‡* (
yz
-
wx
);

418 
ªsu…
.
ñem
[2][2] = 1.0‡- 2.0f*(
xx
+
yy
);

419 
ªsu…
.
ñem
[2][3] = 0.0f;

421 
ªsu…
.
ñem
[3][0] = 0.0f;

422 
ªsu…
.
ñem
[3][1] = 0.0f;

423 
ªsu…
.
ñem
[3][2] = 0.0f;

424 
ªsu…
.
ñem
[3][3] = 1.0f;

426  
ªsu…
;

427 
	}
}

429 
Qu©
 
	$Qu©FromAxisAngÀ
(
Vec3
 
axis
, 
™gÀ
) {

430 
Qu©
 
ªsu…
 = {};

431 
Vec3
 
axis_n‹m
 = 
	`V3N‹m
(
axis
);

432 
sö
 = 
	`söf
(
™gÀ
/2.0f);

433 
ªsu…
.
xyz
 = 
	`V3MulF
(
axis_n‹m
, 
sö
);

434 
ªsu…
.
w
 = 
	`cosf
(
™gÀ
/2.0f);

435  
ªsu…
;

436 
	}
}

438 
Qu©
 
	$Qu©FromEuÀr
(
pôch
 , 
yaw
, 
rﬁl
) {

439 
Qu©
 
ªsu…
 = {};

441 
x0
 = 
	`cosf
(
pôch
*0.5f);

442 
x1
 = 
	`söf
(
pôch
*0.5f);

443 
y0
 = 
	`cosf
(
yaw
*0.5f);

444 
y1
 = 
	`söf
(
yaw
*0.5f);

445 
z0
 = 
	`cosf
(
rﬁl
*0.5f);

446 
z1
 = 
	`söf
(
rﬁl
*0.5f);

448 
ªsu…
.
x
 = 
x1
*
y0
*
z0
 - 
x0
*
y1
*
z1
;

449 
ªsu…
.
y
 = 
x0
*
y1
*
z0
 + 
x1
*
y0
*
z1
;

450 
ªsu…
.
z
 = 
x0
*
y0
*
z1
 - 
x1
*
y1
*
z0
;

451 
ªsu…
.
w
 = 
x0
*
y0
*
z0
 + 
x1
*
y1
*
z1
;

453  
ªsu…
;

454 
	}
};

456 
Vec3
 
	$EuÀrFromQu©
(
Qu©
 
qu©
) {

457 
Vec3
 
ªsu…
 = {};

460 
x0
 = 2.0f*(
qu©
.
w
*qu©.
x
 + qu©.
y
*qu©.
z
);

461 
x1
 = 1.0‡- 2.0f*(
qu©
.
x
*qu©.x + qu©.
y
*quat.y);

462 
ªsu…
.
x
 = 
	`©™2f
(
x0
, 
x1
);

465 
y0
 = 2.0f*(
qu©
.
w
*qu©.
y
 - qu©.
z
*qu©.
x
);

466 
y0
 = y0 > 1.0f ? 1.0f : y0;

467 
y0
 = y0 < -1.0f ? -1.0f : y0;

468 
ªsu…
.
y
 = 
	`asöf
(
y0
);

471 
z0
 = 2.0f*(
qu©
.
w
*qu©.
z
 + qu©.
x
*qu©.
y
);

472 
z1
 = 1.0‡- 2.0f*(
qu©
.
y
*qu©.y + qu©.
z
*quat.z);

473 
ªsu…
.
z
 = 
	`©™2f
(
z0
, 
z1
);

475  
ªsu…
;

476 
	}
}

478 
	$AxisAngÀFromQu©
(
Qu©
 
q
, 
Vec3
* 
outAxis
, * 
outAngÀ
) {

479 i‡(
	`Ábs
(
q
.
w
) > 1.0f)

481 
	`Qu©N‹m
(
q
);

482 
Àngth
 = 
	`sqπf
(
q
.
x
*q.x + q.
y
*q.y + q.
z
*q.z + q.
w
*q.w);

483 i‡(
Àngth
 == 0.0f)Üength = 1.0f;

484 
ûígth
 = 1.0f/
Àngth
;

486 
q
.
w
 = q.
x
*
ûígth
;

487 
q
.
y
 = q.y*
ûígth
;

488 
q
.
z
 = q.z*
ûígth
;

489 
q
.
w
 = q.w*
ûígth
;

492 
Vec3
 
ªsAxis
 = { 0.0f, 0.0f, 0.0f };

493 
ªsAngÀ
 = 2.0f*
	`acosf
(
q
.
w
);

494 
dí
 = 
	`sqπf
(1.0‡- 
q
.
w
*q.w);

496 i‡(
dí
 > 0.0001f)

498 
ªsAxis
.
x
 = 
q
.x/
dí
;

499 
ªsAxis
.
y
 = 
q
.y/
dí
;

500 
ªsAxis
.
z
 = 
q
.z/
dí
;

506 
ªsAxis
.
x
 = 1.0f;

509 *
outAxis
 = 
ªsAxis
;

510 *
outAngÀ
 = 
ªsAngÀ
;

511 
	}
}

514 
Qu©
 
	$Qu©FromDúe˘i⁄Ch™ge
(
Vec3
 
‰om
, Vec3 
to
) {

515 
Qu©
 
ªsu…
 = {};

516 
cos
 = 
	`V3DŸ
(
‰om
, 
to
);

517 i‡(
	`Abs
(
cos
 - (-1.0f)) < 0.000001f) {

518 
ªsu…
 = 
	`Qu©FromAxisAngÀ
(
	`V3
(0.0f, 1.0f, 0.0f), 
	`DegToRad
(180.0f));

520 i‡(
	`Abs
(
cos
 - (1.0f)) < 0.00001f) {

521 
ªsu…
 = 
	`Qu©I
();

523 
™gÀ
 = 
	`acosf
(
cos
);

524 
Vec3
 
axis
 = 
	`V3Cross
(
‰om
, 
to
);

525 
axis
 = 
	`V3N‹m
(axis);

526 
ªsu…
 = 
	`Qu©FromAxisAngÀ
(
axis
, 
™gÀ
);

527  
ªsu…
;

528 
	}
}

533 
Vec3
 
	$RŸ©eVecByQu©
(
Vec3
 
vec
, 
Qu©
 
qu©
) {

534 
Vec3
 
ªsu…
 = {};

535 
Vec3
 
a
 = 
	`V3Cross
(
	`V3MulF
(
qu©
.
xyz
, 2), 
vec
);

536 
Vec3
 
b
 = 
	`V3Cross
(
qu©
.
xyz
, 
a
);

537 
Vec3
 
c
 = 
	`V3MulF
(
a
, 
qu©
.
w
);

538 
ªsu…
 = 
	`V3Add
(V3Add(
vec
, 
c
), 
b
);

539  
ªsu…
;

540 
	}
}

546 
Vec3
 
	$GëF‹w¨dVe˘‹
(
Qu©
 
qu©
Ë{  
	`V3N‹m
(
	`RŸ©eVecByQu©
(
	`V3F‹w¨d
(), qu©)); 
	}
}

547 
Vec3
 
	$GëRightVe˘‹
(
Qu©
 
qu©
Ë{  
	`V3N‹m
(
	`RŸ©eVecByQu©
(
	`V3Right
(), qu©)); 
	}
}

548 
Vec3
 
	$GëUpVe˘‹
(
Qu©
 
qu©
Ë{  
	`V3N‹m
(
	`RŸ©eVecByQu©
(
	`V3Up
(), qu©)); 
	}
}

550 
M©4
 
	$MakeTønsf‹mM©rix
(
Tønsf‹m
 
å™sf‹m
) {

551 
M©4
 
ªsu…
 = 
	`M4I
();

552 
M©4
 
å™¶©i⁄
 = 
	`M4Tøn¶©e
(
å™sf‹m
.
posôi⁄
);

553 
M©4
 
rŸ©i⁄
 = 
	`M4FromQu©
(
å™sf‹m
.rotation);

554 
M©4
 
sˇÀ
 = 
	`M4SˇÀ
(
å™sf‹m
.scale);

557 
ªsu…
 = 
	`M4Mul
(M4Mul(
å™¶©i⁄
, 
rŸ©i⁄
), 
sˇÀ
);

560  
ªsu…
;

561 
	}
}

	@memory_management.h

1 
	#ZîoSåu˘
(
vÆ
Ë
	`ZîoMem
(&(vÆ), (vÆ))

	)

2 
	#ZîoAºay
(
¨øy
, 
cou¡
Ë
	`ZîoMem
◊ºay, cou¡*(◊ºay)[0]))

	)

4 
	$ZîoMem
(* 
±r
, 
u64
 
size
) {

5 
u8
* 
mem
 = (u8*)
±r
;

6 
size
--Ë*
mem
++ = 0;

7 
	}
}

9 
	$C›yMem
(* 
to
, * 
‰om
, 
u64
 
Àn
) {

10 
u8
* 
§c
 = (u8*)
‰om
;

11 
u8
* 
d°
 = (u8*)
to
;

12 
Àn
--Ë*
d°
++ = *
§c
++;

13 
	}
}

15 
boﬁ
 
	$Com∑ªMem
(* 
À·
, * 
right
, 
u64
 
Àn
) {

16 
u8
* 
l
 = (u8*)
À·
;

17 
u8
* 
r
 = (u8*)
right
;

18 
Àn
--Ëif(*
l
++ !*
r
++Ë 
Ál£
;

19  
åue
;

20 
	}
}

22 
	#PushSåu˘
(
±r_¨ía
, 
ty≥
Ë—y≥*)
	`PushSize
(’å_¨ía), —y≥))

	)

23 
	#PushAºay
(
±r_¨ía
, 
ty≥
, 
cou¡
Ë—y≥*)
	`PushSize
(’å_¨ía), —y≥)*(cou¡))

	)

25 
	sMem‹yAª«
 {

26 
Pœtf‹mMem‹yBlock
* 
	mcuºít_block
;

27 
u64
 
	mmö_block_size
;

28 
u32
 
	mãmp_cou¡
;

31 
	sTemp‹¨yMem‹y
 {

32 
Mem‹yAª«
* 
	m¨ía
;

33 
Pœtf‹mMem‹yBlock
* 
	mblock
;

34 
u64
 
	msize
;

38 
	$PushSize
(
Mem‹yAª«
* 
¨ía
, 
u64
 
size
) {

39 * 
Resu…
 = 0;

41 
u32
 
Æig√d_size
 = 0;

42 if(
¨ía
->
cuºít_block
Ë
u32
 
Æig√d_size
 = ((
size
 + 7) >> 3) << 2;

44 if(!
¨ía
->
cuºít_block
 || (◊ª«->cuºít_block->
u£d
 + 
size
) >árena->current_block->size)) {

45 if(!
¨ía
->
mö_block_size
)árena->min_block_size = 1024*1024;

47 
u64
 
block_size
 = 
	`Max
(
size
, 
¨ía
->
mö_block_size
);

48 
Pœtf‹mMem‹yBlock
* 
√w_block
 = 
∂©f‹m_≠i
.
	`Æloˇã_mem‹y
(
block_size
);

49 
√w_block
->
¥ev
 = 
¨ía
->
cuºít_block
;

50 
¨ía
->
cuºít_block
 = 
√w_block
;

53 
	`As£π
((
¨ía
->
cuºít_block
->
u£d
 + 
size
) <=árena->current_block->size);

55 
ªsu…
 = 
¨ía
->
cuºít_block
->
ba£
;

56 
¨ía
->
cuºít_block
->
u£d
 +
Æig√d_size
;

58  
ªsu…
;

59 
	}
}

61 
Temp‹¨yMem‹y


62 
	$BegöTemp‹¨yMem‹y
(
Mem‹yAª«
* 
¨ía
) {

63 
Temp‹¨yAª«
* 
ªsu…
 = {};

65 
ªsu…
.
¨ía
 =árena;

66 
ªsu…
.
block
 = 
¨ía
->
cuºít_block
;

67 
ªsu…
.
u£d
 = 
¨ía
->
cuºít_block
 ?árena->current_block->used : 0;

69 
¨ía
->
ãmp_cou¡
++;

71  
ªsu…
;

72 
	}
}

75 
	$FªeLa°Block
(
Mem‹yAª«
* 
¨ía
) {

76 
Pœtf‹mMem‹yBlock
* 
‰ì_block
 = 
¨ía
->
cuºít_block
;

77 
¨ía
->
cuºít_block
 = 
‰ì_block
->
¥ev
;

78 
∂©f‹m_≠i
.
	`dóŒoˇã_mem‹y
(
‰ì_block
);

79 
	}
}

82 
	$EndTemp‹¨yMem‹y
(
Temp‹¨yMem‹y
* 
ãmp_mem
) {

83 
Mem‹yAª«
* 
¨ía
 = 
ãmp_mem
.arena;

85 
¨ía
->
cuºít_block
 !
ãmp_mem
.
block
) {

86 
	`FªeLa°Block
(
¨ía
);

89 if(
¨ía
->
cuºít_block
) {

90 
	`As£π
(
¨ía
->
cuºít_block
->
u£d
 >
ãmp_mem
.used);

91 
¨ía
->
cuºít_block
->
u£d
 = 
ãmp_mem
.used;

94 
	`As£π
(
¨ía
->
ãmp_cou¡
 > 0);

95 
¨ía
->
ãmpcou¡
--;

96 
	}
}

98 
u32
 
	$SåögLígth
(* 
°rög
) {

99 
u32
 
i
=0;

100 
°rög
[
i
] != 0) i++;

101  
i
;

102 
	}
}

104 
boﬁ
 
	$SåögCom∑ª
(* 
À·
, * 
right
) {

105 
u32
 
À·_Àn
 = 
	`SåögLígth
(
À·
);

106 
u32
 
right_Àn
 = 
	`SåögLígth
(
right
);

107 if(
À·_Àn
 !
right_Àn
Ë 
Ál£
;

108 
u32
 
i
=0; 
À·
[i] != 0; i++)

109 if(
À·
[
i
] !
right
[i]Ë 
Ál£
;

110  
åue
;

111 
	}
}

	@mesh_renderer.cpp

1 
	#MAX_MESH_PIPELINES
 10

	)

2 
	#MAX_SHADER_LENGTH
 5000

	)

4 
	sLightInfo
 {

5 
Vec3
 
	mposôi⁄
;

6 
	mambõn˚
;

9 
	sMeshInfo
 {

10 
M©4
 
	mmodñ
;

11 
Vec4
 
	mcﬁ‹
;

14 
	sMeshPùñöe
 {

15 
RídîBuf„rGroup
* 
	mvîãx_buf„rs
;

16 * 
	mö°™˚_d©a
;

17 
u32
 
	mö°™˚_cou¡
;

20 
	sMeshRídîî
 {

21 
MeshPùñöe
 
	mpùñöes
[
MAX_MESH_PIPELINES
];

22 
u32
 
	mcou¡
;

24 
	mshadî_code
[
MAX_SHADER_LENGTH
];

25 
VîãxShadî
* 
	mvs
;

26 
PixñShadî
* 
	mps
;

30 
	$PushMeshPùñöe
(
MeshPùñöe
 
pùñöe
, 
MeshRídîî
* 
mesh_ªndîî
) {

31 
	`As£π
(
mesh_ªndîî
->
cou¡
 < 
MAX_MESH_PIPELINES
);

32 
mesh_ªndîî
->
pùñöes
[mesh_ªndîî->
cou¡
++] = 
pùñöe
;

33 
	}
}

34 
	gMeshShadîCode
[] = 
R
"FOO(

36 
	sMeshInfo
 {

37 
Êﬂt4x4
 
modñ
;

38 
Êﬂt4
 
	mcﬁ‹
;

41 
	svs
 {

42 
Êﬂt3
 
	mposôi⁄
 : 
POSITION
;

43 
Êﬂt3
 
	mn‹mÆ
 : 
NORMAL
;

46 
cbuf„r
 
	gˇmîa
 : (
b1
) {

47 
Êﬂt4x4
 
võw_¥oj
;

48 
	}
};

50 
	sps
 {

51 
Êﬂt4
 
	mpixñ_pos
 : 
SV_POSITION
;

52 
Êﬂt3
 
	mvîãx_pos
 : 
POSITION
;

53 
Êﬂt3
 
	mn‹mÆ
 : 
NORMAL
;

54 
Êﬂt4
 
	mcﬁ‹
 : 
COLOR
;

57 
	gSåu˘uªdBuf„r
<
	gMeshInfo
> 
	gmesh_öfo_¨øy
 : (
t0
);

59 
cbuf„r
 
	glight
 : (
b1
) {

60 
Êﬂt3
 
light_posôi⁄
;

61 
light_ambõn˚
;

62 
	}
};

64 
ps
 
	$vsf
(
vs
 
öput
, 
ö
 
uöt
 
ö°™˚_id
 : 
SV_In°™˚ID
) {

65 
ps
 
ouçut
;

67 
MeshInfo
 
mesh_öfo
 = 
mesh_öfo_¨øy
[
ö°™˚_id
];

69 
Êﬂt4
 
w‹ld_pos
 = 
	`mul
(
mesh_öfo
.
modñ
, 
	`Êﬂt4
(
öput
.
posôi⁄
, 1.0f));

70 
ouçut
.
pixñ_pos
 = 
	`mul
(
võw_¥oj
, 
w‹ld_pos
);

71 
ouçut
.
vîãx_pos
 = 
w‹ld_pos
.
xyz
;

72 
ouçut
.
n‹mÆ
 = 
	`mul
(
mesh_öfo
.
modñ
, 
	`Êﬂt4
(
öput
.n‹mÆ, 0.0)).
xyz
;

73 
ouçut
.
cﬁ‹
 = 
mesh_öfo
.color;

75  
ouçut
;

76 
	}
}

78 
Êﬂt4
 
	$psf
(
ps
 
öput
Ë: 
SV_T¨gë
 {

79 
Êﬂt3
 
light_dú
 = 
	`n‹mÆize
(
öput
.
vîãx_pos
 - 
light_posôi⁄
);

81 
cos
 = 
	`max
(0.0, 
	`dŸ
(
öput
.
n‹mÆ
, 
light_dú
));

83 
Êﬂt3
 
diffu£_cﬁ‹
 = 
cos
 * 
öput
.
cﬁ‹
.
rgb
;

84 
Êﬂt3
 
ambõ¡_cﬁ‹
 = 
öput
.
cﬁ‹
.
rbg
 * 
light_ambõn˚
;

86 
Êﬂt3
 
föÆ_cﬁ‹
 = 
ambõ¡_cﬁ‹
 + 
diffu£_cﬁ‹
;

88  
	`Êﬂt4
(
föÆ_cﬁ‹
, 
öput
.
cﬁ‹
.
a
);

89 
	}
};

90 )
	gFOO
";

93 
	$CompûeMeshShadî
(
MeshRídîî
* 
mesh_ªndîî
, 
Rídîî
* 
ªndîî
) {

95 
u32
 
shadî_Àngth
 = (
MeshShadîCode
);

96 
	`C›yMem
(
mesh_ªndîî
->
shadî_code
, 
MeshShadîCode
, 
shadî_Àngth
+1);

98 
ShadîDesc
 
sd
 = { 
MeshShadîCode
, (MeshShaderCode), "vsf" };

99 
C⁄°™tsBuf„rDesc
 
cbd
[] = { { 
CONSTANTS_BINDING_SLOT_CAMERA
, (
M©4
) } };

100 
VERTEX_BUFFER
 
vbd
[] = { 
VERTEX_BUFFER_POSITION
, 
VERTEX_BUFFER_NORMAL
 };

101 
Såu˘uªdBuf„rDesc
 
sbd
[] = { 
STRUCTURED_BINDING_SLOT_FRAME
, (
MeshInfo
), 
MAX_MESH_PIPELINES
 };

103 
VîãxShadîDesc
 
vsd
 = {};

104 
vsd
.
shadî
 = 
sd
;

105 
vsd
.
cb_desc
 = 
cbd
;

106 
vsd
.
vb_ty≥
 = 
vbd
;

107 
vsd
.
sb_desc
 = 
sbd
;

108 
vsd
.
vb_cou¡
 = 
	`AºayCou¡
(
vbd
);

109 
vsd
.
cb_cou¡
 = 
	`AºayCou¡
(
cbd
);

110 
vsd
.
sb_cou¡
 = 
	`AºayCou¡
(
sbd
);

112 
mesh_ªndîî
->
vs
 = 
	`U∂ﬂdVîãxShadî
(
vsd
, 
ªndîî
);

115 
PixñShadîDesc
 
psd
 = {};

116 
ShadîDesc
 
sd
 = { 
MeshShadîCode
, (MeshShaderCode), "psf" };

117 
C⁄°™tsBuf„rDesc
 
cbd
[] = { { 
CONSTANTS_BINDING_SLOT_CAMERA
, (
LightInfo
) } };

119 
psd
.
shadî
 = 
sd
;

120 
psd
.
cb_desc
 = 
cbd
;

121 
psd
.
cb_cou¡
 = 
	`AºayCou¡
(
cbd
);

123 
mesh_ªndîî
->
ps
 = 
	`U∂ﬂdPixñShadî
(
psd
, 
ªndîî
);

125 
	}
}

127 
MeshRídîî
*

128 
	$InôMeshRídîî
(
Rídîî
* 
ªndîî
, 
Mem‹yAª«
* 
¨ía
) {

129 
MeshRídîî
* 
ªsu…
 = 
	`PushSåu˘
(
¨ía
, MeshRenderer);

131 
	`CompûeMeshShadî
(
ªsu…
, 
ªndîî
);

133  
ªsu…
;

134 
	}
}

137 
	$MeshRídîîFøme
(
MeshRídîî
* 
mesh_ªndîî
, 
Camîa
* 
ˇmîa
, 
LightInfo
* 
light
, 
Rídîî
* 
ªndîî
) {

138 if(!
	`SåögCom∑ª
(
mesh_ªndîî
->
shadî_code
, 
MeshShadîCode
)) {

139 
ID3D11VîãxShadî
* 
vs
;

140 
ID3D11PixñShadî
* 
ps
;

141 
ID3DBlob
* 
blob
;

142 if(
	`CompûeShadî
(
MeshShadîCode
, (MeshShadîCode), "vsf", (**)&
vs
, &
blob
, 
åue
, 
ªndîî
)) {

143 if(
	`CompûeShadî
(
MeshShadîCode
, (MeshShadîCode), "psf", (**)&
ps
, &
blob
, 
Ál£
, 
ªndîî
)) {

144 
mesh_ªndîî
->
vs
->
shadî
 = vs;

145 
mesh_ªndîî
->
ps
->
shadî
 =Ös;

146 
	`C›yMem
(
mesh_ªndîî
->
shadî_code
, 
MeshShadîCode
, (MeshShaderCode)+1);

151 if(
mesh_ªndîî
->
cou¡
 == 0) ;

153 
RídîPùñöe
 
Ω
 = {};

154 
MeshPùñöe
 
mesh_pùñöe
 = {};

156 
M©4
* 
vp
 = 
	`PushSåu˘
(&
ªndîî
->
å™sõ¡
, Mat4);

157 *
vp
 = 
	`MakeVõwPî•e˘ive
(
ˇmîa
);

159 
Ω
.
vs
 = 
mesh_ªndîî
->vs;

160 
Ω
.
ps
 = 
mesh_ªndîî
->ps;

162 
Ω
.
vrbd_cou¡
 = 1;

163 
Ω
.
vrbd
 = 
	`PushAºay
(&
ªndîî
->
å™sõ¡
, 
PushRídîBuf„rD©a
,Ñp.
vrbd_cou¡
);

164 
Ω
.
vrbd
->
ty≥
 = 
RENDER_BUFFER_TYPE_CONSTANTS
;

165 
Ω
.
vrbd
->
c⁄°™ts
.
¶Ÿ
 = 
CONSTANTS_BINDING_SLOT_CAMERA
;

166 
Ω
.
vrbd
->
c⁄°™ts
.
d©a
 = 
vp
;

168 
Ω
.
¥bd_cou¡
 = 1;

169 
Ω
.
¥bd
 = 
	`PushAºay
(&
ªndîî
->
å™sõ¡
, 
PushRídîBuf„rD©a
,Ñp.
¥bd_cou¡
);

170 
Ω
.
¥bd
->
ty≥
 = 
RENDER_BUFFER_TYPE_CONSTANTS
;

171 
Ω
.
¥bd
->
c⁄°™ts
.
¶Ÿ
 = 
CONSTANTS_BINDING_SLOT_CAMERA
;

172 
Ω
.
¥bd
->
c⁄°™ts
.
d©a
 = 
light
;

174 
	`AddToRídîQueue
(
Ω
, 
ªndîî
);

176 
u32
 
i
=0; i<
mesh_ªndîî
->
cou¡
; i++) {

177 
Ω
 = {};

178 
mesh_pùñöe
 = 
mesh_ªndîî
->
pùñöes
[
i
];

180 
u32
 
vîti˚s_cou¡
;

181 
u8
 
j
=0; j<
mesh_pùñöe
.
vîãx_buf„rs
->
cou¡
; j++) {

182 if(
mesh_pùñöe
.
vîãx_buf„rs
->
rb
[
j
].
ty≥
 =
RENDER_BUFFER_TYPE_VERTEX
) {

183 
vîti˚s_cou¡
 = 
mesh_pùñöe
.
vîãx_buf„rs
->
rb
[
j
].
vîãx
.vertices_count;

187 
Ω
.
rs
 = 
	`RídîSèãDeÁu…s
();

188 
Ω
.
dc
.
ty≥
 = 
DRAW_CALL_INSTANCED
;

189 
Ω
.
dc
.
vîti˚s_cou¡
 = vertices_count;

190 
Ω
.
dc
.
ö°™˚_cou¡
 = 
mesh_pùñöe
.instance_count;

192 
Ω
.
vs
 = 
mesh_ªndîî
->vs;

193 
Ω
.
ps
 = 
mesh_ªndîî
->ps;

195 
Ω
.
vrbg
 = 
mesh_pùñöe
.
vîãx_buf„rs
;

197 
Ω
.
vrbd_cou¡
 = 1;

198 
Ω
.
vrbd
 = 
	`PushAºay
(&
ªndîî
->
å™sõ¡
, 
PushRídîBuf„rD©a
,Ñp.
vrbd_cou¡
);

199 
Ω
.
vrbd
->
ty≥
 = 
RENDER_BUFFER_TYPE_STRUCTURED
;

200 
Ω
.
vrbd
->
°ru˘uªd
.
¶Ÿ
 = 
STRUCTURED_BINDING_SLOT_FRAME
;

201 
Ω
.
vrbd
->
°ru˘uªd
.
cou¡
 = 
mesh_pùñöe
.
ö°™˚_cou¡
;

202 
Ω
.
vrbd
->
°ru˘uªd
.
d©a
 = 
mesh_pùñöe
.
ö°™˚_d©a
;

204 
	`AddToRídîQueue
(
Ω
, 
ªndîî
);

207 
mesh_ªndîî
->
cou¡
 = 0;

208 
	}
}

	@platform_api.h

1 
	sPœtf‹mMem‹yBlock
 {

2 
u64
 
	msize
;

3 
u64
 
	mu£d
;

4 
u8
* 
	mbp
;

6 
Pœtf‹mMem‹yBlock
* 
	m¥ev
;

9 
	sPœtf‹mFûeH™dÀ
 {

10 
boﬁ
 
	mÁûed
;

11 * 
	mh™dÀ
;

14 
	sPœtf‹mFûeInfo
 {

15 
u64
 
	msize
;

16 * 
	m«me
;

19 
	eWIN32_BUTTON
 {

20 
	mWIN32_BUTTON_A
,

21 
	mWIN32_BUTTON_B
,

22 
	mWIN32_BUTTON_C
,

23 
	mWIN32_BUTTON_D
,

24 
	mWIN32_BUTTON_E
,

25 
	mWIN32_BUTTON_F
,

26 
	mWIN32_BUTTON_G
,

27 
	mWIN32_BUTTON_H
,

28 
	mWIN32_BUTTON_I
,

29 
	mWIN32_BUTTON_J
,

30 
	mWIN32_BUTTON_L
,

31 
	mWIN32_BUTTON_M
,

32 
	mWIN32_BUTTON_N
,

33 
	mWIN32_BUTTON_O
,

34 
	mWIN32_BUTTON_P
,

35 
	mWIN32_BUTTON_Q
,

36 
	mWIN32_BUTTON_R
,

37 
	mWIN32_BUTTON_S
,

38 
	mWIN32_BUTTON_T
,

39 
	mWIN32_BUTTON_U
,

40 
	mWIN32_BUTTON_V
,

41 
	mWIN32_BUTTON_W
,

42 
	mWIN32_BUTTON_X
,

43 
	mWIN32_BUTTON_Y
,

44 
	mWIN32_BUTTON_Z
,

46 
	mWIN32_BUTTON_TAB
,

47 
	mWIN32_BUTTON_SHIFT
,

48 
	mWIN32_BUTTON_CTRL
,

49 
	mWIN32_BUTTON_SPACE
,

50 
	mWIN32_BUTTON_ALT
,

52 
	mWIN32_BUTTON_UP
,

53 
	mWIN32_BUTTON_DOWN
,

54 
	mWIN32_BUTTON_LEFT
,

55 
	mWIN32_BUTTON_RIGHT
,

57 
	mWIN32_BUTTON_0
,

58 
	mWIN32_BUTTON_1
,

59 
	mWIN32_BUTTON_2
,

60 
	mWIN32_BUTTON_3
,

61 
	mWIN32_BUTTON_4
,

62 
	mWIN32_BUTTON_5
,

63 
	mWIN32_BUTTON_6
,

64 
	mWIN32_BUTTON_7
,

65 
	mWIN32_BUTTON_8
,

66 
	mWIN32_BUTTON_9
,

68 
	mWIN32_BUTTON_F0
,

69 
	mWIN32_BUTTON_F1
,

70 
	mWIN32_BUTTON_F2
,

71 
	mWIN32_BUTTON_F3
,

72 
	mWIN32_BUTTON_F4
,

73 
	mWIN32_BUTTON_F5
,

74 
	mWIN32_BUTTON_F6
,

75 
	mWIN32_BUTTON_F7
,

76 
	mWIN32_BUTTON_F8
,

77 
	mWIN32_BUTTON_F9
,

78 
	mWIN32_BUTTON_F10
,

79 
	mWIN32_BUTTON_F11
,

80 
	mWIN32_BUTTON_F12
,

82 
	mWIN32_BUTTON_ENTER
,

83 
	mWIN32_BUTTON_ESC
,

85 
	mWIN32_BUTTON_LEFT_MOUSE
,

86 
	mWIN32_BUTTON_RIGHT_MOUSE
,

87 
	mWIN32_BUTTON_MIDDLE_MOUSE
,

89 
	mWIN32_BUTTON_TOTAL


92 
	eWIN32_AXIS
 {

93 
	mWIN32_AXIS_MOUSE
,

94 
	mWIN32_AXIS_MOUSE_DEL
,

95 
	mWIN32_AXIS_TOTAL


98 
	sWödowDimísi⁄s
 { 
u32
 
	mwidth
; u32 
	mheight
; };

99 
	sBuâ⁄
 { 
boﬁ
 
	m¥es£d
, 
	mhñd
; };

100 
	sAxis
 { 
	mx
, 
	my
; };

102 
	sI≈ut
 {

103 
Buâ⁄
 
	mbuâ⁄s
[
WIN32_BUTTON_TOTAL
];

104 
Axis
 
	maxes
[
WIN32_AXIS_TOTAL
];

107 
	sWö32Wödow
 {

108 
WödowDimísi⁄s
 
	mdim
;

109 
HWND
 
	mh™dÀ
;

112 
	#PLATFORM_OPEN_FILE
(
«me
Ë
Pœtf‹mFûeH™dÀ
 
	`«me
(
Pœtf‹mFûeInfo
* 
öfo
)

	)

113 
PLATFORM_OPEN_FILE
(
	tPœtf‹mO≥nFûe
);

115 
	#PLATFORM_CLOSE_FILE
(
«me
Ë
	`«me
(
Pœtf‹mFûeH™dÀ
* 
fûe_h™dÀ
)

	)

116 
PLATFORM_CLOSE_FILE
(
	tPœtf‹mClo£Fûe
);

118 
	#PLATFORM_READ_FILE
(
«me
Ë
	`«me
(
Pœtf‹mFûeH™dÀ
* 
wö32_h™dÀ
, 
u32
 
size
, *
d°
)

	)

119 
PLATFORM_READ_FILE
(
	tPœtf‹mRódFûe
);

121 
	#PLATFORM_ALLOCATE_MEMORY
(
«me
Ë
Pœtf‹mMem‹yBlock
* 
	`«me
(
u64
 
size
)

	)

122 
PLATFORM_ALLOCATE_MEMORY
(
	tPœtf‹mAŒoˇãMem‹y
);

124 
	#PLATFORM_DEALLOCATE_MEMORY
(
«me
Ë
	`«me
(
Pœtf‹mMem‹yBlock
* 
block
)

	)

125 
PLATFORM_DEALLOCATE_MEMORY
(
	tPœtf‹mDóŒoˇãMem‹y
);

127 
	sPœtf‹mAPI
 {

128 
Pœtf‹mO≥nFûe
* 
	m›í_fûe
;

129 
Pœtf‹mClo£Fûe
* 
	m˛o£_fûe
;

130 
Pœtf‹mRódFûe
* 
	mªad_fûe
;

131 
Pœtf‹mAŒoˇãMem‹y
* 
	mÆloˇã_mem‹y
;

	@quad_renderer.cpp

1 
	#MAX_QUADS
 100

	)

2 
	#MAX_TEXTURED_QUADS
 100

	)

4 
	sRídîQuad
 {

5 
Quad
 
	mquad
;

6 
Vec4
 
	mcﬁ‹
;

9 
	sQuadRídîî
 {

10 
RídîQuad
 
	mquads
[
MAX_QUADS
];

11 
u32
 
	mquad_cou¡
;

13 
VîãxShadî
* 
	mquad_vs
;

14 
PixñShadî
* 
	mquad_ps
;

16 
Vec3
 
	mposôi⁄s
[
MAX_TEXTURED_QUADS
*4*3];

17 
Vec2
 
	mãxco‹ds
[
MAX_TEXTURED_QUADS
*4*2];

18 
RídîBuf„r
* 
	mãxtuªs
[
MAX_TEXTURED_QUADS
];

19 
u32
 
	mãxtuªd_quad_cou¡
;

21 
VîãxShadî
* 
	mãxtuªd_quad_vs
;

22 
PixñShadî
* 
	mãxtuªd_quad_ps
;

23 
RídîBuf„rGroup
* 
	mvîãx_buf„rs
;

27 
	$CompûeTextuªdQuadShadî
(
QuadRídîî
* 
quad_ªndîî
, 
Rídîî
* 
ªndîî
) {

28 
VîãxShadîCode
[] = 
R
"FOO(

30 
	svs
 {

31 
Êﬂt3
 
posôi⁄
 : 
POSITION
;

32 
Êﬂt2
 
ãxco‹d
 : 
TEXCOORD
;

35 
	sps
 {

36 
Êﬂt4
 
pixñ_pos
 : 
SV_POSITION
;

37 
Êﬂt2
 
ãxco‹d
 : 
TEXCOORD
;

40 
cbuf„r
 
ˇmîa
 : (
b1
) {

41 
Êﬂt4x4
 
võw_¥oj
;

44 
ps
 
	`vsf
(
vs
 
öput
) {

45 
ps
 
ouçut
;

47 
ouçut
.
pixñ_pos
 = 
	`mul
(
võw_¥oj
, 
	`Êﬂt4
(
öput
.
posôi⁄
, 1.0));

48 
ouçut
.
ãxco‹d
 = 
öput
.texcoord;

50  
ouçut
;

53 )
FOO
";

55 
PixñShadîCode
[] = 
R
"FOO(

56 
	sps
 {

57 
Êﬂt4
 
pixñ_pos
 : 
SV_POSITION
;

58 
Êﬂt2
 
ãxco‹d
 : 
TEXCOORD
;

61 
Textuª2D
 
diffu£_ãxtuª
 : (
t0
);

62 
Sam∂îSèã
 
deÁu…_ßm∂î
 : (
s0
);

64 
Êﬂt4
 
	`psf
(
ps
 
öput
Ë: 
SV_TARGET
 {

65 
Êﬂt3
 
diffu£_cﬁ‹
 = 
diffu£_ãxtuª
.
	`Sam∂e
(
deÁu…_ßm∂î
, 
öput
.
ãxco‹d
).
xyz
;

66  
	`Êﬂt4
(
diffu£_cﬁ‹
, 1.0f);

68 )
FOO
";

70 
ShadîDesc
 
sd
 = { 
VîãxShadîCode
, (VertexShaderCode), "vsf" };

71 
C⁄°™tsBuf„rDesc
 
cbd
[] = { { 
CONSTANTS_BINDING_SLOT_CAMERA
, (
M©4
) } };

72 
VERTEX_BUFFER
 
vbd
[] = { 
VERTEX_BUFFER_POSITION
, 
VERTEX_BUFFER_TEXCOORD
 };

74 
VîãxShadîDesc
 
vsd
 = {};

75 
vsd
.
shadî
 = 
sd
;

76 
vsd
.
cb_desc
 = 
cbd
;

77 
vsd
.
vb_ty≥
 = 
vbd
;

78 
vsd
.
vb_cou¡
 = 
	`AºayCou¡
(
vbd
);

79 
vsd
.
cb_cou¡
 = 
	`AºayCou¡
(
cbd
);

81 
quad_ªndîî
->
ãxtuªd_quad_vs
 = 
	`U∂ﬂdVîãxShadî
(
vsd
, 
ªndîî
);

84 
PixñShadîDesc
 
psd
 = {};

85 
ShadîDesc
 
sd
 = { 
PixñShadîCode
, (PixelShaderCode), "psf" };

86 
TEXTURE_SLOT
 
¶Ÿs
[] = { 
TEXTURE_SLOT_DIFFUSE
 };

88 
psd
.
shadî
 = 
sd
;

89 
psd
.
ãxtuª_¶Ÿ
 = 
¶Ÿs
;

90 
psd
.
ãxtuª_cou¡
 = 
	`AºayCou¡
(
¶Ÿs
);

92 
quad_ªndîî
->
ãxtuªd_quad_ps
 = 
	`U∂ﬂdPixñShadî
(
psd
, 
ªndîî
);

95 
VîãxBuf„rD©a
 
vbd
[] = { { (*)
quad_ªndîî
->
posôi⁄s
, 
VERTEX_BUFFER_POSITION
 },

96 { (*)
quad_ªndîî
->
ãxco‹ds
, 
VERTEX_BUFFER_TEXCOORD
 } };

98 
MeshD©a
 
mesh_d©a
 = {};

99 
mesh_d©a
.
vîti˚s_cou¡
 = 
MAX_TEXTURED_QUADS
*4;

100 
mesh_d©a
.
vb_d©a
 = 
vbd
;

101 
mesh_d©a
.
vb_d©a_cou¡
 = 
	`AºayCou¡
(
vbd
);

103 
VîãxBuf„rDesc
 
vb_desc
[] = { { 
VERTEX_BUFFER_POSITION
, 
åue
 }, { 
VERTEX_BUFFER_TEXCOORD
,Årue } };

105 
MeshDesc
 
mesh_desc
 = {};

106 
mesh_desc
.
vb_desc
 = vb_desc;

107 
mesh_desc
.
vb_cou¡
 = 
	`AºayCou¡
(
vb_desc
);

109 
quad_ªndîî
->
vîãx_buf„rs
 = 
	`U∂ﬂdMesh
(&
mesh_d©a
, &
mesh_desc
, 
ªndîî
);

111 
	}
}

114 
	$CompûeQuadShadî
(
QuadRídîî
* 
quad_ªndîî
, 
Rídîî
* 
ªndîî
) {

115 
VîãxShadîCode
[] = 
R
"FOO(

117 
	sQuad
 {

118 
Êﬂt3
 
é
;

119 
Êﬂt3
 
å
;

120 
Êﬂt3
 
bl
;

121 
Êﬂt3
 
br
;

122 
Êﬂt4
 
cﬁ‹
;

125 
	sps
 {

126 
Êﬂt4
 
pixñ_pos
 : 
SV_POSITION
;

127 
Êﬂt4
 
cﬁ‹
 : 
COLOR
;

130 
cbuf„r
 
ˇmîa
 : (
b1
) {

131 
Êﬂt4x4
 
võw_¥oj
;

134 
Såu˘uªdBuf„r
<
Quad
> 
quad_li°
 : (
t0
);

136 
ps
 
	`vsf
(
ö
 
uöt
 
vît_id
 : 
SV_VîãxID
) {

137 
ps
 
ouçut
;

138 
ödex
 = 
vît_id
 / 6;

139 
vît_cou¡
 = 
vît_id
 % 6;

141 
Quad
 
quad
 = 
quad_li°
[
ödex
];

143 
Êﬂt3
 
c‹√r
;

144 if(
vît_cou¡
 == 0)

145 
c‹√r
 = 
quad
.
é
;

146 if(
vît_cou¡
 == 1)

147 
c‹√r
 = 
quad
.
bl
;

148 if(
vît_cou¡
 == 2)

149 
c‹√r
 = 
quad
.
br
;

151 if(
vît_cou¡
 == 3)

152 
c‹√r
 = 
quad
.
br
;

153 if(
vît_cou¡
 == 4)

154 
c‹√r
 = 
quad
.
å
;

155 if(
vît_cou¡
 == 5)

156 
c‹√r
 = 
quad
.
é
;

158 
Êﬂt4
 
pos
 = 
	`Êﬂt4
(
c‹√r
, 1.0);

159 
ouçut
.
pixñ_pos
 = 
	`mul
(
võw_¥oj
, 
pos
);

161 
ouçut
.
cﬁ‹
 = 
quad
.color;

162  
ouçut
;

165 )
FOO
";

167 
PixñShadîCode
[] = 
R
"FOO(

169 
	sps
 {

170 
Êﬂt4
 
pixñ_pos
 : 
SV_POSITION
;

171 
Êﬂt4
 
cﬁ‹
 : 
COLOR
;

174 
Êﬂt4
 
	`psf
(
ps
 
öput
Ë: 
SV_TARGET
 {

175  
öput
.
cﬁ‹
;

177 )
FOO
";

180 
ShadîDesc
 
sd
 = { 
VîãxShadîCode
, (VertexShaderCode), "vsf" };

181 
C⁄°™tsBuf„rDesc
 
cbd
[] = { { 
CONSTANTS_BINDING_SLOT_CAMERA
, (
M©4
) } };

182 
Såu˘uªdBuf„rDesc
 
sbd
[] = { { 
STRUCTURED_BINDING_SLOT_FRAME
, (
RídîQuad
), 
MAX_QUADS
 } };

184 
VîãxShadîDesc
 
vsd
 = {};

185 
vsd
.
shadî
 = 
sd
;

186 
vsd
.
cb_desc
 = 
cbd
;

187 
vsd
.
sb_desc
 = 
sbd
;

188 
vsd
.
cb_cou¡
 = 
	`AºayCou¡
(
cbd
);

189 
vsd
.
sb_cou¡
 = 
	`AºayCou¡
(
sbd
);

191 
quad_ªndîî
->
quad_vs
 = 
	`U∂ﬂdVîãxShadî
(
vsd
, 
ªndîî
);

194 
PixñShadîDesc
 
psd
 = {};

195 
ShadîDesc
 
sd
 = { 
PixñShadîCode
, (PixelShaderCode), "psf" };

196 
psd
.
shadî
 = 
sd
;

198 
quad_ªndîî
->
quad_ps
 = 
	`U∂ﬂdPixñShadî
(
psd
, 
ªndîî
);

200 
	}
}

202 
QuadRídîî
*

203 
	$InôQuadRídîî
(
Rídîî
* 
ªndîî
, 
Mem‹yAª«
* 
¨ía
) {

204 
QuadRídîî
* 
ªsu…
 = 
	`PushSåu˘
(
¨ía
, QuadRenderer);

206 
	`CompûeQuadShadî
(
ªsu…
, 
ªndîî
);

207 
	`CompûeTextuªdQuadShadî
(
ªsu…
, 
ªndîî
);

208  
ªsu…
;

209 
	}
}

212 
	$PushRídîQuad
(
Quad
* 
quad
, 
Vec4
 
cﬁ‹
, 
QuadRídîî
* 
quad_ªndîî
) {

213 
	`As£π
(
quad_ªndîî
->
quad_cou¡
 <
MAX_QUADS
);

214 
RídîQuad
 
ªndî_quad
 = { *
quad
, 
cﬁ‹
 };

215 
quad_ªndîî
->
quads
[quad_ªndîî->
quad_cou¡
++] = 
ªndî_quad
;

216 
	}
}

219 
	$PushTextuªdQuad
(
Quad
* 
quad
, 
RídîBuf„r
* 
ãxtuª_buf„r
, 
QuadRídîî
* 
quad_ªndîî
) {

220 
	`As£π
(
quad_ªndîî
->
ãxtuªd_quad_cou¡
 <
MAX_TEXTURED_QUADS
);

221 
Vec2
* 
ãxco‹ds
 = 
quad_ªndîî
->texcoords;

222 
Vec3
* 
posôi⁄s
 = 
quad_ªndîî
->positions;

223 
u32
 
ãxtuªd_quad_cou¡
 = 
quad_ªndîî
->textured_quad_count;

225 
posôi⁄s
[
ãxtuªd_quad_cou¡
*4*3] = 
quad
->
bl
;

226 
ãxco‹ds
[
ãxtuªd_quad_cou¡
*4*2] = 
	`V2
(0.0f, 1.0f);

228 
posôi⁄s
[
ãxtuªd_quad_cou¡
*4+1] = 
quad
->
br
;

229 
ãxco‹ds
[
ãxtuªd_quad_cou¡
*4+1] = 
	`V2
(1.0f, 1.0f);

231 
posôi⁄s
[
ãxtuªd_quad_cou¡
*4+2] = 
quad
->
é
;

232 
ãxco‹ds
[
ãxtuªd_quad_cou¡
*4+2] = 
	`V2
(0.0f, 0.0f);

234 
posôi⁄s
[
ãxtuªd_quad_cou¡
*4+3] = 
quad
->
å
;

235 
ãxco‹ds
[
ãxtuªd_quad_cou¡
*4+3] = 
	`V2
(1.0f, 0.0f);

237 
quad_ªndîî
->
ãxtuªs
[quad_ªndîî->
ãxtuªd_quad_cou¡
++] = 
ãxtuª_buf„r
;

238 
	}
}

241 
	$PushRídîLöe
(
Löe
* 
löe
, 
Vec4
 
cﬁ‹
, 
thick√ss
, 
Camîa
* 
ˇmîa
, 
QuadRídîî
* 
quad_ªndîî
) {

242 
Vec3
 
löe_unô_ve˘‹
 = 
	`V3N‹m
(
	`V3Sub
(
löe
->
íd
,Üöe->
°¨t
));

243 
Vec3
 
ˇmîa_f‹w¨d
 = 
	`GëF‹w¨dVe˘‹
(
ˇmîa
->
rŸ©i⁄
);

244 
Vec3
 
≥Ω
 = 
	`V3Cross
(
ˇmîa_f‹w¨d
, 
löe_unô_ve˘‹
);

246 
Quad
 
quad
 = 
	`MakeQuadFromLöe
(
löe
, 
thick√ss
, 
≥Ω
);

248 
	`PushRídîQuad
(&
quad
, 
cﬁ‹
, 
quad_ªndîî
);

249 
	}
}

252 
	$QuadRídîîFøme
(
QuadRídîî
* 
quad_ªndîî
, 
Camîa
* 
ˇm
, 
Rídîî
* 
ªndîî
) {

253 
M©4
* 
vp
 = 
	`PushSåu˘
(&
ªndîî
->
å™sõ¡
, Mat4);

254 *
vp
 = 
	`MakeVõwPî•e˘ive
(
ˇm
);

256 
RídîPùñöe
 
Ω
 = {};

257 
Ω
.
rs
 = 
	`RídîSèãDeÁu…s
();

258 
Ω
.
rs
.r†
RASTERIZER_STATE_DOUBLE_SIDED
;

259 
Ω
.
rs
.
bs
 = 
BLEND_STATE_ENABLED
;

260 
Ω
.
dc
.
ty≥
 = 
DRAW_CALL_VERTICES
;

261 
Ω
.
dc
.
vîti˚s_cou¡
 = 
quad_ªndîî
->
quad_cou¡
 * 6;

262 
Ω
.
vs
 = 
quad_ªndîî
->
quad_vs
;

263 
Ω
.
ps
 = 
quad_ªndîî
->
quad_ps
;

265 
Ω
.
vrbd_cou¡
 = 2;

266 
Ω
.
vrbd
 = 
	`PushAºay
(&
ªndîî
->
å™sõ¡
, 
PushRídîBuf„rD©a
,Ñp.
vrbd_cou¡
);

268 
Ω
.
vrbd
[0].
ty≥
 = 
RENDER_BUFFER_TYPE_CONSTANTS
;

269 
Ω
.
vrbd
[0].
c⁄°™ts
.
¶Ÿ
 = 
CONSTANTS_BINDING_SLOT_CAMERA
;

270 
Ω
.
vrbd
[0].
c⁄°™ts
.
d©a
 = 
vp
;

272 
Ω
.
vrbd
[1].
ty≥
 = 
RENDER_BUFFER_TYPE_STRUCTURED
;

273 
Ω
.
vrbd
[1].
°ru˘uªd
.
¶Ÿ
 = 
STRUCTURED_BINDING_SLOT_FRAME
;

274 
Ω
.
vrbd
[1].
°ru˘uªd
.
cou¡
 = 
quad_ªndîî
->
quad_cou¡
;

275 
Ω
.
vrbd
[1].
°ru˘uªd
.
d©a
 = 
quad_ªndîî
->
quads
;

277 if(
quad_ªndîî
->
quad_cou¡
Ë
	`AddToRídîQueue
(
Ω
, 
ªndîî
);

279 if(
quad_ªndîî
->
ãxtuªd_quad_cou¡
) {

280 
Ω
.
rs
.
t›ﬁogy
 = 
D3D_PRIMITIVE_TOPOLOGY_TRIANGLESTRIP
;

281 
Ω
.
dc
.
ty≥
 = 
DRAW_CALL_NONE
;

282 
Ω
.
vs
 = 
quad_ªndîî
->
ãxtuªd_quad_vs
;

283 
Ω
.
ps
 = 
quad_ªndîî
->
ãxtuªd_quad_ps
;

285 
Ω
.
vrbg
 = 
quad_ªndîî
->
vîãx_buf„rs
;

287 
Ω
.
vrbd_cou¡
 = 3;

288 
Ω
.
vrbd
 = 
	`PushAºay
(&
ªndîî
->
å™sõ¡
, 
PushRídîBuf„rD©a
,Ñp.
vrbd_cou¡
);

290 
Ω
.
vrbd
[0].
ty≥
 = 
RENDER_BUFFER_TYPE_CONSTANTS
;

291 
Ω
.
vrbd
[0].
c⁄°™ts
.
¶Ÿ
 = 
CONSTANTS_BINDING_SLOT_CAMERA
;

292 
Ω
.
vrbd
[0].
c⁄°™ts
.
d©a
 = 
vp
;

294 
Ω
.
vrbd
[1].
ty≥
 = 
RENDER_BUFFER_TYPE_VERTEX
;

295 
Ω
.
vrbd
[1].
vîãx
.
ty≥
 = 
VERTEX_BUFFER_POSITION
;

296 
Ω
.
vrbd
[1].
vîãx
.
d©a
 = 
quad_ªndîî
->
posôi⁄s
;

297 
Ω
.
vrbd
[1].
vîãx
.
vîti˚s_cou¡
 = 
quad_ªndîî
->
ãxtuªd_quad_cou¡
*4;

299 
Ω
.
vrbd
[2].
ty≥
 = 
RENDER_BUFFER_TYPE_VERTEX
;

300 
Ω
.
vrbd
[2].
vîãx
.
ty≥
 = 
VERTEX_BUFFER_TEXCOORD
;

301 
Ω
.
vrbd
[2].
vîãx
.
d©a
 = 
quad_ªndîî
->
ãxco‹ds
;

302 
Ω
.
vrbd
[2].
vîãx
.
vîti˚s_cou¡
 = 
quad_ªndîî
->
ãxtuªd_quad_cou¡
*4;

304 
	`AddToRídîQueue
(
Ω
, 
ªndîî
);

306 
Ω
 = {};

307 
Ω
.
rs
.
t›ﬁogy
 = 
D3D_PRIMITIVE_TOPOLOGY_TRIANGLESTRIP
;

308 
Ω
.
dc
.
ty≥
 = 
DRAW_CALL_VERTICES
;

309 
Ω
.
vs
 = 
quad_ªndîî
->
ãxtuªd_quad_vs
;

310 
Ω
.
ps
 = 
quad_ªndîî
->
ãxtuªd_quad_ps
;

312 
Ω
.
dc
.
vîti˚s_cou¡
 = 4;

313 
u32
 
i
=0; i<
quad_ªndîî
->
ãxtuªd_quad_cou¡
; i++) {

315 
RídîBuf„rGroup
* 
buf„r_group
 = 
	`PushSåu˘
(&
ªndîî
->
å™sõ¡
, RenderBufferGroup);

316 
buf„r_group
->
cou¡
 = 1;

317 
buf„r_group
->
rb
 = 
quad_ªndîî
->
ãxtuªs
[
i
];

319 
Ω
.
dc
.
off£t
 = 
i
*4;

320 
Ω
.
¥bg
 = 
buf„r_group
;

321 
	`AddToRídîQueue
(
Ω
, 
ªndîî
);

325 
quad_ªndîî
->
quad_cou¡
 = 0;

326 
quad_ªndîî
->
ãxtuªd_quad_cou¡
 = 0;

327 
	}
}

	@renderer.cpp

1 
	~"ªndîî.h
"

4 
	$RídîîBegöFøme
(
Rídîî
* 
ªndîî
, 
WödowDimísi⁄s
 
wd
) {

5 
ªndîî
->
vp
[
VIEWPORT_DEFAULT
].
Width
 = 
wd
.
width
;

6 
ªndîî
->
vp
[
VIEWPORT_DEFAULT
].
Height
 = 
wd
.
height
;

8 
cﬁ‹
[4] = { 0.25f, 0.25f, 0.25f, 1.0f };

9 
ªndîî
->
c⁄ãxt
->
	`CÀ¨RídîT¨gëVõw
‘ídîî->
πv
, 
cﬁ‹
);

10 
ªndîî
->
c⁄ãxt
->
	`CÀ¨DïthSãncûVõw
‘ídîî->
dsv
, 
D3D11_CLEAR_DEPTH
, 1.0f, 0);

11 
ªndîî
->
c⁄ãxt
->
	`OMSëRídîT¨gës
(1, &ªndîî->
πv
,Ñídîî->
dsv
);

12 
ªndîî
->
c⁄ãxt
->
	`PSSëSam∂îs
(0, 1, &ªndîî->
ss
[
SAMPLER_STATE_DEFAULT
]);

13 
	}
}

17 
	$PushC⁄°™tsD©a
(* 
d©a
, 
C⁄°™tsBuf„r
* 
cb
, 
ID3D11Devi˚C⁄ãxt
* 
c⁄ãxt
) {

18 
	`As£π
(
d©a
);

19 
	`As£π
(
cb
->
buf„r
);

21 
D3D11_MAPPED_SUBRESOURCE
 
m§
 = {};

23 
c⁄ãxt
->
	`M≠
(
cb
->
buf„r
, 0, 
D3D11_MAP_WRITE_DISCARD
, 0, &
m§
);

24 
	`mem˝y
(
m§
.
pD©a
, 
d©a
, 
cb
->
size
);

25 
c⁄ãxt
->
	`Unm≠
(
cb
->
buf„r
, 0);

27 
d©a
 = 
nuŒ±r
;

28 
	}
}

31 
	$PushSåu˘uªdD©a
(
PushSåu˘uªdBuf„rD©a
* 
sb_d©a
, 
Såu˘uªdBuf„r
* 
sb
, 
ID3D11Devi˚C⁄ãxt
* 
c⁄ãxt
) {

32 
	`As£π
(
sb_d©a
->
d©a
);

33 
	`As£π
(
sb
->
buf„r
);

35 
D3D11_MAPPED_SUBRESOURCE
 
m§
 = {};

37 
c⁄ãxt
->
	`M≠
(
sb
->
buf„r
, 0, 
D3D11_MAP_WRITE_DISCARD
, 0, &
m§
);

38 
	`C›yMem
(
m§
.
pD©a
, 
sb_d©a
->
d©a
, 
sb
->
°ru˘_size
*sb_d©a->
cou¡
);

39 
c⁄ãxt
->
	`Unm≠
(
sb
->
buf„r
, 0);

41 
sb_d©a
->
d©a
 = 
nuŒ±r
;

42 
	}
}

45 
	$PushIndexD©a
(
PushIndexBuf„rD©a
* 
d©a
, 
IndexBuf„r
* 
ib
, 
ID3D11Devi˚C⁄ãxt
* 
c⁄ãxt
) {

46 
	`As£π
(
d©a
);

47 
	`As£π
(
ib
->
buf„r
);

49 
D3D11_MAPPED_SUBRESOURCE
 
m§
 = {};

51 
c⁄ãxt
->
	`M≠
(
ib
->
buf„r
, 0, 
D3D11_MAP_WRITE_DISCARD
, 0, &
m§
);

52 
	`C›yMem
(
m§
.
pD©a
, 
d©a
->d©a, (
u32
)*d©a->
ödi˚s_cou¡
);

53 
c⁄ãxt
->
	`Unm≠
(
ib
->
buf„r
, 0);

55 
d©a
 = 
nuŒ±r
;

56 
	}
}

59 
	$PushVîãxD©a
(
PushVîãxBuf„rD©a
* 
d©a
, 
VîãxBuf„r
* 
vb
, 
ID3D11Devi˚C⁄ãxt
* 
c⁄ãxt
) {

60 
	`As£π
(
d©a
);

61 
	`As£π
(
vb
->
buf„r
);

63 
D3D11_MAPPED_SUBRESOURCE
 
m§
 = {};

65 
c⁄ãxt
->
	`M≠
(
vb
->
buf„r
, 0, 
D3D11_MAP_WRITE_DISCARD
, 0, &
m§
);

66 
	`C›yMem
(
m§
.
pD©a
, 
d©a
->d©a, 
vb
->
°ride
*d©a->
vîti˚s_cou¡
);

67 
c⁄ãxt
->
	`Unm≠
(
vb
->
buf„r
, 0);

69 
d©a
 = 
nuŒ±r
;

70 
	}
}

73 
	$ExecuãRídîPùñöe
(
RídîPùñöe
 
Ω
, 
Rídîî
* 
ªndîî
) {

74 if(
Ω
.
rs
.
comm™d
 =
RENDER_COMMAND_CLEAR_DEPTH_STENCIL
)

75 
ªndîî
->
c⁄ãxt
->
	`CÀ¨DïthSãncûVõw
‘ídîî->
dsv
, 
D3D11_CLEAR_DEPTH
, 1.0f, 0);

77 
DEPTH_STENCIL_STATE
 
dss_t
 = 
ªndîî
->
°©e_ovîrides
.
dss
 ?Ñídîî->°©e_ovîrides.ds†: 
Ω
.
rs
.dss;

78 
BLEND_STATE
 
bs_t
 = 
ªndîî
->
°©e_ovîrides
.
bs
 ?Ñídîî->°©e_ovîrides.b†: 
Ω
.
rs
.bs;

79 
RASTERIZER_STATE
 
rs_t
 = 
ªndîî
->
°©e_ovîrides
.
rs
 ?Ñídîî->°©e_ovîrides.r†: 
Ω
.rs.rs;

80 
VIEWPORT
 
vp_t
 = 
ªndîî
->
°©e_ovîrides
.
vp
 ?Ñídîî->°©e_ovîrides.v∞: 
Ω
.
rs
.vp;

82 if(
Ω
.
rs
.
dss
) {

83 
ID3D11DïthSãncûSèã
* 
dss
 = 
ªndîî
->dss[
dss_t
];

84 
ªndîî
->
c⁄ãxt
->
	`OMSëDïthSãncûSèã
(
dss
, 0);

87 if(
Ω
.
rs
.
bs
) {

88 
ID3D11BÀndSèã
* 
bs
 = 
ªndîî
->bs[
bs_t
];

89 
vÆ
[4] = { 1.0f, 1.0f, 1.0f, 1.0f };

90 
ªndîî
->
c⁄ãxt
->
	`OMSëBÀndSèã
(
bs
, 
vÆ
, 0xFFFFFFFF);

93 if(
Ω
.
rs
.rs) {

94 
ID3D11Ra°îizîSèã
* 
rs
 = 
ªndîî
->rs[
rs_t
];

95 
ªndîî
->
c⁄ãxt
->
	`RSSëSèã
(
rs
);

98 if(
Ω
.
rs
.
vp
) {

99 
D3D11_VIEWPORT
 
vp
 = 
ªndîî
->vp[
vp_t
];

100 
ªndîî
->
c⁄ãxt
->
	`RSSëVõwp‹ts
(1, &
vp
);

101 
D3D11_RECT
 
ª˘
 = {};

102 
ª˘
.
right
 = 
vp
.
Width
;

103 
ª˘
.
bŸtom
 = 
vp
.
Height
;

104 
ªndîî
->
c⁄ãxt
->
	`RSSëSciss‹Re˘s
(1, &
ª˘
);

106 
ªndîî
->
c⁄ãxt
->
	`IASëPrimôiveT›ﬁogy
(
Ω
.
rs
.
t›ﬁogy
);

108 if(
Ω
.
ps
) {

109 
PixñShadî
* 
ps
 = 
Ω
.ps;

110 
ªndîî
->
c⁄ãxt
->
	`PSSëShadî
(
ps
->
shadî
, 
nuŒ±r
, 0);

111 
u8
 
i
=0; i<
ps
->
rb_cou¡
; i++)

112 if(
ps
->
rb
[
i
].
ty≥
 =
RENDER_BUFFER_TYPE_CONSTANTS
)

113 
ªndîî
->
c⁄ãxt
->
	`PSSëC⁄°™tBuf„rs
(
ps
->
rb
[
i
].
c⁄°™ts
.
¶Ÿ
, 1, &ps->rb[i].c⁄°™ts.
buf„r
);

115 
u8
 
i
=0; i<
Ω
.
¥bd_cou¡
; i++)

116 if(
Ω
.
¥bd
[
i
].
ty≥
 =
RENDER_BUFFER_TYPE_CONSTANTS
)

117 
u8
 
j
=0; j<
ps
->
rb_cou¡
; j++)

118 if(
ps
->
rb
[
j
].
ty≥
 =
RENDER_BUFFER_TYPE_CONSTANTS
)

119 if(
Ω
.
¥bd
[
i
].
c⁄°™ts
.
¶Ÿ
 =
ps
->
rb
[
j
].constants.slot)

120 
	`PushC⁄°™tsD©a
(
Ω
.
¥bd
[
i
].
c⁄°™ts
.
d©a
, &
ps
->
rb
[
j
].c⁄°™ts, 
ªndîî
->
c⁄ãxt
);

122 
RídîBuf„rGroup
* 
rbg
 = 
Ω
.
¥bg
;

123 if(
rbg
) {

124 
u8
 
i
=0; i<
ps
->
ãxtuª_cou¡
; i++) {

125 
boﬁ
 
found
 = 
Ál£
;

126 
u8
 
j
=0; j<
rbg
->
cou¡
; j++) {

127 if(
ps
->
ãxtuª_¶Ÿ
[
i
] =
rbg
->
rb
[i].
ãxtuª
.
¶Ÿ
) {

128 
found
 = 
åue
;

129 
ªndîî
->
c⁄ãxt
->
	`PSSëShadîResour˚s
(
rbg
->
rb
[
i
].
ãxtuª
.
¶Ÿ
, 1, &rbg->rb[i].ãxtuª.
võw
);

132 
	`As£π
(
found
);

137 if(
Ω
.
vs
) {

138 
VîãxShadî
* 
vs
 = 
Ω
.vs;

139 
RídîBuf„r
* 
vrb
 = 
vs
->
rb
;

140 
u8
 
vrb_cou¡
 = 
vs
->
rb_cou¡
;

142 
ªndîî
->
c⁄ãxt
->
	`VSSëShadî
(
vs
->
shadî
, 
nuŒ±r
, 0);

143 
ªndîî
->
c⁄ãxt
->
	`IASëI≈utLayout
(
vs
->
û
);

145 
u8
 
i
=0; i<
vrb_cou¡
; i++) {

146 if(
vrb
[
i
].
ty≥
 =
RENDER_BUFFER_TYPE_CONSTANTS
)

147 
ªndîî
->
c⁄ãxt
->
	`VSSëC⁄°™tBuf„rs
(
vrb
[
i
].
c⁄°™ts
.
¶Ÿ
, 1, &vrb[i].c⁄°™ts.
buf„r
);

148 if(
vrb
[
i
].
ty≥
 =
RENDER_BUFFER_TYPE_STRUCTURED
)

149 
ªndîî
->
c⁄ãxt
->
	`VSSëShadîResour˚s
(
vrb
[
i
].
°ru˘uªd
.
¶Ÿ
, 1, &vrb[i].°ru˘uªd.
võw
);

152 
PushRídîBuf„rD©a
* 
d©a
 = 
Ω
.
vrbd
;

153 
u8
 
d©a_cou¡
 = 
Ω
.
vrbd_cou¡
;

155 
RídîBuf„rGroup
* 
rbg
 = 
Ω
.
vrbg
;

157 
u8
 
i
=0; i<
d©a_cou¡
; i++) {

158 
d©a
[
i
].
ty≥
) {

159 
RENDER_BUFFER_TYPE_CONSTANTS
: {

160 
u8
 
j
=0; j<
vrb_cou¡
; j++) {

162 if(
vrb
[
j
].
ty≥
 =
RENDER_BUFFER_TYPE_CONSTANTS
 &&

163 
d©a
[
i
].
c⁄°™ts
.
¶Ÿ
 =
vrb
[
j
].constants.slot)

165 
	`PushC⁄°™tsD©a
(
d©a
[
i
].
c⁄°™ts
.d©a, &
vrb
[
j
].c⁄°™ts, 
ªndîî
->
c⁄ãxt
);

169 
RENDER_BUFFER_TYPE_STRUCTURED
: {

170 
u8
 
j
=0; j<
vrb_cou¡
; j++) {

172 if(
vrb
[
j
].
ty≥
 =
RENDER_BUFFER_TYPE_STRUCTURED
 &&

173 
d©a
[
i
].
°ru˘uªd
.
¶Ÿ
 =
vrb
[
j
].structured.slot)

175 
	`PushSåu˘uªdD©a
(&
d©a
[
i
].
°ru˘uªd
, &
vrb
[
j
].°ru˘uªd, 
ªndîî
->
c⁄ãxt
);

179 
RENDER_BUFFER_TYPE_VERTEX
: {

180 
u8
 
j
=0; j<
rbg
->
cou¡
; j++) {

182 if(
rbg
->
rb
[
j
].
ty≥
 =
RENDER_BUFFER_TYPE_VERTEX
 &&

183 
d©a
[
i
].
vîãx
.
ty≥
 =
rbg
->
rb
[
j
].vertex.type)

185 
	`PushVîãxD©a
(&
d©a
[
i
].
vîãx
, &
rbg
->
rb
[
j
].vîãx, 
ªndîî
->
c⁄ãxt
);

189 
RENDER_BUFFER_TYPE_INDEX
: {

190 
u8
 
j
=0; j<
rbg
->
cou¡
; j++) {

192 if(
rbg
->
rb
[
j
].
ty≥
 =
RENDER_BUFFER_TYPE_INDEX
)

193 
	`PushIndexD©a
(&
d©a
[
i
].
ödex
, &
rbg
->
rb
[
j
].ödex, 
ªndîî
->
c⁄ãxt
);

200 if(
Ω
.
vrbg
) {

201 
u8
 
i
=0; i<
vs
->
vb_cou¡
; i++) {

202 
boﬁ
 
found
 = 
Ál£
;

203 
u8
 
j
=0; j<
rbg
->
cou¡
; j++) {

204 if(
rbg
->
rb
[
j
].
ty≥
 =
RENDER_BUFFER_TYPE_VERTEX
 &&Ñbg->rb[j].
vîãx
.ty≥ =
vs
->
vb_ty≥
[
i
]) {

205 
found
 = 
åue
; 
u32
 
off£t
 = 0;

206 
ªndîî
->
c⁄ãxt
->
	`IASëVîãxBuf„rs
(
i
, 1, &
rbg
->
rb
[
j
].
vîãx
.
buf„r
, &rbg->rb[j].vîãx.
°ride
, &
off£t
);

209 
	`As£π
(
found
);

212 if(
Ω
.
dc
.
ty≥
 =
DRAW_CALL_DEFAULT
) {

213 
boﬁ
 
has_ödex_buf„r
 = 
Ál£
;

214 
u8
 
i
=0; i<
rbg
->
cou¡
; i++) {

215 if(
rbg
->
rb
[
i
].
ty≥
 =
RENDER_BUFFER_TYPE_INDEX
) {

216 
ªndîî
->
c⁄ãxt
->
	`IASëIndexBuf„r
(
rbg
->
rb
[
i
].
ödex
.
buf„r
, 
DXGI_FORMAT_R32_UINT
, 0);

217 
has_ödex_buf„r
 = 
åue
;

218 
ªndîî
->
c⁄ãxt
->
	`DøwIndexed
(
rbg
->
rb
[
i
].
ödex
.
num_ödi˚s
, 0, 0);

222 if(!
has_ödex_buf„r
) {

223 
u8
 
i
=0; i<
rbg
->
cou¡
; i++)

224 if(
rbg
->
rb
[
i
].
ty≥
 =
RENDER_BUFFER_TYPE_VERTEX
) {

225 
ªndîî
->
c⁄ãxt
->
	`Døw
(
rbg
->
rb
[
i
].
vîãx
.
vîti˚s_cou¡
, 0);

235 if(
Ω
.
dc
.
ty≥
 =
DRAW_CALL_INDEXED
)

236 
ªndîî
->
c⁄ãxt
->
	`DøwIndexed
(
Ω
.
dc
.
ödi˚s_cou¡
,Ñp.dc.
off£t
, 0);

237 if(
Ω
.
dc
.
ty≥
 =
DRAW_CALL_VERTICES
)

238 
ªndîî
->
c⁄ãxt
->
	`Døw
(
Ω
.
dc
.
vîti˚s_cou¡
,Ñp.dc.
off£t
);

239 if(
Ω
.
dc
.
ty≥
 =
DRAW_CALL_INSTANCED
)

240 
ªndîî
->
c⁄ãxt
->
	`DøwIn°™˚d
(
Ω
.
dc
.
vîti˚s_cou¡
,Ñp.dc.
ö°™˚_cou¡
, 0, 0);

242 
	}
}

245 
	$RídîîFøme
(
Rídîî
* 
ªndîî
) {

246 
u32
 
i
=0; i<
ªndîî
->
rq_id
; i++Ë
	`ExecuãRídîPùñöe
‘ídîî->
rq
[i],Ñenderer);

247 
	}
}

250 
	$RídîîEndFøme
(
Rídîî
* 
ªndîî
) {

251 
ªndîî
->
sw≠chaö
->
	`Pª£¡
(0, 0);

252 
ªndîî
->
å™sõ¡
.
u£d
 = 0;

253 
ªndîî
->
rq_id
 = 0;

254 
	}
}

257 
	$MakeD3DI≈utEÀmítDesc
(
VERTEX_BUFFER
* 
vb_ty≥
, 
D3D11_INPUT_ELEMENT_DESC
* 
d3d_û_desc
, 
u8
 
cou¡
) {

258 
u32
 
i
 = 0; i < 
cou¡
; i++) {

259 
DXGI_FORMAT
 
f‹m©
;

260 i‡(
vb_ty≥
[
i
] =
VERTEX_BUFFER_POSITION
Ë
f‹m©
 = 
DXGI_FORMAT_R32G32B32_FLOAT
;

261 i‡(
vb_ty≥
[
i
] =
VERTEX_BUFFER_NORMAL
Ë
f‹m©
 = 
DXGI_FORMAT_R32G32B32_FLOAT
;

262 i‡(
vb_ty≥
[
i
] =
VERTEX_BUFFER_COLOR
Ë
f‹m©
 = 
DXGI_FORMAT_R32G32B32_FLOAT
;

264 i‡(
vb_ty≥
[
i
] =
VERTEX_BUFFER_TEXCOORD
Ë
f‹m©
 = 
DXGI_FORMAT_R32G32_FLOAT
;

265 
	`As£π
(
Ál£
);

267 
d3d_û_desc
[
i
] = { 
vîãx_buf„r_«mes
[
vb_ty≥
[i]], 0, 
f‹m©
, i, 0, 
D3D11_INPUT_PER_VERTEX_DATA
, 0 };

269 
	}
}

272 
C⁄°™tsBuf„r


273 
	$U∂ﬂdC⁄°™tsBuf„r
(
C⁄°™tsBuf„rDesc
 
desc
, 
ID3D11Devi˚
* 
devi˚
) {

274 
HRESULT
 
hr
 = {};

275 
C⁄°™tsBuf„r
 
cb
 = {};

276 
ID3D11Buf„r
* 
buf„r
 = 0;

278 
desc
.
size
 += (16 - (desc.size % 16));

279 
D3D11_BUFFER_DESC
 
cb_desc
 = {};

280 
cb_desc
.
ByãWidth
 = 
desc
.
size
;

281 
cb_desc
.
Ußge
 = 
D3D11_USAGE_DYNAMIC
;

282 
cb_desc
.
BödFœgs
 = 
D3D11_BIND_CONSTANT_BUFFER
;

283 
cb_desc
.
CPUAc˚ssFœgs
 = 
D3D11_CPU_ACCESS_WRITE
;

284 
hr
 = 
devi˚
->
	`Cª©eBuf„r
(&
cb_desc
, 
nuŒ±r
, &
buf„r
);

286 
	`As£πHR
(
hr
);

288 
cb
.
buf„r
 = buffer;

289 
cb
.
¶Ÿ
 = 
desc
.slot;

290 
cb
.
size
 = 
desc
.size;

291  
cb
;

292 
	}
}

295 
Såu˘uªdBuf„r


296 
	$U∂ﬂdSåu˘uªdBuf„r
(
Såu˘uªdBuf„rDesc
 
desc
, 
ID3D11Devi˚
* 
devi˚
) {

297 
HRESULT
 
hr
 = {};

298 
Såu˘uªdBuf„r
 
sb
 = {};

300 
ID3D11Buf„r
* 
buf„r
 = 0;

301 
ID3D11ShadîResour˚Võw
* 
võw
 = 0;

303 
D3D11_BUFFER_DESC
 
buf„r_desc
 = {};

304 
buf„r_desc
.
ByãWidth
 = 
desc
.
°ru˘_size_ö_byãs
 * desc.
cou¡
;

305 
buf„r_desc
.
Ußge
 = 
D3D11_USAGE_DYNAMIC
;

306 
buf„r_desc
.
BödFœgs
 = 
D3D11_BIND_SHADER_RESOURCE
;

307 
buf„r_desc
.
CPUAc˚ssFœgs
 = 
D3D11_CPU_ACCESS_WRITE
;

308 
buf„r_desc
.
MiscFœgs
 = 
D3D11_RESOURCE_MISC_BUFFER_STRUCTURED
;

309 
buf„r_desc
.
Såu˘uªByãSåide
 = 
desc
.
°ru˘_size_ö_byãs
;

311 
hr
 = 
devi˚
->
	`Cª©eBuf„r
(&
buf„r_desc
, 
NULL
, &
buf„r
);

312 
	`As£πHR
(
hr
);

314 
D3D11_SHADER_RESOURCE_VIEW_DESC
 
võw_desc
 = {};

315 
võw_desc
.
F‹m©
 = 
DXGI_FORMAT_UNKNOWN
;

316 
võw_desc
.
VõwDimísi⁄
 = 
D3D11_SRV_DIMENSION_BUFFER
;

317 
võw_desc
.
Buf„r
.
EÀmítOff£t
 = 0;

318 
võw_desc
.
Buf„r
.
EÀmítWidth
 = 
desc
.
cou¡
;

320 
hr
 = 
devi˚
->
	`Cª©eShadîResour˚Võw
(
buf„r
, &
võw_desc
, &
võw
);

321 
	`As£πHR
(
hr
);

323 
sb
.
¶Ÿ
 = 
desc
.slot;

324 
sb
.
buf„r
 = buffer;

325 
sb
.
võw
 = view;

326 
sb
.
°ru˘_size
 = 
desc
.
°ru˘_size_ö_byãs
;

327 
sb
.
cou¡
 = 
desc
.count;

329  
sb
;

330 
	}
};

332 
boﬁ


333 
	$CompûeShadî
(* 
shadî_code
, 
u32
 
shadî_Àngth
, * 
íåy
, ** 
shadî
, 
ID3DBlob
** 
blob
,

334 
boﬁ
 
vîãx_shadî
, 
Rídîî
* 
ªndîî
) {

335 
HRESULT
 
hr
;

336 
ID3DBlob
* 
îr‹
;

338 if(
vîãx_shadî
)

339 
hr
 = 
	`D3DCompûe
(
shadî_code
, 
shadî_Àngth
, 
nuŒ±r
,ÇuŒ±r,ÇuŒ±r, 
íåy
, "vs_5_0",

340 0, 0, 
blob
, &
îr‹
);

342 
hr
 = 
	`D3DCompûe
(
shadî_code
, 
shadî_Àngth
, 
nuŒ±r
,ÇuŒ±r,ÇuŒ±r, 
íåy
, "ps_5_0",

343 0, 0, 
blob
, &
îr‹
);

345 i‡(
hr
) {

346 * 
msg
 = (*)
îr‹
->
	`GëBuf„rPoöãr
();

347 
	`OuçutDebugSåögA
(
msg
);

348  
Ál£
;

351 if(
vîãx_shadî
)

352 
hr
 = 
ªndîî
->
devi˚
->
	`Cª©eVîãxShadî
(
blob
[0]->
	`GëBuf„rPoöãr
(), blob[0]->
	`GëBuf„rSize
(),

353 
nuŒ±r
, (
ID3D11VîãxShadî
**)
shadî
);

355 
hr
 = 
ªndîî
->
devi˚
->
	`Cª©ePixñShadî
(
blob
[0]->
	`GëBuf„rPoöãr
(), blob[0]->
	`GëBuf„rSize
(),

356 
nuŒ±r
, (
ID3D11PixñShadî
**)
shadî
);

358 if(
hr
Ë 
Ál£
;

360  
åue
;

361 
	}
};

364 
PixñShadî
*

365 
	$U∂ﬂdPixñShadî
(
PixñShadîDesc
 
desc
, 
Rídîî
* 
ªndîî
) {

366 
HRESULT
 
hr
 = {};

368 
PixñShadî
* 
ps
 = 
	`PushSåu˘
(&
ªndîî
->
≥rm™ít
, PixelShader);

369 
ID3D11PixñShadî
* 
shadî
;

370 
ID3DBlob
* 
blob
;

371 
TEXTURE_SLOT
* 
ãxtuª_¶Ÿ
 = 
nuŒ±r
;

373 
u8
 
rb_cou¡
 = 
desc
.
cb_cou¡
;

374 
RídîBuf„r
* 
rb
 = 
	`PushAºay
(&
ªndîî
->
≥rm™ít
, RídîBuf„r, 
rb_cou¡
);

376 
	`As£π
(
	`CompûeShadî
(
desc
.
shadî
.
code
, desc.shadî.
size
, desc.shadî.
íåy
, (**)&shader,

377 &
blob
, 
Ál£
, 
ªndîî
));

379 
u8
 
i
=0; i<
desc
.
cb_cou¡
; i++) {

380 
rb
[
i
].
ty≥
 = 
RENDER_BUFFER_TYPE_CONSTANTS
;

381 
rb
[
i
].
c⁄°™ts
 = 
	`U∂ﬂdC⁄°™tsBuf„r
(
desc
.
cb_desc
[i], 
ªndîî
->
devi˚
);

384 if(
desc
.
ãxtuª_cou¡
) {

385 
ãxtuª_¶Ÿ
 = 
	`PushAºay
(&
ªndîî
->
≥rm™ít
, 
TEXTURE_SLOT
, 
desc
.
ãxtuª_cou¡
);

386 
	`mem˝y
(
ãxtuª_¶Ÿ
, 
desc
.ãxtuª_¶Ÿ, (
TEXTURE_SLOT
)*desc.
ãxtuª_cou¡
);

389 
ps
->
shadî
 = shader;

390 
ps
->
rb
 =Ñb;

391 
ps
->
ãxtuª_¶Ÿ
 =Åexture_slot;

392 
ps
->
rb_cou¡
 =Ñb_count;

393 
ps
->
ãxtuª_cou¡
 = 
desc
.texture_count;

395  
ps
;

396 
	}
}

399 
VîãxShadî
*

400 
	$U∂ﬂdVîãxShadî
(
VîãxShadîDesc
 
desc
, 
Rídîî
* 
ªndîî
) {

401 
HRESULT
 
hr
 = {};

403 
VîãxShadî
* 
vs
 = 
	`PushSåu˘
(&
ªndîî
->
≥rm™ít
, VertexShader);

404 
ID3D11VîãxShadî
* 
shadî
 = 0;

405 
ID3D11I≈utLayout
* 
û
 = 0;

406 
ID3DBlob
* 
blob
 = 0;

407 
VERTEX_BUFFER
* 
vb_ty≥
 = 0;

409 
u8
 
rb_cou¡
 = 
desc
.
cb_cou¡
 + desc.
sb_cou¡
;

410 
RídîBuf„r
* 
rb
 = 
	`PushAºay
(&
ªndîî
->
≥rm™ít
, RídîBuf„r, 
rb_cou¡
);

412 
	`As£π
(
	`CompûeShadî
(
desc
.
shadî
.
code
, desc.shadî.
size
, desc.shadî.
íåy
, (**)&shader,

413 &
blob
, 
åue
, 
ªndîî
));

415 if(
desc
.
vb_cou¡
) {

416 
D3D11_INPUT_ELEMENT_DESC
* 
õ_desc
 = 
	`PushAºay
(&
ªndîî
->
å™sõ¡
, D3D11_INPUT_ELEMENT_DESC, 
desc
.
vb_cou¡
);

417 
	`MakeD3DI≈utEÀmítDesc
(
desc
.
vb_ty≥
, 
õ_desc
, desc.
vb_cou¡
);

419 
hr
 = 
ªndîî
->
devi˚
->
	`Cª©eI≈utLayout
(
õ_desc
, 
desc
.
vb_cou¡
, 
blob
->
	`GëBuf„rPoöãr
(), blob->
	`GëBuf„rSize
(), &
û
);

421 
vb_ty≥
 = 
	`PushAºay
(&
ªndîî
->
≥rm™ít
, 
VERTEX_BUFFER
, 
desc
.
vb_cou¡
);

422 
	`mem˝y
(
vb_ty≥
, 
desc
.vb_ty≥, (
VERTEX_BUFFER
)*desc.
vb_cou¡
);

423 
	`As£πHR
(
hr
);

424 
	`P›Aºay
(&
ªndîî
->
å™sõ¡
, 
D3D11_INPUT_ELEMENT_DESC
, 
desc
.
vb_cou¡
);

427 
u8
 
i
=0;

428 
i
=0; i<
desc
.
cb_cou¡
; i++) {

429 
rb
[
i
].
ty≥
 = 
RENDER_BUFFER_TYPE_CONSTANTS
;

430 
rb
[
i
].
c⁄°™ts
 = 
	`U∂ﬂdC⁄°™tsBuf„r
(
desc
.
cb_desc
[i], 
ªndîî
->
devi˚
);

433 
u8
 
j
=0; j<
desc
.
sb_cou¡
; j++) {

434 
rb
[
i
+
j
].
ty≥
 = 
RENDER_BUFFER_TYPE_STRUCTURED
;

435 
rb
[
i
+
j
].
°ru˘uªd
 = 
	`U∂ﬂdSåu˘uªdBuf„r
(
desc
.
sb_desc
[j], 
ªndîî
->
devi˚
);

438 
vs
->
shadî
 = shader;

439 
vs
->
û
 = il;

440 
vs
->
vb_ty≥
 = vb_type;

441 
vs
->
rb
 =Ñb;

442 
vs
->
rb_cou¡
 =Ñb_count;

443 
vs
->
vb_cou¡
 = 
desc
.vb_count;

445  
vs
;

446 
	}
}

449 
RídîBuf„r
*

450 
	$U∂ﬂdTextuª
(
TextuªD©a
* 
ãxtuª_d©a
, 
Rídîî
* 
ªndîî
) {

451 
RídîBuf„r
* 
ãxtuª_buf„r
 = 
	`PushSåu˘
(&
ªndîî
->
≥rm™ít
, RenderBuffer);

453 
HRESULT
 
hr
 = {};

454 
ID3D11ShadîResour˚Võw
* 
võw
;

456 
D3D11_TEXTURE2D_DESC
 
desc
 = {};

457 
desc
.
Width
 = 
ãxtuª_d©a
->
width
;

458 
desc
.
Height
 = 
ãxtuª_d©a
->
height
;

459 
desc
.
MùLevñs
 = 1;

460 
desc
.
AºaySize
 = 1;

461 
DXGI_FORMAT
 
f‹m©
;

463 if(
ãxtuª_d©a
->
num_comp⁄íts
 =4Ë
f‹m©
 = 
DXGI_FORMAT_R8G8B8A8_UNORM
;

464 
	`As£π
(
Ál£
);

466 
desc
.
F‹m©
 = 
f‹m©
;

467 
desc
.
Sam∂eDesc
.
Cou¡
 = 1;

468 
desc
.
Ußge
 = 
D3D11_USAGE_IMMUTABLE
;

469 
desc
.
BödFœgs
 = 
D3D11_BIND_SHADER_RESOURCE
;

471 
D3D11_SUBRESOURCE_DATA
 
§
 = {};

472 
§
.
pSysMem
 = 
ãxtuª_d©a
->
pixñs
;

473 
§
.
SysMemPôch
 = 
ãxtuª_d©a
->
width
 *Åextuª_d©a->
num_comp⁄íts
;

475 
ID3D11Textuª2D
* 
buf„r
;

476 
hr
 = 
ªndîî
->
devi˚
->
	`Cª©eTextuª2D
(&
desc
, &
§
, &
buf„r
);

479 
D3D11_SHADER_RESOURCE_VIEW_DESC
 
võw_desc
 = {};

480 
võw_desc
.
F‹m©
 = 
desc
.Format;

481 
võw_desc
.
VõwDimísi⁄
 = 
D3D11_SRV_DIMENSION_TEXTURE2D
;

482 
võw_desc
.
Textuª2D
.
Mo°DëaûedMù
 = 0;

483 
võw_desc
.
Textuª2D
.
MùLevñs
 = (
u32
)-1;

485 
hr
 = 
ªndîî
->
devi˚
->
	`Cª©eShadîResour˚Võw
(
buf„r
, &
võw_desc
, &
võw
);

486 
	`As£πHR
(
hr
);

488 
ãxtuª_buf„r
->
ty≥
 = 
RENDER_BUFFER_TYPE_TEXTURE
;

489 
ãxtuª_buf„r
->
ãxtuª
.
¶Ÿ
 = 
ãxtuª_d©a
->
ty≥
;

490 
ãxtuª_buf„r
->
ãxtuª
.
buf„r
 = buffer;

491 
ãxtuª_buf„r
->
ãxtuª
.
võw
 = view;

492  
ãxtuª_buf„r
;

493 
	}
}

496 
RídîBuf„rGroup
*

497 
	$U∂ﬂdTextuªFromFûe
(* 
fûï©h
, 
TEXTURE_SLOT
 
¶Ÿ
, 
Rídîî
* 
ªndîî
) {

498 
RídîBuf„rGroup
* 
ªsu…
;

499 
x
, 
y
, 
n
;

500 * 
≤g
 = 
	`°bi_lﬂd
(
fûï©h
, &
x
, &
y
, &
n
, 4);

501 
	`As£π
(
≤g
);

503 
TextuªD©a
 
ãxtuª_d©a
 = { 
TEXTURE_SLOT_DIFFUSE
, 
≤g
, (
u32
)
x
, (u32)
y
, 4 };

505 
RídîBuf„r
* 
rb
 = 
	`U∂ﬂdTextuª
(&
ãxtuª_d©a
, 
ªndîî
);

506 
	`STBI_FREE
(
≤g
);

508 
ªsu…
 = 
	`PushSåu˘
(&
ªndîî
->
≥rm™ít
, 
RídîBuf„rGroup
);

509 
ªsu…
->
rb
 =Ñb;

510 
ªsu…
->
cou¡
 = 1;

511  
ªsu…
;

512 
	}
}

515 
VîãxBuf„r


516 
	$U∂ﬂdVîãxBuf„r
(
VîãxBuf„rD©a
 
vb_d©a
, 
u32
 
num_vîti˚s
, 
boﬁ
 
dy«mic
, 
ID3D11Devi˚
* 
devi˚
) {

517 
HRESULT
 
hr
;

518 
VîãxBuf„r
 
vb
 = {};

520 
ID3D11Buf„r
* 
buf„r
;

521 
D3D11_BUFFER_DESC
 
desc
 = {};

522 
u32
 
num_comp⁄íts
 = 0;

523 if(
vb_d©a
.
ty≥
 =
VERTEX_BUFFER_POSITION
Ë
num_comp⁄íts
 = 3;

524 if(
vb_d©a
.
ty≥
 =
VERTEX_BUFFER_COLOR
Ë
num_comp⁄íts
 = 3;

525 if(
vb_d©a
.
ty≥
 =
VERTEX_BUFFER_NORMAL
Ë
num_comp⁄íts
 = 3;

526 if(
vb_d©a
.
ty≥
 =
VERTEX_BUFFER_TEXCOORD
Ë
num_comp⁄íts
 = 2;

527 if(
vb_d©a
.
ty≥
 =
VERTEX_BUFFER_TANGENT
Ë
num_comp⁄íts
 = 4;

528 
	`As£π
(
Ál£
);

530 
u32
 
comp⁄ít_width
 = ();

532 
D3D11_USAGE
 
ußge_Êag
 = 
D3D11_USAGE_IMMUTABLE
;

533 
u32
 
˝u_ac˚ss_Êags
 = 0;

534 if(
dy«mic
) {

535 
ußge_Êag
 = 
D3D11_USAGE_DYNAMIC
;

536 
˝u_ac˚ss_Êags
 |
D3D11_CPU_ACCESS_WRITE
;

539 
desc
.
ByãWidth
 = 
num_comp⁄íts
 * 
comp⁄ít_width
 * 
num_vîti˚s
;

540 
desc
.
Ußge
 = 
ußge_Êag
;

541 
desc
.
BödFœgs
 = 
D3D11_BIND_VERTEX_BUFFER
;

542 
desc
.
CPUAc˚ssFœgs
 = 
˝u_ac˚ss_Êags
;

544 
D3D11_SUBRESOURCE_DATA
 
§
 = {};

545 
§
.
pSysMem
 = 
vb_d©a
.
d©a
;

546 
hr
 = 
devi˚
->
	`Cª©eBuf„r
(&
desc
, &
§
, &
buf„r
);

547 
	`As£πHR
(
hr
);

549 
vb
.
buf„r
 = buffer;

550 
vb
.
°ride
 = 
num_comp⁄íts
 * 
comp⁄ít_width
;

551 
vb
.
ty≥
 = 
vb_d©a
.type;

552 
vb
.
vîti˚s_cou¡
 = 
num_vîti˚s
;

554  
vb
;

555 
	}
}

558 
RídîBuf„rGroup
*

559 
	$U∂ﬂdMesh
(
MeshD©a
* 
mesh_d©a
, 
MeshDesc
* 
mesh_desc
, 
Rídîî
* 
ªndîî
) {

560 
	`As£π
(
mesh_d©a
);

561 
RídîBuf„rGroup
* 
rbg
 = 
	`PushSåu˘
(&
ªndîî
->
≥rm™ít
, RenderBufferGroup);

563 
boﬁ
 
has_ödi˚s
 = 
Ál£
;

564 if(
mesh_d©a
->
ödi˚s
Ë
has_ödi˚s
 = 
åue
;

565 
RídîBuf„r
* 
rb
 = 
	`PushAºay
(&
ªndîî
->
≥rm™ít
, RídîBuf„r, 
mesh_d©a
->
vb_d©a_cou¡
+(
u32
)
has_ödi˚s
);

567 
u8
 
i
=0;

568 
i
=0; i<
mesh_d©a
->
vb_d©a_cou¡
; i++) {

569 
boﬁ
 
dy«mic
 = 
Ál£
;

571 if(
mesh_desc
) {

572 
u8
 
j
=0; j<
mesh_desc
->
vb_cou¡
; j++)

573 if(
mesh_d©a
->
vb_d©a
[
i
].
ty≥
 =
mesh_desc
->
vb_desc
[
j
].type)

574 
dy«mic
 = 
mesh_desc
->
vb_desc
[
j
].dynamic;

577 
rb
[
i
].
ty≥
 = 
RENDER_BUFFER_TYPE_VERTEX
;

578 
rb
[
i
].
vîãx
 = 
	`U∂ﬂdVîãxBuf„r
(
mesh_d©a
->
vb_d©a
[i], mesh_d©a->
vîti˚s_cou¡
, 
dy«mic
, 
ªndîî
->
devi˚
);

581 if(
has_ödi˚s
) {

582 
ID3D11Buf„r
* 
ödex_buf„r
;

583 
D3D11_BUFFER_DESC
 
desc
 = {};

584 
desc
.
ByãWidth
 = (
u32
Ë* 
mesh_d©a
->
ödi˚s_cou¡
;

586 
D3D11_USAGE
 
ußge_Êag
 = 
D3D11_USAGE_IMMUTABLE
;

587 
u32
 
˝u_ac˚ss_Êags
 = 0;

588 if(
mesh_desc
 && mesh_desc->
dy«mic_ödex_buf„r
) {

589 
ußge_Êag
 = 
D3D11_USAGE_DYNAMIC
;

590 
˝u_ac˚ss_Êags
 |
D3D11_CPU_ACCESS_WRITE
;

594 
desc
.
Ußge
 = 
ußge_Êag
;

595 
desc
.
BödFœgs
 = 
˝u_ac˚ss_Êags
;

596 
D3D11_SUBRESOURCE_DATA
 
§
 = {};

597 
§
.
pSysMem
 = 
mesh_d©a
->
ödi˚s
;

598 
ªndîî
->
devi˚
->
	`Cª©eBuf„r
(&
desc
, &
§
, &
ödex_buf„r
);

600 
rb
[
i
].
ty≥
 = 
RENDER_BUFFER_TYPE_INDEX
;

601 
rb
[
i
].
ödex
.
buf„r
 = 
ödex_buf„r
;

602 
rb
[
i
].
ödex
.
num_ödi˚s
 = 
mesh_d©a
->
ödi˚s_cou¡
;

605 
rbg
->
rb
 =Ñb;

606 
rbg
->
cou¡
 = 
mesh_d©a
->
vb_d©a_cou¡
 + (
u32
)
has_ödi˚s
;

607  
rbg
;

608 
	}
}

612 
Rídîî
* 
	$InôRídîî
(
Wö32Wödow
* 
wödow
, 
GameAs£ts
* 
as£ts
, 
Mem‹yAª«
* 
¨ía
) {

613 
Rídîî
* 
ªndîî
;

614 
u8
* 
memblock
 = 
	`GëMem‹y
(
¨ía
, 
	`Megabyãs
(5));

615 
ªndîî
 = (
Rídîî
*)
memblock
;

617 
ªndîî
->
≥rm™ít
.
mem‹y
.
bp
 = 
memblock
;

618 
ªndîî
->
≥rm™ít
.
mem‹y
.
size
 = 
	`Megabyãs
(3);

619 
ªndîî
->
≥rm™ít
.
u£d
 = (
Rídîî
);

621 
ªndîî
->
å™sõ¡
.
mem‹y
.
bp
 = 
memblock
 + 
	`Megabyãs
(3);

622 
ªndîî
->
å™sõ¡
.
mem‹y
.
size
 = 
	`Megabyãs
(2);

624 
HRESULT
 
hr
 = {};

625 
u32
 
mßa_quÆôy_Àvñ
 = 0;

626 
u32
 
mßa_ßm∂e_cou¡
 = 1;

628 
u32
 
Êags
 = 0;

629 
IDXGIFa˘‹y4
* 
dxgi_Á˘‹y
;

630 
hr
 = 
	`Cª©eDXGIFa˘‹y2
(
Êags
, 
IID_IDXGIFa˘‹y4
, (**)&
dxgi_Á˘‹y
);

631 
	`As£πHR
(
hr
);

633 
Êags
 = 0;

634 
Êags
 = 
DXGI_MWA_NO_WINDOW_CHANGES
 | 
DXGI_MWA_NO_ALT_ENTER
;

635 
dxgi_Á˘‹y
->
	`MakeWödowAssocüti⁄
(
wödow
->
h™dÀ
, 
Êags
);

637 
IDXGIAd≠ãr1
* 
ad≠ãrs
[4] = { 
NULL
 };

638 
u32
 
ad≠ãr_cou¡
 = 0;

640 (
ad≠ãr_cou¡
 < 
	`AºayCou¡
(
ad≠ãrs
) -1) &&

641 (
dxgi_Á˘‹y
->
	`EnumAd≠ãrs1
(
ad≠ãr_cou¡
, &
ad≠ãrs
[adapter_count])

642 !
DXGI_ERROR_NOT_FOUND
)Ë
ad≠ãr_cou¡
++;

644 
u32
 
ad≠ãr_to_u£
 = 0;

645 
u64
 
video_mem‹y_avaûabÀ
 = 0;

646 
u32
 
i
 = 0; i < 
ad≠ãr_cou¡
; i++) {

647 
DXGI_ADAPTER_DESC1
 
desc
 = { 
NULL
 };

648 
ad≠ãrs
[
i
]->
	`GëDesc1
(&
desc
);

649 i‡(
desc
.
DediˇãdVideoMem‹y
 > 
video_mem‹y_avaûabÀ
) {

650 
video_mem‹y_avaûabÀ
 = 
desc
.
DediˇãdVideoMem‹y
;

651 
ad≠ãr_to_u£
 = 
i
;

655 
D3D_FEATURE_LEVEL
 
èrgë_„©uª_Àvñs
[] = {

656 
D3D_FEATURE_LEVEL_11_1
,

657 
D3D_FEATURE_LEVEL_11_1


659 
D3D_FEATURE_LEVEL
 
out_„©uª_Àvñs
 = 
D3D_FEATURE_LEVEL_9_1
;

661 
hr
 = 
	`D3D11Cª©eDevi˚
((
IDXGIAd≠ãr
*)
ad≠ãrs
[
ad≠ãr_to_u£
], 
D3D_DRIVER_TYPE_UNKNOWN
, 
NULL
,

662 
Êags
, 
èrgë_„©uª_Àvñs
, 
	`AºayCou¡
—¨gë_„©uª_Àvñs), 
D3D11_SDK_VERSION
,

663 &
ªndîî
->
devi˚
, &
out_„©uª_Àvñs
, &ªndîî->
c⁄ãxt
);

665 
	`As£πHR
(
hr
);

666 
hr
 = 
ªndîî
->
devi˚
->
	`CheckMu…ißm∂eQuÆôyLevñs
(
DXGI_FORMAT_R8G8B8A8_UNORM
,

667 
mßa_ßm∂e_cou¡
, &
mßa_quÆôy_Àvñ
);

668 
mßa_quÆôy_Àvñ
--;

670 
DXGI_SWAP_CHAIN_DESC1
 
sw≠chaö_desc
;

671 
sw≠chaö_desc
.
Width
 = 0;

672 
sw≠chaö_desc
.
Height
 = 0;

673 
sw≠chaö_desc
.
F‹m©
 = 
DXGI_FORMAT_R8G8B8A8_UNORM
;

674 
sw≠chaö_desc
.
Sãªo
 = 0;

676 
sw≠chaö_desc
.
Sam∂eDesc
.
Cou¡
 = 
mßa_ßm∂e_cou¡
;

677 
sw≠chaö_desc
.
Sam∂eDesc
.
QuÆôy
 = 
mßa_quÆôy_Àvñ
;

678 
sw≠chaö_desc
.
Buf„rUßge
 = 
DXGI_USAGE_RENDER_TARGET_OUTPUT
;

680 
sw≠chaö_desc
.
Buf„rCou¡
 = 2;

681 
sw≠chaö_desc
.
Sˇlög
 = 
DXGI_SCALING_STRETCH
;

682 
sw≠chaö_desc
.
Sw≠Ef„˘
 = 
DXGI_SWAP_EFFECT_FLIP_DISCARD
;

683 
sw≠chaö_desc
.
AÕhaMode
 = 
DXGI_ALPHA_MODE_UNSPECIFIED
;

684 
sw≠chaö_desc
.
Fœgs
 = 0;

686 
hr
 = 
dxgi_Á˘‹y
->
	`Cª©eSw≠ChaöF‹Hwnd
((
IUnknown
*)
ªndîî
->
devi˚
, 
wödow
->
h™dÀ
, &
sw≠chaö_desc
, 
NULL
, NULL, &ªndîî->
sw≠chaö
);

688 
	`As£πHR
(
hr
);

691 
hr
 = 
ªndîî
->
sw≠chaö
->
	`QuîyI¡îÁ˚
(
	`IID_PPV_ARGS
(&renderer->swapchain));

692 
	`As£πHR
(
hr
);

696 
ID3D11Textuª2D
* 
πv_ãx
;

697 
hr
 = 
ªndîî
->
sw≠chaö
->
	`GëBuf„r
(0, 
	`IID_PPV_ARGS
(&
πv_ãx
));

698 
D3D11_TEXTURE2D_DESC
 
πv_ãx_desc
 = {};

699 
πv_ãx
->
	`GëDesc
(&
πv_ãx_desc
);

701 
D3D11_RENDER_TARGET_VIEW_DESC
 
πv_desc
 = {};

702 
πv_desc
.
F‹m©
 = 
DXGI_FORMAT_R8G8B8A8_UNORM
;

703 
πv_desc
.
VõwDimísi⁄
 = 
D3D11_RTV_DIMENSION_TEXTURE2D
;

705 
hr
 = 
ªndîî
->
devi˚
->
	`Cª©eRídîT¨gëVõw
((
ID3D11Resour˚
*)
πv_ãx
, &
πv_desc
, &ªndîî->
πv
);

706 
	`As£πHR
(
hr
);

708 
ID3D11Textuª2D
* 
dsv_ãx
;

709 
D3D11_TEXTURE2D_DESC
 
dsv_ãx_desc
;

710 
πv_ãx
->
	`GëDesc
(&
dsv_ãx_desc
);

711 
dsv_ãx_desc
.
MùLevñs
 = 1;

712 
dsv_ãx_desc
.
AºaySize
 = 1;

713 
dsv_ãx_desc
.
F‹m©
 = 
DXGI_FORMAT_D32_FLOAT
;

714 
dsv_ãx_desc
.
Ußge
 = 
D3D11_USAGE_DEFAULT
;

715 
dsv_ãx_desc
.
BödFœgs
 = 
D3D11_BIND_DEPTH_STENCIL
;

716 
dsv_ãx_desc
.
Sam∂eDesc
.
Cou¡
 = 
mßa_ßm∂e_cou¡
;

717 
dsv_ãx_desc
.
Sam∂eDesc
.
QuÆôy
 = 
mßa_quÆôy_Àvñ
;

719 
hr
 = 
ªndîî
->
devi˚
->
	`Cª©eTextuª2D
(&
dsv_ãx_desc
, 
NULL
, &
dsv_ãx
);

720 
	`As£πHR
(
hr
);

722 
D3D11_DEPTH_STENCIL_VIEW_DESC
 
dsv_desc
 = {};

723 
dsv_desc
.
F‹m©
 = 
DXGI_FORMAT_D32_FLOAT
;

724 
dsv_desc
.
VõwDimísi⁄
 = 
D3D11_DSV_DIMENSION_TEXTURE2D
;

725 
hr
 = 
ªndîî
->
devi˚
->
	`Cª©eDïthSãncûVõw
((
ID3D11Resour˚
*)
dsv_ãx
, &
dsv_desc
, &ªndîî->
dsv
);

726 
	`As£πHR
(
hr
);

732 
D3D11_BLEND_DESC
 
bs_desc
 = {};

733 
bs_desc
.
RídîT¨gë
[0].
RídîT¨gëWrôeMask
 = 
D3D11_COLOR_WRITE_ENABLE_ALL
;

734 
bs_desc
.
RídîT¨gë
[0].
BÀndE«bÀ
 = 
Ál£
;

736 
hr
 = 
ªndîî
->
devi˚
->
	`Cª©eBÀndSèã
(&
bs_desc
, &ªndîî->
bs
[
BLEND_STATE_NO_BLEND
]);

737 
	`As£πHR
(
hr
);

740 
D3D11_BLEND_DESC
 
bs_desc
 = {};

741 
bs_desc
.
RídîT¨gë
[0].
RídîT¨gëWrôeMask
 = 
D3D11_COLOR_WRITE_ENABLE_ALL
;

742 
bs_desc
.
RídîT¨gë
[0].
BÀndE«bÀ
 = 
åue
;

743 
bs_desc
.
RídîT¨gë
[0].
SrcBÀnd
 = 
D3D11_BLEND_SRC_ALPHA
;

744 
bs_desc
.
RídîT¨gë
[0].
De°BÀnd
 = 
D3D11_BLEND_INV_SRC_ALPHA
;

745 
bs_desc
.
RídîT¨gë
[0].
BÀndOp
 = 
D3D11_BLEND_OP_ADD
;

746 
bs_desc
.
RídîT¨gë
[0].
SrcBÀndAÕha
 = 
D3D11_BLEND_ONE
;

747 
bs_desc
.
RídîT¨gë
[0].
De°BÀndAÕha
 = 
D3D11_BLEND_ONE
;

748 
bs_desc
.
RídîT¨gë
[0].
BÀndOpAÕha
 = 
D3D11_BLEND_OP_MAX
;

751 
hr
 = 
ªndîî
->
devi˚
->
	`Cª©eBÀndSèã
(&
bs_desc
, &ªndîî->
bs
[
BLEND_STATE_ENABLED
]);

752 
	`As£πHR
(
hr
);

757 
ID3D11DïthSãncûSèã
* 
dss
;

758 
D3D11_DEPTH_STENCIL_DESC
 
dss_desc
 = {};

759 
dss_desc
.
DïthE«bÀ
 = 
åue
;

760 
dss_desc
.
DïthWrôeMask
 = 
D3D11_DEPTH_WRITE_MASK_ALL
;

761 
dss_desc
.
DïthFunc
 = 
D3D11_COMPARISON_LESS_EQUAL
;

762 
hr
 = 
ªndîî
->
devi˚
->
	`Cª©eDïthSãncûSèã
(&
dss_desc
, &
dss
);

763 
ªndîî
->
dss
[
DEPTH_STENCIL_STATE_DEFAULT
] = dss;

764 
	`As£πHR
(
hr
);

769 
ID3D11Ra°îizîSèã
* 
rs
;

770 
D3D11_RASTERIZER_DESC
 
rs_desc
;

771 
rs_desc
.
FûlMode
 = 
D3D11_FILL_SOLID
;

772 
rs_desc
.
CuŒMode
 = 
D3D11_CULL_BACK
;

773 
rs_desc
.
Fr⁄tCou¡îClockwi£
 = 
åue
;

774 
rs_desc
.
Mu…ißm∂eE«bÀ
 = 
åue
;

775 
hr
 = 
ªndîî
->
devi˚
->
	`Cª©eRa°îizîSèã
(&
rs_desc
, &
rs
);

776 
ªndîî
->
rs
[
RASTERIZER_STATE_DEFAULT
] =Ñs;

777 
	`As£πHR
(
hr
);

780 
rs_desc
.
FûlMode
 = 
D3D11_FILL_WIREFRAME
;

781 
hr
 = 
ªndîî
->
devi˚
->
	`Cª©eRa°îizîSèã
(&
rs_desc
, &
rs
);

782 
ªndîî
->
rs
[
RASTERIZER_STATE_WIREFRAME
] =Ñs;

783 
	`As£πHR
(
hr
);

785 
rs_desc
 = {};

786 
rs_desc
.
FûlMode
 = 
D3D11_FILL_SOLID
;

787 
rs_desc
.
CuŒMode
 = 
D3D11_CULL_NONE
;

788 
rs_desc
.
Fr⁄tCou¡îClockwi£
 = 
åue
;

789 
hr
 = 
ªndîî
->
devi˚
->
	`Cª©eRa°îizîSèã
(&
rs_desc
, &
rs
);

790 
ªndîî
->
rs
[
RASTERIZER_STATE_DOUBLE_SIDED
] =Ñs;

791 
	`As£πHR
(
hr
);

795 
D3D11_VIEWPORT
 
vp
 = {};

796 
vp
.
T›Le·X
 = 0.0f;

797 
vp
.
T›Le·Y
 = 0.0f;

798 
vp
.
Width
 = 
wödow
->
dim
.
width
;

799 
vp
.
Height
 = 
wödow
->
dim
.
height
;

800 
vp
.
MöDïth
 = 0.0f;

801 
vp
.
MaxDïth
 = 1.0f;

802 
ªndîî
->
vp
[
VIEWPORT_DEFAULT
] = vp;

807 
ID3D11Sam∂îSèã
* 
ss
;

808 
D3D11_SAMPLER_DESC
 
desc
 = {};

809 
desc
.
Fûãr
 = 
D3D11_FILTER_MIN_MAG_MIP_POINT
;

810 
desc
.
AddªssU
 = 
D3D11_TEXTURE_ADDRESS_CLAMP
;

811 
desc
.
AddªssV
 = 
D3D11_TEXTURE_ADDRESS_CLAMP
;

812 
desc
.
AddªssW
 = 
D3D11_TEXTURE_ADDRESS_CLAMP
;

813 
desc
.
Com∑ris⁄Func
 = 
D3D11_COMPARISON_ALWAYS
;

814 
desc
.
MaxLOD
 = 
D3D11_FLOAT32_MAX
;

815 
hr
 = 
ªndîî
->
devi˚
->
	`Cª©eSam∂îSèã
(&
desc
, &
ss
);

816 
	`As£πHR
(
hr
);

817 
ªndîî
->
ss
[
SAMPLER_STATE_DEFAULT
] = ss;

820 
ID3D11Sam∂îSèã
* 
ss
;

821 
D3D11_SAMPLER_DESC
 
desc
 = {};

822 
desc
.
Fûãr
 = 
D3D11_FILTER_MIN_MAG_MIP_POINT
;

823 
desc
.
AddªssU
 = 
D3D11_TEXTURE_ADDRESS_WRAP
;

824 
desc
.
AddªssV
 = 
D3D11_TEXTURE_ADDRESS_WRAP
;

825 
desc
.
AddªssW
 = 
D3D11_TEXTURE_ADDRESS_WRAP
;

826 
desc
.
Com∑ris⁄Func
 = 
D3D11_COMPARISON_ALWAYS
;

827 
desc
.
MaxLOD
 = 
D3D11_FLOAT32_MAX
;

828 
hr
 = 
ªndîî
->
devi˚
->
	`Cª©eSam∂îSèã
(&
desc
, &
ss
);

829 
	`As£πHR
(
hr
);

830 
ªndîî
->
ss
[
SAMPLER_STATE_TILE
] = ss;

833  
ªndîî
;

834 
	}
}

	@renderer.h

1 
	eRENDERER_MISC_FLAGS
 {

2 
	mRENDER_BUFFER_MAX
 = 255,

3 
	mRENDER_QUEUE_MAX
 = 255

6 
	eDEPTH_STENCIL_STATE
 {

7 
	mDEPTH_STENCIL_STATE_NONE
,

8 
	mDEPTH_STENCIL_STATE_DEFAULT
,

9 
	mDEPTH_STENCIL_STATE_TOTAL


12 
	eBLEND_STATE
 {

13 
	mBLEND_STATE_NONE
,

14 
	mBLEND_STATE_NO_BLEND
,

15 
	mBLEND_STATE_ENABLED
,

16 
	mBLEND_STATE_TOTAL


19 
	eRASTERIZER_STATE
 {

20 
	mRASTERIZER_STATE_NONE
,

21 
	mRASTERIZER_STATE_DEFAULT
,

22 
	mRASTERIZER_STATE_WIREFRAME
,

23 
	mRASTERIZER_STATE_DOUBLE_SIDED
,

24 
	mRASTERIZER_STATE_TOTAL


27 
	eVIEWPORT
 {

28 
	mVIEWPORT_NONE
,

29 
	mVIEWPORT_DEFAULT
,

30 
	mVIEWPORT_TOTAL


33 
	eVERTEX_SHADER
 {

34 
	mVERTEX_SHADER_NONE
,

35 
	mVERTEX_SHADER_POS_NOR
,

36 
	mVERTEX_SHADER_POS_NOR_TEX
,

37 
	mVERTEX_SHADER_TEXT
,

38 
	mVERTEX_SHADER_LINE
,

39 
	mVERTEX_SHADER_TOTAL


42 
	ePIXEL_SHADER
 {

43 
	mPIXEL_SHADER_NONE
,

44 
	mPIXEL_SHADER_UNLIT
,

45 
	mPIXEL_SHADER_DIFFUSE
,

46 
	mPIXEL_SHADER_DIFFUSE_TEXTURED
,

47 
	mPIXEL_SHADER_TEXT
,

48 
	mPIXEL_SHADER_LINE
,

49 
	mPIXEL_SHADER_TOTAL


52 
	eSAMPLER_STATE
 {

53 
	mSAMPLER_STATE_NONE
,

54 
	mSAMPLER_STATE_DEFAULT
,

55 
	mSAMPLER_STATE_TILE
,

56 
	mSAMPLER_STATE_TOTAL


59 
	eRENDER_BUFFER_GROUP
 {

60 
	mRENDER_BUFFER_GROUP_NONE
,

61 
	mRENDER_BUFFER_GROUP_CUBE
,

62 
	mRENDER_BUFFER_GROUP_SPHERE
,

63 
	mRENDER_BUFFER_GROUP_CONE
,

64 
	mRENDER_BUFFER_GROUP_TORUS
,

65 
	mRENDER_BUFFER_GROUP_PLANE
,

66 
	mRENDER_BUFFER_GROUP_FONT
,

67 
	mRENDER_BUFFER_GROUP_SPACE_BACKGROUND
,

68 
	mRENDER_BUFFER_GROUP_SPACE_RED
,

69 
	mRENDER_BUFFER_GROUP_END
,

70 
	mRENDER_BUFFER_GROUP_TOTAL
 = 255

73 
	eSTRUCTURED_BINDING_SLOT
 {

74 
	mSTRUCTURED_BINDING_SLOT_FRAME


77 
	eCONSTANTS_BINDING_SLOT
 {

78 
	mCONSTANTS_BINDING_SLOT_FRAME
,

79 
	mCONSTANTS_BINDING_SLOT_CAMERA
,

80 
	mCONSTANTS_BINDING_SLOT_OBJECT
,

83 
	eTEXTURE_BINDING_SLOT
 {

84 
	mTEXTURE_BINDING_SLOT_ALBEDO
,

85 
	mTEXTURE_BINDING_SLOT_NORMAL


88 
	eRENDER_BUFFER_TYPE
 {

89 
	mRENDER_BUFFER_TYPE_NOT_SET
,

90 
	mRENDER_BUFFER_TYPE_VERTEX
,

91 
	mRENDER_BUFFER_TYPE_INDEX
,

92 
	mRENDER_BUFFER_TYPE_CONSTANTS
,

93 
	mRENDER_BUFFER_TYPE_STRUCTURED
,

94 
	mRENDER_BUFFER_TYPE_TEXTURE
,

97 
	eDRAW_CALL
 {

98 
	mDRAW_CALL_NONE
,

99 
	mDRAW_CALL_DEFAULT
,

100 
	mDRAW_CALL_INDEXED
,

101 
	mDRAW_CALL_VERTICES
,

102 
	mDRAW_CALL_INSTANCED
,

105 
	sShadîDesc
 {

106 * 
	mcode
;

107 
u32
 
	msize
;

108 * 
	míåy
;

111 
	sC⁄°™tsBuf„rDesc
 {

112 
CONSTANTS_BINDING_SLOT
 
	m¶Ÿ
;

113 
u32
 
	msize
;

116 
	sSåu˘uªdBuf„rDesc
 {

117 
STRUCTURED_BINDING_SLOT
 
	m¶Ÿ
;

118 
u32
 
	m°ru˘_size_ö_byãs
;

119 
u32
 
	mcou¡
;

122 
	sVîãxShadîDesc
 {

123 
ShadîDesc
 
	mshadî
;

124 
Såu˘uªdBuf„rDesc
* 
	msb_desc
;

125 
C⁄°™tsBuf„rDesc
* 
	mcb_desc
;

126 
VERTEX_BUFFER
* 
	mvb_ty≥
;

128 
u8
 
	mcb_cou¡
, 
	mvb_cou¡
, 
	msb_cou¡
;

131 
	sTextuªDesc
 {

132 
TEXTURE_SLOT
 
	m¶Ÿ
;

133 
u8
 
	mnum_ch™√ls
;

136 
	sPixñShadîDesc
 {

137 
ShadîDesc
 
	mshadî
;

138 
C⁄°™tsBuf„rDesc
* 
	mcb_desc
;

140 
TEXTURE_SLOT
* 
	mãxtuª_¶Ÿ
;

142 
u8
 
	mãxtuª_cou¡
, 
	mcb_cou¡
;

145 
	sVîãxBuf„rDesc
 {

146 
VERTEX_BUFFER
 
	mty≥
;

147 
boﬁ
 
	mdy«mic
;

150 
	sMeshDesc
 {

151 
VîãxBuf„rDesc
* 
	mvb_desc
;

152 
u8
 
	mvb_cou¡
;

153 
boﬁ
 
	mdy«mic_ödex_buf„r
;

156 
	sIndexBuf„r
 {

157 
ID3D11Buf„r
* 
	mbuf„r
;

158 
u32
 
	mnum_ödi˚s
;

161 
	sVîãxBuf„r
 {

162 
VERTEX_BUFFER
 
	mty≥
;

163 
ID3D11Buf„r
* 
	mbuf„r
;

164 
u32
 
	m°ride
;

165 
u32
 
	mvîti˚s_cou¡
;

168 
	sSåu˘uªdBuf„r
 {

169 
STRUCTURED_BINDING_SLOT
 
	m¶Ÿ
;

170 
ID3D11Buf„r
* 
	mbuf„r
;

171 
ID3D11ShadîResour˚Võw
* 
	mvõw
;

172 
u32
 
	m°ru˘_size
;

173 
u32
 
	mcou¡
;

176 
	sTextuªBuf„r
 {

177 
TEXTURE_SLOT
 
	m¶Ÿ
;

178 
ID3D11Textuª2D
* 
	mbuf„r
;

179 
ID3D11ShadîResour˚Võw
* 
	mvõw
;

182 
	sC⁄°™tsBuf„r
 {

183 
CONSTANTS_BINDING_SLOT
 
	m¶Ÿ
;

184 
ID3D11Buf„r
* 
	mbuf„r
;

185 
u32
 
	msize
;

188 
	sRídîBuf„r
 {

189 
RENDER_BUFFER_TYPE
 
	mty≥
;

191 
VîãxBuf„r
 
	mvîãx
;

192 
IndexBuf„r
 
	mödex
;

193 
C⁄°™tsBuf„r
 
	mc⁄°™ts
;

194 
Såu˘uªdBuf„r
 
	m°ru˘uªd
;

195 
TextuªBuf„r
 
	mãxtuª
;

199 
	sRídîBuf„rGroup
 {

200 
RídîBuf„r
* 
	mrb
;

201 
u8
 
	mcou¡
;

204 
	sVîãxShadî
 {

205 
ID3D11VîãxShadî
* 
	mshadî
;

206 
ID3D11I≈utLayout
* 
	mû
;

207 
VERTEX_BUFFER
* 
	mvb_ty≥
;

208 
RídîBuf„r
* 
	mrb
;

209 
u8
 
	mvb_cou¡
, 
	mrb_cou¡
;

212 
	sPixñShadî
 {

213 
ID3D11PixñShadî
* 
	mshadî
;

214 
TEXTURE_SLOT
* 
	mãxtuª_¶Ÿ
;

215 
RídîBuf„r
* 
	mrb
;

217 
u8
 
	mãxtuª_cou¡
, 
	mrb_cou¡
;

220 
	sPushC⁄°™tsBuf„rD©a
 {

221 
CONSTANTS_BINDING_SLOT
 
	m¶Ÿ
;

222 * 
	md©a
;

225 
	sPushSåu˘uªdBuf„rD©a
 {

226 
STRUCTURED_BINDING_SLOT
 
	m¶Ÿ
;

227 
u32
 
	mcou¡
;

228 * 
	md©a
;

231 
	sPushTextuªBuf„rD©a
 {

232 
TEXTURE_SLOT
 
	m¶Ÿ
;

233 * 
	md©a
;

236 
	sPushVîãxBuf„rD©a
 {

237 
VERTEX_BUFFER
 
	mty≥
;

238 * 
	md©a
;

239 
u32
 
	mvîti˚s_cou¡
;

242 
	sPushIndexBuf„rD©a
 {

243 * 
	md©a
;

244 
u32
 
	mödi˚s_cou¡
;

247 
	sPushRídîBuf„rD©a
 {

248 
RENDER_BUFFER_TYPE
 
	mty≥
;

250 
PushIndexBuf„rD©a
 
	mödex
;

251 
PushVîãxBuf„rD©a
 
	mvîãx
;

252 
PushC⁄°™tsBuf„rD©a
 
	mc⁄°™ts
;

253 
PushSåu˘uªdBuf„rD©a
 
	m°ru˘uªd
;

254 
PushTextuªBuf„rD©a
 
	mãxtuª
;

258 
	sDøwCÆl
 {

259 
DRAW_CALL
 
	mty≥
;

262 
u32
 
	mvîti˚s_cou¡
;

263 
u32
 
	moff£t
;

266 
u32
 
	mödi˚s_cou¡
;

267 
u32
 
	moff£t
;

270 
u32
 
	mvîti˚s_cou¡
;

271 
u32
 
	mö°™˚_cou¡
;

276 
	eRENDER_COMMAND
 {

277 
	mRENDER_COMMAND_NONE
,

278 
	mRENDER_COMMAND_CLEAR_DEPTH_STENCIL
,

279 
	mRENDER_COMMAND_CLEAR_RENDER_TARGET
,

282 
	sRídîSèã
 {

283 
RENDER_COMMAND
 
	mcomm™d
;

284 
DEPTH_STENCIL_STATE
 
	mdss
;

285 
BLEND_STATE
 
	mbs
;

286 
RASTERIZER_STATE
 
	mrs
;

287 
VIEWPORT
 
	mvp
;

288 
D3D11_PRIMITIVE_TOPOLOGY
 
	mt›ﬁogy
;

289 
SAMPLER_STATE
 
	mss
;

292 
	sRídîPùñöe
 {

294 
RídîSèã
 
	mrs
;

295 
VîãxShadî
* 
	mvs
;

296 
PixñShadî
* 
	mps
;

297 
DøwCÆl
 
	mdc
;

298 
RídîBuf„rGroup
* 
	mvrbg
;

299 
RídîBuf„rGroup
* 
	m¥bg
;

300 
PushRídîBuf„rD©a
* 
	mvrbd
;

301 
PushRídîBuf„rD©a
* 
	m¥bd
;

304 
u8
 
	mvrbd_cou¡
, 
	m¥bd_cou¡
;

308 
	sRídîî
 {

309 
Mem‹yAª«
 
	m≥rm™ít
;

310 
Mem‹yAª«
 
	må™sõ¡
;

312 
ID3D11Devi˚
* 
	mdevi˚
;

313 
ID3D11Devi˚C⁄ãxt
* 
	mc⁄ãxt
;

314 
IDXGISw≠Chaö1
* 
	msw≠chaö
;

316 
ID3D11RídîT¨gëVõw
* 
	mπv
;

317 
ID3D11DïthSãncûVõw
* 
	mdsv
;

319 
ID3D11DïthSãncûSèã
* 
	mdss
[
DEPTH_STENCIL_STATE_TOTAL
];

320 
ID3D11BÀndSèã
* 
	mbs
[
BLEND_STATE_TOTAL
];

322 
ID3D11Ra°îizîSèã
* 
	mrs
[
RASTERIZER_STATE_TOTAL
];

323 
D3D11_VIEWPORT
 
	mvp
[
VIEWPORT_TOTAL
];

325 
ID3D11Sam∂îSèã
* 
	mss
[
SAMPLER_STATE_TOTAL
];

327 
RídîPùñöe
 
	mrq
[
RENDER_QUEUE_MAX
];

328 
u32
 
	mrq_id
;

330 
RídîSèã
 
	m°©e_ovîrides
;

334 
	$AddToRídîQueue
(
RídîPùñöe
 
Ω
, 
Rídîî
* 
ªndîî
) {

335 
	`As£π
(
ªndîî
->
rq_id
 < 
RENDER_QUEUE_MAX
);

336 
ªndîî
->
rq
[ªndîî->
rq_id
++] = 
Ω
;

337 
	}
}

339 
RídîSèã


340 
	$RídîSèãDeÁu…s
() {

341  
RídîSèã
 { 
RENDER_COMMAND_NONE
, 
DEPTH_STENCIL_STATE_DEFAULT
,

342 
BLEND_STATE_NO_BLEND
, 
RASTERIZER_STATE_DEFAULT
, 
VIEWPORT_DEFAULT
,

343 
D3D11_PRIMITIVE_TOPOLOGY_TRIANGLELIST
, 
SAMPLER_STATE_DEFAULT
 };

344 
	}
}

	@shapes.cpp

1 
	sQuad
 {

2 
Vec3
 
	mé
;

3 
Vec3
 
	må
;

4 
Vec3
 
	mbl
;

5 
Vec3
 
	mbr
;

8 
	sLöe
 {

9 
Vec3
 
	m°¨t
;

10 
Vec3
 
	míd
;

15 
	$Gíî©eFœtShadedN‹mÆs
(
Vec3
* 
vîti˚s
, 
u32
 
cou¡
, Vec3* 
out_n‹mÆs
 ) {

16 
	`As£π
(
cou¡
 % 3 == 0);

17 
u32
 
i
=0; i<
cou¡
; i+=3) {

18 
Vec3
 
a
 = 
vîti˚s
[
i
];

19 
Vec3
 
b
 = 
vîti˚s
[
i
+1];

20 
Vec3
 
c
 = 
vîti˚s
[
i
+2];

21 
Vec3
 
¸oss
 = 
	`V3N‹m
(
	`V3Cross
(
	`V3Sub
(
b
, 
a
), V3Sub(
c
,á)));

22 
out_n‹mÆs
[
i
] = 
¸oss
;

23 
out_n‹mÆs
[
i
+1] = 
¸oss
;

24 
out_n‹mÆs
[
i
+2] = 
¸oss
;

26 
	}
};

28 
Quad


29 
	$MakeQuadFromLöe
(
Löe
* 
löe
, 
thick√ss
, 
Vec3
 
n‹mÆ
) {

30 
Quad
 
ªsu…
 = {};

32 
ªsu…
.
é
 = 
	`V3Add
(
löe
->
°¨t
, 
	`V3MulF
(
n‹mÆ
, 
thick√ss
));

33 
ªsu…
.
bl
 = 
	`V3Add
(
löe
->
°¨t
, 
	`V3MulF
(
n‹mÆ
, -
thick√ss
));

34 
ªsu…
.
å
 = 
	`V3Add
(
löe
->
íd
, 
	`V3MulF
(
n‹mÆ
, 
thick√ss
));

35 
ªsu…
.
br
 = 
	`V3Add
(
löe
->
íd
, 
	`V3MulF
(
n‹mÆ
, -
thick√ss
));

36  
ªsu…
;

37 
	}
}

42 
	$Gíî©eTëøhedr⁄
(
Vec3
* 
out_vîti˚s
) {

43 
a
 = 1.0f / 3.0f;

44 
b
 = 
	`sqπf
(8.0f / 9.0f);

45 
c
 = 
	`sqπf
(2.0f / 9.0f);

46 
d
 = 
	`sqπf
(2.0f / 3.0f);

48 
Vec3
 
vîti˚s
[4] = { 
	`V3
(0.0, 0.0, 1.0f),

49 
	`V3
(-
c
, 
d
, -
a
),

50 
	`V3
(-
c
, -
d
, -d),

51 
	`V3
(
b
, 0, -
a
) };

53 
out_vîti˚s
[0] = 
vîti˚s
[0];

54 
out_vîti˚s
[1] = 
vîti˚s
[1];

55 
out_vîti˚s
[2] = 
vîti˚s
[2];

56 
out_vîti˚s
[3] = 
vîti˚s
[0];

57 
out_vîti˚s
[4] = 
vîti˚s
[2];

58 
out_vîti˚s
[5] = 
vîti˚s
[3];

59 
out_vîti˚s
[6] = 
vîti˚s
[0];

60 
out_vîti˚s
[7] = 
vîti˚s
[3];

61 
out_vîti˚s
[8] = 
vîti˚s
[1];

62 
out_vîti˚s
[9] = 
vîti˚s
[3];

63 
out_vîti˚s
[10] = 
vîti˚s
[2];

64 
out_vîti˚s
[11] = 
vîti˚s
[1];

65 
	}
}

	@simulation.cpp

2 
	$Fú°Pîs⁄C⁄åﬁ
(
Vec3
* 
posôi⁄
, 
Qu©
* 
rŸ©i⁄
, 
boﬁ
 
ˇmîa
, 
FPC⁄åﬁInfo
* 
ci
, 
I≈ut
* 
öput
) {

3 
ba£_£ns
 = 
ci
->base_sens;

4 
å™s_£ns
 = 
ci
->trans_sens;

5 
rŸ_£ns
 = 
ci
->rot_sens;

7 
tdñ
 = 
ba£_£ns
 * 
å™s_£ns
 * 0.00001f;

8 
rdñ
 = 
ba£_£ns
 * 
rŸ_£ns
 * 0.005f;

10 
boﬁ
 
f
 = 
öput
->
buâ⁄s
[
WIN32_BUTTON_W
].
hñd
;

11 
boﬁ
 
b
 = 
öput
->
buâ⁄s
[
WIN32_BUTTON_S
].
hñd
;

12 
boﬁ
 
l
 = 
öput
->
buâ⁄s
[
WIN32_BUTTON_A
].
hñd
;

13 
boﬁ
 
r
 = 
öput
->
buâ⁄s
[
WIN32_BUTTON_D
].
hñd
;

14 
boﬁ
 
u
 = 
öput
->
buâ⁄s
[
WIN32_BUTTON_Q
].
hñd
;

15 
boﬁ
 
d
 = 
öput
->
buâ⁄s
[
WIN32_BUTTON_E
].
hñd
;

17 
y
 = 
öput
->
axes
[
WIN32_AXIS_MOUSE_DEL
].
x
 * !
ci
->
block_yaw
;

18 
p
 = 
öput
->
axes
[
WIN32_AXIS_MOUSE_DEL
].
y
 * !
ci
->
block_pôch
;

20 
Vec3
 
pos
 = *
posôi⁄
;

21 
Qu©
 
rŸ
 = *
rŸ©i⁄
;

24 
Vec3
 
fv
 = 
ˇmîa
 ? 
	`V3Neg
(
	`GëF‹w¨dVe˘‹
(
rŸ
)) : GetForwardVector(rot);

25 
Vec3
 
fdi•
 = 
	`V3MulF
(
fv
, 
tdñ
);

27 
Vec3
 
rv
 = 
	`GëRightVe˘‹
(
rŸ
);

28 
Vec3
 
rdi•
 = 
	`V3MulF
(
rv
, 
tdñ
);

30 
Vec3
 
uv
 = 
	`V3Up
();

31 
Vec3
 
udi•
 = 
	`V3MulF
(
uv
, 
tdñ
);

33 
pos
 = 
	`V3Add
’os, 
	`V3MulF
(V3Add(
fv
, 
fdi•
), 
f
));

34 
pos
 = 
	`V3Sub
’os, 
	`V3MulF
(
	`V3Add
(
fv
, 
fdi•
), 
b
));

36 
pos
 = 
	`V3Add
’os, 
	`V3MulF
(V3Add(
rv
, 
rdi•
), 
r
));

37 
pos
 = 
	`V3Sub
’os, 
	`V3MulF
(
	`V3Add
(
rv
, 
rdi•
), 
l
));

39 
pos
 = 
	`V3Add
’os, 
	`V3MulF
(V3Add(
uv
, 
rdi•
), 
u
));

40 
pos
 = 
	`V3Sub
’os, 
	`V3MulF
(
	`V3Add
(
uv
, 
rdi•
), 
d
));

42 
Qu©
 
yrŸ
 = 
y
 ? 
	`Qu©FromAxisAngÀ
(
	`V3Up
(), -y * 
rdñ
Ë: 
	`Qu©I
();

43 
Qu©
 
xrŸ
 = 
p
 ? 
	`Qu©FromAxisAngÀ
(
rv
, -∞* 
rdñ
Ë: 
	`Qu©I
();

45 
rŸ
 = 
	`Qu©Mul
(Qu©Mul(
yrŸ
, 
xrŸ
),Ñot);

47 *
posôi⁄
 = 
pos
;

48 *
rŸ©i⁄
 = 
rŸ
;

49 
	}
}

	@simulation.h

1 
	sFPC⁄åﬁInfo
 {

2 
	mba£_£ns
;

3 
	må™s_£ns
;

4 
	mrŸ_£ns
;

6 
boﬁ
 
	mblock_yaw
;

7 
boﬁ
 
	mblock_pôch
;

	@tetra.cpp

1 
	#MAX_TETRA
 10

	)

3 
	sTëø
 {

4 
Tønsf‹m
 
	må™sf‹m
[
MAX_TETRA
];

5 
Vec4
 
	mcﬁ‹
[
MAX_TETRA
];

6 
u32
 
	mcou¡
;

8 
MeshInfo
 
	möfo
[
MAX_TETRA
];

9 
RídîBuf„rGroup
* 
	mvîãx_buf„rs
;

12 
Tëø
*

13 
	$InôTëø
(
Rídîî
* 
ªndîî
, 
Mem‹yAª«
* 
¨ía
) {

14 
Tëø
* 
ªsu…
 = 
	`PushSåu˘
(
¨ía
, Tetra);

16 
Vec3
* 
vîti˚s
 = 
	`PushAºay
(&
ªndîî
->
å™sõ¡
, Vec3, 12);

17 
Vec3
* 
n‹mÆs
 = 
	`PushAºay
(&
ªndîî
->
å™sõ¡
, Vec3, 12);

19 
	`Gíî©eTëøhedr⁄
(
vîti˚s
);

20 
	`Gíî©eFœtShadedN‹mÆs
(
vîti˚s
, 12, 
n‹mÆs
);

22 
VîãxBuf„rD©a
 
vbd
[] = { { 
vîti˚s
, 
VERTEX_BUFFER_POSITION
 },

23 
n‹mÆs
, 
VERTEX_BUFFER_NORMAL
 };

25 
MeshD©a
 
mesh_d©a
 = {};

26 
mesh_d©a
.
vb_d©a
 = 
vbd
;

27 
mesh_d©a
.
vb_d©a_cou¡
 = 
	`AºayCou¡
(
vbd
);

28 
mesh_d©a
.
vîti˚s_cou¡
 = 12;

30 
ªsu…
->
vîãx_buf„rs
 = 
	`U∂ﬂdMesh
(&
mesh_d©a
, 
nuŒ±r
, 
ªndîî
);

31  
ªsu…
;

32 
	}
}

35 
	$S∑wnTëø
(
Tëø
* 
ãåa
, 
Tønsf‹m
 
å™sf‹m
, 
Vec4
 
cﬁ‹
) {

36 
ãåa
->
å™sf‹m
[ãåa->
cou¡
] =Åransform;

37 
ãåa
->
cﬁ‹
[ãåa->
cou¡
] = color;

38 
ãåa
->
cou¡
++;

39 
	}
}

42 
	$Gíî©eTëøInfo
(
Tëø
* 
ãåa
) {

43 
u32
 
i
=0; i<
ãåa
->
cou¡
; i++) {

44 
ãåa
->
öfo
[
i
].
modñ
 = 
	`MakeTønsf‹mM©rix
—ëø->
å™sf‹m
[i]);

45 
ãåa
->
öfo
[
i
].
cﬁ‹
 =Åetra->color[i];

47 
	}
}

50 
	$Upd©eTëø
(
Tëø
* 
ãåa
) {

51 
u32
 
i
=0;

52 
i
=0; i<
ãåa
->
cou¡
; i++) {

53 
ãåa
->
å™sf‹m
[
i
].
rŸ©i⁄
 = 
	`Qu©Mul
(
	`Qu©FromEuÀr
((i+1)*0.01, 0.0f, 0.0f),Åetra->transform[i].rotation);

55 
	}
};

58 
	$RídîTëø
(
Tëø
* 
ãåa
, 
MeshRídîî
* 
mesh_ªndîî
) {

59 
MeshPùñöe
 
mesh_pùñöe
 = {};

60 
mesh_pùñöe
.
vîãx_buf„rs
 = 
ãåa
->vertex_buffers;;

61 
mesh_pùñöe
.
ö°™˚_d©a
 = (*)
ãåa
->
öfo
;

62 
mesh_pùñöe
.
ö°™˚_cou¡
 = 
ãåa
->
cou¡
;

63 
	`PushMeshPùñöe
(
mesh_pùñöe
, 
mesh_ªndîî
);

64 
	}
}

	@win32.cpp

1 
	~<wödows.h
>

3 
	~"ba£_ty≥s.h
"

4 
	~"∂©f‹m_≠i.h
"

5 
	~"mem‹y_m™agemít.h
"

7 
	~"game_œyî.h
"

8 
	~"wö32.h
"

10 
	#STB_SPRINTF_IMPLEMENTATION


	)

11 
	~"ö˛ude/°b_•rötf.h
"

13 
Pœtf‹mAPI
 
	gwö32_≠i
;

14 
globÆ
 
boﬁ
 
	gg_ru¬ög
;

15 
globÆ
 
Wö32Sèã
 
	gg_wö32_°©e
;

16 
globÆ
 
Wö32Wödow
 
	gg_wö32_wödow
;

17 
globÆ
 
Wö32GameFun˘i⁄TabÀ
 
	gg_game_fun˘i⁄s
;

20 
FILETIME


21 
	$Wö32GëLa°WrôeTime
(* 
absfûï©h
) {

22 
FILETIME
 
ªsu…
 = {};

23 
WIN32_FILE_ATTRIBUTE_DATA
 
fûe_©åibuã
 = {};

24 
	`As£π
(
	`GëFûeAâribuãsExA
(
absfûï©h
, 
GëFûeExInfoSènd¨d
, &
fûe_©åibuã
));

25 
ªsu…
 = 
fûe_©åibuã
.
·La°WrôeTime
;

26  
ªsu…
;

27 
	}
}

29 
WödowDimísi⁄s


30 
	$Wö32GëWödowDimísi⁄s
(
HWND
 
wödow
) {

31 
WödowDimísi⁄s
 
wd
 = {};

32 
RECT
 
ª˘
;

33 
	`GëClõ¡Re˘
(
wödow
, &
ª˘
);

34 
wd
.
width
 = (
u32
)(
ª˘
.
right
 -Ñe˘.
À·
);

35 
wd
.
height
 = (
u32
)(
ª˘
.
bŸtom
 -Ñe˘.
t›
);

36  
wd
;

37 
	}
}

40 
	$Wö32MakeTempDLLAbsFûeP©h
(
Wö32Sèã
* 
°©e
, 
Wö32DLL
* 
code
, * 
d°
) {

41 
	`°b•_•rötf
(
d°
, "%s%d_%s", 
°©e
->
exe_absfﬁdî∑th
, 
code
->
å™sõ¡_dŒ_cou¡î
++, code->
å™sõ¡_dŒ_«me
);

42 if(
code
->
å™sõ¡_dŒ_cou¡î
 >= 1024) code->transient_dll_counter = 0;

43 
	}
}

46 
	$Wö32U∆ﬂdDLL
(
Wö32DLL
* 
code
) {

47 
	`FªeLibøry
(
code
->
dŒ
);

48 
code
->
vÆid
 = 
Ál£
;

49 
code
->
dŒ
 = 0;

50 
	`ZîoAºay
(
code
->
fun˘i⁄s
, code->
fun˘i⁄_cou¡
);

51 
	}
}

54 
	$Wö32LﬂdDLL
(
Wö32Sèã
* 
°©e
, 
Wö32DLL
* 
code
) {

55 
ãmp_dŒ_absfûï©h
[
MAX_PATH
] = {};

56 
WIN32_FILE_ATTRIBUTE_DATA
 
d©a
;

57 if(!
	`GëFûeAâribuãsExA
(
code
->
lock_absfûï©h
, 
GëFûeExInfoSènd¨d
, &
d©a
)) {

58 
code
->
œ°_wrôe_time
 = 
	`Wö32GëLa°WrôeTime
(code->
absfûï©h
);

59 
u32
 
åõs
=0;Åries<128;Åries++) {

60 
	`Wö32MakeTempDLLAbsFûeP©h
(
°©e
, 
code
, 
ãmp_dŒ_absfûï©h
);

61 if(
	`C›yFûe
(
code
->
absfûï©h
, 
ãmp_dŒ_absfûï©h
, 
FALSE
)) ;

64 
code
->
dŒ
 = 
	`LﬂdLibøryA
(
ãmp_dŒ_absfûï©h
);

65 if(
code
->
dŒ
) {

66 
code
->
vÆid
 = 
åue
;

67 
u8
 
i
=0; i<
code
->
fun˘i⁄_cou¡
; i++) {

68 * 
func
 = 
	`GëProcAddªss
(
code
->
dŒ
, code->
fun˘i⁄_«mes
[
i
]);

69 if(
func
Ë
code
->
fun˘i⁄s
[
i
] = func;

70 
code
->
vÆid
 = 
Ál£
;

75 if(!
code
->
vÆid
Ë
	`Wö32U∆ﬂdDLL
(code);

76 
	}
}

79 
	$Wö32RñﬂdDLL
(
Wö32Sèã
* 
°©e
, 
Wö32DLL
* 
code
) {

80 
	`Wö32U∆ﬂdDLL
(
code
);

81 
u32
 
åõs
=0;Åries<100;Åries++) {

82 if(!
code
->
vÆid
) {

83 
	`Wö32LﬂdDLL
(
°©e
, 
code
);

84 
	`SÀï
(100);

87 
	}
}

89 
boﬁ


90 
	$Wö32HasDLLCh™ged
(
Wö32DLL
* 
code
) {

91 
FILETIME
 
·
 = 
	`Wö32GëLa°WrôeTime
(
code
->
absfûï©h
);

92  
	`Com∑ªFûeTime
(&
·
, &
code
->
œ°_wrôe_time
);

93 
	}
}

95 
LRESULT
 
CALLBACK


96 
	$Wö32MaöWödowCÆlback
(
HWND
 
wödow
, 
UINT
 
msg
, 
WPARAM
 
w∑øm
, 
LPARAM
 
Õ¨am
) {

97 
LRESULT
 
ªsu…
 = 0;

98 
msg
) {

99 
WM_CLOSE
: { 
g_ru¬ög
 = 
Ál£
; } ;

100 
WM_DESTROY
: { 
g_ru¬ög
 = 
Ál£
; } ;

101 
WM_SIZE
: {

102 
g_wö32_wödow
.
dim
.
width
 = 
	`LOWORD
(
Õ¨am
);

103 
g_wö32_wödow
.
dim
.
height
 = 
	`HIWORD
(
Õ¨am
);

105 
WM_SETCURSOR
: {

106 if(
g_wö32_°©e
.
curs‹_íabÀd
)

107 
	`SëCurs‹
(
g_wö32_°©e
.
curs‹
);

109 
	`SëCurs‹
(0);

111 : { 
ªsu…
 = 
	`DefWödowProcA
(
wödow
, 
msg
, 
w∑øm
, 
Õ¨am
); } ;

113  
ªsu…
;

114 
	}
}

117 
	$Wö32PªPro˚ssBuâ⁄
(
Buâ⁄
* 
buâ⁄
) {

118 if(
buâ⁄
->
¥es£d
) {

119 
buâ⁄
->
hñd
 = 
åue
;

120 
buâ⁄
->
¥es£d
 = 
Ál£
;

122 
	}
}

125 
	$Wö32Pro˚ssBuâ⁄
(
Buâ⁄
* 
buâ⁄
, 
boﬁ
 
is_down
) {

126 if(
is_down
) {

127 if(!
buâ⁄
->
hñd
Ëbuâ⁄->
¥es£d
 = 
åue
;

130 
buâ⁄
->
¥es£d
 = 
Ál£
;

131 
buâ⁄
->
hñd
 = 
Ál£
;

133 
	}
}

135 
	$PLATFORM_ALLOCATE_MEMORY
(
wö32_Æloˇã_mem‹y
) {

136 
u64
 
∑ge_size
 = 4096;

137 
u64
 
tŸÆ_size
 = (
Wö32Mem‹yBlock
Ë+ 
size
;

138 
u64
 
off£t
 = (
Wö32Mem‹yBlock
);

140 
Wö32Mem‹yBlock
* 
block
 = (Wö32Mem‹yBlock*)
	`VútuÆAŒoc
(0, 
tŸÆ_size
, 
MEM_COMMIT
|
MEM_RESERVE
, 
PAGE_READWRITE
);

141 
	`As£π
(
block
);

142 
block
->block.
ba£
 = (
u8
*)block + 
off£t
;

143 
	`As£π
(
block
->block.
u£d
 == 0);

144 
	`As£π
(
block
->block.
¥ev
 == 0);

146 
wö32_mem‹y_block
* 
£¡öñ
 = &
g_wö32_°©e
.
mem‹y_£¡öñ
;

148 
block
->block.
size
 = size;

149 
block
->
√xt
 = 
£¡öñ
;

150 
block
->
¥ev
 = 
£¡õ∆
->prev;

152 
block
->
¥ev
->
√xt
 = block;

153 
block
->
√xt
->
¥ev
 = block;

155  
block
;

156 
	}
}

158 
	$PLATFORM_DEALLOCATE_MEMORY
(
wö32_dóŒoˇã_mem‹y
) {

159 
boﬁ
 
ªsu…
 = 
	`VútuÆFªe
(
block
, 0, 
MEM_RELEASE
);

160 
	`As£π
(
ªsu…
);

161 
	}
}

163 
	$PLATFORM_OPEN_FILE
(
wö32_›í_fûe
) {

164 
Pœtf‹mFûeH™dÀ
 
ªsu…
 = {};

165 * 
fûíame
 = (*)
öfo
->
«me
;

167 
HANDLE
 
h™dÀ
 = 
	`Cª©eFûeA
(
fûíame
, 
GENERIC_READ
, 
FILE_SHARE_READ
, 0, 
OPEN_EXISTING
, 0, 0);

168 
LARGE_INTEGER
 
li
 = {};

169 
	`GëFûeSizeEx
(
h™dÀ
, &
li
);

170 
öfo
->
size
 = 
li
.
QuadP¨t
;

172 
ªsu…
.
Áûed
 = 
h™dÀ
 =
INVALID_HANDLE_VALUE
;

173 *(
HANDLE
*)&
ªsu…
.
h™dÀ
 = handle;

175  
ªsu…
;

176 
	}
}

178 
	$PLATFORM_CLOSE_FILE
(
wö32_˛o£_fûe
) {

179 
	`As£π
(!
fûe_h™dÀ
->
Áûed
);

180 
HANDLE
 
h™dÀ
 = *(HANDLE*)&
fûe_h™dÀ
->handle;

181 
	`Clo£H™dÀ
(
h™dÀ
);

182 
	}
}

184 
	$PLATFORM_READ_FILE
(
wö32_ªad_fûe
) {

185 
	`As£π
(!
wö32_h™dÀ
->
Áûed
);

186 
HANDLE
 
h™dÀ
 = *(HANDLE*)&
wö32_h™dÀ
->handle;

187 
	`As£π
(
	`RódFûe
(
h™dÀ
, 
d°
, 
size
, 0, 0));

188 
	}
}

191 
	$Wö32Pro˚ssBuâ⁄I≈ut
(
MSG
 
msg
, 
I≈ut
* 
öput
) {

192 
boﬁ
 
is_key_down
 = 
msg
.
mesßge
 =
WM_KEYDOWN
 ? 
åue
 : 
Ál£
;

193 
u32
 
VKCode
 = (u32)
msg
.
wP¨am
;

194 
boﬁ
 
is_down
 = ((
msg
.
lP¨am
 & (1UL << 31)) == 0);

196 if(
VKCode
 ='W'Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_W
], 
is_down
);

197 if(
VKCode
 ='A'Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_A
], 
is_down
);

198 if(
VKCode
 ='S'Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_S
], 
is_down
);

199 if(
VKCode
 ='D'Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_D
], 
is_down
);

200 if(
VKCode
 ='Q'Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_Q
], 
is_down
);

201 if(
VKCode
 ='E'Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_E
], 
is_down
);

203 if(
VKCode
 =
VK_SHIFT
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_SHIFT
], 
is_down
);

204 if(
VKCode
 =
VK_LMENU
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_ALT
], 
is_down
);

205 if(
VKCode
 =
VK_SPACE
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_SPACE
], 
is_down
);

206 if(
VKCode
 =
VK_CONTROL
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_B
], 
is_down
);

208 if(
VKCode
 =
VK_F1
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_F1
], 
is_down
);

209 if(
VKCode
 =
VK_F2
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_F2
], 
is_down
);

210 if(
VKCode
 =
VK_F3
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_F3
], 
is_down
);

211 if(
VKCode
 =
VK_F4
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_F4
], 
is_down
);

212 if(
VKCode
 =
VK_F5
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_F5
], 
is_down
);

213 if(
VKCode
 =
VK_F6
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_F6
], 
is_down
);

214 if(
VKCode
 =
VK_F7
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_F7
], 
is_down
);

215 if(
VKCode
 =
VK_F8
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_F8
], 
is_down
);

216 if(
VKCode
 =
VK_F9
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_F9
], 
is_down
);

217 if(
VKCode
 =
VK_F10
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_F10
], 
is_down
);

218 if(
VKCode
 =
VK_F11
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_F11
], 
is_down
);

219 if(
VKCode
 =
VK_F12
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_F12
], 
is_down
);

221 if(
msg
.
mesßge
 =
WM_LBUTTONDOWN
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_LEFT_MOUSE
], 
åue
);

222 if(
msg
.
mesßge
 =
WM_LBUTTONUP
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_RIGHT_MOUSE
], 
Ál£
);

223 if(
msg
.
mesßge
 =
WM_RBUTTONDOWN
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_RIGHT_MOUSE
], 
åue
);

224 if(
msg
.
mesßge
 =
WM_RBUTTONUP
Ë
	`Wö32Pro˚ssBuâ⁄
(&
öput
->
buâ⁄s
[
WIN32_BUTTON_RIGHT_MOUSE
], 
Ál£
);

225 
	}
}

228 
	$Wö32PªPro˚ssMou£Move
(
I≈ut
* 
öput
, 
boﬁ
 
w¨p_mou£_to_˚¡î
) {

229 
POINT
 
poöt
;

230 
	`GëCurs‹Pos
(&
poöt
);

231 
ﬁd_x_pos
 = 
öput
->
axes
[
WIN32_AXIS_MOUSE
].
x
;

232 
ﬁd_y_pos
 = 
öput
->
axes
[
WIN32_AXIS_MOUSE
].
y
;

234 
öput
->
axes
[
WIN32_AXIS_MOUSE
].
x
 = 
poöt
.x;

235 
öput
->
axes
[
WIN32_AXIS_MOUSE
].
y
 = 
poöt
.y;

237 if(!
w¨p_mou£_to_˚¡î
) {

238 
öput
->
axes
[
WIN32_AXIS_MOUSE_DEL
].
x
 = 
poöt
.x - 
ﬁd_x_pos
;

239 
öput
->
axes
[
WIN32_AXIS_MOUSE_DEL
].
y
 = 
poöt
.y - 
ﬁd_y_pos
;

242 
RECT
 
ª˘
 = {};

243 
	`GëWödowRe˘
(
g_wö32_wödow
.
h™dÀ
, &
ª˘
);

244 
˚¡î_x
 = 
ª˘
.
À·
+ª˘.
right
/2;

245 
˚¡î_y
 = 
ª˘
.
t›
+ª˘.
bŸtom
/2;

246 
öput
->
axes
[
WIN32_AXIS_MOUSE_DEL
].
x
 = 
˚¡î_x
 - 
poöt
.x;

247 
öput
->
axes
[
WIN32_AXIS_MOUSE_DEL
].
y
 = 
˚¡î_y
 - 
poöt
.y;

248 
	`SëCurs‹Pos
(
˚¡î_x
, 
˚¡î_y
);

251 
	}
}

254 
CALLBACK


255 
	$WöMaö
(
HINSTANCE
 
ö°™˚
, HINSTANCE 
¥ev_ö°™˚
, 
LPSTR
 
cmdlöe
, 
show_code
) {

256 
HRESULT
 
hr
 = {};

258 
WNDCLASS
 
wödow_˛ass
 = {};

260 
wödow_˛ass
.
°yÀ
 = 
CS_OWNDC
|
CS_HREDRAW
|
CS_VREDRAW
;

261 
wödow_˛ass
.
Õ‚WndProc
 = 
Wö32MaöWödowCÆlback
;

262 
wödow_˛ass
.
hIn°™˚
 = 
ö°™˚
;

263 
wödow_˛ass
.
ÕszMíuName
 = "Game_menu";

264 
wödow_˛ass
.
ÕszCœssName
 = "Game_class";

266 
g_wö32_°©e
.
curs‹
 = 
	`LﬂdCurs‹
(0, 
IDC_CROSS
);

267 
wödow_˛ass
.
hCurs‹
 = 
g_wö32_°©e
.
curs‹
;

269 
	`As£π
(
	`Regi°îCœssA
(&
wödow_˛ass
));

271 
HWND
 
wödow
 = 
	`Cª©eWödowExA
(0, 
wödow_˛ass
.
ÕszCœssName
, "Game",

272 
WS_OVERLAPPEDWINDOW
|
WS_VISIBLE
, 
CW_USEDEFAULT
, CW_USEDEFAULT,

273 
CW_USEDEFAULT
, CW_USEDEFAULT, 0, 0, 
ö°™˚
, 0);

274 
	`As£π
(
wödow
);

276 
g_wö32_°©e
.
deÁu…_wödow_h™dÀ
 = 
wödow
;

277 
	`GëModuÀFûeNameA
(0, 
g_wö32_°©e
.
exe_absfûï©h
, (g_win32_state.exe_absfilepath));

279 
u32
 
exe_fﬁdî_∑th_Àn
 = 0;

280 
u32
 
i
=0; 
g_wö32_°©e
.
exe_absfûï©h
[i] != 0; i++)

281 if(
g_wö32_°©e
.
exe_absfûï©h
[
i
] ='\\'Ë
exe_fﬁdî_∑th_Àn
 = i+1;

282 
	`C›yMem
(
g_wö32_°©e
.
exe_absfﬁdî∑th
, g_wö32_°©e.
exe_absfûï©h
, 
exe_fﬁdî_∑th_Àn
);

284 
ãmp_exe_absfûï©h
[
MAX_PATH
] = {};

285 
ﬁd_exe_absfûï©h
[
MAX_PATH
] = {};

286 
game_dŒ_absfûï©h
[
MAX_PATH
] = {};

287 
lock_absfûï©h
[
MAX_PATH
] = {};

288 
ªndîî_dŒ_absfûï©h
[
MAX_PATH
] = {};

290 * 
ãmp_exe_fûíame
 = "win32_entry_temp.exe";

291 * 
ﬁd_exe_fûíame
 = "win32_entry_old.exe";

292 * 
game_dŒ_fûíame
 = "game.dll";

293 * 
ªndîî_dŒ_fûíame
 = "win32_d3d11.dll";

294 * 
lock_fûíame
 = "lock.tmp";

296 
	`°b•_•rötf
(
ãmp_exe_absfûï©h
 , "%s%s" , 
g_wö32_°©e
.
exe_absfﬁdî∑th
 , 
ãmp_exe_fûíame
);

297 
	`°b•_•rötf
(
ﬁd_exe_absfûï©h
 , "%s%s" , 
g_wö32_°©e
.
exe_absfﬁdî∑th
 , 
ﬁd_exe_fûíame
);

298 
	`°b•_•rötf
(
game_dŒ_absfûï©h
 , "%s%s" , 
g_wö32_°©e
.
exe_absfﬁdî∑th
 , 
game_dŒ_fûíame
);

299 
	`°b•_•rötf
(
ªndîî_dŒ_absfûï©h
 , "%s%s" , 
g_wö32_°©e
.
exe_absfﬁdî∑th
 , 
ªndîî_dŒ_fûíame
);

300 
	`°b•_•rötf
(
lock_absfûï©h
 , "%s%s" , 
g_wö32_°©e
.
exe_absfﬁdî∑th
 , 
lock_fûíame
);

303 
g_ru¬ög
 = 
åue
;

304 
I≈ut
 
öput
 = {};

307 
Wö32DLL
 
game_code
 = {};

308 
game_code
.
å™sõ¡_dŒ_«me
 = "game_temp.dll";

309 
game_code
.
absfûï©h
 = 
game_dŒ_absfûï©h
;

310 
game_code
.
lock_absfûï©h
 =Üock_absfilepath;

311 
game_code
.
fun˘i⁄_«mes
 = 
wö32_game_fun˘i⁄_«mes
;

312 
game_code
.
fun˘i⁄s
 = (**)&
g_game_fun˘i⁄s
;

313 
game_code
.
fun˘i⁄_cou¡
 = 
	`AºayCou¡
(
wö32_game_fun˘i⁄_«mes
);

315 
	`Wö32LﬂdDLL
(&
g_wö32_°©e
, &
game_code
);

317 
wö32_≠i
.
›í_fûe
 = 
wö32_›í_fûe
;

318 
wö32_≠i
.
˛o£_fûe
 = 
wö32_˛o£_fûe
;

319 
wö32_≠i
.
ªad_fûe
 = 
wö32_ªad_fûe
;

320 
wö32_≠i
.
Æloˇã_mem‹y
 = 
wö32_Æloˇã_mem‹y
;

321 
wö32_≠i
.
dñŒoˇã_mem‹y
 = 
wö32_dóŒoˇã_mem‹y
;

323 
GameLayî
 
game_œyî
 = {};

324 
game_œyî
.
∂©f‹m_≠i
 = &
wö32_≠i
;

326 
g_wö32_wödow
.
h™dÀ
 = 
wödow
;

327 
g_wö32_wödow
.
dim
 = 
	`Wö32GëWödowDimísi⁄s
(
wödow
);

329 
g_game_fun˘i⁄s
.
	`game_öô
(&
game_œyî
, &
g_wö32_wödow
);

332 
g_ru¬ög
) {

334 if(
game_œyî
.
debug_curs‹_ªque°
) {

335 
g_wö32_°©e
.
curs‹_w¨p_íabÀd
 = 
Ál£
;

337 if(!
g_wö32_°©e
.
curs‹_íabÀd
) {

338 
	`SëCurs‹
(
g_wö32_°©e
.
curs‹
);

339 
g_wö32_°©e
.
curs‹_íabÀd
 = 
åue
;

341 if(!
g_wö32_°©e
.
curs‹_˛ù_íabÀd
) {

342 
RECT
 
ª˘
;

343 
	`GëWödowRe˘
(
g_wö32_wödow
.
h™dÀ
, &
ª˘
);

344 
	`ClùCurs‹
(&
ª˘
);

345 
g_wö32_°©e
.
curs‹_˛ù_íabÀd
 = 
åue
;

349 
g_wö32_°©e
.
curs‹_w¨p_íabÀd
 = 
åue
;

350 if(
g_wö32_°©e
.
curs‹_íabÀd
) {

351 
	`SëCurs‹
(0);

352 
g_wö32_°©e
.
curs‹_íabÀd
 = 
Ál£
;

354 if(
g_wö32_°©e
.
curs‹_˛ù_íabÀd
) {

355 
	`ClùCurs‹
(
nuŒ±r
);

356 
g_wö32_°©e
.
curs‹_˛ù_íabÀd
 = 
Ál£
;

360 
u8
 
i
=0; i<
WIN32_BUTTON_TOTAL
; i++Ë
	`Wö32PªPro˚ssBuâ⁄
(&
öput
.
buâ⁄s
[i]);

361 
	`Wö32PªPro˚ssMou£Move
(&
öput
, 
g_wö32_°©e
.
curs‹_w¨p_íabÀd
);

363 
MSG
 
msg
 = {};

364 
	`PìkMesßgeA
(&
msg
, 0, 0, 0, 
PM_REMOVE
)) {

365 
msg
.
mesßge
) {

366 
WM_QUIT
: { 
g_ru¬ög
 = 
Ál£
; } ;

367 
WM_SYSKEYDOWN
:

368 
WM_SYSKEYUP
:

369 
WM_KEYUP
:

370 
WM_KEYDOWN
:

371 
WM_LBUTTONDOWN
:

372 
WM_RBUTTONDOWN
: {

373 
	`Wö32Pro˚ssBuâ⁄I≈ut
(
msg
, &
öput
);

376 
	`Tøn¶©eMesßge
(&
msg
);

377 
	`Di•©chMesßge
(&
msg
);

382 
g_game_fun˘i⁄s
.
	`game_lo›
(&
game_œyî
, &
g_wö32_wödow
, &
öput
);

384 if(
	`Wö32HasDLLCh™ged
(&
game_code
)Ë
	`Wö32RñﬂdDLL
(&
g_wö32_°©e
, &game_code);

385 if(
game_œyî
.
quô_ªque°
Ë
g_ru¬ög
 = 
Ál£
;

388 
	}
}

	@win32.h

1 
	sWö32DLL
 {

2 
boﬁ
 
	mvÆid
;

3 
HMODULE
 
	mdŒ
;

4 
FILETIME
 
	mœ°_wrôe_time
;

5 
u32
 
	må™sõ¡_dŒ_cou¡î
;

7 * 
	mabsfûï©h
;

8 * 
	mlock_absfûï©h
;

9 * 
	må™sõ¡_dŒ_«me
;

10 ** 
	mfun˘i⁄s
;

11 ** 
	mfun˘i⁄_«mes
;

12 
u8
 
	mfun˘i⁄_cou¡
;

15 * 
	gwö32_game_fun˘i⁄_«mes
[] = {

20 
	sWö32GameFun˘i⁄TabÀ
 {

21 
GameInô
* 
	mgame_öô
;

22 
GameLo›
* 
	mgame_lo›
;

25 
	sWö32Mem‹yBlock
 {

26 
Pœtf‹mMem‹yBlock
 
	mblock
;

28 
Wö32Mem‹yBlock
* 
	m¥ev
;

29 
Wö32Mem‹yBlock
* 
	m√xt
;

32 
	sWö32Sèã
 {

33 
Wö32Mem‹yBlock
 
	mmem‹y_£¡öñ
;

35 
	mexe_absfûï©h
[
MAX_PATH
];

36 
	mexe_absfﬁdî∑th
[
MAX_PATH
];

37 
HWND
 
	mdeÁu…_wödow_h™dÀ
;

38 
HCURSOR
 
	mcurs‹
;

40 
boﬁ
 
	mcurs‹_íabÀd
;

41 
boﬁ
 
	mcurs‹_˛ù_íabÀd
;

42 
boﬁ
 
	mcurs‹_w¨p_íabÀd
;

	@
1
.
0
27
375
asset_formats.h
asset_info.cpp
asset_info.h
asset_loading.cpp
base_types.h
camera.cpp
file_formats.h
font_handling.cpp
font_handling.h
game.cpp
game.h
game_layer.h
include/stb_image.h
include/stb_sprintf.h
math.h
memory_management.h
mesh_renderer.cpp
platform_api.h
quad_renderer.cpp
renderer.cpp
renderer.h
shapes.cpp
simulation.cpp
simulation.h
tetra.cpp
win32.cpp
win32.h
